(function () {
var define = null;
var buildDate = '2016-10-25 16:07:09';
var buildUUID = 'b4970a63fae042c593763858867396b4';
!function(t){"use strict";function e(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function i(t){return"string"!=typeof t&&(t=String(t)),t}function n(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return f.iterable&&(e[Symbol.iterator]=function(){return e}),e}function o(t){this.map={},t instanceof o?t.forEach(function(t,e){this.append(e,t)},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function r(t){return t.bodyUsed?Promise.reject(new TypeError("Already read")):(t.bodyUsed=!0,void 0)}function s(t){return new Promise(function(e,i){t.onload=function(){e(t.result)},t.onerror=function(){i(t.error)}})}function a(t){var e=new FileReader;return e.readAsArrayBuffer(t),s(e)}function l(t){var e=new FileReader;return e.readAsText(t),s(e)}function h(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,"string"==typeof t)this._bodyText=t;else if(f.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(f.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(f.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(t){if(!f.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t))throw new Error("unsupported BodyInit type")}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):f.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},f.blob?(this.blob=function(){var t=r(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this.blob().then(a)},this.text=function(){var t=r(this);if(t)return t;if(this._bodyBlob)return l(this._bodyBlob);if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)}):this.text=function(){var t=r(this);return t?t:Promise.resolve(this._bodyText)},f.formData&&(this.formData=function(){return this.text().then(d)}),this.json=function(){return this.text().then(JSON.parse)},this}function u(t){var e=t.toUpperCase();return g.indexOf(e)>-1?e:t}function c(t,e){e=e||{};var i=e.body;if(c.prototype.isPrototypeOf(t)){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new o(t.headers)),this.method=t.method,this.mode=t.mode,i||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=t;if(this.credentials=e.credentials||this.credentials||"omit",(e.headers||!this.headers)&&(this.headers=new o(e.headers)),this.method=u(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function d(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var i=t.split("="),n=i.shift().replace(/\+/g," "),o=i.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(o))}}),e}function p(t){var e=new o,i=(t.getAllResponseHeaders()||"").trim().split("\n");return i.forEach(function(t){var i=t.trim().split(":"),n=i.shift().trim(),o=i.join(":").trim();e.append(n,o)}),e}function m(t,e){e||(e={}),this.type="default",this.status=e.status,this.ok=this.status>=200&&this.status<300,this.statusText=e.statusText,this.headers=e.headers instanceof o?e.headers:new o(e.headers),this.url=e.url||"",this._initBody(t)}if(!t.fetch){var f={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};o.prototype.append=function(t,n){t=e(t),n=i(n);var o=this.map[t];o||(o=[],this.map[t]=o),o.push(n)},o.prototype["delete"]=function(t){delete this.map[e(t)]},o.prototype.get=function(t){var i=this.map[e(t)];return i?i[0]:null},o.prototype.getAll=function(t){return this.map[e(t)]||[]},o.prototype.has=function(t){return this.map.hasOwnProperty(e(t))},o.prototype.set=function(t,n){this.map[e(t)]=[i(n)]},o.prototype.forEach=function(t,e){Object.getOwnPropertyNames(this.map).forEach(function(i){this.map[i].forEach(function(n){t.call(e,n,i,this)},this)},this)},o.prototype.keys=function(){var t=[];return this.forEach(function(e,i){t.push(i)}),n(t)},o.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),n(t)},o.prototype.entries=function(){var t=[];return this.forEach(function(e,i){t.push([i,e])}),n(t)},f.iterable&&(o.prototype[Symbol.iterator]=o.prototype.entries);var g=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];c.prototype.clone=function(){return new c(this)},h.call(c.prototype),h.call(m.prototype),m.prototype.clone=function(){return new m(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new o(this.headers),url:this.url})},m.error=function(){var t=new m(null,{status:0,statusText:""});return t.type="error",t};var _=[301,302,303,307,308];m.redirect=function(t,e){if(-1===_.indexOf(e))throw new RangeError("Invalid status code");return new m(null,{status:e,headers:{location:t}})},t.Headers=o,t.Request=c,t.Response=m,t.fetch=function(t,e){return new Promise(function(i,n){function o(){return"responseURL"in s?s.responseURL:/^X-Request-URL:/im.test(s.getAllResponseHeaders())?s.getResponseHeader("X-Request-URL"):void 0}var r;r=c.prototype.isPrototypeOf(t)&&!e?t:new c(t,e);var s=new XMLHttpRequest;s.onload=function(){var t={status:s.status,statusText:s.statusText,headers:p(s),url:o()},e="response"in s?s.response:s.responseText;i(new m(e,t))},s.onerror=function(){n(new TypeError("Network request failed"))},s.ontimeout=function(){n(new TypeError("Network request failed"))},s.open(r.method,r.url,!0),"include"===r.credentials&&(s.withCredentials=!0),"responseType"in s&&f.blob&&(s.responseType="blob"),r.headers.forEach(function(t,e){s.setRequestHeader(e,t)}),s.send("undefined"==typeof r._bodyInit?null:r._bodyInit)})},t.fetch.polyfill=!0}}("undefined"!=typeof self?self:this),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.ES6Promise=e()}(this,function(){"use strict";function t(t){return"function"==typeof t||"object"==typeof t&&null!==t}function e(t){return"function"==typeof t}function i(t){q=t}function n(t){W=t}function o(){return function(){return process.nextTick(h)}}function r(){return"undefined"!=typeof V?function(){V(h)}:l()}function s(){var t=0,e=new J(h),i=document.createTextNode("");return e.observe(i,{characterData:!0}),function(){i.data=t=++t%2}}function a(){var t=new MessageChannel;return t.port1.onmessage=h,function(){return t.port2.postMessage(0)}}function l(){var t=setTimeout;return function(){return t(h,1)}}function h(){for(var t=0;j>t;t+=2){var e=$[t],i=$[t+1];e(i),$[t]=void 0,$[t+1]=void 0}j=0}function u(){try{var t=require,e=t("vertx");return V=e.runOnLoop||e.runOnContext,r()}catch(i){return l()}}function c(t,e){var i=arguments,n=this,o=new this.constructor(p);void 0===o[ee]&&E(o);var r=n._state;return r?function(){var t=i[r-1];W(function(){return D(r,o,t,n._result)})}():T(n,o,t,e),o}function d(t){var e=this;if(t&&"object"==typeof t&&t.constructor===e)return t;var i=new e(p);return L(i,t),i}function p(){}function m(){return new TypeError("You cannot resolve a promise with itself")}function f(){return new TypeError("A promises callback cannot return that same promise.")}function g(t){try{return t.then}catch(e){return re.error=e,re}}function _(t,e,i,n){try{t.call(e,i,n)}catch(o){return o}}function v(t,e,i){W(function(t){var n=!1,o=_(i,e,function(i){n||(n=!0,e!==i?L(t,i):P(t,i))},function(e){n||(n=!0,S(t,e))},"Settle: "+(t._label||" unknown promise"));!n&&o&&(n=!0,S(t,o))},t)}function y(t,e){e._state===ne?P(t,e._result):e._state===oe?S(t,e._result):T(e,void 0,function(e){return L(t,e)},function(e){return S(t,e)})}function x(t,i,n){i.constructor===t.constructor&&n===c&&i.constructor.resolve===d?y(t,i):n===re?S(t,re.error):void 0===n?P(t,i):e(n)?v(t,i,n):P(t,i)}function L(e,i){e===i?S(e,m()):t(i)?x(e,i,g(i)):P(e,i)}function b(t){t._onerror&&t._onerror(t._result),w(t)}function P(t,e){t._state===ie&&(t._result=e,t._state=ne,0!==t._subscribers.length&&W(w,t))}function S(t,e){t._state===ie&&(t._state=oe,t._result=e,W(b,t))}function T(t,e,i,n){var o=t._subscribers,r=o.length;t._onerror=null,o[r]=e,o[r+ne]=i,o[r+oe]=n,0===r&&t._state&&W(w,t)}function w(t){var e=t._subscribers,i=t._state;if(0!==e.length){for(var n=void 0,o=void 0,r=t._result,s=0;s<e.length;s+=3)n=e[s],o=e[s+i],n?D(i,n,o,r):o(r);t._subscribers.length=0}}function C(){this.error=null}function M(t,e){try{return t(e)}catch(i){return se.error=i,se}}function D(t,i,n,o){var r=e(n),s=void 0,a=void 0,l=void 0,h=void 0;if(r){if(s=M(n,o),s===se?(h=!0,a=s.error,s=null):l=!0,i===s)return S(i,f()),void 0}else s=o,l=!0;i._state!==ie||(r&&l?L(i,s):h?S(i,a):t===ne?P(i,s):t===oe&&S(i,s))}function I(t,e){try{e(function(e){L(t,e)},function(e){S(t,e)})}catch(i){S(t,i)}}function k(){return ae++}function E(t){t[ee]=ae++,t._state=void 0,t._result=void 0,t._subscribers=[]}function O(t,e){this._instanceConstructor=t,this.promise=new t(p),this.promise[ee]||E(this.promise),H(e)?(this._input=e,this.length=e.length,this._remaining=e.length,this._result=new Array(this.length),0===this.length?P(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&P(this.promise,this._result))):S(this.promise,A())}function A(){return new Error("Array Methods must be provided an Array")}function N(t){return new O(this,t).promise}function B(t){var e=this;return H(t)?new e(function(i,n){for(var o=t.length,r=0;o>r;r++)e.resolve(t[r]).then(i,n)}):new e(function(t,e){return e(new TypeError("You must pass an array to race."))})}function U(t){var e=this,i=new e(p);return S(i,t),i}function z(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function R(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function F(t){this[ee]=k(),this._result=this._state=void 0,this._subscribers=[],p!==t&&("function"!=typeof t&&z(),this instanceof F?I(this,t):R())}function G(){var t=void 0;if("undefined"!=typeof global)t=global;else if("undefined"!=typeof self)t=self;else try{t=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var i=t.Promise;if(i){var n=null;try{n=Object.prototype.toString.call(i.resolve())}catch(e){}if("[object Promise]"===n&&!i.cast)return}t.Promise=F}var Z=void 0;Z=Array.isArray?Array.isArray:function(t){return"[object Array]"===Object.prototype.toString.call(t)};var H=Z,j=0,V=void 0,q=void 0,W=function(t,e){$[j]=t,$[j+1]=e,j+=2,2===j&&(q?q(h):te())},K="undefined"!=typeof window?window:void 0,Y=K||{},J=Y.MutationObserver||Y.WebKitMutationObserver,X="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Q="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,$=new Array(1e3),te=void 0;te=X?o():J?s():Q?a():void 0===K&&"function"==typeof require?u():l();var ee=Math.random().toString(36).substring(16),ie=void 0,ne=1,oe=2,re=new C,se=new C,ae=0;return O.prototype._enumerate=function(){for(var t=this.length,e=this._input,i=0;this._state===ie&&t>i;i++)this._eachEntry(e[i],i)},O.prototype._eachEntry=function(t,e){var i=this._instanceConstructor,n=i.resolve;if(n===d){var o=g(t);if(o===c&&t._state!==ie)this._settledAt(t._state,e,t._result);else if("function"!=typeof o)this._remaining--,this._result[e]=t;else if(i===F){var r=new i(p);x(r,t,o),this._willSettleAt(r,e)}else this._willSettleAt(new i(function(e){return e(t)}),e)}else this._willSettleAt(n(t),e)},O.prototype._settledAt=function(t,e,i){var n=this.promise;n._state===ie&&(this._remaining--,t===oe?S(n,i):this._result[e]=i),0===this._remaining&&P(n,this._result)},O.prototype._willSettleAt=function(t,e){var i=this;T(t,void 0,function(t){return i._settledAt(ne,e,t)},function(t){return i._settledAt(oe,e,t)})},F.all=N,F.race=B,F.resolve=d,F.reject=U,F._setScheduler=i,F._setAsap=n,F._asap=W,F.prototype={constructor:F,then:c,"catch":function(t){return this.then(null,t)}},F.polyfill=G,F.Promise=F,F}),ES6Promise.polyfill(),function(t,e,i){var n=t.L,o={};o.version="0.7.7","object"==typeof module&&"object"==typeof module.exports?module.exports=o:"function"==typeof define&&define.amd&&define(o),o.noConflict=function(){return t.L=n,this},t.L=o,o.Util={extend:function(t){var e,i,n,o,r=Array.prototype.slice.call(arguments,1);for(i=0,n=r.length;n>i;i++){o=r[i]||{};for(e in o)o.hasOwnProperty(e)&&(t[e]=o[e])}return t},bind:function(t,e){var i=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return t.apply(e,i||arguments)}},stamp:function(){var t=0,e="_leaflet_id";return function(i){return i[e]=i[e]||++t,i[e]}}(),invokeEach:function(t,e,i){var n,o;if("object"==typeof t){o=Array.prototype.slice.call(arguments,3);for(n in t)e.apply(i,[n,t[n]].concat(o));return!0}return!1},limitExecByInterval:function(t,e,i){var n,o;return function r(){var s=arguments;return n?(o=!0,void 0):(n=!0,setTimeout(function(){n=!1,o&&(r.apply(i,s),o=!1)},e),t.apply(i,s),void 0)}},falseFn:function(){return!1},formatNum:function(t,e){var i=Math.pow(10,e||5);return Math.round(t*i)/i},trim:function(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")},splitWords:function(t){return o.Util.trim(t).split(/\s+/)},setOptions:function(t,e){return t.options=o.extend({},t.options,e),t.options},getParamString:function(t,e,i){var n=[];for(var o in t)n.push(encodeURIComponent(i?o.toUpperCase():o)+"="+encodeURIComponent(t[o]));return(e&&-1!==e.indexOf("?")?"&":"?")+n.join("&")},template:function(t,e){return t.replace(/\{ *([\w_]+) *\}/g,function(t,n){var o=e[n];if(o===i)throw new Error("No value provided for variable "+t);return"function"==typeof o&&(o=o(e)),o})},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},emptyImageUrl:"data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="},function(){function e(e){var i,n,o=["webkit","moz","o","ms"];for(i=0;i<o.length&&!n;i++)n=t[o[i]+e];return n}function i(e){var i=+new Date,o=Math.max(0,16-(i-n));return n=i+o,t.setTimeout(e,o)}var n=0,r=t.requestAnimationFrame||e("RequestAnimationFrame")||i,s=t.cancelAnimationFrame||e("CancelAnimationFrame")||e("CancelRequestAnimationFrame")||function(e){t.clearTimeout(e)};o.Util.requestAnimFrame=function(e,n,s,a){return e=o.bind(e,n),s&&r===i?(e(),void 0):r.call(t,e,a)},o.Util.cancelAnimFrame=function(e){e&&s.call(t,e)}}(),o.extend=o.Util.extend,o.bind=o.Util.bind,o.stamp=o.Util.stamp,o.setOptions=o.Util.setOptions,o.Class=function(){},o.Class.extend=function(t){var e=function(){this.initialize&&this.initialize.apply(this,arguments),this._initHooks&&this.callInitHooks()},i=function(){};i.prototype=this.prototype;var n=new i;n.constructor=e,e.prototype=n;for(var r in this)this.hasOwnProperty(r)&&"prototype"!==r&&(e[r]=this[r]);t.statics&&(o.extend(e,t.statics),delete t.statics),t.includes&&(o.Util.extend.apply(null,[n].concat(t.includes)),delete t.includes),t.options&&n.options&&(t.options=o.extend({},n.options,t.options)),o.extend(n,t),n._initHooks=[];var s=this;return e.__super__=s.prototype,n.callInitHooks=function(){if(!this._initHooksCalled){s.prototype.callInitHooks&&s.prototype.callInitHooks.call(this),this._initHooksCalled=!0;for(var t=0,e=n._initHooks.length;e>t;t++)n._initHooks[t].call(this)}},e},o.Class.include=function(t){o.extend(this.prototype,t)},o.Class.mergeOptions=function(t){o.extend(this.prototype.options,t)},o.Class.addInitHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};this.prototype._initHooks=this.prototype._initHooks||[],this.prototype._initHooks.push(i)};var r="_leaflet_events";o.Mixin={},o.Mixin.Events={addEventListener:function(t,e,i){if(o.Util.invokeEach(t,this.addEventListener,this,e,i))return this;var n,s,a,l,h,u,c,d=this[r]=this[r]||{},p=i&&i!==this&&o.stamp(i);for(t=o.Util.splitWords(t),n=0,s=t.length;s>n;n++)a={action:e,context:i||this},l=t[n],p?(h=l+"_idx",u=h+"_len",c=d[h]=d[h]||{},c[p]||(c[p]=[],d[u]=(d[u]||0)+1),c[p].push(a)):(d[l]=d[l]||[],d[l].push(a));return this},hasEventListeners:function(t){var e=this[r];return!!e&&(t in e&&e[t].length>0||t+"_idx"in e&&e[t+"_idx_len"]>0)},removeEventListener:function(t,e,i){if(!this[r])return this;if(!t)return this.clearAllEventListeners();if(o.Util.invokeEach(t,this.removeEventListener,this,e,i))return this;var n,s,a,l,h,u,c,d,p,m=this[r],f=i&&i!==this&&o.stamp(i);for(t=o.Util.splitWords(t),n=0,s=t.length;s>n;n++)if(a=t[n],u=a+"_idx",c=u+"_len",d=m[u],e){if(l=f&&d?d[f]:m[a]){for(h=l.length-1;h>=0;h--)l[h].action!==e||i&&l[h].context!==i||(p=l.splice(h,1),p[0].action=o.Util.falseFn);i&&d&&0===l.length&&(delete d[f],m[c]--)}}else delete m[a],delete m[u],delete m[c];return this},clearAllEventListeners:function(){return delete this[r],this},fireEvent:function(t,e){if(!this.hasEventListeners(t))return this;var i,n,s,a,l,h=o.Util.extend({},e,{type:t,target:this}),u=this[r];if(u[t])for(i=u[t].slice(),n=0,s=i.length;s>n;n++)i[n].action.call(i[n].context,h);a=u[t+"_idx"];for(l in a)if(i=a[l].slice())for(n=0,s=i.length;s>n;n++)i[n].action.call(i[n].context,h);return this},addOneTimeEventListener:function(t,e,i){if(o.Util.invokeEach(t,this.addOneTimeEventListener,this,e,i))return this;var n=o.bind(function(){this.removeEventListener(t,e,i).removeEventListener(t,n,i)},this);return this.addEventListener(t,e,i).addEventListener(t,n,i)}},o.Mixin.Events.on=o.Mixin.Events.addEventListener,o.Mixin.Events.off=o.Mixin.Events.removeEventListener,o.Mixin.Events.once=o.Mixin.Events.addOneTimeEventListener,o.Mixin.Events.fire=o.Mixin.Events.fireEvent,function(){var n="ActiveXObject"in t,r=n&&!e.addEventListener,s=navigator.userAgent.toLowerCase(),a=-1!==s.indexOf("webkit"),l=-1!==s.indexOf("chrome"),h=-1!==s.indexOf("phantom"),u=-1!==s.indexOf("android"),c=-1!==s.search("android [23]"),d=-1!==s.indexOf("gecko"),p=typeof orientation!=i+"",m=!t.PointerEvent&&t.MSPointerEvent,f=t.PointerEvent&&t.navigator.pointerEnabled||m,g="devicePixelRatio"in t&&t.devicePixelRatio>1||"matchMedia"in t&&t.matchMedia("(min-resolution:144dpi)")&&t.matchMedia("(min-resolution:144dpi)").matches,_=e.documentElement,v=n&&"transition"in _.style,y="WebKitCSSMatrix"in t&&"m11"in new t.WebKitCSSMatrix&&!c,x="MozPerspective"in _.style,L="OTransition"in _.style,b=!t.L_DISABLE_3D&&(v||y||x||L)&&!h,P=!t.L_NO_TOUCH&&!h&&(f||"ontouchstart"in t||t.DocumentTouch&&e instanceof t.DocumentTouch);o.Browser={ie:n,ielt9:r,webkit:a,gecko:d&&!a&&!t.opera&&!n,android:u,android23:c,chrome:l,ie3d:v,webkit3d:y,gecko3d:x,opera3d:L,any3d:b,mobile:p,mobileWebkit:p&&a,mobileWebkit3d:p&&y,mobileOpera:p&&t.opera,touch:P,msPointer:m,pointer:f,retina:g}}(),o.Point=function(t,e,i){this.x=i?Math.round(t):t,this.y=i?Math.round(e):e},o.Point.prototype={clone:function(){return new o.Point(this.x,this.y)},add:function(t){return this.clone()._add(o.point(t))},_add:function(t){return this.x+=t.x,this.y+=t.y,this},subtract:function(t){return this.clone()._subtract(o.point(t))},_subtract:function(t){return this.x-=t.x,this.y-=t.y,this},divideBy:function(t){return this.clone()._divideBy(t)},_divideBy:function(t){return this.x/=t,this.y/=t,this},multiplyBy:function(t){return this.clone()._multiplyBy(t)},_multiplyBy:function(t){return this.x*=t,this.y*=t,this},round:function(){return this.clone()._round()},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},floor:function(){return this.clone()._floor()},_floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},distanceTo:function(t){t=o.point(t);var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},equals:function(t){return t=o.point(t),t.x===this.x&&t.y===this.y},contains:function(t){return t=o.point(t),Math.abs(t.x)<=Math.abs(this.x)&&Math.abs(t.y)<=Math.abs(this.y)},toString:function(){return"Point("+o.Util.formatNum(this.x)+", "+o.Util.formatNum(this.y)+")"}},o.point=function(t,e,n){return t instanceof o.Point?t:o.Util.isArray(t)?new o.Point(t[0],t[1]):t===i||null===t?t:new o.Point(t,e,n)},o.Bounds=function(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;o>n;n++)this.extend(i[n])},o.Bounds.prototype={extend:function(t){return t=o.point(t),this.min||this.max?(this.min.x=Math.min(t.x,this.min.x),this.max.x=Math.max(t.x,this.max.x),this.min.y=Math.min(t.y,this.min.y),this.max.y=Math.max(t.y,this.max.y)):(this.min=t.clone(),this.max=t.clone()),this},getCenter:function(t){return new o.Point((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,t)},getBottomLeft:function(){return new o.Point(this.min.x,this.max.y)},getTopRight:function(){return new o.Point(this.max.x,this.min.y)},getSize:function(){return this.max.subtract(this.min)},contains:function(t){var e,i;return t="number"==typeof t[0]||t instanceof o.Point?o.point(t):o.bounds(t),t instanceof o.Bounds?(e=t.min,i=t.max):e=i=t,e.x>=this.min.x&&i.x<=this.max.x&&e.y>=this.min.y&&i.y<=this.max.y},intersects:function(t){t=o.bounds(t);var e=this.min,i=this.max,n=t.min,r=t.max,s=r.x>=e.x&&n.x<=i.x,a=r.y>=e.y&&n.y<=i.y;return s&&a},isValid:function(){return!(!this.min||!this.max)}},o.bounds=function(t,e){return!t||t instanceof o.Bounds?t:new o.Bounds(t,e)},o.Transformation=function(t,e,i,n){this._a=t,this._b=e,this._c=i,this._d=n},o.Transformation.prototype={transform:function(t,e){return this._transform(t.clone(),e)},_transform:function(t,e){return e=e||1,t.x=e*(this._a*t.x+this._b),t.y=e*(this._c*t.y+this._d),t},untransform:function(t,e){return e=e||1,new o.Point((t.x/e-this._b)/this._a,(t.y/e-this._d)/this._c)}},o.DomUtil={get:function(t){return"string"==typeof t?e.getElementById(t):t},getStyle:function(t,i){var n=t.style[i];if(!n&&t.currentStyle&&(n=t.currentStyle[i]),(!n||"auto"===n)&&e.defaultView){var o=e.defaultView.getComputedStyle(t,null);n=o?o[i]:null}return"auto"===n?null:n},getViewportOffset:function(t){var i,n=0,r=0,s=t,a=e.body,l=e.documentElement;do{if(n+=s.offsetTop||0,r+=s.offsetLeft||0,n+=parseInt(o.DomUtil.getStyle(s,"borderTopWidth"),10)||0,r+=parseInt(o.DomUtil.getStyle(s,"borderLeftWidth"),10)||0,i=o.DomUtil.getStyle(s,"position"),s.offsetParent===a&&"absolute"===i)break;if("fixed"===i){n+=a.scrollTop||l.scrollTop||0,r+=a.scrollLeft||l.scrollLeft||0;break}if("relative"===i&&!s.offsetLeft){var h=o.DomUtil.getStyle(s,"width"),u=o.DomUtil.getStyle(s,"max-width"),c=s.getBoundingClientRect();("none"!==h||"none"!==u)&&(r+=c.left+s.clientLeft),n+=c.top+(a.scrollTop||l.scrollTop||0);break}s=s.offsetParent}while(s);s=t;do{if(s===a)break;n-=s.scrollTop||0,r-=s.scrollLeft||0,s=s.parentNode}while(s);return new o.Point(r,n)},documentIsLtr:function(){return o.DomUtil._docIsLtrCached||(o.DomUtil._docIsLtrCached=!0,o.DomUtil._docIsLtr="ltr"===o.DomUtil.getStyle(e.body,"direction")),o.DomUtil._docIsLtr},create:function(t,i,n){var o=e.createElement(t);return o.className=i,n&&n.appendChild(o),o},hasClass:function(t,e){if(t.classList!==i)return t.classList.contains(e);var n=o.DomUtil._getClass(t);return n.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(n)},addClass:function(t,e){if(t.classList!==i)for(var n=o.Util.splitWords(e),r=0,s=n.length;s>r;r++)t.classList.add(n[r]);else if(!o.DomUtil.hasClass(t,e)){var a=o.DomUtil._getClass(t);o.DomUtil._setClass(t,(a?a+" ":"")+e)}},removeClass:function(t,e){t.classList!==i?t.classList.remove(e):o.DomUtil._setClass(t,o.Util.trim((" "+o.DomUtil._getClass(t)+" ").replace(" "+e+" "," ")))},_setClass:function(t,e){t.className.baseVal===i?t.className=e:t.className.baseVal=e},_getClass:function(t){return t.className.baseVal===i?t.className:t.className.baseVal},setOpacity:function(t,e){if("opacity"in t.style)t.style.opacity=e;else if("filter"in t.style){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=t.filters.item(n)}catch(o){if(1===e)return}e=Math.round(100*e),i?(i.Enabled=100!==e,i.Opacity=e):t.style.filter+=" progid:"+n+"(opacity="+e+")"}},testProp:function(t){for(var i=e.documentElement.style,n=0;n<t.length;n++)if(t[n]in i)return t[n];return!1},getTranslateString:function(t){var e=o.Browser.webkit3d,i="translate"+(e?"3d":"")+"(",n=(e?",0":"")+")";return i+t.x+"px,"+t.y+"px"+n},getScaleString:function(t,e){var i=o.DomUtil.getTranslateString(e.add(e.multiplyBy(-1*t))),n=" scale("+t+") ";return i+n},setPosition:function(t,e,i){t._leaflet_pos=e,!i&&o.Browser.any3d?t.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(e):(t.style.left=e.x+"px",t.style.top=e.y+"px")},getPosition:function(t){return t._leaflet_pos}},o.DomUtil.TRANSFORM=o.DomUtil.testProp(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),o.DomUtil.TRANSITION=o.DomUtil.testProp(["webkitTransition","transition","OTransition","MozTransition","msTransition"]),o.DomUtil.TRANSITION_END="webkitTransition"===o.DomUtil.TRANSITION||"OTransition"===o.DomUtil.TRANSITION?o.DomUtil.TRANSITION+"End":"transitionend",function(){if("onselectstart"in e)o.extend(o.DomUtil,{disableTextSelection:function(){o.DomEvent.on(t,"selectstart",o.DomEvent.preventDefault)},enableTextSelection:function(){o.DomEvent.off(t,"selectstart",o.DomEvent.preventDefault)}});else{var i=o.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);o.extend(o.DomUtil,{disableTextSelection:function(){if(i){var t=e.documentElement.style;this._userSelect=t[i],t[i]="none"}},enableTextSelection:function(){i&&(e.documentElement.style[i]=this._userSelect,delete this._userSelect)}})}o.extend(o.DomUtil,{disableImageDrag:function(){o.DomEvent.on(t,"dragstart",o.DomEvent.preventDefault)},enableImageDrag:function(){o.DomEvent.off(t,"dragstart",o.DomEvent.preventDefault)}})}(),o.LatLng=function(t,e,n){if(t=parseFloat(t),e=parseFloat(e),isNaN(t)||isNaN(e))throw new Error("Invalid LatLng object: ("+t+", "+e+")");this.lat=t,this.lng=e,n!==i&&(this.alt=parseFloat(n))},o.extend(o.LatLng,{DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,MAX_MARGIN:1e-9}),o.LatLng.prototype={equals:function(t){if(!t)return!1;t=o.latLng(t);var e=Math.max(Math.abs(this.lat-t.lat),Math.abs(this.lng-t.lng));return e<=o.LatLng.MAX_MARGIN},toString:function(t){return"LatLng("+o.Util.formatNum(this.lat,t)+", "+o.Util.formatNum(this.lng,t)+")"},distanceTo:function(t){t=o.latLng(t);var e=6378137,i=o.LatLng.DEG_TO_RAD,n=(t.lat-this.lat)*i,r=(t.lng-this.lng)*i,s=this.lat*i,a=t.lat*i,l=Math.sin(n/2),h=Math.sin(r/2),u=l*l+h*h*Math.cos(s)*Math.cos(a);return 2*e*Math.atan2(Math.sqrt(u),Math.sqrt(1-u))},wrap:function(t,e){var i=this.lng;return t=t||-180,e=e||180,i=(i+e)%(e-t)+(t>i||i===e?e:t),new o.LatLng(this.lat,i)}},o.latLng=function(t,e){return t instanceof o.LatLng?t:o.Util.isArray(t)?"number"==typeof t[0]||"string"==typeof t[0]?new o.LatLng(t[0],t[1],t[2]):null:t===i||null===t?t:"object"==typeof t&&"lat"in t?new o.LatLng(t.lat,"lng"in t?t.lng:t.lon):e===i?null:new o.LatLng(t,e)},o.LatLngBounds=function(t,e){if(t)for(var i=e?[t,e]:t,n=0,o=i.length;o>n;n++)this.extend(i[n])},o.LatLngBounds.prototype={extend:function(t){if(!t)return this;var e=o.latLng(t);return t=null!==e?e:o.latLngBounds(t),t instanceof o.LatLng?this._southWest||this._northEast?(this._southWest.lat=Math.min(t.lat,this._southWest.lat),this._southWest.lng=Math.min(t.lng,this._southWest.lng),this._northEast.lat=Math.max(t.lat,this._northEast.lat),this._northEast.lng=Math.max(t.lng,this._northEast.lng)):(this._southWest=new o.LatLng(t.lat,t.lng),this._northEast=new o.LatLng(t.lat,t.lng)):t instanceof o.LatLngBounds&&(this.extend(t._southWest),this.extend(t._northEast)),this},pad:function(t){var e=this._southWest,i=this._northEast,n=Math.abs(e.lat-i.lat)*t,r=Math.abs(e.lng-i.lng)*t;return new o.LatLngBounds(new o.LatLng(e.lat-n,e.lng-r),new o.LatLng(i.lat+n,i.lng+r))},getCenter:function(){return new o.LatLng((this._southWest.lat+this._northEast.lat)/2,(this._southWest.lng+this._northEast.lng)/2)},getSouthWest:function(){return this._southWest},getNorthEast:function(){return this._northEast},getNorthWest:function(){return new o.LatLng(this.getNorth(),this.getWest())},getSouthEast:function(){return new o.LatLng(this.getSouth(),this.getEast())},getWest:function(){return this._southWest.lng},getSouth:function(){return this._southWest.lat},getEast:function(){return this._northEast.lng},getNorth:function(){return this._northEast.lat},contains:function(t){t="number"==typeof t[0]||t instanceof o.LatLng?o.latLng(t):o.latLngBounds(t);var e,i,n=this._southWest,r=this._northEast;return t instanceof o.LatLngBounds?(e=t.getSouthWest(),i=t.getNorthEast()):e=i=t,e.lat>=n.lat&&i.lat<=r.lat&&e.lng>=n.lng&&i.lng<=r.lng},intersects:function(t){t=o.latLngBounds(t);var e=this._southWest,i=this._northEast,n=t.getSouthWest(),r=t.getNorthEast(),s=r.lat>=e.lat&&n.lat<=i.lat,a=r.lng>=e.lng&&n.lng<=i.lng;return s&&a},toBBoxString:function(){return[this.getWest(),this.getSouth(),this.getEast(),this.getNorth()].join(",")},equals:function(t){return t?(t=o.latLngBounds(t),this._southWest.equals(t.getSouthWest())&&this._northEast.equals(t.getNorthEast())):!1},isValid:function(){return!(!this._southWest||!this._northEast)}},o.latLngBounds=function(t,e){return!t||t instanceof o.LatLngBounds?t:new o.LatLngBounds(t,e)},o.Projection={},o.Projection.SphericalMercator={MAX_LATITUDE:85.0511287798,project:function(t){var e=o.LatLng.DEG_TO_RAD,i=this.MAX_LATITUDE,n=Math.max(Math.min(i,t.lat),-i),r=t.lng*e,s=n*e;return s=Math.log(Math.tan(Math.PI/4+s/2)),new o.Point(r,s)},unproject:function(t){var e=o.LatLng.RAD_TO_DEG,i=t.x*e,n=(2*Math.atan(Math.exp(t.y))-Math.PI/2)*e;return new o.LatLng(n,i)}},o.Projection.LonLat={project:function(t){return new o.Point(t.lng,t.lat)},unproject:function(t){return new o.LatLng(t.y,t.x)}},o.CRS={latLngToPoint:function(t,e){var i=this.projection.project(t),n=this.scale(e);return this.transformation._transform(i,n)},pointToLatLng:function(t,e){var i=this.scale(e),n=this.transformation.untransform(t,i);return this.projection.unproject(n)},project:function(t){return this.projection.project(t)},scale:function(t){return 256*Math.pow(2,t)},getSize:function(t){var e=this.scale(t);return o.point(e,e)}},o.CRS.Simple=o.extend({},o.CRS,{projection:o.Projection.LonLat,transformation:new o.Transformation(1,0,-1,0),scale:function(t){return Math.pow(2,t)}}),o.CRS.EPSG3857=o.extend({},o.CRS,{code:"EPSG:3857",projection:o.Projection.SphericalMercator,transformation:new o.Transformation(.5/Math.PI,.5,-.5/Math.PI,.5),project:function(t){var e=this.projection.project(t),i=6378137;return e.multiplyBy(i)}}),o.CRS.EPSG900913=o.extend({},o.CRS.EPSG3857,{code:"EPSG:900913"}),o.CRS.EPSG4326=o.extend({},o.CRS,{code:"EPSG:4326",projection:o.Projection.LonLat,transformation:new o.Transformation(1/360,.5,-1/360,.5)}),o.Map=o.Class.extend({includes:o.Mixin.Events,options:{crs:o.CRS.EPSG3857,fadeAnimation:o.DomUtil.TRANSITION&&!o.Browser.android23,trackResize:!0,markerZoomAnimation:o.DomUtil.TRANSITION&&o.Browser.any3d},initialize:function(t,e){e=o.setOptions(this,e),this._initContainer(t),this._initLayout(),this._onResize=o.bind(this._onResize,this),this._initEvents(),e.maxBounds&&this.setMaxBounds(e.maxBounds),e.center&&e.zoom!==i&&this.setView(o.latLng(e.center),e.zoom,{reset:!0}),this._handlers=[],this._layers={},this._zoomBoundLayers={},this._tileLayersNum=0,this.callInitHooks(),this._addLayers(e.layers)},setView:function(t,e){return e=e===i?this.getZoom():e,this._resetView(o.latLng(t),this._limitZoom(e)),this
},setZoom:function(t,e){return this._loaded?this.setView(this.getCenter(),t,{zoom:e}):(this._zoom=this._limitZoom(t),this)},zoomIn:function(t,e){return this.setZoom(this._zoom+(t||1),e)},zoomOut:function(t,e){return this.setZoom(this._zoom-(t||1),e)},setZoomAround:function(t,e,i){var n=this.getZoomScale(e),r=this.getSize().divideBy(2),s=t instanceof o.Point?t:this.latLngToContainerPoint(t),a=s.subtract(r).multiplyBy(1-1/n),l=this.containerPointToLatLng(r.add(a));return this.setView(l,e,{zoom:i})},fitBounds:function(t,e){e=e||{},t=t.getBounds?t.getBounds():o.latLngBounds(t);var i=o.point(e.paddingTopLeft||e.padding||[0,0]),n=o.point(e.paddingBottomRight||e.padding||[0,0]),r=this.getBoundsZoom(t,!1,i.add(n));r=e.maxZoom?Math.min(e.maxZoom,r):r;var s=n.subtract(i).divideBy(2),a=this.project(t.getSouthWest(),r),l=this.project(t.getNorthEast(),r),h=this.unproject(a.add(l).divideBy(2).add(s),r);return this.setView(h,r,e)},fitWorld:function(t){return this.fitBounds([[-90,-180],[90,180]],t)},panTo:function(t,e){return this.setView(t,this._zoom,{pan:e})},panBy:function(t){return this.fire("movestart"),this._rawPanBy(o.point(t)),this.fire("move"),this.fire("moveend")},setMaxBounds:function(t){return t=o.latLngBounds(t),this.options.maxBounds=t,t?(this._loaded&&this._panInsideMaxBounds(),this.on("moveend",this._panInsideMaxBounds,this)):this.off("moveend",this._panInsideMaxBounds,this)},panInsideBounds:function(t,e){var i=this.getCenter(),n=this._limitCenter(i,this._zoom,t);return i.equals(n)?this:this.panTo(n,e)},addLayer:function(t){var e=o.stamp(t);return this._layers[e]?this:(this._layers[e]=t,!t.options||isNaN(t.options.maxZoom)&&isNaN(t.options.minZoom)||(this._zoomBoundLayers[e]=t,this._updateZoomLevels()),this.options.zoomAnimation&&o.TileLayer&&t instanceof o.TileLayer&&(this._tileLayersNum++,this._tileLayersToLoad++,t.on("load",this._onTileLayerLoad,this)),this._loaded&&this._layerAdd(t),this)},removeLayer:function(t){var e=o.stamp(t);return this._layers[e]?(this._loaded&&t.onRemove(this),delete this._layers[e],this._loaded&&this.fire("layerremove",{layer:t}),this._zoomBoundLayers[e]&&(delete this._zoomBoundLayers[e],this._updateZoomLevels()),this.options.zoomAnimation&&o.TileLayer&&t instanceof o.TileLayer&&(this._tileLayersNum--,this._tileLayersToLoad--,t.off("load",this._onTileLayerLoad,this)),this):this},hasLayer:function(t){return t?o.stamp(t)in this._layers:!1},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},invalidateSize:function(t){if(!this._loaded)return this;t=o.extend({animate:!1,pan:!0},t===!0?{animate:!0}:t);var e=this.getSize();this._sizeChanged=!0,this._initialCenter=null;var i=this.getSize(),n=e.divideBy(2).round(),r=i.divideBy(2).round(),s=n.subtract(r);return s.x||s.y?(t.animate&&t.pan?this.panBy(s):(t.pan&&this._rawPanBy(s),this.fire("move"),t.debounceMoveend?(clearTimeout(this._sizeTimer),this._sizeTimer=setTimeout(o.bind(this.fire,this,"moveend"),200)):this.fire("moveend")),this.fire("resize",{oldSize:e,newSize:i})):this},addHandler:function(t,e){if(!e)return this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},remove:function(){this._loaded&&this.fire("unload"),this._initEvents("off");try{delete this._container._leaflet}catch(t){this._container._leaflet=i}return this._clearPanes(),this._clearControlPos&&this._clearControlPos(),this._clearHandlers(),this},getCenter:function(){return this._checkIfLoaded(),this._initialCenter&&!this._moved()?this._initialCenter:this.layerPointToLatLng(this._getCenterLayerPoint())},getZoom:function(){return this._zoom},getBounds:function(){var t=this.getPixelBounds(),e=this.unproject(t.getBottomLeft()),i=this.unproject(t.getTopRight());return new o.LatLngBounds(e,i)},getMinZoom:function(){return this.options.minZoom===i?this._layersMinZoom===i?0:this._layersMinZoom:this.options.minZoom},getMaxZoom:function(){return this.options.maxZoom===i?this._layersMaxZoom===i?1/0:this._layersMaxZoom:this.options.maxZoom},getBoundsZoom:function(t,e,i){t=o.latLngBounds(t);var n,r=this.getMinZoom()-(e?1:0),s=this.getMaxZoom(),a=this.getSize(),l=t.getNorthWest(),h=t.getSouthEast(),u=!0;i=o.point(i||[0,0]);do r++,n=this.project(h,r).subtract(this.project(l,r)).add(i),u=e?n.x<a.x||n.y<a.y:a.contains(n);while(u&&s>=r);return u&&e?null:e?r:r-1},getSize:function(){return(!this._size||this._sizeChanged)&&(this._size=new o.Point(this._container.clientWidth,this._container.clientHeight),this._sizeChanged=!1),this._size.clone()},getPixelBounds:function(){var t=this._getTopLeftPoint();return new o.Bounds(t,t.add(this.getSize()))},getPixelOrigin:function(){return this._checkIfLoaded(),this._initialTopLeftPoint},getPanes:function(){return this._panes},getContainer:function(){return this._container},getZoomScale:function(t){var e=this.options.crs;return e.scale(t)/e.scale(this._zoom)},getScaleZoom:function(t){return this._zoom+Math.log(t)/Math.LN2},project:function(t,e){return e=e===i?this._zoom:e,this.options.crs.latLngToPoint(o.latLng(t),e)},unproject:function(t,e){return e=e===i?this._zoom:e,this.options.crs.pointToLatLng(o.point(t),e)},layerPointToLatLng:function(t){var e=o.point(t).add(this.getPixelOrigin());return this.unproject(e)},latLngToLayerPoint:function(t){var e=this.project(o.latLng(t))._round();return e._subtract(this.getPixelOrigin())},containerPointToLayerPoint:function(t){return o.point(t).subtract(this._getMapPanePos())},layerPointToContainerPoint:function(t){return o.point(t).add(this._getMapPanePos())},containerPointToLatLng:function(t){var e=this.containerPointToLayerPoint(o.point(t));return this.layerPointToLatLng(e)},latLngToContainerPoint:function(t){return this.layerPointToContainerPoint(this.latLngToLayerPoint(o.latLng(t)))},mouseEventToContainerPoint:function(t){return o.DomEvent.getMousePosition(t,this._container)},mouseEventToLayerPoint:function(t){return this.containerPointToLayerPoint(this.mouseEventToContainerPoint(t))},mouseEventToLatLng:function(t){return this.layerPointToLatLng(this.mouseEventToLayerPoint(t))},_initContainer:function(t){var e=this._container=o.DomUtil.get(t);if(!e)throw new Error("Map container not found.");if(e._leaflet)throw new Error("Map container is already initialized.");e._leaflet=!0},_initLayout:function(){var t=this._container;o.DomUtil.addClass(t,"leaflet-container"+(o.Browser.touch?" leaflet-touch":"")+(o.Browser.retina?" leaflet-retina":"")+(o.Browser.ielt9?" leaflet-oldie":"")+(this.options.fadeAnimation?" leaflet-fade-anim":""));var e=o.DomUtil.getStyle(t,"position");"absolute"!==e&&"relative"!==e&&"fixed"!==e&&(t.style.position="relative"),this._initPanes(),this._initControlPos&&this._initControlPos()},_initPanes:function(){var t=this._panes={};this._mapPane=t.mapPane=this._createPane("leaflet-map-pane",this._container),this._tilePane=t.tilePane=this._createPane("leaflet-tile-pane",this._mapPane),t.objectsPane=this._createPane("leaflet-objects-pane",this._mapPane),t.shadowPane=this._createPane("leaflet-shadow-pane"),t.overlayPane=this._createPane("leaflet-overlay-pane"),t.markerPane=this._createPane("leaflet-marker-pane"),t.popupPane=this._createPane("leaflet-popup-pane");var e=" leaflet-zoom-hide";this.options.markerZoomAnimation||(o.DomUtil.addClass(t.markerPane,e),o.DomUtil.addClass(t.shadowPane,e),o.DomUtil.addClass(t.popupPane,e))},_createPane:function(t,e){return o.DomUtil.create("div",t,e||this._panes.objectsPane)},_clearPanes:function(){this._container.removeChild(this._mapPane)},_addLayers:function(t){t=t?o.Util.isArray(t)?t:[t]:[];for(var e=0,i=t.length;i>e;e++)this.addLayer(t[e])},_resetView:function(t,e,i,n){var r=this._zoom!==e;n||(this.fire("movestart"),r&&this.fire("zoomstart")),this._zoom=e,this._initialCenter=t,this._initialTopLeftPoint=this._getNewTopLeftPoint(t),i?this._initialTopLeftPoint._add(this._getMapPanePos()):o.DomUtil.setPosition(this._mapPane,new o.Point(0,0)),this._tileLayersToLoad=this._tileLayersNum;var s=!this._loaded;this._loaded=!0,this.fire("viewreset",{hard:!i}),s&&(this.fire("load"),this.eachLayer(this._layerAdd,this)),this.fire("move"),(r||n)&&this.fire("zoomend"),this.fire("moveend",{hard:!i})},_rawPanBy:function(t){o.DomUtil.setPosition(this._mapPane,this._getMapPanePos().subtract(t))},_getZoomSpan:function(){return this.getMaxZoom()-this.getMinZoom()},_updateZoomLevels:function(){var t,e=1/0,n=-1/0,o=this._getZoomSpan();for(t in this._zoomBoundLayers){var r=this._zoomBoundLayers[t];isNaN(r.options.minZoom)||(e=Math.min(e,r.options.minZoom)),isNaN(r.options.maxZoom)||(n=Math.max(n,r.options.maxZoom))}t===i?this._layersMaxZoom=this._layersMinZoom=i:(this._layersMaxZoom=n,this._layersMinZoom=e),o!==this._getZoomSpan()&&this.fire("zoomlevelschange")},_panInsideMaxBounds:function(){this.panInsideBounds(this.options.maxBounds)},_checkIfLoaded:function(){if(!this._loaded)throw new Error("Set map center and zoom first.")},_initEvents:function(e){if(o.DomEvent){e=e||"on",o.DomEvent[e](this._container,"click",this._onMouseClick,this);var i,n,r=["dblclick","mousedown","mouseup","mouseenter","mouseleave","mousemove","contextmenu"];for(i=0,n=r.length;n>i;i++)o.DomEvent[e](this._container,r[i],this._fireMouseEvent,this);this.options.trackResize&&o.DomEvent[e](t,"resize",this._onResize,this)}},_onResize:function(){o.Util.cancelAnimFrame(this._resizeRequest),this._resizeRequest=o.Util.requestAnimFrame(function(){this.invalidateSize({debounceMoveend:!0})},this,!1,this._container)},_onMouseClick:function(t){!this._loaded||!t._simulated&&(this.dragging&&this.dragging.moved()||this.boxZoom&&this.boxZoom.moved())||o.DomEvent._skipped(t)||(this.fire("preclick"),this._fireMouseEvent(t))},_fireMouseEvent:function(t){if(this._loaded&&!o.DomEvent._skipped(t)){var e=t.type;if(e="mouseenter"===e?"mouseover":"mouseleave"===e?"mouseout":e,this.hasEventListeners(e)){"contextmenu"===e&&o.DomEvent.preventDefault(t);var i=this.mouseEventToContainerPoint(t),n=this.containerPointToLayerPoint(i),r=this.layerPointToLatLng(n);this.fire(e,{latlng:r,layerPoint:n,containerPoint:i,originalEvent:t})}}},_onTileLayerLoad:function(){this._tileLayersToLoad--,this._tileLayersNum&&!this._tileLayersToLoad&&this.fire("tilelayersload")},_clearHandlers:function(){for(var t=0,e=this._handlers.length;e>t;t++)this._handlers[t].disable()},whenReady:function(t,e){return this._loaded?t.call(e||this,this):this.on("load",t,e),this},_layerAdd:function(t){t.onAdd(this),this.fire("layeradd",{layer:t})},_getMapPanePos:function(){return o.DomUtil.getPosition(this._mapPane)},_moved:function(){var t=this._getMapPanePos();return t&&!t.equals([0,0])},_getTopLeftPoint:function(){return this.getPixelOrigin().subtract(this._getMapPanePos())},_getNewTopLeftPoint:function(t,e){var i=this.getSize()._divideBy(2);return this.project(t,e)._subtract(i)._round()},_latLngToNewLayerPoint:function(t,e,i){var n=this._getNewTopLeftPoint(i,e).add(this._getMapPanePos());return this.project(t,e)._subtract(n)},_getCenterLayerPoint:function(){return this.containerPointToLayerPoint(this.getSize()._divideBy(2))},_getCenterOffset:function(t){return this.latLngToLayerPoint(t).subtract(this._getCenterLayerPoint())},_limitCenter:function(t,e,i){if(!i)return t;var n=this.project(t,e),r=this.getSize().divideBy(2),s=new o.Bounds(n.subtract(r),n.add(r)),a=this._getBoundsOffset(s,i,e);return this.unproject(n.add(a),e)},_limitOffset:function(t,e){if(!e)return t;var i=this.getPixelBounds(),n=new o.Bounds(i.min.add(t),i.max.add(t));return t.add(this._getBoundsOffset(n,e))},_getBoundsOffset:function(t,e,i){var n=this.project(e.getNorthWest(),i).subtract(t.min),r=this.project(e.getSouthEast(),i).subtract(t.max),s=this._rebound(n.x,-r.x),a=this._rebound(n.y,-r.y);return new o.Point(s,a)},_rebound:function(t,e){return t+e>0?Math.round(t-e)/2:Math.max(0,Math.ceil(t))-Math.max(0,Math.floor(e))},_limitZoom:function(t){var e=this.getMinZoom(),i=this.getMaxZoom();return Math.max(e,Math.min(i,t))}}),o.map=function(t,e){return new o.Map(t,e)},o.Projection.Mercator={MAX_LATITUDE:85.0840591556,R_MINOR:6356752.314245179,R_MAJOR:6378137,project:function(t){var e=o.LatLng.DEG_TO_RAD,i=this.MAX_LATITUDE,n=Math.max(Math.min(i,t.lat),-i),r=this.R_MAJOR,s=this.R_MINOR,a=t.lng*e*r,l=n*e,h=s/r,u=Math.sqrt(1-h*h),c=u*Math.sin(l);c=Math.pow((1-c)/(1+c),.5*u);var d=Math.tan(.5*(.5*Math.PI-l))/c;return l=-r*Math.log(d),new o.Point(a,l)},unproject:function(t){for(var e,i=o.LatLng.RAD_TO_DEG,n=this.R_MAJOR,r=this.R_MINOR,s=t.x*i/n,a=r/n,l=Math.sqrt(1-a*a),h=Math.exp(-t.y/n),u=Math.PI/2-2*Math.atan(h),c=15,d=1e-7,p=c,m=.1;Math.abs(m)>d&&--p>0;)e=l*Math.sin(u),m=Math.PI/2-2*Math.atan(h*Math.pow((1-e)/(1+e),.5*l))-u,u+=m;return new o.LatLng(u*i,s)}},o.CRS.EPSG3395=o.extend({},o.CRS,{code:"EPSG:3395",projection:o.Projection.Mercator,transformation:function(){var t=o.Projection.Mercator,e=t.R_MAJOR,i=.5/(Math.PI*e);return new o.Transformation(i,.5,-i,.5)}()}),o.TileLayer=o.Class.extend({includes:o.Mixin.Events,options:{minZoom:0,maxZoom:18,tileSize:256,subdomains:"abc",errorTileUrl:"",attribution:"",zoomOffset:0,opacity:1,unloadInvisibleTiles:o.Browser.mobile,updateWhenIdle:o.Browser.mobile},initialize:function(t,e){e=o.setOptions(this,e),e.detectRetina&&o.Browser.retina&&e.maxZoom>0&&(e.tileSize=Math.floor(e.tileSize/2),e.zoomOffset++,e.minZoom>0&&e.minZoom--,this.options.maxZoom--),e.bounds&&(e.bounds=o.latLngBounds(e.bounds)),this._url=t;var i=this.options.subdomains;"string"==typeof i&&(this.options.subdomains=i.split(""))},onAdd:function(t){this._map=t,this._animated=t._zoomAnimated,this._initContainer(),t.on({viewreset:this._reset,moveend:this._update},this),this._animated&&t.on({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||(this._limitedUpdate=o.Util.limitExecByInterval(this._update,150,this),t.on("move",this._limitedUpdate,this)),this._reset(),this._update()},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){this._container.parentNode.removeChild(this._container),t.off({viewreset:this._reset,moveend:this._update},this),this._animated&&t.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||t.off("move",this._limitedUpdate,this),this._container=null,this._map=null},bringToFront:function(){var t=this._map._panes.tilePane;return this._container&&(t.appendChild(this._container),this._setAutoZIndex(t,Math.max)),this},bringToBack:function(){var t=this._map._panes.tilePane;return this._container&&(t.insertBefore(this._container,t.firstChild),this._setAutoZIndex(t,Math.min)),this},getAttribution:function(){return this.options.attribution},getContainer:function(){return this._container},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},setZIndex:function(t){return this.options.zIndex=t,this._updateZIndex(),this},setUrl:function(t,e){return this._url=t,e||this.redraw(),this},redraw:function(){return this._map&&(this._reset({hard:!0}),this._update()),this},_updateZIndex:function(){this._container&&this.options.zIndex!==i&&(this._container.style.zIndex=this.options.zIndex)},_setAutoZIndex:function(t,e){var i,n,o,r=t.children,s=-e(1/0,-1/0);for(n=0,o=r.length;o>n;n++)r[n]!==this._container&&(i=parseInt(r[n].style.zIndex,10),isNaN(i)||(s=e(s,i)));this.options.zIndex=this._container.style.zIndex=(isFinite(s)?s:0)+e(1,-1)},_updateOpacity:function(){var t,e=this._tiles;if(o.Browser.ielt9)for(t in e)o.DomUtil.setOpacity(e[t],this.options.opacity);else o.DomUtil.setOpacity(this._container,this.options.opacity)},_initContainer:function(){var t=this._map._panes.tilePane;if(!this._container){if(this._container=o.DomUtil.create("div","leaflet-layer"),this._updateZIndex(),this._animated){var e="leaflet-tile-container";this._bgBuffer=o.DomUtil.create("div",e,this._container),this._tileContainer=o.DomUtil.create("div",e,this._container)}else this._tileContainer=this._container;t.appendChild(this._container),this.options.opacity<1&&this._updateOpacity()}},_reset:function(t){for(var e in this._tiles)this.fire("tileunload",{tile:this._tiles[e]});this._tiles={},this._tilesToLoad=0,this.options.reuseTiles&&(this._unusedTiles=[]),this._tileContainer.innerHTML="",this._animated&&t&&t.hard&&this._clearBgBuffer(),this._initContainer()},_getTileSize:function(){var t=this._map,e=t.getZoom()+this.options.zoomOffset,i=this.options.maxNativeZoom,n=this.options.tileSize;return i&&e>i&&(n=Math.round(t.getZoomScale(e)/t.getZoomScale(i)*n)),n},_update:function(){if(this._map){var t=this._map,e=t.getPixelBounds(),i=t.getZoom(),n=this._getTileSize();if(!(i>this.options.maxZoom||i<this.options.minZoom)){var r=o.bounds(e.min.divideBy(n)._floor(),e.max.divideBy(n)._floor());this._addTilesFromCenterOut(r),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(r)}}},_addTilesFromCenterOut:function(t){var i,n,r,s=[],a=t.getCenter();for(i=t.min.y;i<=t.max.y;i++)for(n=t.min.x;n<=t.max.x;n++)r=new o.Point(n,i),this._tileShouldBeLoaded(r)&&s.push(r);var l=s.length;if(0!==l){s.sort(function(t,e){return t.distanceTo(a)-e.distanceTo(a)});var h=e.createDocumentFragment();for(this._tilesToLoad||this.fire("loading"),this._tilesToLoad+=l,n=0;l>n;n++)this._addTile(s[n],h);this._tileContainer.appendChild(h)}},_tileShouldBeLoaded:function(t){if(t.x+":"+t.y in this._tiles)return!1;var e=this.options;if(!e.continuousWorld){var i=this._getWrapTileNum();if(e.noWrap&&(t.x<0||t.x>=i.x)||t.y<0||t.y>=i.y)return!1}if(e.bounds){var n=this._getTileSize(),o=t.multiplyBy(n),r=o.add([n,n]),s=this._map.unproject(o),a=this._map.unproject(r);if(e.continuousWorld||e.noWrap||(s=s.wrap(),a=a.wrap()),!e.bounds.intersects([s,a]))return!1}return!0},_removeOtherTiles:function(t){var e,i,n,o;for(o in this._tiles)e=o.split(":"),i=parseInt(e[0],10),n=parseInt(e[1],10),(i<t.min.x||i>t.max.x||n<t.min.y||n>t.max.y)&&this._removeTile(o)},_removeTile:function(t){var e=this._tiles[t];this.fire("tileunload",{tile:e,url:e.src}),this.options.reuseTiles?(o.DomUtil.removeClass(e,"leaflet-tile-loaded"),this._unusedTiles.push(e)):e.parentNode===this._tileContainer&&this._tileContainer.removeChild(e),o.Browser.android||(e.onload=null,e.src=o.Util.emptyImageUrl),delete this._tiles[t]},_addTile:function(t,e){var i=this._getTilePos(t),n=this._getTile();o.DomUtil.setPosition(n,i,o.Browser.chrome),this._tiles[t.x+":"+t.y]=n,this._loadTile(n,t),n.parentNode!==this._tileContainer&&e.appendChild(n)},_getZoomForUrl:function(){var t=this.options,e=this._map.getZoom();return t.zoomReverse&&(e=t.maxZoom-e),e+=t.zoomOffset,t.maxNativeZoom?Math.min(e,t.maxNativeZoom):e},_getTilePos:function(t){var e=this._map.getPixelOrigin(),i=this._getTileSize();return t.multiplyBy(i).subtract(e)},getTileUrl:function(t){return o.Util.template(this._url,o.extend({s:this._getSubdomain(t),z:t.z,x:t.x,y:t.y},this.options))},_getWrapTileNum:function(){var t=this._map.options.crs,e=t.getSize(this._map.getZoom());return e.divideBy(this._getTileSize())._floor()},_adjustTilePoint:function(t){var e=this._getWrapTileNum();this.options.continuousWorld||this.options.noWrap||(t.x=(t.x%e.x+e.x)%e.x),this.options.tms&&(t.y=e.y-t.y-1),t.z=this._getZoomForUrl()},_getSubdomain:function(t){var e=Math.abs(t.x+t.y)%this.options.subdomains.length;return this.options.subdomains[e]},_getTile:function(){if(this.options.reuseTiles&&this._unusedTiles.length>0){var t=this._unusedTiles.pop();return this._resetTile(t),t}return this._createTile()},_resetTile:function(){},_createTile:function(){var t=o.DomUtil.create("img","leaflet-tile");return t.style.width=t.style.height=this._getTileSize()+"px",t.galleryimg="no",t.onselectstart=t.onmousemove=o.Util.falseFn,o.Browser.ielt9&&this.options.opacity!==i&&o.DomUtil.setOpacity(t,this.options.opacity),o.Browser.mobileWebkit3d&&(t.style.WebkitBackfaceVisibility="hidden"),t},_loadTile:function(t,e){t._layer=this,t.onload=this._tileOnLoad,t.onerror=this._tileOnError,this._adjustTilePoint(e),t.src=this.getTileUrl(e),this.fire("tileloadstart",{tile:t,url:t.src})},_tileLoaded:function(){this._tilesToLoad--,this._animated&&o.DomUtil.addClass(this._tileContainer,"leaflet-zoom-animated"),this._tilesToLoad||(this.fire("load"),this._animated&&(clearTimeout(this._clearBgBufferTimer),this._clearBgBufferTimer=setTimeout(o.bind(this._clearBgBuffer,this),500)))},_tileOnLoad:function(){var t=this._layer;this.src!==o.Util.emptyImageUrl&&(o.DomUtil.addClass(this,"leaflet-tile-loaded"),t.fire("tileload",{tile:this,url:this.src})),t._tileLoaded()},_tileOnError:function(){var t=this._layer;t.fire("tileerror",{tile:this,url:this.src});var e=t.options.errorTileUrl;e&&(this.src=e),t._tileLoaded()}}),o.tileLayer=function(t,e){return new o.TileLayer(t,e)},o.TileLayer.WMS=o.TileLayer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},initialize:function(t,e){this._url=t;var i=o.extend({},this.defaultWmsParams),n=e.tileSize||this.options.tileSize;i.width=i.height=e.detectRetina&&o.Browser.retina?2*n:n;for(var r in e)this.options.hasOwnProperty(r)||"crs"===r||(i[r]=e[r]);this.wmsParams=i,o.setOptions(this,e)},onAdd:function(t){this._crs=this.options.crs||t.options.crs,this._wmsVersion=parseFloat(this.wmsParams.version);var e=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[e]=this._crs.code,o.TileLayer.prototype.onAdd.call(this,t)},getTileUrl:function(t){var e=this._map,i=this.options.tileSize,n=t.multiplyBy(i),r=n.add([i,i]),s=this._crs.project(e.unproject(n,t.z)),a=this._crs.project(e.unproject(r,t.z)),l=this._wmsVersion>=1.3&&this._crs===o.CRS.EPSG4326?[a.y,s.x,s.y,a.x].join(","):[s.x,a.y,a.x,s.y].join(","),h=o.Util.template(this._url,{s:this._getSubdomain(t)});return h+o.Util.getParamString(this.wmsParams,h,!0)+"&BBOX="+l},setParams:function(t,e){return o.extend(this.wmsParams,t),e||this.redraw(),this}}),o.tileLayer.wms=function(t,e){return new o.TileLayer.WMS(t,e)},o.TileLayer.Canvas=o.TileLayer.extend({options:{async:!1},initialize:function(t){o.setOptions(this,t)},redraw:function(){this._map&&(this._reset({hard:!0}),this._update());for(var t in this._tiles)this._redrawTile(this._tiles[t]);return this},_redrawTile:function(t){this.drawTile(t,t._tilePoint,this._map._zoom)},_createTile:function(){var t=o.DomUtil.create("canvas","leaflet-tile");return t.width=t.height=this.options.tileSize,t.onselectstart=t.onmousemove=o.Util.falseFn,t},_loadTile:function(t,e){t._layer=this,t._tilePoint=e,this._redrawTile(t),this.options.async||this.tileDrawn(t)},drawTile:function(){},tileDrawn:function(t){this._tileOnLoad.call(t)}}),o.tileLayer.canvas=function(t){return new o.TileLayer.Canvas(t)},o.ImageOverlay=o.Class.extend({includes:o.Mixin.Events,options:{opacity:1},initialize:function(t,e,i){this._url=t,this._bounds=o.latLngBounds(e),o.setOptions(this,i)},onAdd:function(t){this._map=t,this._image||this._initImage(),t._panes.overlayPane.appendChild(this._image),t.on("viewreset",this._reset,this),t.options.zoomAnimation&&o.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._image),t.off("viewreset",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},setOpacity:function(t){return this.options.opacity=t,this._updateOpacity(),this},bringToFront:function(){return this._image&&this._map._panes.overlayPane.appendChild(this._image),this},bringToBack:function(){var t=this._map._panes.overlayPane;return this._image&&t.insertBefore(this._image,t.firstChild),this},setUrl:function(t){this._url=t,this._image.src=this._url},getAttribution:function(){return this.options.attribution},_initImage:function(){this._image=o.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&o.Browser.any3d?o.DomUtil.addClass(this._image,"leaflet-zoom-animated"):o.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),o.extend(this._image,{galleryimg:"no",onselectstart:o.Util.falseFn,onmousemove:o.Util.falseFn,onload:o.bind(this._onImageLoad,this),src:this._url})},_animateZoom:function(t){var e=this._map,i=this._image,n=e.getZoomScale(t.zoom),r=this._bounds.getNorthWest(),s=this._bounds.getSouthEast(),a=e._latLngToNewLayerPoint(r,t.zoom,t.center),l=e._latLngToNewLayerPoint(s,t.zoom,t.center)._subtract(a),h=a._add(l._multiplyBy(.5*(1-1/n)));i.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(h)+" scale("+n+") "},_reset:function(){var t=this._image,e=this._map.latLngToLayerPoint(this._bounds.getNorthWest()),i=this._map.latLngToLayerPoint(this._bounds.getSouthEast())._subtract(e);o.DomUtil.setPosition(t,e),t.style.width=i.x+"px",t.style.height=i.y+"px"},_onImageLoad:function(){this.fire("load")},_updateOpacity:function(){o.DomUtil.setOpacity(this._image,this.options.opacity)}}),o.imageOverlay=function(t,e,i){return new o.ImageOverlay(t,e,i)},o.Icon=o.Class.extend({options:{className:""},initialize:function(t){o.setOptions(this,t)},createIcon:function(t){return this._createIcon("icon",t)},createShadow:function(t){return this._createIcon("shadow",t)},_createIcon:function(t,e){var i=this._getIconUrl(t);if(!i){if("icon"===t)throw new Error("iconUrl not set in Icon options (see the docs).");return null}var n;return n=e&&"IMG"===e.tagName?this._createImg(i,e):this._createImg(i),this._setIconStyles(n,t),n},_setIconStyles:function(t,e){var i,n=this.options,r=o.point(n[e+"Size"]);i="shadow"===e?o.point(n.shadowAnchor||n.iconAnchor):o.point(n.iconAnchor),!i&&r&&(i=r.divideBy(2,!0)),t.className="leaflet-marker-"+e+" "+n.className,i&&(t.style.marginLeft=-i.x+"px",t.style.marginTop=-i.y+"px"),r&&(t.style.width=r.x+"px",t.style.height=r.y+"px")},_createImg:function(t,i){return i=i||e.createElement("img"),i.src=t,i},_getIconUrl:function(t){return o.Browser.retina&&this.options[t+"RetinaUrl"]?this.options[t+"RetinaUrl"]:this.options[t+"Url"]}}),o.icon=function(t){return new o.Icon(t)},o.Icon.Default=o.Icon.extend({options:{iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]},_getIconUrl:function(t){var e=t+"Url";if(this.options[e])return this.options[e];o.Browser.retina&&"icon"===t&&(t+="-2x");var i=o.Icon.Default.imagePath;if(!i)throw new Error("Couldn't autodetect L.Icon.Default.imagePath, set it manually.");return i+"/marker-"+t+".png"}}),o.Icon.Default.imagePath=function(){var t,i,n,o,r,s=e.getElementsByTagName("script"),a=/[\/^]leaflet[\-\._]?([\w\-\._]*)\.js\??/;for(t=0,i=s.length;i>t;t++)if(n=s[t].src,o=n.match(a))return r=n.split(a)[0],(r?r+"/":"")+"images"}(),o.Marker=o.Class.extend({includes:o.Mixin.Events,options:{icon:new o.Icon.Default,title:"",alt:"",clickable:!0,draggable:!1,keyboard:!0,zIndexOffset:0,opacity:1,riseOnHover:!1,riseOffset:250},initialize:function(t,e){o.setOptions(this,e),this._latlng=o.latLng(t)},onAdd:function(t){this._map=t,t.on("viewreset",this.update,this),this._initIcon(),this.update(),this.fire("add"),t.options.zoomAnimation&&t.options.markerZoomAnimation&&t.on("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){this.dragging&&this.dragging.disable(),this._removeIcon(),this._removeShadow(),this.fire("remove"),t.off({viewreset:this.update,zoomanim:this._animateZoom},this),this._map=null},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=o.latLng(t),this.update(),this.fire("move",{latlng:this._latlng})},setZIndexOffset:function(t){return this.options.zIndexOffset=t,this.update(),this},setIcon:function(t){return this.options.icon=t,this._map&&(this._initIcon(),this.update()),this._popup&&this.bindPopup(this._popup),this},update:function(){return this._icon&&this._setPos(this._map.latLngToLayerPoint(this._latlng).round()),this},_initIcon:function(){var t=this.options,e=this._map,i=e.options.zoomAnimation&&e.options.markerZoomAnimation,n=i?"leaflet-zoom-animated":"leaflet-zoom-hide",r=t.icon.createIcon(this._icon),s=!1;r!==this._icon&&(this._icon&&this._removeIcon(),s=!0,t.title&&(r.title=t.title),t.alt&&(r.alt=t.alt)),o.DomUtil.addClass(r,n),t.keyboard&&(r.tabIndex="0"),this._icon=r,this._initInteraction(),t.riseOnHover&&o.DomEvent.on(r,"mouseover",this._bringToFront,this).on(r,"mouseout",this._resetZIndex,this);var a=t.icon.createShadow(this._shadow),l=!1;a!==this._shadow&&(this._removeShadow(),l=!0),a&&o.DomUtil.addClass(a,n),this._shadow=a,t.opacity<1&&this._updateOpacity();var h=this._map._panes;s&&h.markerPane.appendChild(this._icon),a&&l&&h.shadowPane.appendChild(this._shadow)},_removeIcon:function(){this.options.riseOnHover&&o.DomEvent.off(this._icon,"mouseover",this._bringToFront).off(this._icon,"mouseout",this._resetZIndex),this._map._panes.markerPane.removeChild(this._icon),this._icon=null},_removeShadow:function(){this._shadow&&this._map._panes.shadowPane.removeChild(this._shadow),this._shadow=null},_setPos:function(t){o.DomUtil.setPosition(this._icon,t),this._shadow&&o.DomUtil.setPosition(this._shadow,t),this._zIndex=t.y+this.options.zIndexOffset,this._resetZIndex()},_updateZIndex:function(t){this._icon.style.zIndex=this._zIndex+t},_animateZoom:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center).round();this._setPos(e)},_initInteraction:function(){if(this.options.clickable){var t=this._icon,e=["dblclick","mousedown","mouseover","mouseout","contextmenu"];o.DomUtil.addClass(t,"leaflet-clickable"),o.DomEvent.on(t,"click",this._onMouseClick,this),o.DomEvent.on(t,"keypress",this._onKeyPress,this);for(var i=0;i<e.length;i++)o.DomEvent.on(t,e[i],this._fireMouseEvent,this);o.Handler.MarkerDrag&&(this.dragging=new o.Handler.MarkerDrag(this),this.options.draggable&&this.dragging.enable())}},_onMouseClick:function(t){var e=this.dragging&&this.dragging.moved();(this.hasEventListeners(t.type)||e)&&o.DomEvent.stopPropagation(t),e||(this.dragging&&this.dragging._enabled||!this._map.dragging||!this._map.dragging.moved())&&this.fire(t.type,{originalEvent:t,latlng:this._latlng})},_onKeyPress:function(t){13===t.keyCode&&this.fire("click",{originalEvent:t,latlng:this._latlng})},_fireMouseEvent:function(t){this.fire(t.type,{originalEvent:t,latlng:this._latlng}),"contextmenu"===t.type&&this.hasEventListeners(t.type)&&o.DomEvent.preventDefault(t),"mousedown"!==t.type?o.DomEvent.stopPropagation(t):o.DomEvent.preventDefault(t)},setOpacity:function(t){return this.options.opacity=t,this._map&&this._updateOpacity(),this},_updateOpacity:function(){o.DomUtil.setOpacity(this._icon,this.options.opacity),this._shadow&&o.DomUtil.setOpacity(this._shadow,this.options.opacity)},_bringToFront:function(){this._updateZIndex(this.options.riseOffset)},_resetZIndex:function(){this._updateZIndex(0)}}),o.marker=function(t,e){return new o.Marker(t,e)},o.DivIcon=o.Icon.extend({options:{iconSize:[12,12],className:"leaflet-div-icon",html:!1},createIcon:function(t){var i=t&&"DIV"===t.tagName?t:e.createElement("div"),n=this.options;return i.innerHTML=n.html!==!1?n.html:"",n.bgPos&&(i.style.backgroundPosition=-n.bgPos.x+"px "+-n.bgPos.y+"px"),this._setIconStyles(i,"icon"),i},createShadow:function(){return null}}),o.divIcon=function(t){return new o.DivIcon(t)},o.Map.mergeOptions({closePopupOnClick:!0}),o.Popup=o.Class.extend({includes:o.Mixin.Events,options:{minWidth:50,maxWidth:300,autoPan:!0,closeButton:!0,offset:[0,7],autoPanPadding:[5,5],keepInView:!1,className:"",zoomAnimation:!0},initialize:function(t,e){o.setOptions(this,t),this._source=e,this._animated=o.Browser.any3d&&this.options.zoomAnimation,this._isOpen=!1},onAdd:function(t){this._map=t,this._container||this._initLayout();var e=t.options.fadeAnimation;e&&o.DomUtil.setOpacity(this._container,0),t._panes.popupPane.appendChild(this._container),t.on(this._getEvents(),this),this.update(),e&&o.DomUtil.setOpacity(this._container,1),this.fire("open"),t.fire("popupopen",{popup:this}),this._source&&this._source.fire("popupopen",{popup:this})},addTo:function(t){return t.addLayer(this),this},openOn:function(t){return t.openPopup(this),this},onRemove:function(t){t._panes.popupPane.removeChild(this._container),o.Util.falseFn(this._container.offsetWidth),t.off(this._getEvents(),this),t.options.fadeAnimation&&o.DomUtil.setOpacity(this._container,0),this._map=null,this.fire("close"),t.fire("popupclose",{popup:this}),this._source&&this._source.fire("popupclose",{popup:this})
},getLatLng:function(){return this._latlng},setLatLng:function(t){return this._latlng=o.latLng(t),this._map&&(this._updatePosition(),this._adjustPan()),this},getContent:function(){return this._content},setContent:function(t){return this._content=t,this.update(),this},update:function(){this._map&&(this._container.style.visibility="hidden",this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",this._adjustPan())},_getEvents:function(){var t={viewreset:this._updatePosition};return this._animated&&(t.zoomanim=this._zoomAnimation),("closeOnClick"in this.options?this.options.closeOnClick:this._map.options.closePopupOnClick)&&(t.preclick=this._close),this.options.keepInView&&(t.moveend=this._adjustPan),t},_close:function(){this._map&&this._map.closePopup(this)},_initLayout:function(){var t,e="leaflet-popup",i=e+" "+this.options.className+" leaflet-zoom-"+(this._animated?"animated":"hide"),n=this._container=o.DomUtil.create("div",i);this.options.closeButton&&(t=this._closeButton=o.DomUtil.create("a",e+"-close-button",n),t.href="#close",t.innerHTML="&#215;",o.DomEvent.disableClickPropagation(t),o.DomEvent.on(t,"click",this._onCloseButtonClick,this));var r=this._wrapper=o.DomUtil.create("div",e+"-content-wrapper",n);o.DomEvent.disableClickPropagation(r),this._contentNode=o.DomUtil.create("div",e+"-content",r),o.DomEvent.disableScrollPropagation(this._contentNode),o.DomEvent.on(r,"contextmenu",o.DomEvent.stopPropagation),this._tipContainer=o.DomUtil.create("div",e+"-tip-container",n),this._tip=o.DomUtil.create("div",e+"-tip",this._tipContainer)},_updateContent:function(){if(this._content){if("string"==typeof this._content)this._contentNode.innerHTML=this._content;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(this._content)}this.fire("contentupdate")}},_updateLayout:function(){var t=this._contentNode,e=t.style;e.width="",e.whiteSpace="nowrap";var i=t.offsetWidth;i=Math.min(i,this.options.maxWidth),i=Math.max(i,this.options.minWidth),e.width=i+1+"px",e.whiteSpace="",e.height="";var n=t.offsetHeight,r=this.options.maxHeight,s="leaflet-popup-scrolled";r&&n>r?(e.height=r+"px",o.DomUtil.addClass(t,s)):o.DomUtil.removeClass(t,s),this._containerWidth=this._container.offsetWidth},_updatePosition:function(){if(this._map){var t=this._map.latLngToLayerPoint(this._latlng),e=this._animated,i=o.point(this.options.offset);e&&o.DomUtil.setPosition(this._container,t),this._containerBottom=-i.y-(e?0:t.y),this._containerLeft=-Math.round(this._containerWidth/2)+i.x+(e?0:t.x),this._container.style.bottom=this._containerBottom+"px",this._container.style.left=this._containerLeft+"px"}},_zoomAnimation:function(t){var e=this._map._latLngToNewLayerPoint(this._latlng,t.zoom,t.center);o.DomUtil.setPosition(this._container,e)},_adjustPan:function(){if(this.options.autoPan){var t=this._map,e=this._container.offsetHeight,i=this._containerWidth,n=new o.Point(this._containerLeft,-e-this._containerBottom);this._animated&&n._add(o.DomUtil.getPosition(this._container));var r=t.layerPointToContainerPoint(n),s=o.point(this.options.autoPanPadding),a=o.point(this.options.autoPanPaddingTopLeft||s),l=o.point(this.options.autoPanPaddingBottomRight||s),h=t.getSize(),u=0,c=0;r.x+i+l.x>h.x&&(u=r.x+i-h.x+l.x),r.x-u-a.x<0&&(u=r.x-a.x),r.y+e+l.y>h.y&&(c=r.y+e-h.y+l.y),r.y-c-a.y<0&&(c=r.y-a.y),(u||c)&&t.fire("autopanstart").panBy([u,c])}},_onCloseButtonClick:function(t){this._close(),o.DomEvent.stop(t)}}),o.popup=function(t,e){return new o.Popup(t,e)},o.Map.include({openPopup:function(t,e,i){if(this.closePopup(),!(t instanceof o.Popup)){var n=t;t=new o.Popup(i).setLatLng(e).setContent(n)}return t._isOpen=!0,this._popup=t,this.addLayer(t)},closePopup:function(t){return t&&t!==this._popup||(t=this._popup,this._popup=null),t&&(this.removeLayer(t),t._isOpen=!1),this}}),o.Marker.include({openPopup:function(){return this._popup&&this._map&&!this._map.hasLayer(this._popup)&&(this._popup.setLatLng(this._latlng),this._map.openPopup(this._popup)),this},closePopup:function(){return this._popup&&this._popup._close(),this},togglePopup:function(){return this._popup&&(this._popup._isOpen?this.closePopup():this.openPopup()),this},bindPopup:function(t,e){var i=o.point(this.options.icon.options.popupAnchor||[0,0]);return i=i.add(o.Popup.prototype.options.offset),e&&e.offset&&(i=i.add(e.offset)),e=o.extend({offset:i},e),this._popupHandlersAdded||(this.on("click",this.togglePopup,this).on("remove",this.closePopup,this).on("move",this._movePopup,this),this._popupHandlersAdded=!0),t instanceof o.Popup?(o.setOptions(t,e),this._popup=t,t._source=this):this._popup=new o.Popup(e,this).setContent(t),this},setPopupContent:function(t){return this._popup&&this._popup.setContent(t),this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this.togglePopup,this).off("remove",this.closePopup,this).off("move",this._movePopup,this),this._popupHandlersAdded=!1),this},getPopup:function(){return this._popup},_movePopup:function(t){this._popup.setLatLng(t.latlng)}}),o.LayerGroup=o.Class.extend({initialize:function(t){this._layers={};var e,i;if(t)for(e=0,i=t.length;i>e;e++)this.addLayer(t[e])},addLayer:function(t){var e=this.getLayerId(t);return this._layers[e]=t,this._map&&this._map.addLayer(t),this},removeLayer:function(t){var e=t in this._layers?t:this.getLayerId(t);return this._map&&this._layers[e]&&this._map.removeLayer(this._layers[e]),delete this._layers[e],this},hasLayer:function(t){return t?t in this._layers||this.getLayerId(t)in this._layers:!1},clearLayers:function(){return this.eachLayer(this.removeLayer,this),this},invoke:function(t){var e,i,n=Array.prototype.slice.call(arguments,1);for(e in this._layers)i=this._layers[e],i[t]&&i[t].apply(i,n);return this},onAdd:function(t){this._map=t,this.eachLayer(t.addLayer,t)},onRemove:function(t){this.eachLayer(t.removeLayer,t),this._map=null},addTo:function(t){return t.addLayer(this),this},eachLayer:function(t,e){for(var i in this._layers)t.call(e,this._layers[i]);return this},getLayer:function(t){return this._layers[t]},getLayers:function(){var t=[];for(var e in this._layers)t.push(this._layers[e]);return t},setZIndex:function(t){return this.invoke("setZIndex",t)},getLayerId:function(t){return o.stamp(t)}}),o.layerGroup=function(t){return new o.LayerGroup(t)},o.FeatureGroup=o.LayerGroup.extend({includes:o.Mixin.Events,statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose"},addLayer:function(t){return this.hasLayer(t)?this:("on"in t&&t.on(o.FeatureGroup.EVENTS,this._propagateEvent,this),o.LayerGroup.prototype.addLayer.call(this,t),this._popupContent&&t.bindPopup&&t.bindPopup(this._popupContent,this._popupOptions),this.fire("layeradd",{layer:t}))},removeLayer:function(t){return this.hasLayer(t)?(t in this._layers&&(t=this._layers[t]),"off"in t&&t.off(o.FeatureGroup.EVENTS,this._propagateEvent,this),o.LayerGroup.prototype.removeLayer.call(this,t),this._popupContent&&this.invoke("unbindPopup"),this.fire("layerremove",{layer:t})):this},bindPopup:function(t,e){return this._popupContent=t,this._popupOptions=e,this.invoke("bindPopup",t,e)},openPopup:function(t){for(var e in this._layers){this._layers[e].openPopup(t);break}return this},setStyle:function(t){return this.invoke("setStyle",t)},bringToFront:function(){return this.invoke("bringToFront")},bringToBack:function(){return this.invoke("bringToBack")},getBounds:function(){var t=new o.LatLngBounds;return this.eachLayer(function(e){t.extend(e instanceof o.Marker?e.getLatLng():e.getBounds())}),t},_propagateEvent:function(t){t=o.extend({layer:t.target,target:this},t),this.fire(t.type,t)}}),o.featureGroup=function(t){return new o.FeatureGroup(t)},o.Path=o.Class.extend({includes:[o.Mixin.Events],statics:{CLIP_PADDING:function(){var e=o.Browser.mobile?1280:2e3,i=(e/Math.max(t.outerWidth,t.outerHeight)-1)/2;return Math.max(0,Math.min(.5,i))}()},options:{stroke:!0,color:"#0033ff",dashArray:null,lineCap:null,lineJoin:null,weight:5,opacity:.5,fill:!1,fillColor:null,fillOpacity:.2,clickable:!0},initialize:function(t){o.setOptions(this,t)},onAdd:function(t){this._map=t,this._container||(this._initElements(),this._initEvents()),this.projectLatlngs(),this._updatePath(),this._container&&this._map._pathRoot.appendChild(this._container),this.fire("add"),t.on({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},addTo:function(t){return t.addLayer(this),this},onRemove:function(t){t._pathRoot.removeChild(this._container),this.fire("remove"),this._map=null,o.Browser.vml&&(this._container=null,this._stroke=null,this._fill=null),t.off({viewreset:this.projectLatlngs,moveend:this._updatePath},this)},projectLatlngs:function(){},setStyle:function(t){return o.setOptions(this,t),this._container&&this._updateStyle(),this},redraw:function(){return this._map&&(this.projectLatlngs(),this._updatePath()),this}}),o.Map.include({_updatePathViewport:function(){var t=o.Path.CLIP_PADDING,e=this.getSize(),i=o.DomUtil.getPosition(this._mapPane),n=i.multiplyBy(-1)._subtract(e.multiplyBy(t)._round()),r=n.add(e.multiplyBy(1+2*t)._round());this._pathViewport=new o.Bounds(n,r)}}),o.Path.SVG_NS="http://www.w3.org/2000/svg",o.Browser.svg=!(!e.createElementNS||!e.createElementNS(o.Path.SVG_NS,"svg").createSVGRect),o.Path=o.Path.extend({statics:{SVG:o.Browser.svg},bringToFront:function(){var t=this._map._pathRoot,e=this._container;return e&&t.lastChild!==e&&t.appendChild(e),this},bringToBack:function(){var t=this._map._pathRoot,e=this._container,i=t.firstChild;return e&&i!==e&&t.insertBefore(e,i),this},getPathString:function(){},_createElement:function(t){return e.createElementNS(o.Path.SVG_NS,t)},_initElements:function(){this._map._initPathRoot(),this._initPath(),this._initStyle()},_initPath:function(){this._container=this._createElement("g"),this._path=this._createElement("path"),this.options.className&&o.DomUtil.addClass(this._path,this.options.className),this._container.appendChild(this._path)},_initStyle:function(){this.options.stroke&&(this._path.setAttribute("stroke-linejoin","round"),this._path.setAttribute("stroke-linecap","round")),this.options.fill&&this._path.setAttribute("fill-rule","evenodd"),this.options.pointerEvents&&this._path.setAttribute("pointer-events",this.options.pointerEvents),this.options.clickable||this.options.pointerEvents||this._path.setAttribute("pointer-events","none"),this._updateStyle()},_updateStyle:function(){this.options.stroke?(this._path.setAttribute("stroke",this.options.color),this._path.setAttribute("stroke-opacity",this.options.opacity),this._path.setAttribute("stroke-width",this.options.weight),this.options.dashArray?this._path.setAttribute("stroke-dasharray",this.options.dashArray):this._path.removeAttribute("stroke-dasharray"),this.options.lineCap&&this._path.setAttribute("stroke-linecap",this.options.lineCap),this.options.lineJoin&&this._path.setAttribute("stroke-linejoin",this.options.lineJoin)):this._path.setAttribute("stroke","none"),this.options.fill?(this._path.setAttribute("fill",this.options.fillColor||this.options.color),this._path.setAttribute("fill-opacity",this.options.fillOpacity)):this._path.setAttribute("fill","none")},_updatePath:function(){var t=this.getPathString();t||(t="M0 0"),this._path.setAttribute("d",t)},_initEvents:function(){if(this.options.clickable){(o.Browser.svg||!o.Browser.vml)&&o.DomUtil.addClass(this._path,"leaflet-clickable"),o.DomEvent.on(this._container,"click",this._onMouseClick,this);for(var t=["dblclick","mousedown","mouseover","mouseout","mousemove","contextmenu"],e=0;e<t.length;e++)o.DomEvent.on(this._container,t[e],this._fireMouseEvent,this)}},_onMouseClick:function(t){this._map.dragging&&this._map.dragging.moved()||this._fireMouseEvent(t)},_fireMouseEvent:function(t){if(this._map&&this.hasEventListeners(t.type)){var e=this._map,i=e.mouseEventToContainerPoint(t),n=e.containerPointToLayerPoint(i),r=e.layerPointToLatLng(n);this.fire(t.type,{latlng:r,layerPoint:n,containerPoint:i,originalEvent:t}),"contextmenu"===t.type&&o.DomEvent.preventDefault(t),"mousemove"!==t.type&&o.DomEvent.stopPropagation(t)}}}),o.Map.include({_initPathRoot:function(){this._pathRoot||(this._pathRoot=o.Path.prototype._createElement("svg"),this._panes.overlayPane.appendChild(this._pathRoot),this.options.zoomAnimation&&o.Browser.any3d?(o.DomUtil.addClass(this._pathRoot,"leaflet-zoom-animated"),this.on({zoomanim:this._animatePathZoom,zoomend:this._endPathZoom})):o.DomUtil.addClass(this._pathRoot,"leaflet-zoom-hide"),this.on("moveend",this._updateSvgViewport),this._updateSvgViewport())},_animatePathZoom:function(t){var e=this.getZoomScale(t.zoom),i=this._getCenterOffset(t.center)._multiplyBy(-e)._add(this._pathViewport.min);this._pathRoot.style[o.DomUtil.TRANSFORM]=o.DomUtil.getTranslateString(i)+" scale("+e+") ",this._pathZooming=!0},_endPathZoom:function(){this._pathZooming=!1},_updateSvgViewport:function(){if(!this._pathZooming){this._updatePathViewport();var t=this._pathViewport,e=t.min,i=t.max,n=i.x-e.x,r=i.y-e.y,s=this._pathRoot,a=this._panes.overlayPane;o.Browser.mobileWebkit&&a.removeChild(s),o.DomUtil.setPosition(s,e),s.setAttribute("width",n),s.setAttribute("height",r),s.setAttribute("viewBox",[e.x,e.y,n,r].join(" ")),o.Browser.mobileWebkit&&a.appendChild(s)}}}),o.Path.include({bindPopup:function(t,e){return t instanceof o.Popup?this._popup=t:((!this._popup||e)&&(this._popup=new o.Popup(e,this)),this._popup.setContent(t)),this._popupHandlersAdded||(this.on("click",this._openPopup,this).on("remove",this.closePopup,this),this._popupHandlersAdded=!0),this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openPopup).off("remove",this.closePopup),this._popupHandlersAdded=!1),this},openPopup:function(t){return this._popup&&(t=t||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],this._openPopup({latlng:t})),this},closePopup:function(){return this._popup&&this._popup._close(),this},_openPopup:function(t){this._popup.setLatLng(t.latlng),this._map.openPopup(this._popup)}}),o.Browser.vml=!o.Browser.svg&&function(){try{var t=e.createElement("div");t.innerHTML='<v:shape adj="1"/>';var i=t.firstChild;return i.style.behavior="url(#default#VML)",i&&"object"==typeof i.adj}catch(n){return!1}}(),o.Path=o.Browser.svg||!o.Browser.vml?o.Path:o.Path.extend({statics:{VML:!0,CLIP_PADDING:.02},_createElement:function(){try{return e.namespaces.add("lvml","urn:schemas-microsoft-com:vml"),function(t){return e.createElement("<lvml:"+t+' class="lvml">')}}catch(t){return function(t){return e.createElement("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="lvml">')}}}(),_initPath:function(){var t=this._container=this._createElement("shape");o.DomUtil.addClass(t,"leaflet-vml-shape"+(this.options.className?" "+this.options.className:"")),this.options.clickable&&o.DomUtil.addClass(t,"leaflet-clickable"),t.coordsize="1 1",this._path=this._createElement("path"),t.appendChild(this._path),this._map._pathRoot.appendChild(t)},_initStyle:function(){this._updateStyle()},_updateStyle:function(){var t=this._stroke,e=this._fill,i=this.options,n=this._container;n.stroked=i.stroke,n.filled=i.fill,i.stroke?(t||(t=this._stroke=this._createElement("stroke"),t.endcap="round",n.appendChild(t)),t.weight=i.weight+"px",t.color=i.color,t.opacity=i.opacity,t.dashStyle=i.dashArray?o.Util.isArray(i.dashArray)?i.dashArray.join(" "):i.dashArray.replace(/( *, *)/g," "):"",i.lineCap&&(t.endcap=i.lineCap.replace("butt","flat")),i.lineJoin&&(t.joinstyle=i.lineJoin)):t&&(n.removeChild(t),this._stroke=null),i.fill?(e||(e=this._fill=this._createElement("fill"),n.appendChild(e)),e.color=i.fillColor||i.color,e.opacity=i.fillOpacity):e&&(n.removeChild(e),this._fill=null)},_updatePath:function(){var t=this._container.style;t.display="none",this._path.v=this.getPathString()+" ",t.display=""}}),o.Map.include(o.Browser.svg||!o.Browser.vml?{}:{_initPathRoot:function(){if(!this._pathRoot){var t=this._pathRoot=e.createElement("div");t.className="leaflet-vml-container",this._panes.overlayPane.appendChild(t),this.on("moveend",this._updatePathViewport),this._updatePathViewport()}}}),o.Browser.canvas=function(){return!!e.createElement("canvas").getContext}(),o.Path=o.Path.SVG&&!t.L_PREFER_CANVAS||!o.Browser.canvas?o.Path:o.Path.extend({statics:{CANVAS:!0,SVG:!1},redraw:function(){return this._map&&(this.projectLatlngs(),this._requestUpdate()),this},setStyle:function(t){return o.setOptions(this,t),this._map&&(this._updateStyle(),this._requestUpdate()),this},onRemove:function(t){t.off("viewreset",this.projectLatlngs,this).off("moveend",this._updatePath,this),this.options.clickable&&(this._map.off("click",this._onClick,this),this._map.off("mousemove",this._onMouseMove,this)),this._requestUpdate(),this.fire("remove"),this._map=null},_requestUpdate:function(){this._map&&!o.Path._updateRequest&&(o.Path._updateRequest=o.Util.requestAnimFrame(this._fireMapMoveEnd,this._map))},_fireMapMoveEnd:function(){o.Path._updateRequest=null,this.fire("moveend")},_initElements:function(){this._map._initPathRoot(),this._ctx=this._map._canvasCtx},_updateStyle:function(){var t=this.options;t.stroke&&(this._ctx.lineWidth=t.weight,this._ctx.strokeStyle=t.color),t.fill&&(this._ctx.fillStyle=t.fillColor||t.color),t.lineCap&&(this._ctx.lineCap=t.lineCap),t.lineJoin&&(this._ctx.lineJoin=t.lineJoin)},_drawPath:function(){var t,e,i,n,r,s;for(this._ctx.beginPath(),t=0,i=this._parts.length;i>t;t++){for(e=0,n=this._parts[t].length;n>e;e++)r=this._parts[t][e],s=(0===e?"move":"line")+"To",this._ctx[s](r.x,r.y);this instanceof o.Polygon&&this._ctx.closePath()}},_checkIfEmpty:function(){return!this._parts.length},_updatePath:function(){if(!this._checkIfEmpty()){var t=this._ctx,e=this.options;this._drawPath(),t.save(),this._updateStyle(),e.fill&&(t.globalAlpha=e.fillOpacity,t.fill(e.fillRule||"evenodd")),e.stroke&&(t.globalAlpha=e.opacity,t.stroke()),t.restore()}},_initEvents:function(){this.options.clickable&&(this._map.on("mousemove",this._onMouseMove,this),this._map.on("click dblclick contextmenu",this._fireMouseEvent,this))},_fireMouseEvent:function(t){this._containsPoint(t.layerPoint)&&this.fire(t.type,t)},_onMouseMove:function(t){this._map&&!this._map._animatingZoom&&(this._containsPoint(t.layerPoint)?(this._ctx.canvas.style.cursor="pointer",this._mouseInside=!0,this.fire("mouseover",t)):this._mouseInside&&(this._ctx.canvas.style.cursor="",this._mouseInside=!1,this.fire("mouseout",t)))}}),o.Map.include(o.Path.SVG&&!t.L_PREFER_CANVAS||!o.Browser.canvas?{}:{_initPathRoot:function(){var t,i=this._pathRoot;i||(i=this._pathRoot=e.createElement("canvas"),i.style.position="absolute",t=this._canvasCtx=i.getContext("2d"),t.lineCap="round",t.lineJoin="round",this._panes.overlayPane.appendChild(i),this.options.zoomAnimation&&(this._pathRoot.className="leaflet-zoom-animated",this.on("zoomanim",this._animatePathZoom),this.on("zoomend",this._endPathZoom)),this.on("moveend",this._updateCanvasViewport),this._updateCanvasViewport())},_updateCanvasViewport:function(){if(!this._pathZooming){this._updatePathViewport();var t=this._pathViewport,e=t.min,i=t.max.subtract(e),n=this._pathRoot;o.DomUtil.setPosition(n,e),n.width=i.x,n.height=i.y,n.getContext("2d").translate(-e.x,-e.y)}}}),o.LineUtil={simplify:function(t,e){if(!e||!t.length)return t.slice();var i=e*e;return t=this._reducePoints(t,i),t=this._simplifyDP(t,i)},pointToSegmentDistance:function(t,e,i){return Math.sqrt(this._sqClosestPointOnSegment(t,e,i,!0))},closestPointOnSegment:function(t,e,i){return this._sqClosestPointOnSegment(t,e,i)},_simplifyDP:function(t,e){var n=t.length,o=typeof Uint8Array!=i+""?Uint8Array:Array,r=new o(n);r[0]=r[n-1]=1,this._simplifyDPStep(t,r,e,0,n-1);var s,a=[];for(s=0;n>s;s++)r[s]&&a.push(t[s]);return a},_simplifyDPStep:function(t,e,i,n,o){var r,s,a,l=0;for(s=n+1;o-1>=s;s++)a=this._sqClosestPointOnSegment(t[s],t[n],t[o],!0),a>l&&(r=s,l=a);l>i&&(e[r]=1,this._simplifyDPStep(t,e,i,n,r),this._simplifyDPStep(t,e,i,r,o))},_reducePoints:function(t,e){for(var i=[t[0]],n=1,o=0,r=t.length;r>n;n++)this._sqDist(t[n],t[o])>e&&(i.push(t[n]),o=n);return r-1>o&&i.push(t[r-1]),i},clipSegment:function(t,e,i,n){var o,r,s,a=n?this._lastCode:this._getBitCode(t,i),l=this._getBitCode(e,i);for(this._lastCode=l;;){if(!(a|l))return[t,e];if(a&l)return!1;o=a||l,r=this._getEdgeIntersection(t,e,o,i),s=this._getBitCode(r,i),o===a?(t=r,a=s):(e=r,l=s)}},_getEdgeIntersection:function(t,e,i,n){var r=e.x-t.x,s=e.y-t.y,a=n.min,l=n.max;return 8&i?new o.Point(t.x+r*(l.y-t.y)/s,l.y):4&i?new o.Point(t.x+r*(a.y-t.y)/s,a.y):2&i?new o.Point(l.x,t.y+s*(l.x-t.x)/r):1&i?new o.Point(a.x,t.y+s*(a.x-t.x)/r):void 0},_getBitCode:function(t,e){var i=0;return t.x<e.min.x?i|=1:t.x>e.max.x&&(i|=2),t.y<e.min.y?i|=4:t.y>e.max.y&&(i|=8),i},_sqDist:function(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n},_sqClosestPointOnSegment:function(t,e,i,n){var r,s=e.x,a=e.y,l=i.x-s,h=i.y-a,u=l*l+h*h;return u>0&&(r=((t.x-s)*l+(t.y-a)*h)/u,r>1?(s=i.x,a=i.y):r>0&&(s+=l*r,a+=h*r)),l=t.x-s,h=t.y-a,n?l*l+h*h:new o.Point(s,a)}},o.Polyline=o.Path.extend({initialize:function(t,e){o.Path.prototype.initialize.call(this,e),this._latlngs=this._convertLatLngs(t)},options:{smoothFactor:1,noClip:!1},projectLatlngs:function(){this._originalPoints=[];for(var t=0,e=this._latlngs.length;e>t;t++)this._originalPoints[t]=this._map.latLngToLayerPoint(this._latlngs[t])},getPathString:function(){for(var t=0,e=this._parts.length,i="";e>t;t++)i+=this._getPathPartStr(this._parts[t]);return i},getLatLngs:function(){return this._latlngs},setLatLngs:function(t){return this._latlngs=this._convertLatLngs(t),this.redraw()},addLatLng:function(t){return this._latlngs.push(o.latLng(t)),this.redraw()},spliceLatLngs:function(){var t=[].splice.apply(this._latlngs,arguments);return this._convertLatLngs(this._latlngs,!0),this.redraw(),t},closestLayerPoint:function(t){for(var e,i,n=1/0,r=this._parts,s=null,a=0,l=r.length;l>a;a++)for(var h=r[a],u=1,c=h.length;c>u;u++){e=h[u-1],i=h[u];var d=o.LineUtil._sqClosestPointOnSegment(t,e,i,!0);n>d&&(n=d,s=o.LineUtil._sqClosestPointOnSegment(t,e,i))}return s&&(s.distance=Math.sqrt(n)),s},getBounds:function(){return new o.LatLngBounds(this.getLatLngs())},_convertLatLngs:function(t,e){var i,n,r=e?t:[];for(i=0,n=t.length;n>i;i++){if(o.Util.isArray(t[i])&&"number"!=typeof t[i][0])return;r[i]=o.latLng(t[i])}return r},_initEvents:function(){o.Path.prototype._initEvents.call(this)},_getPathPartStr:function(t){for(var e,i=o.Path.VML,n=0,r=t.length,s="";r>n;n++)e=t[n],i&&e._round(),s+=(n?"L":"M")+e.x+" "+e.y;return s},_clipPoints:function(){var t,e,i,n=this._originalPoints,r=n.length;if(this.options.noClip)return this._parts=[n],void 0;this._parts=[];var s=this._parts,a=this._map._pathViewport,l=o.LineUtil;for(t=0,e=0;r-1>t;t++)i=l.clipSegment(n[t],n[t+1],a,t),i&&(s[e]=s[e]||[],s[e].push(i[0]),(i[1]!==n[t+1]||t===r-2)&&(s[e].push(i[1]),e++))},_simplifyPoints:function(){for(var t=this._parts,e=o.LineUtil,i=0,n=t.length;n>i;i++)t[i]=e.simplify(t[i],this.options.smoothFactor)},_updatePath:function(){this._map&&(this._clipPoints(),this._simplifyPoints(),o.Path.prototype._updatePath.call(this))}}),o.polyline=function(t,e){return new o.Polyline(t,e)},o.PolyUtil={},o.PolyUtil.clipPolygon=function(t,e){var i,n,r,s,a,l,h,u,c,d=[1,4,2,8],p=o.LineUtil;for(n=0,h=t.length;h>n;n++)t[n]._code=p._getBitCode(t[n],e);for(s=0;4>s;s++){for(u=d[s],i=[],n=0,h=t.length,r=h-1;h>n;r=n++)a=t[n],l=t[r],a._code&u?l._code&u||(c=p._getEdgeIntersection(l,a,u,e),c._code=p._getBitCode(c,e),i.push(c)):(l._code&u&&(c=p._getEdgeIntersection(l,a,u,e),c._code=p._getBitCode(c,e),i.push(c)),i.push(a));t=i}return t},o.Polygon=o.Polyline.extend({options:{fill:!0},initialize:function(t,e){o.Polyline.prototype.initialize.call(this,t,e),this._initWithHoles(t)},_initWithHoles:function(t){var e,i,n;if(t&&o.Util.isArray(t[0])&&"number"!=typeof t[0][0])for(this._latlngs=this._convertLatLngs(t[0]),this._holes=t.slice(1),e=0,i=this._holes.length;i>e;e++)n=this._holes[e]=this._convertLatLngs(this._holes[e]),n[0].equals(n[n.length-1])&&n.pop();t=this._latlngs,t.length>=2&&t[0].equals(t[t.length-1])&&t.pop()},projectLatlngs:function(){if(o.Polyline.prototype.projectLatlngs.call(this),this._holePoints=[],this._holes){var t,e,i,n;for(t=0,i=this._holes.length;i>t;t++)for(this._holePoints[t]=[],e=0,n=this._holes[t].length;n>e;e++)this._holePoints[t][e]=this._map.latLngToLayerPoint(this._holes[t][e])}},setLatLngs:function(t){return t&&o.Util.isArray(t[0])&&"number"!=typeof t[0][0]?(this._initWithHoles(t),this.redraw()):o.Polyline.prototype.setLatLngs.call(this,t)},_clipPoints:function(){var t=this._originalPoints,e=[];if(this._parts=[t].concat(this._holePoints),!this.options.noClip){for(var i=0,n=this._parts.length;n>i;i++){var r=o.PolyUtil.clipPolygon(this._parts[i],this._map._pathViewport);r.length&&e.push(r)}this._parts=e}},_getPathPartStr:function(t){var e=o.Polyline.prototype._getPathPartStr.call(this,t);return e+(o.Browser.svg?"z":"x")}}),o.polygon=function(t,e){return new o.Polygon(t,e)},function(){function t(t){return o.FeatureGroup.extend({initialize:function(t,e){this._layers={},this._options=e,this.setLatLngs(t)},setLatLngs:function(e){var i=0,n=e.length;for(this.eachLayer(function(t){n>i?t.setLatLngs(e[i++]):this.removeLayer(t)},this);n>i;)this.addLayer(new t(e[i++],this._options));return this},getLatLngs:function(){var t=[];return this.eachLayer(function(e){t.push(e.getLatLngs())}),t}})}o.MultiPolyline=t(o.Polyline),o.MultiPolygon=t(o.Polygon),o.multiPolyline=function(t,e){return new o.MultiPolyline(t,e)},o.multiPolygon=function(t,e){return new o.MultiPolygon(t,e)}}(),o.Rectangle=o.Polygon.extend({initialize:function(t,e){o.Polygon.prototype.initialize.call(this,this._boundsToLatLngs(t),e)},setBounds:function(t){this.setLatLngs(this._boundsToLatLngs(t))},_boundsToLatLngs:function(t){return t=o.latLngBounds(t),[t.getSouthWest(),t.getNorthWest(),t.getNorthEast(),t.getSouthEast()]}}),o.rectangle=function(t,e){return new o.Rectangle(t,e)},o.Circle=o.Path.extend({initialize:function(t,e,i){o.Path.prototype.initialize.call(this,i),this._latlng=o.latLng(t),this._mRadius=e},options:{fill:!0},setLatLng:function(t){return this._latlng=o.latLng(t),this.redraw()},setRadius:function(t){return this._mRadius=t,this.redraw()},projectLatlngs:function(){var t=this._getLngRadius(),e=this._latlng,i=this._map.latLngToLayerPoint([e.lat,e.lng-t]);this._point=this._map.latLngToLayerPoint(e),this._radius=Math.max(this._point.x-i.x,1)},getBounds:function(){var t=this._getLngRadius(),e=360*(this._mRadius/40075017),i=this._latlng;return new o.LatLngBounds([i.lat-e,i.lng-t],[i.lat+e,i.lng+t])},getLatLng:function(){return this._latlng},getPathString:function(){var t=this._point,e=this._radius;return this._checkIfEmpty()?"":o.Browser.svg?"M"+t.x+","+(t.y-e)+"A"+e+","+e+",0,1,1,"+(t.x-.1)+","+(t.y-e)+" z":(t._round(),e=Math.round(e),"AL "+t.x+","+t.y+" "+e+","+e+" 0,"+23592600)},getRadius:function(){return this._mRadius},_getLatRadius:function(){return 360*(this._mRadius/40075017)},_getLngRadius:function(){return this._getLatRadius()/Math.cos(o.LatLng.DEG_TO_RAD*this._latlng.lat)},_checkIfEmpty:function(){if(!this._map)return!1;var t=this._map._pathViewport,e=this._radius,i=this._point;return i.x-e>t.max.x||i.y-e>t.max.y||i.x+e<t.min.x||i.y+e<t.min.y}}),o.circle=function(t,e,i){return new o.Circle(t,e,i)},o.CircleMarker=o.Circle.extend({options:{radius:10,weight:2},initialize:function(t,e){o.Circle.prototype.initialize.call(this,t,null,e),this._radius=this.options.radius},projectLatlngs:function(){this._point=this._map.latLngToLayerPoint(this._latlng)},_updateStyle:function(){o.Circle.prototype._updateStyle.call(this),this.setRadius(this.options.radius)},setLatLng:function(t){return o.Circle.prototype.setLatLng.call(this,t),this._popup&&this._popup._isOpen&&this._popup.setLatLng(t),this},setRadius:function(t){return this.options.radius=this._radius=t,this.redraw()},getRadius:function(){return this._radius}}),o.circleMarker=function(t,e){return new o.CircleMarker(t,e)},o.Polyline.include(o.Path.CANVAS?{_containsPoint:function(t,e){var i,n,r,s,a,l,h,u=this.options.weight/2;for(o.Browser.touch&&(u+=10),i=0,s=this._parts.length;s>i;i++)for(h=this._parts[i],n=0,a=h.length,r=a-1;a>n;r=n++)if((e||0!==n)&&(l=o.LineUtil.pointToSegmentDistance(t,h[r],h[n]),u>=l))return!0;return!1}}:{}),o.Polygon.include(o.Path.CANVAS?{_containsPoint:function(t){var e,i,n,r,s,a,l,h,u=!1;if(o.Polyline.prototype._containsPoint.call(this,t,!0))return!0;for(r=0,l=this._parts.length;l>r;r++)for(e=this._parts[r],s=0,h=e.length,a=h-1;h>s;a=s++)i=e[s],n=e[a],i.y>t.y!=n.y>t.y&&t.x<(n.x-i.x)*(t.y-i.y)/(n.y-i.y)+i.x&&(u=!u);return u}}:{}),o.Circle.include(o.Path.CANVAS?{_drawPath:function(){var t=this._point;this._ctx.beginPath(),this._ctx.arc(t.x,t.y,this._radius,0,2*Math.PI,!1)},_containsPoint:function(t){var e=this._point,i=this.options.stroke?this.options.weight/2:0;return t.distanceTo(e)<=this._radius+i}}:{}),o.CircleMarker.include(o.Path.CANVAS?{_updateStyle:function(){o.Path.prototype._updateStyle.call(this)}}:{}),o.GeoJSON=o.FeatureGroup.extend({initialize:function(t,e){o.setOptions(this,e),this._layers={},t&&this.addData(t)},addData:function(t){var e,i,n,r=o.Util.isArray(t)?t:t.features;if(r){for(e=0,i=r.length;i>e;e++)n=r[e],(n.geometries||n.geometry||n.features||n.coordinates)&&this.addData(r[e]);return this}var s=this.options;if(!s.filter||s.filter(t)){var a=o.GeoJSON.geometryToLayer(t,s.pointToLayer,s.coordsToLatLng,s);return a.feature=o.GeoJSON.asFeature(t),a.defaultOptions=a.options,this.resetStyle(a),s.onEachFeature&&s.onEachFeature(t,a),this.addLayer(a)}},resetStyle:function(t){var e=this.options.style;e&&(o.Util.extend(t.options,t.defaultOptions),this._setLayerStyle(t,e))},setStyle:function(t){this.eachLayer(function(e){this._setLayerStyle(e,t)},this)},_setLayerStyle:function(t,e){"function"==typeof e&&(e=e(t.feature)),t.setStyle&&t.setStyle(e)}}),o.extend(o.GeoJSON,{geometryToLayer:function(t,e,i,n){var r,s,a,l,h="Feature"===t.type?t.geometry:t,u=h.coordinates,c=[];switch(i=i||this.coordsToLatLng,h.type){case"Point":return r=i(u),e?e(t,r):new o.Marker(r);case"MultiPoint":for(a=0,l=u.length;l>a;a++)r=i(u[a]),c.push(e?e(t,r):new o.Marker(r));return new o.FeatureGroup(c);case"LineString":return s=this.coordsToLatLngs(u,0,i),new o.Polyline(s,n);case"Polygon":if(2===u.length&&!u[1].length)throw new Error("Invalid GeoJSON object.");return s=this.coordsToLatLngs(u,1,i),new o.Polygon(s,n);case"MultiLineString":return s=this.coordsToLatLngs(u,1,i),new o.MultiPolyline(s,n);case"MultiPolygon":return s=this.coordsToLatLngs(u,2,i),new o.MultiPolygon(s,n);case"GeometryCollection":for(a=0,l=h.geometries.length;l>a;a++)c.push(this.geometryToLayer({geometry:h.geometries[a],type:"Feature",properties:t.properties},e,i,n));return new o.FeatureGroup(c);default:throw new Error("Invalid GeoJSON object.")}},coordsToLatLng:function(t){return new o.LatLng(t[1],t[0],t[2])},coordsToLatLngs:function(t,e,i){var n,o,r,s=[];for(o=0,r=t.length;r>o;o++)n=e?this.coordsToLatLngs(t[o],e-1,i):(i||this.coordsToLatLng)(t[o]),s.push(n);return s},latLngToCoords:function(t){var e=[t.lng,t.lat];return t.alt!==i&&e.push(t.alt),e},latLngsToCoords:function(t){for(var e=[],i=0,n=t.length;n>i;i++)e.push(o.GeoJSON.latLngToCoords(t[i]));return e},getFeature:function(t,e){return t.feature?o.extend({},t.feature,{geometry:e}):o.GeoJSON.asFeature(e)},asFeature:function(t){return"Feature"===t.type?t:{type:"Feature",properties:{},geometry:t}}});var s={toGeoJSON:function(){return o.GeoJSON.getFeature(this,{type:"Point",coordinates:o.GeoJSON.latLngToCoords(this.getLatLng())})}};o.Marker.include(s),o.Circle.include(s),o.CircleMarker.include(s),o.Polyline.include({toGeoJSON:function(){return o.GeoJSON.getFeature(this,{type:"LineString",coordinates:o.GeoJSON.latLngsToCoords(this.getLatLngs())})}}),o.Polygon.include({toGeoJSON:function(){var t,e,i,n=[o.GeoJSON.latLngsToCoords(this.getLatLngs())];if(n[0].push(n[0][0]),this._holes)for(t=0,e=this._holes.length;e>t;t++)i=o.GeoJSON.latLngsToCoords(this._holes[t]),i.push(i[0]),n.push(i);
return o.GeoJSON.getFeature(this,{type:"Polygon",coordinates:n})}}),function(){function t(t){return function(){var e=[];return this.eachLayer(function(t){e.push(t.toGeoJSON().geometry.coordinates)}),o.GeoJSON.getFeature(this,{type:t,coordinates:e})}}o.MultiPolyline.include({toGeoJSON:t("MultiLineString")}),o.MultiPolygon.include({toGeoJSON:t("MultiPolygon")}),o.LayerGroup.include({toGeoJSON:function(){var e,i=this.feature&&this.feature.geometry,n=[];if(i&&"MultiPoint"===i.type)return t("MultiPoint").call(this);var r=i&&"GeometryCollection"===i.type;return this.eachLayer(function(t){t.toGeoJSON&&(e=t.toGeoJSON(),n.push(r?e.geometry:o.GeoJSON.asFeature(e)))}),r?o.GeoJSON.getFeature(this,{geometries:n,type:"GeometryCollection"}):{type:"FeatureCollection",features:n}}})}(),o.geoJson=function(t,e){return new o.GeoJSON(t,e)},o.DomEvent={addListener:function(t,e,i,n){var r,s,a,l=o.stamp(i),h="_leaflet_"+e+l;return t[h]?this:(r=function(e){return i.call(n||t,e||o.DomEvent._getEvent())},o.Browser.pointer&&0===e.indexOf("touch")?this.addPointerListener(t,e,r,l):(o.Browser.touch&&"dblclick"===e&&this.addDoubleTapListener&&this.addDoubleTapListener(t,r,l),"addEventListener"in t?"mousewheel"===e?(t.addEventListener("DOMMouseScroll",r,!1),t.addEventListener(e,r,!1)):"mouseenter"===e||"mouseleave"===e?(s=r,a="mouseenter"===e?"mouseover":"mouseout",r=function(e){return o.DomEvent._checkMouse(t,e)?s(e):void 0},t.addEventListener(a,r,!1)):"click"===e&&o.Browser.android?(s=r,r=function(t){return o.DomEvent._filterClick(t,s)},t.addEventListener(e,r,!1)):t.addEventListener(e,r,!1):"attachEvent"in t&&t.attachEvent("on"+e,r),t[h]=r,this))},removeListener:function(t,e,i){var n=o.stamp(i),r="_leaflet_"+e+n,s=t[r];return s?(o.Browser.pointer&&0===e.indexOf("touch")?this.removePointerListener(t,e,n):o.Browser.touch&&"dblclick"===e&&this.removeDoubleTapListener?this.removeDoubleTapListener(t,n):"removeEventListener"in t?"mousewheel"===e?(t.removeEventListener("DOMMouseScroll",s,!1),t.removeEventListener(e,s,!1)):"mouseenter"===e||"mouseleave"===e?t.removeEventListener("mouseenter"===e?"mouseover":"mouseout",s,!1):t.removeEventListener(e,s,!1):"detachEvent"in t&&t.detachEvent("on"+e,s),t[r]=null,this):this},stopPropagation:function(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,o.DomEvent._skipped(t),this},disableScrollPropagation:function(t){var e=o.DomEvent.stopPropagation;return o.DomEvent.on(t,"mousewheel",e).on(t,"MozMousePixelScroll",e)},disableClickPropagation:function(t){for(var e=o.DomEvent.stopPropagation,i=o.Draggable.START.length-1;i>=0;i--)o.DomEvent.on(t,o.Draggable.START[i],e);return o.DomEvent.on(t,"click",o.DomEvent._fakeStop).on(t,"dblclick",e)},preventDefault:function(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this},stop:function(t){return o.DomEvent.preventDefault(t).stopPropagation(t)},getMousePosition:function(t,e){if(!e)return new o.Point(t.clientX,t.clientY);var i=e.getBoundingClientRect();return new o.Point(t.clientX-i.left-e.clientLeft,t.clientY-i.top-e.clientTop)},getWheelDelta:function(t){var e=0;return t.wheelDelta&&(e=t.wheelDelta/120),t.detail&&(e=-t.detail/3),e},_skipEvents:{},_fakeStop:function(t){o.DomEvent._skipEvents[t.type]=!0},_skipped:function(t){var e=this._skipEvents[t.type];return this._skipEvents[t.type]=!1,e},_checkMouse:function(t,e){var i=e.relatedTarget;if(!i)return!0;try{for(;i&&i!==t;)i=i.parentNode}catch(n){return!1}return i!==t},_getEvent:function(){var e=t.event;if(!e)for(var i=arguments.callee.caller;i&&(e=i.arguments[0],!e||t.Event!==e.constructor);)i=i.caller;return e},_filterClick:function(t,e){var i=t.timeStamp||t.originalEvent.timeStamp,n=o.DomEvent._lastClick&&i-o.DomEvent._lastClick;return n&&n>100&&500>n||t.target._simulatedClick&&!t._simulated?(o.DomEvent.stop(t),void 0):(o.DomEvent._lastClick=i,e(t))}},o.DomEvent.on=o.DomEvent.addListener,o.DomEvent.off=o.DomEvent.removeListener,o.Draggable=o.Class.extend({includes:o.Mixin.Events,statics:{START:o.Browser.touch?["touchstart","mousedown"]:["mousedown"],END:{mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},MOVE:{mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"}},initialize:function(t,e){this._element=t,this._dragStartTarget=e||t},enable:function(){if(!this._enabled){for(var t=o.Draggable.START.length-1;t>=0;t--)o.DomEvent.on(this._dragStartTarget,o.Draggable.START[t],this._onDown,this);this._enabled=!0}},disable:function(){if(this._enabled){for(var t=o.Draggable.START.length-1;t>=0;t--)o.DomEvent.off(this._dragStartTarget,o.Draggable.START[t],this._onDown,this);this._enabled=!1,this._moved=!1}},_onDown:function(t){if(this._moved=!1,!(t.shiftKey||1!==t.which&&1!==t.button&&!t.touches||(o.DomEvent.stopPropagation(t),o.Draggable._disabled||(o.DomUtil.disableImageDrag(),o.DomUtil.disableTextSelection(),this._moving)))){var i=t.touches?t.touches[0]:t;this._startPoint=new o.Point(i.clientX,i.clientY),this._startPos=this._newPos=o.DomUtil.getPosition(this._element),o.DomEvent.on(e,o.Draggable.MOVE[t.type],this._onMove,this).on(e,o.Draggable.END[t.type],this._onUp,this)}},_onMove:function(t){if(t.touches&&t.touches.length>1)return this._moved=!0,void 0;var i=t.touches&&1===t.touches.length?t.touches[0]:t,n=new o.Point(i.clientX,i.clientY),r=n.subtract(this._startPoint);(r.x||r.y)&&(o.Browser.touch&&Math.abs(r.x)+Math.abs(r.y)<3||(o.DomEvent.preventDefault(t),this._moved||(this.fire("dragstart"),this._moved=!0,this._startPos=o.DomUtil.getPosition(this._element).subtract(r),o.DomUtil.addClass(e.body,"leaflet-dragging"),this._lastTarget=t.target||t.srcElement,o.DomUtil.addClass(this._lastTarget,"leaflet-drag-target")),this._newPos=this._startPos.add(r),this._moving=!0,o.Util.cancelAnimFrame(this._animRequest),this._animRequest=o.Util.requestAnimFrame(this._updatePosition,this,!0,this._dragStartTarget)))},_updatePosition:function(){this.fire("predrag"),o.DomUtil.setPosition(this._element,this._newPos),this.fire("drag")},_onUp:function(){o.DomUtil.removeClass(e.body,"leaflet-dragging"),this._lastTarget&&(o.DomUtil.removeClass(this._lastTarget,"leaflet-drag-target"),this._lastTarget=null);for(var t in o.Draggable.MOVE)o.DomEvent.off(e,o.Draggable.MOVE[t],this._onMove).off(e,o.Draggable.END[t],this._onUp);o.DomUtil.enableImageDrag(),o.DomUtil.enableTextSelection(),this._moved&&this._moving&&(o.Util.cancelAnimFrame(this._animRequest),this.fire("dragend",{distance:this._newPos.distanceTo(this._startPos)})),this._moving=!1}}),o.Handler=o.Class.extend({initialize:function(t){this._map=t},enable:function(){this._enabled||(this._enabled=!0,this.addHooks())},disable:function(){this._enabled&&(this._enabled=!1,this.removeHooks())},enabled:function(){return!!this._enabled}}),o.Map.mergeOptions({dragging:!0,inertia:!o.Browser.android23,inertiaDeceleration:3400,inertiaMaxSpeed:1/0,inertiaThreshold:o.Browser.touch?32:18,easeLinearity:.25,worldCopyJump:!1}),o.Map.Drag=o.Handler.extend({addHooks:function(){if(!this._draggable){var t=this._map;this._draggable=new o.Draggable(t._mapPane,t._container),this._draggable.on({dragstart:this._onDragStart,drag:this._onDrag,dragend:this._onDragEnd},this),t.options.worldCopyJump&&(this._draggable.on("predrag",this._onPreDrag,this),t.on("viewreset",this._onViewReset,this),t.whenReady(this._onViewReset,this))}this._draggable.enable()},removeHooks:function(){this._draggable.disable()},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(){var t=this._map;t._panAnim&&t._panAnim.stop(),t.fire("movestart").fire("dragstart"),t.options.inertia&&(this._positions=[],this._times=[])},_onDrag:function(){if(this._map.options.inertia){var t=this._lastTime=+new Date,e=this._lastPos=this._draggable._newPos;this._positions.push(e),this._times.push(t),t-this._times[0]>200&&(this._positions.shift(),this._times.shift())}this._map.fire("move").fire("drag")},_onViewReset:function(){var t=this._map.getSize()._divideBy(2),e=this._map.latLngToLayerPoint([0,0]);this._initialWorldOffset=e.subtract(t).x,this._worldWidth=this._map.project([0,180]).x},_onPreDrag:function(){var t=this._worldWidth,e=Math.round(t/2),i=this._initialWorldOffset,n=this._draggable._newPos.x,o=(n-e+i)%t+e-i,r=(n+e+i)%t-e-i,s=Math.abs(o+i)<Math.abs(r+i)?o:r;this._draggable._newPos.x=s},_onDragEnd:function(t){var e=this._map,i=e.options,n=+new Date-this._lastTime,r=!i.inertia||n>i.inertiaThreshold||!this._positions[0];if(e.fire("dragend",t),r)e.fire("moveend");else{var s=this._lastPos.subtract(this._positions[0]),a=(this._lastTime+n-this._times[0])/1e3,l=i.easeLinearity,h=s.multiplyBy(l/a),u=h.distanceTo([0,0]),c=Math.min(i.inertiaMaxSpeed,u),d=h.multiplyBy(c/u),p=c/(i.inertiaDeceleration*l),m=d.multiplyBy(-p/2).round();m.x&&m.y?(m=e._limitOffset(m,e.options.maxBounds),o.Util.requestAnimFrame(function(){e.panBy(m,{duration:p,easeLinearity:l,noMoveStart:!0})})):e.fire("moveend")}}}),o.Map.addInitHook("addHandler","dragging",o.Map.Drag),o.Map.mergeOptions({doubleClickZoom:!0}),o.Map.DoubleClickZoom=o.Handler.extend({addHooks:function(){this._map.on("dblclick",this._onDoubleClick,this)},removeHooks:function(){this._map.off("dblclick",this._onDoubleClick,this)},_onDoubleClick:function(t){var e=this._map,i=e.getZoom()+(t.originalEvent.shiftKey?-1:1);"center"===e.options.doubleClickZoom?e.setZoom(i):e.setZoomAround(t.containerPoint,i)}}),o.Map.addInitHook("addHandler","doubleClickZoom",o.Map.DoubleClickZoom),o.Map.mergeOptions({scrollWheelZoom:!0}),o.Map.ScrollWheelZoom=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"mousewheel",this._onWheelScroll,this),o.DomEvent.on(this._map._container,"MozMousePixelScroll",o.DomEvent.preventDefault),this._delta=0},removeHooks:function(){o.DomEvent.off(this._map._container,"mousewheel",this._onWheelScroll),o.DomEvent.off(this._map._container,"MozMousePixelScroll",o.DomEvent.preventDefault)},_onWheelScroll:function(t){var e=o.DomEvent.getWheelDelta(t);this._delta+=e,this._lastMousePos=this._map.mouseEventToContainerPoint(t),this._startTime||(this._startTime=+new Date);var i=Math.max(40-(+new Date-this._startTime),0);clearTimeout(this._timer),this._timer=setTimeout(o.bind(this._performZoom,this),i),o.DomEvent.preventDefault(t),o.DomEvent.stopPropagation(t)},_performZoom:function(){var t=this._map,e=this._delta,i=t.getZoom();e=e>0?Math.ceil(e):Math.floor(e),e=Math.max(Math.min(e,4),-4),e=t._limitZoom(i+e)-i,this._delta=0,this._startTime=null,e&&("center"===t.options.scrollWheelZoom?t.setZoom(i+e):t.setZoomAround(this._lastMousePos,i+e))}}),o.Map.addInitHook("addHandler","scrollWheelZoom",o.Map.ScrollWheelZoom),o.extend(o.DomEvent,{_touchstart:o.Browser.msPointer?"MSPointerDown":o.Browser.pointer?"pointerdown":"touchstart",_touchend:o.Browser.msPointer?"MSPointerUp":o.Browser.pointer?"pointerup":"touchend",addDoubleTapListener:function(t,i,n){function r(t){var e;if(o.Browser.pointer?(m.push(t.pointerId),e=m.length):e=t.touches.length,!(e>1)){var i=Date.now(),n=i-(a||i);l=t.touches?t.touches[0]:t,h=n>0&&u>=n,a=i}}function s(t){if(o.Browser.pointer){var e=m.indexOf(t.pointerId);if(-1===e)return;m.splice(e,1)}if(h){if(o.Browser.pointer){var n,r={};for(var s in l)n=l[s],r[s]="function"==typeof n?n.bind(l):n;l=r}l.type="dblclick",i(l),a=null}}var a,l,h=!1,u=250,c="_leaflet_",d=this._touchstart,p=this._touchend,m=[];t[c+d+n]=r,t[c+p+n]=s;var f=o.Browser.pointer?e.documentElement:t;return t.addEventListener(d,r,!1),f.addEventListener(p,s,!1),o.Browser.pointer&&f.addEventListener(o.DomEvent.POINTER_CANCEL,s,!1),this},removeDoubleTapListener:function(t,i){var n="_leaflet_";return t.removeEventListener(this._touchstart,t[n+this._touchstart+i],!1),(o.Browser.pointer?e.documentElement:t).removeEventListener(this._touchend,t[n+this._touchend+i],!1),o.Browser.pointer&&e.documentElement.removeEventListener(o.DomEvent.POINTER_CANCEL,t[n+this._touchend+i],!1),this}}),o.extend(o.DomEvent,{POINTER_DOWN:o.Browser.msPointer?"MSPointerDown":"pointerdown",POINTER_MOVE:o.Browser.msPointer?"MSPointerMove":"pointermove",POINTER_UP:o.Browser.msPointer?"MSPointerUp":"pointerup",POINTER_CANCEL:o.Browser.msPointer?"MSPointerCancel":"pointercancel",_pointers:[],_pointerDocumentListener:!1,addPointerListener:function(t,e,i,n){switch(e){case"touchstart":return this.addPointerListenerStart(t,e,i,n);case"touchend":return this.addPointerListenerEnd(t,e,i,n);case"touchmove":return this.addPointerListenerMove(t,e,i,n);default:throw"Unknown touch event type"}},addPointerListenerStart:function(t,i,n,r){var s="_leaflet_",a=this._pointers,l=function(t){"mouse"!==t.pointerType&&t.pointerType!==t.MSPOINTER_TYPE_MOUSE&&o.DomEvent.preventDefault(t);for(var e=!1,i=0;i<a.length;i++)if(a[i].pointerId===t.pointerId){e=!0;break}e||a.push(t),t.touches=a.slice(),t.changedTouches=[t],n(t)};if(t[s+"touchstart"+r]=l,t.addEventListener(this.POINTER_DOWN,l,!1),!this._pointerDocumentListener){var h=function(t){for(var e=0;e<a.length;e++)if(a[e].pointerId===t.pointerId){a.splice(e,1);break}};e.documentElement.addEventListener(this.POINTER_UP,h,!1),e.documentElement.addEventListener(this.POINTER_CANCEL,h,!1),this._pointerDocumentListener=!0}return this},addPointerListenerMove:function(t,e,i,n){function o(t){if(t.pointerType!==t.MSPOINTER_TYPE_MOUSE&&"mouse"!==t.pointerType||0!==t.buttons){for(var e=0;e<s.length;e++)if(s[e].pointerId===t.pointerId){s[e]=t;break}t.touches=s.slice(),t.changedTouches=[t],i(t)}}var r="_leaflet_",s=this._pointers;return t[r+"touchmove"+n]=o,t.addEventListener(this.POINTER_MOVE,o,!1),this},addPointerListenerEnd:function(t,e,i,n){var o="_leaflet_",r=this._pointers,s=function(t){for(var e=0;e<r.length;e++)if(r[e].pointerId===t.pointerId){r.splice(e,1);break}t.touches=r.slice(),t.changedTouches=[t],i(t)};return t[o+"touchend"+n]=s,t.addEventListener(this.POINTER_UP,s,!1),t.addEventListener(this.POINTER_CANCEL,s,!1),this},removePointerListener:function(t,e,i){var n="_leaflet_",o=t[n+e+i];switch(e){case"touchstart":t.removeEventListener(this.POINTER_DOWN,o,!1);break;case"touchmove":t.removeEventListener(this.POINTER_MOVE,o,!1);break;case"touchend":t.removeEventListener(this.POINTER_UP,o,!1),t.removeEventListener(this.POINTER_CANCEL,o,!1)}return this}}),o.Map.mergeOptions({touchZoom:o.Browser.touch&&!o.Browser.android23,bounceAtZoomLimits:!0}),o.Map.TouchZoom=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"touchstart",this._onTouchStart,this)},removeHooks:function(){o.DomEvent.off(this._map._container,"touchstart",this._onTouchStart,this)},_onTouchStart:function(t){var i=this._map;if(t.touches&&2===t.touches.length&&!i._animatingZoom&&!this._zooming){var n=i.mouseEventToLayerPoint(t.touches[0]),r=i.mouseEventToLayerPoint(t.touches[1]),s=i._getCenterLayerPoint();this._startCenter=n.add(r)._divideBy(2),this._startDist=n.distanceTo(r),this._moved=!1,this._zooming=!0,this._centerOffset=s.subtract(this._startCenter),i._panAnim&&i._panAnim.stop(),o.DomEvent.on(e,"touchmove",this._onTouchMove,this).on(e,"touchend",this._onTouchEnd,this),o.DomEvent.preventDefault(t)}},_onTouchMove:function(t){var e=this._map;if(t.touches&&2===t.touches.length&&this._zooming){var i=e.mouseEventToLayerPoint(t.touches[0]),n=e.mouseEventToLayerPoint(t.touches[1]);this._scale=i.distanceTo(n)/this._startDist,this._delta=i._add(n)._divideBy(2)._subtract(this._startCenter),1!==this._scale&&(e.options.bounceAtZoomLimits||!(e.getZoom()===e.getMinZoom()&&this._scale<1||e.getZoom()===e.getMaxZoom()&&this._scale>1))&&(this._moved||(o.DomUtil.addClass(e._mapPane,"leaflet-touching"),e.fire("movestart").fire("zoomstart"),this._moved=!0),o.Util.cancelAnimFrame(this._animRequest),this._animRequest=o.Util.requestAnimFrame(this._updateOnMove,this,!0,this._map._container),o.DomEvent.preventDefault(t))}},_updateOnMove:function(){var t=this._map,e=this._getScaleOrigin(),i=t.layerPointToLatLng(e),n=t.getScaleZoom(this._scale);t._animateZoom(i,n,this._startCenter,this._scale,this._delta,!1,!0)},_onTouchEnd:function(){if(!this._moved||!this._zooming)return this._zooming=!1,void 0;var t=this._map;this._zooming=!1,o.DomUtil.removeClass(t._mapPane,"leaflet-touching"),o.Util.cancelAnimFrame(this._animRequest),o.DomEvent.off(e,"touchmove",this._onTouchMove).off(e,"touchend",this._onTouchEnd);var i=this._getScaleOrigin(),n=t.layerPointToLatLng(i),r=t.getZoom(),s=t.getScaleZoom(this._scale)-r,a=s>0?Math.ceil(s):Math.floor(s),l=t._limitZoom(r+a),h=t.getZoomScale(l)/this._scale;t._animateZoom(n,l,i,h)},_getScaleOrigin:function(){var t=this._centerOffset.subtract(this._delta).divideBy(this._scale);return this._startCenter.add(t)}}),o.Map.addInitHook("addHandler","touchZoom",o.Map.TouchZoom),o.Map.mergeOptions({tap:!0,tapTolerance:15}),o.Map.Tap=o.Handler.extend({addHooks:function(){o.DomEvent.on(this._map._container,"touchstart",this._onDown,this)},removeHooks:function(){o.DomEvent.off(this._map._container,"touchstart",this._onDown,this)},_onDown:function(t){if(t.touches){if(o.DomEvent.preventDefault(t),this._fireClick=!0,t.touches.length>1)return this._fireClick=!1,clearTimeout(this._holdTimeout),void 0;var i=t.touches[0],n=i.target;this._startPos=this._newPos=new o.Point(i.clientX,i.clientY),n.tagName&&"a"===n.tagName.toLowerCase()&&o.DomUtil.addClass(n,"leaflet-active"),this._holdTimeout=setTimeout(o.bind(function(){this._isTapValid()&&(this._fireClick=!1,this._onUp(),this._simulateEvent("contextmenu",i))},this),1e3),o.DomEvent.on(e,"touchmove",this._onMove,this).on(e,"touchend",this._onUp,this)}},_onUp:function(t){if(clearTimeout(this._holdTimeout),o.DomEvent.off(e,"touchmove",this._onMove,this).off(e,"touchend",this._onUp,this),this._fireClick&&t&&t.changedTouches){var i=t.changedTouches[0],n=i.target;n&&n.tagName&&"a"===n.tagName.toLowerCase()&&o.DomUtil.removeClass(n,"leaflet-active"),this._isTapValid()&&this._simulateEvent("click",i)}},_isTapValid:function(){return this._newPos.distanceTo(this._startPos)<=this._map.options.tapTolerance},_onMove:function(t){var e=t.touches[0];this._newPos=new o.Point(e.clientX,e.clientY)},_simulateEvent:function(i,n){var o=e.createEvent("MouseEvents");o._simulated=!0,n.target._simulatedClick=!0,o.initMouseEvent(i,!0,!0,t,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(o)}}),o.Browser.touch&&!o.Browser.pointer&&o.Map.addInitHook("addHandler","tap",o.Map.Tap),o.Map.mergeOptions({boxZoom:!0}),o.Map.BoxZoom=o.Handler.extend({initialize:function(t){this._map=t,this._container=t._container,this._pane=t._panes.overlayPane,this._moved=!1},addHooks:function(){o.DomEvent.on(this._container,"mousedown",this._onMouseDown,this)},removeHooks:function(){o.DomEvent.off(this._container,"mousedown",this._onMouseDown),this._moved=!1},moved:function(){return this._moved},_onMouseDown:function(t){return this._moved=!1,!t.shiftKey||1!==t.which&&1!==t.button?!1:(o.DomUtil.disableTextSelection(),o.DomUtil.disableImageDrag(),this._startLayerPoint=this._map.mouseEventToLayerPoint(t),o.DomEvent.on(e,"mousemove",this._onMouseMove,this).on(e,"mouseup",this._onMouseUp,this).on(e,"keydown",this._onKeyDown,this),void 0)},_onMouseMove:function(t){this._moved||(this._box=o.DomUtil.create("div","leaflet-zoom-box",this._pane),o.DomUtil.setPosition(this._box,this._startLayerPoint),this._container.style.cursor="crosshair",this._map.fire("boxzoomstart"));var e=this._startLayerPoint,i=this._box,n=this._map.mouseEventToLayerPoint(t),r=n.subtract(e),s=new o.Point(Math.min(n.x,e.x),Math.min(n.y,e.y));o.DomUtil.setPosition(i,s),this._moved=!0,i.style.width=Math.max(0,Math.abs(r.x)-4)+"px",i.style.height=Math.max(0,Math.abs(r.y)-4)+"px"},_finish:function(){this._moved&&(this._pane.removeChild(this._box),this._container.style.cursor=""),o.DomUtil.enableTextSelection(),o.DomUtil.enableImageDrag(),o.DomEvent.off(e,"mousemove",this._onMouseMove).off(e,"mouseup",this._onMouseUp).off(e,"keydown",this._onKeyDown)},_onMouseUp:function(t){this._finish();var e=this._map,i=e.mouseEventToLayerPoint(t);if(!this._startLayerPoint.equals(i)){var n=new o.LatLngBounds(e.layerPointToLatLng(this._startLayerPoint),e.layerPointToLatLng(i));e.fitBounds(n),e.fire("boxzoomend",{boxZoomBounds:n})}},_onKeyDown:function(t){27===t.keyCode&&this._finish()}}),o.Map.addInitHook("addHandler","boxZoom",o.Map.BoxZoom),o.Map.mergeOptions({keyboard:!0,keyboardPanOffset:80,keyboardZoomOffset:1}),o.Map.Keyboard=o.Handler.extend({keyCodes:{left:[37],right:[39],down:[40],up:[38],zoomIn:[187,107,61,171],zoomOut:[189,109,173]},initialize:function(t){this._map=t,this._setPanOffset(t.options.keyboardPanOffset),this._setZoomOffset(t.options.keyboardZoomOffset)},addHooks:function(){var t=this._map._container;-1===t.tabIndex&&(t.tabIndex="0"),o.DomEvent.on(t,"focus",this._onFocus,this).on(t,"blur",this._onBlur,this).on(t,"mousedown",this._onMouseDown,this),this._map.on("focus",this._addHooks,this).on("blur",this._removeHooks,this)},removeHooks:function(){this._removeHooks();var t=this._map._container;o.DomEvent.off(t,"focus",this._onFocus,this).off(t,"blur",this._onBlur,this).off(t,"mousedown",this._onMouseDown,this),this._map.off("focus",this._addHooks,this).off("blur",this._removeHooks,this)},_onMouseDown:function(){if(!this._focused){var i=e.body,n=e.documentElement,o=i.scrollTop||n.scrollTop,r=i.scrollLeft||n.scrollLeft;this._map._container.focus(),t.scrollTo(r,o)}},_onFocus:function(){this._focused=!0,this._map.fire("focus")},_onBlur:function(){this._focused=!1,this._map.fire("blur")},_setPanOffset:function(t){var e,i,n=this._panKeys={},o=this.keyCodes;for(e=0,i=o.left.length;i>e;e++)n[o.left[e]]=[-1*t,0];for(e=0,i=o.right.length;i>e;e++)n[o.right[e]]=[t,0];for(e=0,i=o.down.length;i>e;e++)n[o.down[e]]=[0,t];for(e=0,i=o.up.length;i>e;e++)n[o.up[e]]=[0,-1*t]},_setZoomOffset:function(t){var e,i,n=this._zoomKeys={},o=this.keyCodes;for(e=0,i=o.zoomIn.length;i>e;e++)n[o.zoomIn[e]]=t;for(e=0,i=o.zoomOut.length;i>e;e++)n[o.zoomOut[e]]=-t},_addHooks:function(){o.DomEvent.on(e,"keydown",this._onKeyDown,this)},_removeHooks:function(){o.DomEvent.off(e,"keydown",this._onKeyDown,this)},_onKeyDown:function(t){var e=t.keyCode,i=this._map;if(e in this._panKeys){if(i._panAnim&&i._panAnim._inProgress)return;i.panBy(this._panKeys[e]),i.options.maxBounds&&i.panInsideBounds(i.options.maxBounds)}else{if(!(e in this._zoomKeys))return;i.setZoom(i.getZoom()+this._zoomKeys[e])}o.DomEvent.stop(t)}}),o.Map.addInitHook("addHandler","keyboard",o.Map.Keyboard),o.Handler.MarkerDrag=o.Handler.extend({initialize:function(t){this._marker=t},addHooks:function(){var t=this._marker._icon;this._draggable||(this._draggable=new o.Draggable(t,t)),this._draggable.on("dragstart",this._onDragStart,this).on("drag",this._onDrag,this).on("dragend",this._onDragEnd,this),this._draggable.enable(),o.DomUtil.addClass(this._marker._icon,"leaflet-marker-draggable")},removeHooks:function(){this._draggable.off("dragstart",this._onDragStart,this).off("drag",this._onDrag,this).off("dragend",this._onDragEnd,this),this._draggable.disable(),o.DomUtil.removeClass(this._marker._icon,"leaflet-marker-draggable")},moved:function(){return this._draggable&&this._draggable._moved},_onDragStart:function(){this._marker.closePopup().fire("movestart").fire("dragstart")},_onDrag:function(){var t=this._marker,e=t._shadow,i=o.DomUtil.getPosition(t._icon),n=t._map.layerPointToLatLng(i);e&&o.DomUtil.setPosition(e,i),t._latlng=n,t.fire("move",{latlng:n}).fire("drag")},_onDragEnd:function(t){this._marker.fire("moveend").fire("dragend",t)}}),o.Control=o.Class.extend({options:{position:"topright"},initialize:function(t){o.setOptions(this,t)},getPosition:function(){return this.options.position},setPosition:function(t){var e=this._map;return e&&e.removeControl(this),this.options.position=t,e&&e.addControl(this),this},getContainer:function(){return this._container},addTo:function(t){this._map=t;var e=this._container=this.onAdd(t),i=this.getPosition(),n=t._controlCorners[i];return o.DomUtil.addClass(e,"leaflet-control"),-1!==i.indexOf("bottom")?n.insertBefore(e,n.firstChild):n.appendChild(e),this},removeFrom:function(t){var e=this.getPosition(),i=t._controlCorners[e];return i.removeChild(this._container),this._map=null,this.onRemove&&this.onRemove(t),this},_refocusOnMap:function(){this._map&&this._map.getContainer().focus()}}),o.control=function(t){return new o.Control(t)},o.Map.include({addControl:function(t){return t.addTo(this),this},removeControl:function(t){return t.removeFrom(this),this},_initControlPos:function(){function t(t,r){var s=i+t+" "+i+r;e[t+r]=o.DomUtil.create("div",s,n)}var e=this._controlCorners={},i="leaflet-",n=this._controlContainer=o.DomUtil.create("div",i+"control-container",this._container);t("top","left"),t("top","right"),t("bottom","left"),t("bottom","right")},_clearControlPos:function(){this._container.removeChild(this._controlContainer)}}),o.Control.Zoom=o.Control.extend({options:{position:"topleft",zoomInText:"+",zoomInTitle:"Zoom in",zoomOutText:"-",zoomOutTitle:"Zoom out"},onAdd:function(t){var e="leaflet-control-zoom",i=o.DomUtil.create("div",e+" leaflet-bar");return this._map=t,this._zoomInButton=this._createButton(this.options.zoomInText,this.options.zoomInTitle,e+"-in",i,this._zoomIn,this),this._zoomOutButton=this._createButton(this.options.zoomOutText,this.options.zoomOutTitle,e+"-out",i,this._zoomOut,this),this._updateDisabled(),t.on("zoomend zoomlevelschange",this._updateDisabled,this),i},onRemove:function(t){t.off("zoomend zoomlevelschange",this._updateDisabled,this)},_zoomIn:function(t){this._map.zoomIn(t.shiftKey?3:1)},_zoomOut:function(t){this._map.zoomOut(t.shiftKey?3:1)},_createButton:function(t,e,i,n,r,s){var a=o.DomUtil.create("a",i,n);a.innerHTML=t,a.href="#",a.title=e;var l=o.DomEvent.stopPropagation;return o.DomEvent.on(a,"click",l).on(a,"mousedown",l).on(a,"dblclick",l).on(a,"click",o.DomEvent.preventDefault).on(a,"click",r,s).on(a,"click",this._refocusOnMap,s),a},_updateDisabled:function(){var t=this._map,e="leaflet-disabled";o.DomUtil.removeClass(this._zoomInButton,e),o.DomUtil.removeClass(this._zoomOutButton,e),t._zoom===t.getMinZoom()&&o.DomUtil.addClass(this._zoomOutButton,e),t._zoom===t.getMaxZoom()&&o.DomUtil.addClass(this._zoomInButton,e)}}),o.Map.mergeOptions({zoomControl:!0}),o.Map.addInitHook(function(){this.options.zoomControl&&(this.zoomControl=new o.Control.Zoom,this.addControl(this.zoomControl))}),o.control.zoom=function(t){return new o.Control.Zoom(t)},o.Control.Attribution=o.Control.extend({options:{position:"bottomright",prefix:'<a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a>'},initialize:function(t){o.setOptions(this,t),this._attributions={}},onAdd:function(t){this._container=o.DomUtil.create("div","leaflet-control-attribution"),o.DomEvent.disableClickPropagation(this._container);for(var e in t._layers)t._layers[e].getAttribution&&this.addAttribution(t._layers[e].getAttribution());return t.on("layeradd",this._onLayerAdd,this).on("layerremove",this._onLayerRemove,this),this._update(),this._container},onRemove:function(t){t.off("layeradd",this._onLayerAdd).off("layerremove",this._onLayerRemove)},setPrefix:function(t){return this.options.prefix=t,this._update(),this},addAttribution:function(t){return t?(this._attributions[t]||(this._attributions[t]=0),this._attributions[t]++,this._update(),this):void 0},removeAttribution:function(t){return t?(this._attributions[t]&&(this._attributions[t]--,this._update()),this):void 0},_update:function(){if(this._map){var t=[];for(var e in this._attributions)this._attributions[e]&&t.push(e);var i=[];this.options.prefix&&i.push(this.options.prefix),t.length&&i.push(t.join(", ")),this._container.innerHTML=i.join(" | ")}},_onLayerAdd:function(t){t.layer.getAttribution&&this.addAttribution(t.layer.getAttribution())},_onLayerRemove:function(t){t.layer.getAttribution&&this.removeAttribution(t.layer.getAttribution())}}),o.Map.mergeOptions({attributionControl:!0}),o.Map.addInitHook(function(){this.options.attributionControl&&(this.attributionControl=(new o.Control.Attribution).addTo(this))}),o.control.attribution=function(t){return new o.Control.Attribution(t)},o.Control.Scale=o.Control.extend({options:{position:"bottomleft",maxWidth:100,metric:!0,imperial:!0,updateWhenIdle:!1},onAdd:function(t){this._map=t;var e="leaflet-control-scale",i=o.DomUtil.create("div",e),n=this.options;return this._addScales(n,e,i),t.on(n.updateWhenIdle?"moveend":"move",this._update,this),t.whenReady(this._update,this),i},onRemove:function(t){t.off(this.options.updateWhenIdle?"moveend":"move",this._update,this)},_addScales:function(t,e,i){t.metric&&(this._mScale=o.DomUtil.create("div",e+"-line",i)),t.imperial&&(this._iScale=o.DomUtil.create("div",e+"-line",i))},_update:function(){var t=this._map.getBounds(),e=t.getCenter().lat,i=6378137*Math.PI*Math.cos(e*Math.PI/180),n=i*(t.getNorthEast().lng-t.getSouthWest().lng)/180,o=this._map.getSize(),r=this.options,s=0;o.x>0&&(s=n*(r.maxWidth/o.x)),this._updateScales(r,s)},_updateScales:function(t,e){t.metric&&e&&this._updateMetric(e),t.imperial&&e&&this._updateImperial(e)},_updateMetric:function(t){var e=this._getRoundNum(t);this._mScale.style.width=this._getScaleWidth(e/t)+"px",this._mScale.innerHTML=1e3>e?e+" m":e/1e3+" km"},_updateImperial:function(t){var e,i,n,o=3.2808399*t,r=this._iScale;o>5280?(e=o/5280,i=this._getRoundNum(e),r.style.width=this._getScaleWidth(i/e)+"px",r.innerHTML=i+" mi"):(n=this._getRoundNum(o),r.style.width=this._getScaleWidth(n/o)+"px",r.innerHTML=n+" ft")},_getScaleWidth:function(t){return Math.round(this.options.maxWidth*t)-10},_getRoundNum:function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1,e*i}}),o.control.scale=function(t){return new o.Control.Scale(t)},o.Control.Layers=o.Control.extend({options:{collapsed:!0,position:"topright",autoZIndex:!0},initialize:function(t,e,i){o.setOptions(this,i),this._layers={},this._lastZIndex=0,this._handlingClick=!1;for(var n in t)this._addLayer(t[n],n);for(n in e)this._addLayer(e[n],n,!0)},onAdd:function(t){return this._initLayout(),this._update(),t.on("layeradd",this._onLayerChange,this).on("layerremove",this._onLayerChange,this),this._container},onRemove:function(t){t.off("layeradd",this._onLayerChange,this).off("layerremove",this._onLayerChange,this)},addBaseLayer:function(t,e){return this._addLayer(t,e),this._update(),this},addOverlay:function(t,e){return this._addLayer(t,e,!0),this._update(),this},removeLayer:function(t){var e=o.stamp(t);return delete this._layers[e],this._update(),this},_initLayout:function(){var t="leaflet-control-layers",e=this._container=o.DomUtil.create("div",t);e.setAttribute("aria-haspopup",!0),o.Browser.touch?o.DomEvent.on(e,"click",o.DomEvent.stopPropagation):o.DomEvent.disableClickPropagation(e).disableScrollPropagation(e);var i=this._form=o.DomUtil.create("form",t+"-list");if(this.options.collapsed){o.Browser.android||o.DomEvent.on(e,"mouseover",this._expand,this).on(e,"mouseout",this._collapse,this);var n=this._layersLink=o.DomUtil.create("a",t+"-toggle",e);n.href="#",n.title="Layers",o.Browser.touch?o.DomEvent.on(n,"click",o.DomEvent.stop).on(n,"click",this._expand,this):o.DomEvent.on(n,"focus",this._expand,this),o.DomEvent.on(i,"click",function(){setTimeout(o.bind(this._onInputClick,this),0)},this),this._map.on("click",this._collapse,this)}else this._expand();this._baseLayersList=o.DomUtil.create("div",t+"-base",i),this._separator=o.DomUtil.create("div",t+"-separator",i),this._overlaysList=o.DomUtil.create("div",t+"-overlays",i),e.appendChild(i)},_addLayer:function(t,e,i){var n=o.stamp(t);this._layers[n]={layer:t,name:e,overlay:i},this.options.autoZIndex&&t.setZIndex&&(this._lastZIndex++,t.setZIndex(this._lastZIndex))},_update:function(){if(this._container){this._baseLayersList.innerHTML="",this._overlaysList.innerHTML="";var t,e,i=!1,n=!1;for(t in this._layers)e=this._layers[t],this._addItem(e),n=n||e.overlay,i=i||!e.overlay;this._separator.style.display=n&&i?"":"none"}},_onLayerChange:function(t){var e=this._layers[o.stamp(t.layer)];
if(e){this._handlingClick||this._update();var i=e.overlay?"layeradd"===t.type?"overlayadd":"overlayremove":"layeradd"===t.type?"baselayerchange":null;i&&this._map.fire(i,e)}},_createRadioElement:function(t,i){var n='<input type="radio" class="leaflet-control-layers-selector" name="'+t+'"';i&&(n+=' checked="checked"'),n+="/>";var o=e.createElement("div");return o.innerHTML=n,o.firstChild},_addItem:function(t){var i,n=e.createElement("label"),r=this._map.hasLayer(t.layer);t.overlay?(i=e.createElement("input"),i.type="checkbox",i.className="leaflet-control-layers-selector",i.defaultChecked=r):i=this._createRadioElement("leaflet-base-layers",r),i.layerId=o.stamp(t.layer),o.DomEvent.on(i,"click",this._onInputClick,this);var s=e.createElement("span");s.innerHTML=" "+t.name,n.appendChild(i),n.appendChild(s);var a=t.overlay?this._overlaysList:this._baseLayersList;return a.appendChild(n),n},_onInputClick:function(){var t,e,i,n=this._form.getElementsByTagName("input"),o=n.length;for(this._handlingClick=!0,t=0;o>t;t++)e=n[t],i=this._layers[e.layerId],e.checked&&!this._map.hasLayer(i.layer)?this._map.addLayer(i.layer):!e.checked&&this._map.hasLayer(i.layer)&&this._map.removeLayer(i.layer);this._handlingClick=!1,this._refocusOnMap()},_expand:function(){o.DomUtil.addClass(this._container,"leaflet-control-layers-expanded")},_collapse:function(){this._container.className=this._container.className.replace(" leaflet-control-layers-expanded","")}}),o.control.layers=function(t,e,i){return new o.Control.Layers(t,e,i)},o.PosAnimation=o.Class.extend({includes:o.Mixin.Events,run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._newPos=e,this.fire("start"),t.style[o.DomUtil.TRANSITION]="all "+(i||.25)+"s cubic-bezier(0,0,"+(n||.5)+",1)",o.DomEvent.on(t,o.DomUtil.TRANSITION_END,this._onTransitionEnd,this),o.DomUtil.setPosition(t,e),o.Util.falseFn(t.offsetWidth),this._stepTimer=setInterval(o.bind(this._onStep,this),50)},stop:function(){this._inProgress&&(o.DomUtil.setPosition(this._el,this._getPos()),this._onTransitionEnd(),o.Util.falseFn(this._el.offsetWidth))},_onStep:function(){var t=this._getPos();return t?(this._el._leaflet_pos=t,this.fire("step"),void 0):(this._onTransitionEnd(),void 0)},_transformRe:/([-+]?(?:\d*\.)?\d+)\D*, ([-+]?(?:\d*\.)?\d+)\D*\)/,_getPos:function(){var e,i,n,r=this._el,s=t.getComputedStyle(r);if(o.Browser.any3d){if(n=s[o.DomUtil.TRANSFORM].match(this._transformRe),!n)return;e=parseFloat(n[1]),i=parseFloat(n[2])}else e=parseFloat(s.left),i=parseFloat(s.top);return new o.Point(e,i,!0)},_onTransitionEnd:function(){o.DomEvent.off(this._el,o.DomUtil.TRANSITION_END,this._onTransitionEnd,this),this._inProgress&&(this._inProgress=!1,this._el.style[o.DomUtil.TRANSITION]="",this._el._leaflet_pos=this._newPos,clearInterval(this._stepTimer),this.fire("step").fire("end"))}}),o.Map.include({setView:function(t,e,n){if(e=e===i?this._zoom:this._limitZoom(e),t=this._limitCenter(o.latLng(t),e,this.options.maxBounds),n=n||{},this._panAnim&&this._panAnim.stop(),this._loaded&&!n.reset&&n!==!0){n.animate!==i&&(n.zoom=o.extend({animate:n.animate},n.zoom),n.pan=o.extend({animate:n.animate},n.pan));var r=this._zoom!==e?this._tryAnimatedZoom&&this._tryAnimatedZoom(t,e,n.zoom):this._tryAnimatedPan(t,n.pan);if(r)return clearTimeout(this._sizeTimer),this}return this._resetView(t,e),this},panBy:function(t,e){if(t=o.point(t).round(),e=e||{},!t.x&&!t.y)return this;if(this._panAnim||(this._panAnim=new o.PosAnimation,this._panAnim.on({step:this._onPanTransitionStep,end:this._onPanTransitionEnd},this)),e.noMoveStart||this.fire("movestart"),e.animate!==!1){o.DomUtil.addClass(this._mapPane,"leaflet-pan-anim");var i=this._getMapPanePos().subtract(t);this._panAnim.run(this._mapPane,i,e.duration||.25,e.easeLinearity)}else this._rawPanBy(t),this.fire("move").fire("moveend");return this},_onPanTransitionStep:function(){this.fire("move")},_onPanTransitionEnd:function(){o.DomUtil.removeClass(this._mapPane,"leaflet-pan-anim"),this.fire("moveend")},_tryAnimatedPan:function(t,e){var i=this._getCenterOffset(t)._floor();return(e&&e.animate)===!0||this.getSize().contains(i)?(this.panBy(i,e),!0):!1}}),o.PosAnimation=o.DomUtil.TRANSITION?o.PosAnimation:o.PosAnimation.extend({run:function(t,e,i,n){this.stop(),this._el=t,this._inProgress=!0,this._duration=i||.25,this._easeOutPower=1/Math.max(n||.5,.2),this._startPos=o.DomUtil.getPosition(t),this._offset=e.subtract(this._startPos),this._startTime=+new Date,this.fire("start"),this._animate()},stop:function(){this._inProgress&&(this._step(),this._complete())},_animate:function(){this._animId=o.Util.requestAnimFrame(this._animate,this),this._step()},_step:function(){var t=+new Date-this._startTime,e=1e3*this._duration;e>t?this._runFrame(this._easeOut(t/e)):(this._runFrame(1),this._complete())},_runFrame:function(t){var e=this._startPos.add(this._offset.multiplyBy(t));o.DomUtil.setPosition(this._el,e),this.fire("step")},_complete:function(){o.Util.cancelAnimFrame(this._animId),this._inProgress=!1,this.fire("end")},_easeOut:function(t){return 1-Math.pow(1-t,this._easeOutPower)}}),o.Map.mergeOptions({zoomAnimation:!0,zoomAnimationThreshold:4}),o.DomUtil.TRANSITION&&o.Map.addInitHook(function(){this._zoomAnimated=this.options.zoomAnimation&&o.DomUtil.TRANSITION&&o.Browser.any3d&&!o.Browser.android23&&!o.Browser.mobileOpera,this._zoomAnimated&&o.DomEvent.on(this._mapPane,o.DomUtil.TRANSITION_END,this._catchTransitionEnd,this)}),o.Map.include(o.DomUtil.TRANSITION?{_catchTransitionEnd:function(t){this._animatingZoom&&t.propertyName.indexOf("transform")>=0&&this._onZoomTransitionEnd()},_nothingToAnimate:function(){return!this._container.getElementsByClassName("leaflet-zoom-animated").length},_tryAnimatedZoom:function(t,e,i){if(this._animatingZoom)return!0;if(i=i||{},!this._zoomAnimated||i.animate===!1||this._nothingToAnimate()||Math.abs(e-this._zoom)>this.options.zoomAnimationThreshold)return!1;var n=this.getZoomScale(e),o=this._getCenterOffset(t)._divideBy(1-1/n),r=this._getCenterLayerPoint()._add(o);return i.animate===!0||this.getSize().contains(o)?(this.fire("movestart").fire("zoomstart"),this._animateZoom(t,e,r,n,null,!0),!0):!1},_animateZoom:function(t,e,i,n,r,s,a){a||(this._animatingZoom=!0),o.DomUtil.addClass(this._mapPane,"leaflet-zoom-anim"),this._animateToCenter=t,this._animateToZoom=e,o.Draggable&&(o.Draggable._disabled=!0),o.Util.requestAnimFrame(function(){this.fire("zoomanim",{center:t,zoom:e,origin:i,scale:n,delta:r,backwards:s}),setTimeout(o.bind(this._onZoomTransitionEnd,this),250)},this)},_onZoomTransitionEnd:function(){this._animatingZoom&&(this._animatingZoom=!1,o.DomUtil.removeClass(this._mapPane,"leaflet-zoom-anim"),o.Util.requestAnimFrame(function(){this._resetView(this._animateToCenter,this._animateToZoom,!0,!0),o.Draggable&&(o.Draggable._disabled=!1)},this))}}:{}),o.TileLayer.include({_animateZoom:function(t){this._animating||(this._animating=!0,this._prepareBgBuffer());var e=this._bgBuffer,i=o.DomUtil.TRANSFORM,n=t.delta?o.DomUtil.getTranslateString(t.delta):e.style[i],r=o.DomUtil.getScaleString(t.scale,t.origin);e.style[i]=t.backwards?r+" "+n:n+" "+r},_endZoomAnim:function(){var t=this._tileContainer,e=this._bgBuffer;t.style.visibility="",t.parentNode.appendChild(t),o.Util.falseFn(e.offsetWidth);var i=this._map.getZoom();(i>this.options.maxZoom||i<this.options.minZoom)&&this._clearBgBuffer(),this._animating=!1},_clearBgBuffer:function(){var t=this._map;!t||t._animatingZoom||t.touchZoom._zooming||(this._bgBuffer.innerHTML="",this._bgBuffer.style[o.DomUtil.TRANSFORM]="")},_prepareBgBuffer:function(){var t=this._tileContainer,e=this._bgBuffer,i=this._getLoadedTilesPercentage(e),n=this._getLoadedTilesPercentage(t);return e&&i>.5&&.5>n?(t.style.visibility="hidden",this._stopLoadingImages(t),void 0):(e.style.visibility="hidden",e.style[o.DomUtil.TRANSFORM]="",this._tileContainer=e,e=this._bgBuffer=t,this._stopLoadingImages(e),clearTimeout(this._clearBgBufferTimer),void 0)},_getLoadedTilesPercentage:function(t){var e,i,n=t.getElementsByTagName("img"),o=0;for(e=0,i=n.length;i>e;e++)n[e].complete&&o++;return o/i},_stopLoadingImages:function(t){var e,i,n,r=Array.prototype.slice.call(t.getElementsByTagName("img"));for(e=0,i=r.length;i>e;e++)n=r[e],n.complete||(n.onload=o.Util.falseFn,n.onerror=o.Util.falseFn,n.src=o.Util.emptyImageUrl,n.parentNode.removeChild(n))}}),o.Map.include({_defaultLocateOptions:{watch:!1,setView:!1,maxZoom:1/0,timeout:1e4,maximumAge:0,enableHighAccuracy:!1},locate:function(t){if(t=this._locateOptions=o.extend(this._defaultLocateOptions,t),!navigator.geolocation)return this._handleGeolocationError({code:0,message:"Geolocation not supported."}),this;var e=o.bind(this._handleGeolocationResponse,this),i=o.bind(this._handleGeolocationError,this);return t.watch?this._locationWatchId=navigator.geolocation.watchPosition(e,i,t):navigator.geolocation.getCurrentPosition(e,i,t),this},stopLocate:function(){return navigator.geolocation&&navigator.geolocation.clearWatch(this._locationWatchId),this._locateOptions&&(this._locateOptions.setView=!1),this},_handleGeolocationError:function(t){var e=t.code,i=t.message||(1===e?"permission denied":2===e?"position unavailable":"timeout");this._locateOptions.setView&&!this._loaded&&this.fitWorld(),this.fire("locationerror",{code:e,message:"Geolocation error: "+i+"."})},_handleGeolocationResponse:function(t){var e=t.coords.latitude,i=t.coords.longitude,n=new o.LatLng(e,i),r=180*t.coords.accuracy/40075017,s=r/Math.cos(o.LatLng.DEG_TO_RAD*e),a=o.latLngBounds([e-r,i-s],[e+r,i+s]),l=this._locateOptions;if(l.setView){var h=Math.min(this.getBoundsZoom(a),l.maxZoom);this.setView(n,h)}var u={latlng:n,bounds:a,timestamp:t.timestamp};for(var c in t.coords)"number"==typeof t.coords[c]&&(u[c]=t.coords[c]);this.fire("locationfound",u)}})}(window,document),function(){"use strict";function t(t,e,i){this.layer=t,this.tilePoint=e,this.zoom=i,this.gmx=t._gmx,this.zKey=this.layer._tileCoordsToKey(e,i);var o=n;this.worldWidthMerc=o.worldWidthMerc;var r=o.getTileNumFromLeaflet(e,i);this.tbounds=o.getTileBounds(r.x,r.y,r.z),this.tpx=256*r.x,this.tpy=256*(1+r.y),this.gmxTilePoint=r,this.showRaster=i>=this.gmx.minZoomRasters&&"rasterBGfunc"in this.gmx||i>=this.gmx.minZoomQuicklooks&&"quicklookBGfunc"in this.gmx,this.rasters={},this.rasterRequests={},this._uniqueID=0,this.gmx.badTiles=this.gmx.badTiles||{}}var e;"undefined"!=typeof module&&module.exports?(e=require("leaflet"),e.gmx={},module.exports=e.gmx):e=window.L,function(){var t=/\[(.+?)\]/g,i=/(floor\()/g,n={functionFromExpression:function(e){return new Function("props","indexes","return "+e.replace(t,'props[indexes["$1"]]').replace(i,"Math.$1")+";")}},o=function(t,e){return{head:t,tail:e}},r=function(t,e){return o(t,e)},s=function(t,e){return o(t,e)},a=new s(-1,null),l=function(t){return-1===t.head},h=function(t,e){return new s(t.head+e,t.tail)},u=function(t){var e=t.length;return function(i,n){return i.substr(n.head,e)===t?h(n,e):a}},c=function(t){var e=t.length;return t=t.toLowerCase(),function(i,n){return i.substr(n.head,e).toLowerCase()===t?h(n,e):a}},d=function(t,e){var i=t.charCodeAt(0),n=e.charCodeAt(0);return function(t,e){var o=t.charCodeAt(e.head);return o>=i&&n>=o?h(e,1):a}},p=function(t){return function(e,i){return e.length>i.head&&l(t(e,i))?h(i,1):a}},m=function(t){return function(e,i){for(var n=0;n<t.length;n++)if(i=t[n](e,i),l(i))return a;return i}},f=function(t){return function(e,i){for(var n=0;n<t.length;n++){var o=t[n](e,i);if(!l(o))return o}return a}},g=function(t,e){return e},_=function(t){return f([t,g])},v=function(t,e){return function(i,n){for(var o=0;;){var r=e(i,n);if(l(r))return o>=t?n:a;o+=1,n=r}}},y=function(t,e,i){var n=m([e,v(t-1,m([i,e]))]);return t>0?n:f([n,g])},x=v(0,f([u(" "),u("	"),u("\n")])),L=function(t,e,i){return y(t,e,m([x,i,x]))},b=function(t){for(var e=[],i=0;i<t.length;i++)e.length>0&&e.push(x),e.push(t[i]);return m(e)},P=function(t){return function(e,i){var n=t(e,i);return l(n)?a:new s(n.head,new r(e.substr(i.head,n.head-i.head),n.tail))}},S=function(t,e){return function(i,n){var o=n,h=t(i,new s(o.head,null));return l(h)?a:new s(h.head,new r(e(h.tail),o.tail))}},T=P(v(1,f([d("a","z"),d("A","Z"),d("",""),d("",""),d("0","9"),u("_")]))),w=P(v(1,f([d("a","z"),d("A","Z"),d("",""),d("",""),d("0","9"),u("_"),u(" ")]))),C=f([T,m([u('"'),w,u('"')]),m([u("`"),w,u("`")])]),M=m([u("'"),P(v(0,p(u("'")))),u("'")]),D=v(1,d("0","9")),I=P(m([_(u("-")),D,_(m([u("."),D]))])),k=f([I,M]),E=function(t,e){return e(t,new s(0,null))},O=S(b([C,P(f([u("=="),u("!="),u("<>"),u("<="),u(">="),u("="),u("<"),u(">"),c("LIKE")])),f([k,C])]),function(t){var i=t.tail.tail.head,n=t.tail.head,o=t.head,r=null;return"LIKE"===n.toUpperCase()&&(r=function(t){var e=null;return e=function(i,n){var r=o.charAt(i),s=t.charAt(n);return""===r?""===s:"%"===r?e(i+1,n)||""!==s&&e(i,n+1):r===s&&e(i+1,n+1)},e(0,0)}),function(t,s,a){var l=t[s[i]],h=o;if(o in s&&(h=t[s[h]]),"date"===a[i]&&"string"==typeof h&&(h=e.gmxUtil.getUnixTimeFromStr(h)),"boolean"==typeof l&&"string"==typeof h&&(l=l?"True":"False"),null===l)return!1;if(null!==r)return r(l);if("="===n||"=="===n)return l==h;if("!="===n||"<>"===n)return l!=h;var u,c;return o in s||"string"!=typeof h||E(h,I).head!==h.length?(u=l,c=h,"<"===n?c>u:">"===n?u>c:"<="===n?c>=u:">="===n?u>=c:!1):(u=parseFloat(l),c=parseFloat(h),"<"===n?c>u:">"===n?u>c:"<="===n?c>=u:">="===n?u>=c:!1)}}),A=S(b([C,c("IN"),u("("),L(0,k,u(",")),u(")")]),function(t){for(var e=t;null!=e.tail;)e=e.tail;var i=e.head;return function(e,n){var o=e[n[i]];if(null==o)return!1;for(var r=t;null!==r.tail;){if(r.head===o)return!0;r=r.tail}return!1}}),N=function(t,e){return N(t,e)},B=function(t,e){return B(t,e)},U=S(b([c("NOT"),N]),function(t){var e=t.head;return function(t,i,n){return!e(t,i,n)}});N=f([U,O,A,b([u("("),B,u(")")])]);var z=S(L(2,N,c("AND")),function(t){return function(e,i,n){for(var o=!0,r=t;null!=r;)o=o&&r.head(e,i,n),r=r.tail;return o}}),R=S(L(2,N,c("OR")),function(t){return function(e,i,n){for(var o=!1,r=t;null!=r;)o=o||r.head(e,i,n),r=r.tail;return o}});B=f([z,R,N]);var F=m([x,B,x]);n.parseSQL=function(t){var e=E(t,F);return e.head===t.length?e.tail.head:E(t,x).head===t.length?function(){return!0}:null};var G=function(t,e){return G(t,e)},Z=function(t,e){return Z(t,e)};G=S(L(1,Z,P(f([u("+"),u("-")]))),function(t){return function(e,i,n){for(var o=t,r=0;null!==o;){if(r+=o.head(e,i,n),null===o.tail)return r;"-"===o.tail.head&&(r=-r),o=o.tail.tail}return r}});var H=f([S(I,function(t){return function(){return parseFloat(t.head)}}),S(m([u("floor("),G,u(")")]),function(t){return function(e,i,n){var o=t.head(e,i,n);return Math.floor(o)}}),S(m([u("["),T,u("]")]),function(t){return function(e,i){return parseFloat(e[i[t.head]])}}),b([u("("),G,u(")")])]);H=f([H,S(b([u("-"),H]),function(t){return function(e,i,n){return-t.head(e,i,n)}})]),Z=S(L(1,H,P(f([u("*"),u("/")]))),function(t){return function(e,i,n){for(var o=t,r=1;null!==o;){if(r*=o.head(e,i,n),null===o.tail)return r;"/"===o.tail.head&&(r=1/r),o=o.tail.tail}return r}}),H=f([H,S(b([u("-"),H]),function(t){return function(e,i,n){return-t.head(e,i,n)}})]);var j=m([x,G,x]);n.parseExpression=function(t){var e=E(t,j);return e.head===t.length?e.tail.head:null};var V=S(v(0,f([I,u(","),u("M"),u("C"),v(1,f([u(" "),u("	"),u("\r"),u("\n")]))])),function(t){for(var e=[];null!==t;)e.push(parseFloat(t.head)),t=t.tail;return e.reverse(),e});n.parseSVGPath=function(t){var e=E(t,V);return e.head===t.length?e.tail.head:[]},e.gmx=e.gmx||{},e.gmx.Parsers=n}();var i=function(t){var e,n=[],o=[],r=!1,s=!1,a=!1,l=!1,h=this._fulfill=function(t){if(!r){var i=t?n:o;e=[].slice.call(arguments,1),r=!0,s=t,i.forEach(function(t){t.apply(null,e)}),n=o=[]}};this.resolve=function(){l||h.apply(null,[!0].concat([].slice.call(arguments)))},this.reject=function(){l||h.apply(null,[!1].concat([].slice.call(arguments)))};var u=this.cancel=function(){l||r||(l=!0,t&&t())},c=this.then=function(t,a){if(l)return null;var h=null,c=new i(function(){u(),h&&h.cancel()}),d=function(t,e){return function(){if(t){var n=t.apply(null,arguments);n instanceof i?(h=n,n.then(c.resolve,c.reject)):c.resolve(n)}else c._fulfill.apply(null,[e].concat([].slice.call(arguments)))}};return r?d(s?t:a,s).apply(null,e):(n.push(d(t,!0)),o.push(d(a,!1))),c};this.once=function(t){a||(a=!0,c(t))},this.always=function(t){c(t,t)},this.getFulfilledData=function(){return e}};i.all=function(){var t=[].slice.apply(arguments),e=new i,n=t.length,o=new Array(t.length);return n?t.forEach(function(t,i){t.then(function(t){o[i]=t,n--,0===n&&e.resolve.apply(e,o)},function(){e.reject()})}):e.resolve(),e},e.gmx=e.gmx||{},e.gmx.Deferred=i,function(){var t=function(t,i,n){this._id=t,this.def=new e.gmx.Deferred(e.gmx.imageLoader._cancelRequest.bind(e.gmx.imageLoader,this)),this.remove=e.gmx.imageLoader._removeRequestFromCache.bind(e.gmx.imageLoader,this),this.url=i,this.options=n||{}},i=e.Class.extend({includes:e.Mixin.Events,statics:{MAX_COUNT:20},initialize:function(){this.curCount=0,this.requests=[],this.inProgress={},this.requestsCache={},this.uniqueID=0},_resolveRequest:function(t,e,i){var n=t.def;if(e){if(!i&&t.options.cache){var o=t.url,r=this.requestsCache[o],s=t._id;r||(r=this.requestsCache[o]={image:e,requests:{}}),r.requests[s]||(r.requests[s]=t)}n.resolve(e)}else i||n.reject();this.fire("requestdone",{request:t})},_imageLoaded:function(t,i,n){if(t in this.inProgress){var o=function(t){this._resolveRequest(t,i,n)};this.inProgress[t].requests.forEach(o.bind(this)),--this.curCount,delete this.inProgress[t]}e.gmxUtil.loaderStatus(t,!0),this.fire("imageloaded",{url:t}),this._nextLoad()},_nextLoad:function(){if(!(this.curCount>=i.MAX_COUNT)&&this.requests.length){var t=this.requests.shift(),n=t.url;if(n in this.inProgress)this.inProgress[n].requests.push(t);else{var o=[t];this.inProgress[n]={requests:o},++this.curCount;for(var r=this.requests.length-1;r>=0;r--)this.requests[r].url===n&&(o.push(this.requests[r]),this.requests.splice(r,1));var s=this._loadImage(t);s.width||e.gmxUtil.loaderStatus(n),this.inProgress[n]&&(this.inProgress[n].image=s)}}},_loadImage:function(t){var e=new Image,i=t.url,n=this;return t.options.crossOrigin&&(e.crossOrigin=t.options.crossOrigin),e.onload=this._imageLoaded.bind(this,i,e,!1),e.onerror=function(){n._imageLoaded(i)},e.src=i,this.fire("imageloadstart",{url:i}),e},_cancelRequest:function(t){var i,n=t._id,o=t.url,r=0;if(o in this.inProgress){var s=this.inProgress[o],a=s.requests;if(i=a.length,1===i&&a[0]._id===n)s.image.onload=e.Util.falseFn,s.image.onerror=e.Util.falseFn,s.image.src=e.Util.emptyImageUrl,this._imageLoaded(o,null,!0);else for(r=0;i>r;r++)if(a[r]._id===n){a.splice(r,1);break}}else for(r=0,i=this.requests.length;i>r;r++)if(this.requests[r]._id===n){this.requests.splice(r,1);break}this.fire("requestdone",{request:t})},_removeRequestFromCache:function(t){this._cancelRequest(t),this._clearCacheItem(t.url,t._id)},_clearCacheItem:function(t,e){if(this.requestsCache[t]){var i=this.requestsCache[t];delete i.requests[e],0===Object.keys(i.requests).length&&delete this.requestsCache[t]}},_add:function(e,i,n){var o="id"+ ++this.uniqueID,r=new t(o,i,n);return i in this.inProgress?this.inProgress[i].requests.push(r):(e?this.requests.unshift(r):this.requests.push(r),this._nextLoad()),this.fire("request",{request:r}),r},push:function(t,e){return this._add(!1,t,e)},unshift:function(t,e){return this._add(!0,t,e)}});e.gmx.imageLoader=new i}();var n={lastMapId:0,newId:function(){return n.lastMapId+=1,"_"+n.lastMapId},uniqueGlobalName:function(t){var e=n.newId();return window[e]=t,e},isPageHidden:function(){return document.hidden||document.msHidden||document.webkitHidden||document.mozHidden||!1},normalizeHostname:function(t){var i=e.gmxUtil.parseUri(("http"!==t.substr(0,4)?"http://":"")+t);return t=i.host+i.directory,"/"===t[t.length-1]&&(t=t.substring(0,t.length-1)),t},getLayerItemFromServer:function(t){var e=t.query?t.query:"["+t.field+"]="+t.value,i={WrapStyle:"func",geometry:!0,layer:t.layerID,query:e};return t.border&&(i.border=t.border),n.requestJSONP(t.url||(window.serverBase||"http://maps.kosmosnimki.ru/")+"VectorLayer/Search.ashx",i,t)},getCadastreFeatures:function(t){if(t.latlng){var e=t.latlng,i={WrapStyle:"func",text:(e.lat+" "+e.lng).replace(/\./g,","),tolerance:t.tolerance||0};return n.requestJSONP(t.url||"http://pkk5.rosreestr.ru/api/features/",i,t)}return null},requestJSONP:function(t,i,o){o=o||{};var r=new e.gmx.Deferred,s=document.createElement("script");s.setAttribute("charset","UTF-8");var a="callbackParamName"in o?o.callbackParamName:"CallbackName",l=e.extend({},i);if(a){var h=n.uniqueGlobalName(function(t){delete window[h],r.resolve(t,o)});l[a]=h}var u=[];for(var c in l)u.push(c+"="+encodeURIComponent(l[c]));var d=t+(-1===t.indexOf("?")?"?":"&")+u.join("&");return s.onerror=function(t){r.reject(t),e.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},s.onload=function(){e.gmxUtil.loaderStatus(d,!0),s.parentNode.removeChild(s)},e.gmxUtil.loaderStatus(d,null,"vector"),s.setAttribute("src",d),document.getElementsByTagName("head").item(0).appendChild(s),r},getXmlHttp:function(){var t;if("undefined"!=typeof XMLHttpRequest)t=new XMLHttpRequest;else try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(i){t=!1}}return t},request:function(t){var i=n.getXmlHttp();if(i){if(i.open(t.type?t.type:"GET",t.url,t.async||!1),t.headers)for(var o in t.headers)i.setRequestHeader(o,t.headers[o]);var r=e.gmxUtil.loaderStatus();return t.async&&(t.withCredentials&&(i.withCredentials=!0),i.onreadystatechange=function(){4===i.readyState&&(e.gmxUtil.loaderStatus(r,!0),200===i.status?(t.callback(i.responseText),i=null):t.onError&&t.onError(i))}),i.send(t.params?t.params:null),t.async||200!==i.status?!0:(t.callback(i.responseText),e.gmxUtil.loaderStatus(r,!0),i.status)}return t.onError&&t.onError({Error:"bad XMLHttpRequest!"}),!1},tileSizes:[],getTileNumFromLeaflet:function(t,e){"z"in t&&(e=t.z);var i=Math.pow(2,e),n=t.x%i+(t.x<0?i:0),o=t.y%i+(t.y<0?i:0);return{z:e,x:n%i-i/2,y:i/2-1-o%i}},getTilePosZoomDelta:function(t,e,i){var n=Math.pow(2,e-i),o=256/n,r=t.x%n,s=t.y%n;return{size:o,zDelta:n,x:o*(0>r?n+r:r),y:o*(0>s?-(1+t.y)%n:n-1-s)}},geoItemBounds:function(t){if(!t)return{bounds:null,boundsArr:[]};var e=t.type,i=t.coordinates,o=null,r=0,s=0,a=null,l=[];if("MULTIPOLYGON"===e||"MultiPolygon"===e)for(a=n.bounds(),r=0,s=i.length;s>r;r++){for(var h=[],u=0,c=i[r].length;c>u;u++)o=n.bounds(i[r][u]),h.push(o),0===u&&a.extendBounds(o);l.push(h)}else if("POLYGON"===e||"Polygon"===e)for(a=n.bounds(),r=0,s=i.length;s>r;r++)o=n.bounds(i[r]),l.push(o),0===r&&a.extendBounds(o);else if("POINT"===e||"Point"===e)a=n.bounds([i]);else if("MULTIPOINT"===e||"MultiPoint"===e)for(a=n.bounds(),r=0,s=i.length;s>r;r++)o=n.bounds([i[r]]),a.extendBounds(o);else if("LINESTRING"===e||"LineString"===e)a=n.bounds(i);else if("MULTILINESTRING"===e||"MultiLineString"===e)for(a=n.bounds(),r=0,s=i.length;s>r;r++)o=n.bounds(i[r]),a.extendBounds(o);return{bounds:a,boundsArr:l}},getUnFlattenGeo:function(t){var e=t.type,i=-1!==e.indexOf("POLYGON")||-1!==e.indexOf("Polygon"),o=t.coordinates,r=o;if(i){r=[];var s="POLYGON"===e||"Polygon"===e;s&&(o=[o]);for(var a=0,l=o.length;l>a;a++){for(var h=[],u=0,c=o[a].length;c>u;u++)h[u]=n.unFlattenRing(o[a][u]);r.push(h)}s&&(r=r[0])}return{type:e,coordinates:r}},unFlattenRing:function(t){if("number"!=typeof t[0])return t;for(var e=t.length,i=0,n=new Array(e/2),o=0;e>o;o+=2)n[i++]=[t[o],t[o+1]];return n},geoFlatten:function(t){var e=t.type,i=-1!==e.indexOf("POLYGON")||-1!==e.indexOf("Polygon"),o="POLYGON"===e||"Polygon"===e,r=t.coordinates;if(i){o&&(r=[r]);for(var s=0,a=r.length;a>s;s++)for(var l=0,h=r[s].length;h>l;l++)r[s][l]=n.flattenRing(r[s][l])}},flattenRing:function(t){for(var e=t.length,i=0,n="function"==typeof Float64Array?Float64Array:Array,o=new n(2*e),r=0;e>r;r++)o[i++]=t[r][0],o[i++]=t[r][1];return o},isRectangle:function(t){return!(!t||!t[0]||5!==t[0].length&&4!==t[0].length||t[0][0][0]!==t[0][1][0]&&t[0][0][1]!==t[0][1][1]||t[0][1][0]!==t[0][2][0]&&t[0][1][1]!==t[0][2][1]||t[0][2][0]!==t[0][3][0]&&t[0][2][1]!==t[0][3][1]||t[0][3][0]!==t[0][0][0]&&t[0][3][1]!==t[0][0][1])},getGeometryBounds:function(t){var e=n.geoItemBounds(t);return e.bounds},getMarkerPolygon:function(t,e,i){var n=(t.min.x+t.max.x)/2,o=(t.min.y+t.max.y)/2;return[[n-e,o-i],[n-e,o+i],[n+e,o+i],[n+e,o-i],[n-e,o-i]]},getQuicklookPointsFromProperties:function(t,i){var o=i.tileAttributeIndexes,r={x1:n.getPropItem(i.quicklookX1||("x1"in o?"x1":"X1"),t,o)||0,y1:n.getPropItem(i.quicklookY1||("y1"in o?"y1":"Y1"),t,o)||0,x2:n.getPropItem(i.quicklookX2||("x2"in o?"x2":"X2"),t,o)||0,y2:n.getPropItem(i.quicklookY2||("y2"in o?"y2":"Y2"),t,o)||0,x3:n.getPropItem(i.quicklookX3||("x3"in o?"x3":"X3"),t,o)||0,y3:n.getPropItem(i.quicklookY3||("y3"in o?"y3":"Y3"),t,o)||0,x4:n.getPropItem(i.quicklookX4||("x4"in o?"x4":"X4"),t,o)||0,y4:n.getPropItem(i.quicklookY4||("y4"in o?"y4":"Y4"),t,o)||0},s=n.bounds([[r.x1,r.y1],[r.x2,r.y2],[r.x3,r.y3],[r.x4,r.y4]]);if(s.max.x===s.min.x||s.max.y===s.min.y)return null;if(!i.quicklookPlatform){var a=e.Projection.Mercator.project(e.latLng(r.y1,r.x1));r.x1=a.x,r.y1=a.y,a=e.Projection.Mercator.project(e.latLng(r.y2,r.x2)),r.x2=a.x,r.y2=a.y,a=e.Projection.Mercator.project(e.latLng(r.y3,r.x3)),r.x3=a.x,r.y3=a.y,a=e.Projection.Mercator.project(e.latLng(r.y4,r.x4)),r.x4=a.x,r.y4=a.y}return r},getPropertiesHash:function(t,e){var i={};for(var n in e)i[n]=t[e[n]];return i},getPropItem:function(t,e,i){return t in i?e[i[t]]:""},dec2rgba:function(t,e){var i=255&t>>16,n=255&t>>8,o=255&t;return"rgba("+i+", "+n+", "+o+", "+e+")"},dec2hex:function(t){return(t+16777216).toString(16).substr(-6)},dec2color:function(t,e){return 1>e?this.dec2rgba(t,e):"#"+this.dec2hex(t)},oneDay:86400,isTileKeysIntersects:function(t,e){if(t.z<e.z){var i=t;t=e,e=i}var n=t.z-e.z;return t.x>>n===e.x&&t.y>>n===e.y},rotatePoints:function(t,e,i,n){var o=[];e*=Math.PI/180;var r=Math.sin(e),s=Math.cos(e);i||(i=1);for(var a=0;a<t.length;a++){var l=i*t[a].x-n.x,h=i*t[a].y-n.y;o.push({x:s*l-r*h+n.x,y:r*l+s*h+n.y})}return o},getPatternIcon:function(t,e,i){if(!e.fillPattern)return null;var o=!0,r=e.fillPattern,s=t?t.properties:null,a=r.step>0?r.step:0,l={minWidth:1,maxWidth:1e3,minStep:0,maxStep:1e3};r.patternStepFunction&&null!==s&&(a=r.patternStepFunction(s,i),o=!1),a>l.maxStep?a=l.maxStep:a<l.minStep&&(a=l.minStep);var h=r.width>0?r.width:8;r.patternWidthFunction&&null!==s&&(h=r.patternWidthFunction(s,i),o=!1),h>l.maxWidth?h=l.maxWidth:h<l.minWidth&&(h=l.minWidth);var u=e.fillOpacity;e.opacityFunction&&null!==s&&(u=e.opacityFunction(s,i)/100,o=!1);var c=[16711680,65280,255],d=null!=r.colors?r.colors:c,p=d.length,m=[],f=0;for(f=0;p>f;f++){var g=d[f];r.patternColorsFunction&&null!==r.patternColorsFunction[f]&&(g=null!==s?r.patternColorsFunction[f](s,i):c[f%3],o=!1),m.push(g)}0===p&&(m=[0],u=0,p=1);var _=h+a,v=_*p,y=0,x=0,L=v,b=v,P=r.style||"horizontal",S=!1;if("diagonal1"===P||"diagonal2"===P||"cross"===P||"cross1"===P?S=!0:"circle"===P?(b=L=2*_,y=Math.floor(b/2),x=2*Math.PI/p):"vertical"===P?L=1:"horizontal"===P&&(b=1),b*L>l.maxWidth)return console.log({func:"getPatternIcon",Error:"MAX_PATTERN_SIZE",alert:"Bitmap from pattern is too big"}),null;var T=document.createElement("canvas");T.width=b,T.height=L;var w=T.getContext("2d");for(w.clearRect(0,0,T.width,T.height),("diagonal2"===P||"vertical"===P)&&(w.translate(b,0),w.rotate(Math.PI/2)),f=0;p>f;f++){w.beginPath();var C=n.dec2color(m[f],u);if(w.fillStyle=C,S){var M=f*_,D=M+h;w.moveTo(M,0),w.lineTo(D,0),w.lineTo(0,D),w.lineTo(0,M),w.lineTo(M,0),M+=v,D=M+h,w.moveTo(M,0),w.lineTo(D,0),w.lineTo(0,D),w.lineTo(0,M),w.lineTo(M,0),("cross"===P||"cross1"===P)&&(M=f*_,D=M+h,w.moveTo(b,M),w.lineTo(b,D),w.lineTo(b-D,0),w.lineTo(b-M,0),w.lineTo(b,M),M+=v,D=M+h,w.moveTo(b,M),w.lineTo(b,D),w.lineTo(b-D,0),w.lineTo(b-M,0),w.lineTo(b,M))}else"circle"===P?(w.arc(y,y,h,f*x,(f+1)*x),w.lineTo(y,y)):w.fillRect(0,f*_,b,h);w.closePath(),w.fill()}var I=document.createElement("canvas");I.width=b,I.height=L;var k=I.getContext("2d");return k.drawImage(T,0,0,b,L),{notFunc:o,canvas:I}},getSVGIcon:function(t){var i='<svg xmlns="'+e.Path.SVG_NS+'" xmlns:xlink="http://www.w3.org/1999/xlink"',n=t.type,o=t.fillStyle||"rgba(255, 255, 255, 0.5)",r=t.strokeStyle||"#0000ff",s=t.lineWidth||2,a={className:"gmx-svg-icon"};t.className&&(a.className=t.className);var l=t.iconSize;if(a.iconSize=[l,l],i+=' height = "'+l+'px"  width = "'+l+'px">',"circle"===n){if(t.fillRadialGradient){i+='<defs><radialGradient id="myRadialGradient4" spreadMethod="pad">';for(var h=t.fillRadialGradient.colorStop||t.fillRadialGradient.addColorStop||[[0,"#ffff00",.8],[1,"#ff0000",.8]],u=0,c=h.length;c>u;u++){var d=h[u];i+='<stop offset="'+100*d[0]+'%"   stop-color="'+d[1]+'" stop-opacity="'+d[2]+'"/>'}i+="</radialGradient></defs>",o="url(#myRadialGradient4)",r=s=null}l/=2,i+='<g><circle cx="'+l+'" cy="'+l+'" r="'+l+'" style="',o&&(i+=" fill:"+o+";"),r&&(i+=' stroke:"'+r+";"),s&&(i+=' stroke-width:"'+s+";"),i+=';" />'}else"square"===n&&(i+='<g><rect width="'+l+'" height="'+l+'" style="',o&&(i+=" fill:"+o+";"),r&&(i+=" stroke:"+r+";"),s&&(i+=" stroke-width:"+2*s+";"),i+='" />');if(t.text){var p=t.text;i+='<text x="50%" y="50%" dy="0.4em"';for(var m in p)"count"!==m&&(i+=" "+m+'="'+p[m]+'"');i+=">"+p.count+"</text>"}return i+="</g></svg>",a.html=i,new e.DivIcon(a)},toPixels:function(t,e,i,n){var o=t[0]*n;o=.5+o<<0;var r=t[1]*n;return r=.5+r<<0,[o-e,i-r].concat(t.slice(2))},getPixelPoint:function(t,e){var i=t.gmx,o=i.mInPixel,r=t.item,s=r.currentStyle||r.parsedStyleKeys||{},a=t.style||{},l=s.iconScale||1,h=s.iconCenter||!1,u=s.sx||a.sx||4,c=s.sy||a.sy||4,d=s.weight||a.weight||0,p=s.iconAnchor||a.iconAnchor||null,m=t.tpx,f=t.tpy;!h&&p&&(_-=p[0],g-=p[1]),u*=l,c*=l,u+=d,c+=d;var g=f-e[1]*o,_=e[0]*o-m;return _-u>256?_=(e[0]-2*n.worldWidthMerc)*o-m:-u>_&&(_=(e[0]+2*n.worldWidthMerc)*o-m),g-c>256||_-u>256||0>_+u||0>g+c?null:{sx:u,sy:c,px1:.5+_<<0,py1:.5+g<<0}},getImageData:function(t){if(e.gmxUtil.isIE9||e.gmxUtil.isIE10)return null;var i=document.createElement("canvas"),n=t.width,o=t.height;i.width=n,i.height=o;var r=i.getContext("2d");return r.drawImage(t,0,0),r.getImageData(0,0,n,o).data},DEFAULT_REPLACEMENT_COLOR:16711935,isIE:function(t){return t===n.getIEversion()},gtIE:function(t){return t<n.getIEversion()},getIEversion:function(){var t=navigator.userAgent||"",e=t.indexOf("MSIE ");if(e>0)return parseInt(t.substring(e+5,t.indexOf(".",e)),10);var i=t.indexOf("Trident/");if(i>0){var n=t.indexOf("rv:");return parseInt(t.substring(n+3,t.indexOf(".",n)),10)}var o=t.indexOf("Edge/");return o>0?parseInt(t.substring(o+5,t.indexOf(".",o)),10):-1},replaceColor:function(t,i,n){if(e.gmxUtil.isIE9||e.gmxUtil.isIE10)return t;var o=document.createElement("canvas"),r=t.width,s=t.height;o.width=r,o.height=s;var a,l=!1,h=o.getContext("2d");if("string"==typeof i&&(i=parseInt("0x"+i.replace(/#/,""))),i!==this.DEFAULT_REPLACEMENT_COLOR){var u=255&i>>16,c=255&i>>8,d=255&i;n?a=h.createImageData(r,s):(h.drawImage(t,0,0),a=h.getImageData(0,0,r,s),n=a.data);for(var p=a.data,m=0,f=n.length;f>m;m+=4)255!==n[m]&&238!==n[m]||0!==n[m+1]||255!==n[m+2]||(p[m]=u,p[m+1]=c,p[m+2]=d,p[m+3]=n[m+3],l=!0)}return l?h.putImageData(a,0,0):h.drawImage(t,0,0),o},drawIconPath:function(t,i){if(e.Util.isArray(t)&&!(t.length<3)&&i.ctx){var o=!1,r=i.ctx,s=i.radian;(i.px||i.py)&&(r.translate(i.px||0,i.py||0),o=!0),!s&&i.rotateRes&&(s=Math.PI+n.degRad(i.rotateRes)),s&&(r.rotate(s),o=!0),r.moveTo(t[0],t[1]);for(var a=2,l=t.length;l>a;a+=2)r.lineTo(t[a],t[a+1]);o&&r.setTransform(1,0,0,1,0,0)}},pointToCanvas:function(t){var e=t.gmx,i=t.pointAttr,o=t.style||{},r=t.item,s=r.currentStyle||r.parsedStyleKeys,a=s.iconScale||1,l=s.image,h=i.sx,u=i.sy,c=i.px1,d=i.py1,p=c,m=d,f=t.ctx;if("image"===s.type&&(h=o.sx,u=o.sy,l=o.image),s.iconCenter?(p-=h/2,m-=u/2):"circle"===o.type&&(c+=h/2,d+=u/2),s.iconPath&&(t.px=c,t.py=d,t.rotateRes=s.rotate||0),l)"iconColor"in s&&(l=this.replaceColor(l,s.iconColor,t.imageData)),o.rotateRes=s.rotate||0,"opacity"in o&&(f.globalAlpha=s.opacity||o.opacity),e.transformFlag?(f.setTransform(e.mInPixel,0,0,e.mInPixel,-t.tpx,t.tpy),f.drawImage(l,c,-d,h,u),f.setTransform(e.mInPixel,0,0,-e.mInPixel,-t.tpx,t.tpy)):(1!==a&&(h*=a,u*=a,c=i.px1,d=i.py1,p=c,m=d,s.iconCenter&&(p-=h/2,m-=u/2)),o.rotateRes?(f.translate(c,d),f.rotate(n.degRad(o.rotateRes)),f.translate(-c,-d),f.drawImage(l,p,m,h,u),f.setTransform(1,0,0,1,0,0)):f.drawImage(l,p,m,h,u)),"opacity"in o&&(f.globalAlpha=1);
else if(o.fillColor||s.fillRadialGradient){if(f.beginPath(),s.iconPath)n.drawIconPath(s.iconPath,t);else if("circle"===o.type||s.fillRadialGradient){var g=o.iconSize/2;if(s.fillRadialGradient){var _=s.fillRadialGradient;g=_.r2*a;for(var v=f.createRadialGradient(c+_.x1,d+_.y1,_.r1*a,c+_.x2,d+_.y2,g),y=0,x=_.addColorStop.length;x>y;y++){var L=_.addColorStop[y];v.addColorStop(L[0],L[1])}f.fillStyle=v}f.arc(c,d,g,0,2*Math.PI)}else f.fillRect(p,m,h,u);f.fill()}s.strokeStyle&&(f.beginPath(),s.iconPath?n.drawIconPath(s.iconPath,t):"circle"===o.type?f.arc(c,d,o.iconSize/2,0,2*Math.PI):f.strokeRect(p,m,h,u),f.stroke())},lineToCanvasAsIcon:function(t,e){var i=t.length,o=e.ctx,r=e.item,s=r.currentStyle||r.parsedStyleKeys,a=s.iconPath;if(i>0){"getLineDash"in o&&o.getLineDash().length>0&&o.setLineDash([]),o.beginPath();for(var l,h=0;i>h;h++)l=t[h],n.drawIconPath(a,{ctx:o,px:l.x,py:l.y,radian:l.radian});s.strokeStyle&&o.stroke(),s.fillStyle&&o.fill()}},lineToCanvas:function(t){var e=t.gmx,i=t.coords,o=t.ctx,r=t.item,s=r.currentStyle||r.parsedStyleKeys,a=s.iconPath?[]:null,l=null,h=null;o.beginPath();for(var u=0,c=i.length;c>u;u++){var d=n.toPixels(i[u],t.tpx,t.tpy,e.mInPixel),p=d[0],m=d[1];(l!==p||h!==m)&&(a&&a.push({x:p,y:m,radian:d[2]}),0===u?o.moveTo(p,m):o.lineTo(p,m),l=p,h=m)}return o.stroke(),a},getCoordsPixels:function(t){for(var e=t.gmx,i=t.coords,o=t.hiddenLines||[],r=[],s=[],a=!1,l={gmx:e,tpx:t.tpx,tpy:t.tpy,coords:null,hiddenLines:null},h=0,u=i.length;u>h;h++){for(var c=i[h],d=o[h]||[],p=[],m=[],f=0,g=c.length;g>f;f++){l.coords=c[f],l.hiddenLines=d[f]||[];var _=n.getRingPixels(l);p.push(_.coords),m.push(_.hidden),_.hidden&&(a=!0)}r.push(p),s.push(m)}return{coords:r,hidden:a?s:null,z:e.currentZoom}},getRingPixels:function(t){if(0===t.coords.length)return null;for(var e=t.gmx,i=e.mInPixel,n=t.coords,o=t.hiddenLines||null,r=t.tpx,s=t.tpy,a=0,l=0,h=null,u=null,c="number"==typeof n[0]?2:1,d=[],p=[],m=0,f=n.length;f>m;m+=c){var g=!1;o&&m===o[l]&&(g=!0,l++);var _=1===c?n[m]:[n[m],n[m+1]],v=_[0]*i,y=_[1]*i,x=Math.round(v-r),L=Math.round(s-y);(h!==x||u!==L)&&(h=x,u=L,g&&p.push(a),d[a++]=v,d[a++]=y)}return{coords:d,hidden:p.length?p:null}},polygonToCanvas:function(t){if(0===t.coords.length)return null;var e=t.hiddenLines||null,i=t.coords,n=t.ctx,o=t.tpx,r=t.tpy,s=0,a=0,l="number"==typeof i[0]?2:1,h=null,u=null;n.beginPath();for(var c=0,d=i.length;d>c;c+=l){var p=1===l?i[c]:[i[c],i[c+1]],m=Math.round(p[0]-o),f=Math.round(r-p[1]),g=!1;e&&c===e[a]&&(g=!0,a++),(h!==m||u!==f)&&(n[g?"moveTo":"lineTo"](m,f),h=m,u=f,s++)}1===s&&n.lineTo(h+1,u),n.stroke()},polygonToCanvasFill:function(t){if(!(t.coords.length<3)){var e=t.coords,i=t.tpx,n=t.tpy,o=1,r=t.ctx;r.lineWidth=0,"number"==typeof e[0]?(o=2,r.moveTo(Math.round(e[0]-i),Math.round(n-e[1]))):r.moveTo(Math.round(e[0][0]-i),Math.round(n-e[0][1]));for(var s=o,a=e.length;a>s;s+=o){var l=1===o?e[s]:[e[s],e[s+1]];r.lineTo(Math.round(l[0]-i),Math.round(n-l[1]))}}},isPatternNode:function(t){return t instanceof HTMLCanvasElement||t instanceof HTMLImageElement},labelCanvasContext:null,getLabelWidth:function(t,e){if(e){if(!n.labelCanvasContext){var i=document.createElement("canvas");i.width=i.height=512,n.labelCanvasContext=i.getContext("2d")}var o=n.labelCanvasContext;return o.clearRect(0,0,512,512),o.font!==e.font&&(o.font=e.font),o.fillStyle!==e.fillStyle&&(o.fillStyle=e.fillStyle),o.fillText(t,0,0),o.measureText(t).width}return 0},setLabel:function(t,e,i,n){var o=i[0],r=i[1];t.shadowColor!==n.strokeStyle&&(t.shadowColor=n.strokeStyle),t.shadowBlur!==n.shadowBlur&&(t.shadowBlur=n.shadowBlur),t.font!==n.font&&(t.font=n.font),t.strokeStyle!==n.strokeStyle&&(t.strokeStyle=n.strokeStyle),t.fillStyle!==n.fillStyle&&(t.fillStyle=n.fillStyle),t.strokeText(e,o,r),t.fillText(e,o,r)},worldWidthMerc:20037508,rMajor:6378137,degRad:function(t){return t*(Math.PI/180)},distVincenty:function(t,e,i,o){for(var r={lon:n.degRad(t),lat:n.degRad(e)},s={lon:n.degRad(i),lat:n.degRad(o)},a=n.rMajor,l=6356752.3142,h=1/298.257223563,u=s.lon-r.lon,c=Math.atan((1-h)*Math.tan(r.lat)),d=Math.atan((1-h)*Math.tan(s.lat)),p=Math.sin(c),m=Math.cos(c),f=Math.sin(d),g=Math.cos(d),_=u,v=2*Math.PI,y=20;Math.abs(_-v)>1e-12&&--y>0;){var x=Math.sin(_),L=Math.cos(_),b=Math.sqrt(g*x*g*x+(m*f-p*g*L)*(m*f-p*g*L));if(0===b)return 0;var P=p*f+m*g*L,S=Math.atan2(b,P),T=m*g*x/b,w=1-T*T,C=P-2*p*f/w;isNaN(C)&&(C=0);var M=h/16*w*(4+h*(4-3*w));v=_,_=u+(1-M)*h*T*(S+M*b*(C+M*P*(-1+2*C*C)))}if(0===y)return 0/0;var D=w*(a*a/(l*l)-1),I=1+D/16384*(4096+D*(-768+D*(320-175*D))),k=D/1024*(256+D*(-128+D*(74-47*D))),E=k*b*(C+k/4*(P*(-1+2*C*C)-k/6*C*(-3+4*b*b)*(-3+4*C*C))),O=l*I*(S-E);return O},_vfi:function(t,e,i){return[-Math.cos(t)*Math.sin(e)+Math.sin(t)*Math.sin(i)*Math.cos(e),Math.cos(t)*Math.cos(e)+Math.sin(t)*Math.sin(i)*Math.sin(e),-Math.sin(t)*Math.cos(i)]},getCircleLatLngs:function(t,i){var o=0,r=0;if(t instanceof e.LatLng)o=t.lng,r=t.lat;else{if(!e.Util.isArray(t))return null;o=t[1],r=t[0]}for(var s=Math.PI/180,a=o*s,l=r*s,h=n.rMajor,u=h*Math.sin(i/h),c=h*Math.cos(i/h),d=[c*Math.cos(l)*Math.cos(a),c*Math.cos(l)*Math.sin(a),c*Math.sin(l)],p=[],m=0,f=2*Math.PI+1e-6;f>m;m+=s){for(var g=n._vfi(m,a,l),_=[],v=0;3>v;v++)_[v]=d[v]+u*g[v];var y=Math.acos(_[0]/Math.sqrt(_[0]*_[0]+_[1]*_[1]))/s;_[1]<0&&(y=-y),o-180>y?y+=360:y>o+180&&(y-=360),p.push([Math.asin(_[2]/h)/s,y])}return p},parseCoordinates:function(t){var i=null,n=/\(EPSG:(\d+)\)/g,o=n.exec(t);if(o&&(i=o[1],t=t.replace(n,"")),t.match(/[qrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(-1===t.indexOf(" ")&&-1===t.indexOf(","))return null;-1!==t.indexOf(" ")&&(t=t.replace(/,/g,"."));var r=[];for(n=/(-?\d+(\.\d+)?)([^\d\-]*)/g,o=n.exec(t);o;)r.push(o[1]),o=n.exec(t);if(r.length<2)return null;var s,a=Math.floor(r.length/2),l=0,h=1;for(s=0;a>s;s++)l+=parseFloat(r[s])*h,h/=60;var u=0;for(h=1,s=a;s<r.length;s++)u+=parseFloat(r[s])*h,h/=60;Math.max(t.indexOf("N"),t.indexOf("S"))>Math.max(t.indexOf("E"),t.indexOf("W"))&&(o=u,u=l,l=o);var c;return"3857"===i&&(c=e.Projection.SphericalMercator.unproject(new e.Point(l,u)._divideBy(6378137)),u=c.lng,l=c.lat),(Math.abs(u)>180||Math.abs(l)>180)&&(c=e.Projection.Mercator.unproject(new e.Point(l,u)),u=c.lng,l=c.lat),-1!==t.indexOf("W")&&(u=-u),-1!==t.indexOf("S")&&(l=-l),[l,u]},pad2:function(t){return 10>t?"0"+t:""+t},trunc:function(t){return(""+(Math.round(1e7*t)/1e7+1e-8)).substring(0,9)},formatDegrees:function(t){t=Math.round(1e7*t)/1e7+1e-8;var e=Math.floor(t),i=Math.floor(60*(t-e)),o=n.toPrecision(3600*(t-e-i/60),2);return n.pad2(e)+""+n.pad2(i)+"'"+n.pad2(o)+'"'},latLonFormatCoordinates:function(t,e){return t%=360,t>180?t-=360:-180>t&&(t+=360),n.formatDegrees(Math.abs(e))+(e>0?" N, ":" S, ")+n.formatDegrees(Math.abs(t))+(t>0?" E":" W")},formatCoordinates:function(t,e){return n.latLonFormatCoordinates(t,e)},latLonFormatCoordinates2:function(t,e){return n.trunc(Math.abs(e))+(e>0?" N, ":" S, ")+n.trunc(Math.abs(t))+(t>0?" E":" W")},formatCoordinates2:function(t,e){return n.latLonFormatCoordinates2(t,e)},getPixelScale:function(t){return 256/n.tileSizes[t]},forEachPoint:function(t,e){if(!t||0===t.length)return[];var i,o,r=[];if(t[0].length)for(i=0,o=t.length;o>i;i++)"string"!=typeof t[i]&&r.push(n.forEachPoint(t[i],e));else{if(2===t.length)return e(t);for(i=0,o=t.length/2;o>i;i++)r.push(e([t[2*i],t[2*i+1]]))}return r},getItemCenter:function(t,e){var i=t.bounds,o=i.min,r=i.max,s=t.type,a="POINT"===s||"MULTIPOINT"===s,l=a?[o.x,o.y]:[(o.x+r.x)/2,(o.y+r.y)/2];if("MULTIPOLYGON"===s)return l;if("POLYGON"===s)for(var h=0,u=e.length;u>h;h++){var c=e[h],d=c.geo,p=d.coordinates,m=c.dataOption,f=m.bounds;if(f.contains(l)){"POLYGON"===d.type&&(p=[p]);for(var g=0,_=p.length;_>g;g++)for(var v=0,y=p[g],x=y.length;x>v;v++){var L=n.getHSegmentsInPolygon(l[1],y[v]);if(L)return L.max.center}}}else{if("POINT"===s||"MULTIPOINT"===s)return l;if("LINESTRING"===s||"MULTILINESTRING"===s)return l}return null},getHSegmentsInPolygon:function(t,e){var i,n,o,r=[],s=1,a=e[0];"number"==typeof e[0]&&(s=2,a=[e[0],e[1]]);var l=t>a[1];for(i=s,n=e.length;n>i;i+=s){var h=1===s?e[i]:[e[i],e[i+1]],u=t>h[1];l!==u&&r.push(a[0]-(a[0]-h[0])*(a[1]-t)/(a[1]-h[1])),a=h,l=u}if(n=r.length){r=r.sort();var c=0,d=-1;for(i=1;n>i;i+=2){var p=i-1,m=Math.abs(r[i]-r[p]);m>c&&(c=m,d=p)}o={y:t,segArr:r,max:{width:c,center:[(r[d]+r[d+1])/2,t]}}}return o},isPointInPolygonArr:function(t,e){var i=!1,n=t[0],o=t[1],r=1,s=e[0];"number"==typeof e[0]&&(r=2,s=[e[0],e[1]]);for(var a=r,l=e.length;l>a;a+=r){var h=1===r?e[a]:[e[a],e[a+1]],u=Math.min(s[0],h[0]),c=Math.max(s[0],h[0]),d=Math.max(s[1],h[1]);if(n>u&&c>=n&&d>=o&&s[0]!==h[0]){var p=(n-s[0])*(h[1]-s[1])/(h[0]-s[0])+s[1];(s[1]===h[1]||p>=o)&&(i=!i)}s=h}return i},isPointInPolygonWithHoles:function(t,e){if(!n.isPointInPolygonArr(t,e[0]))return!1;for(var i=1,o=e.length;o>i;i++)if(n.isPointInPolygonArr(t,e[i]))return!1;return!0},isClockwise:function(t){for(var e,i=0,n=0,o=t.length;o>n;n++)e=(n+1)%o,i+=t[n][0]*t[e][1],i-=t[e][0]*t[n][1];return 0>i},isPointInPolyLine:function(t,i,n,o){var r=t[0],s=t[1],a={x:r,y:s},l=r-i,h=r+i,u=s-i,c=s+i,d=0;i*=i;for(var p=1,m=n.length;m>p;p++)if(o&&p===o[d])d++;else{var f=n[p-1],g=n[p],_=f[0],v=f[1],y=g[0],x=g[1];if(!(Math.max(_,y)<l||Math.min(_,y)>h||Math.max(v,x)<u||Math.min(v,x)>c)){var L=e.LineUtil._sqClosestPointOnSegment(a,{x:_,y:v},{x:y,y:x},!0);if(i>L)return!0}}return!1},isPointInLines:function(t){for(var e=t.coords,i=t.point,o=t.delta,r=t.boundsArr,s=t.hidden,a=0,l=e.length,h=!1;l>a;a++)if(h=r[a]?r[a].contains(i):!0,h&&n.isPointInPolyLine(i,o,e[a],s?s[a]:null))return!0;return!1},getLength:function(t,i){var o=0;if(t&&t.length){var r=!1,s=!1;i=void 0===i||i,t.forEach(function(t){if(e.Util.isArray(t)){if(e.Util.isArray(t[0]))return o+=n.getLength(t,i);i&&(t=e.Projection.Mercator.unproject({x:t[0],y:t[1]}))}r!==!1&&s!==!1&&(o+=parseFloat(n.distVincenty(r,s,t.lng,t.lat))),r=t.lng,s=t.lat})}return o},prettifyDistance:function(t,i){var n=" "+e.gmxLocale.getText("units.km");return"nm"===i?Math.round(.539956803*t)/1e3+" "+e.gmxLocale.getText("units.nm"):"km"===i?Math.round(t)/1e3+n:2e3>t||"m"===i?Math.round(t)+" "+e.gmxLocale.getText("units.m"):2e5>t?Math.round(t/10)/100+n:Math.round(t/1e3)+n},geoJSONGetLength:function(t){var e,i,o,r,s,a=0;if("GeometryCollection"===t.type?a+=t.geometries.forEach(n.geoJSONGetLength):"Feature"===t.type?a+=n.geoJSONGetLength(t.geometry):"FeatureCollection"===t.type&&(a+=t.features.forEach(n.geoJSONGetLength)),"LineString"===t.type||"MultiLineString"===t.type)for(s=t.coordinates,"LineString"===t.type&&(s=[s]),e=0,o=s.length;o>e;e++)a+=n.getRingLength(s[e]);if("Polygon"===t.type||"MultiPolygon"===t.type)for(s=t.coordinates,"Polygon"===t.type&&(s=[s]),e=0,o=s.length;o>e;e++)for(i=0,r=s[e].length;r>i;i++)a+=n.getRingLength(s[e][i]);return a},getRingLength:function(t){var i=0;if(t&&t.length){var o=!1,r=!1;t.forEach(function(t){return e.Util.isArray(t)&&t.length>2?i+=n.getRingLength(t):(o!==!1&&r!==!1&&(i+=parseFloat(n.distVincenty(o,r,t[0],t[1]))),o=t[0],r=t[1],void 0)})}return i},geoJSONGetArea:function(t){var e=0;if("GeometryCollection"===t.type?e+=t.geometries.forEach(n.geoJSONGetArea):"Feature"===t.type?e+=n.geoJSONGetArea(t.geometry):"FeatureCollection"===t.type&&(e+=t.features.forEach(n.geoJSONGetArea)),"Polygon"===t.type||"MultiPolygon"===t.type){var i=t.coordinates;"Polygon"===t.type&&(i=[i]);for(var o=0,r=i.length;r>o;o++){e+=n.getRingArea(i[o][0]);for(var s=1,a=i[o].length;a>s;s++)e-=n.getRingArea(i[o][s])}}return e},geoJSONGetLatLng:function(t){if("Feature"===t.type)return n.geoJSONGetLatLng(t.geometry);if("Point"===t.type)return e.latLng(t.coordinates[1],t.coordinates[0]);throw new Error("cannot get "+t.type+" latLng")},getRingArea:function(t){for(var e=0,i=0,o=t.length;o>i;i++){var r=i===o-1?0:i+1,s=t[i],a=t[r];e+=s[0]*Math.sin(n.degRad(a[1]))-a[0]*Math.sin(n.degRad(s[1]))}var l=Math.abs(e*n.lambertCoefX*n.lambertCoefY/2);return l},getArea:function(t){for(var e=0,i=0,o=t.length;o>i;i++){var r=i===o-1?0:i+1,s=t[i],a=t[r];e+=s.lng*Math.sin(n.degRad(a.lat))-a.lng*Math.sin(n.degRad(s.lat))}return Math.abs(e*n.lambertCoefX*n.lambertCoefY/2)},prettifyArea:function(t,i){var n=" "+e.gmxLocale.getText("units.km2");return"km2"===i?""+Math.round(t/100)/1e4+n:"ha"===i?""+Math.round(t/100)/100+" "+e.gmxLocale.getText("units.ha"):1e5>t||"m2"===i?Math.round(t)+" "+e.gmxLocale.getText("units.m2"):3e6>t?(""+Math.round(t/1e3)/1e3).replace(".",",")+n:3e7>t?(""+Math.round(t/1e4)/100).replace(".",",")+n:3e8>t?(""+Math.round(t/1e5)/10).replace(".",",")+n:Math.round(t/1e6)+n},geoLength:function(t){var e=0,i=t.type;if("MULTILINESTRING"===i||"MultiLineString"===i){for(var o=0,r=t.coordinates.length;r>o;o++)e+=n.geoLength({type:"LINESTRING",coordinates:t.coordinates[o]});return e}return("LINESTRING"===i||"LineString"===i)&&(e=n.getLength(t.coordinates)),e},geometryToGeoJSON:function(t,e){if(!t)return null;var i="MULTIPOLYGON"===t.type?"MultiPolygon":"POLYGON"===t.type?"Polygon":"MULTILINESTRING"===t.type?"MultiLineString":"LINESTRING"===t.type?"LineString":"MULTIPOINT"===t.type?"MultiPoint":"POINT"===t.type?"Point":t.type,o=t.coordinates;return e&&(o=n.coordsFromMercator(i,o)),{type:i,coordinates:o}},convertGeometry:function(t,e){var i="MULTIPOLYGON"===t.type?"MultiPolygon":"POLYGON"===t.type?"Polygon":"MULTILINESTRING"===t.type?"MultiLineString":"LINESTRING"===t.type?"LineString":"MULTIPOINT"===t.type?"MultiPoint":"POINT"===t.type?"Point":t.type,o=t.coordinates;return o=e?n.coordsFromMercator(i,o):n.coordsToMercator(i,o),{type:t.type,coordinates:o}},geoJSONtoGeometry:function(t,e){if("FeatureCollection"===t.type)return n.geoJSONtoGeometry(t.features[0],e);if("Feature"===t.type)return n.geoJSONtoGeometry(t.geometry,e);if("FeatureCollection"===t.type)return n.geoJSONtoGeometry(t.features[0],e);var i="MultiPolygon"===t.type?"MULTIPOLYGON":"Polygon"===t.type?"POLYGON":"MultiLineString"===t.type?"MULTILINESTRING":"LineString"===t.type?"LINESTRING":"MultiPoint"===t.type?"MULTIPOINT":"Point"===t.type?"POINT":t.type,o=t.coordinates;return e&&(o=n.coordsToMercator(t.type,o)),{type:i,coordinates:o}},_coordsConvert:function(t,i,o){var r,s,a,l=[];if("Point"===t)o?(a=e.Projection.Mercator.project({lat:i[1],lng:i[0]}),l=[a.x,a.y]):(a=e.Projection.Mercator.unproject({y:i[1],x:i[0]}),l=[a.lng,a.lat]);else if("LineString"===t||"MultiPoint"===t)for(r=0,s=i.length;s>r;r++)l.push(n._coordsConvert("Point",i[r],o));else if("Polygon"===t||"MultiLineString"===t)for(r=0,s=i.length;s>r;r++)l.push(n._coordsConvert("MultiPoint",i[r],o));else if("MultiPolygon"===t)for(r=0,s=i.length;s>r;r++)l.push(n._coordsConvert("Polygon",i[r],o));return l},coordsFromMercator:function(t,e){return n._coordsConvert(t,e,!1)},coordsToMercator:function(t,e){return n._coordsConvert(t,e,!0)},transformGeometry:function(t,e){return t?{type:t.type,coordinates:n.forEachPoint(t.coordinates,function(t){return e(t)})}:t},geoArea:function(t,i){var o,r,s=0,a=t.type||"";if(i=void 0===i||i,"MULTIPOLYGON"===a||"MultiPolygon"===a){for(o=0,r=t.coordinates.length;r>o;o++)s+=n.geoArea({type:"POLYGON",coordinates:t.coordinates[o]},i);return s}if("POLYGON"===a||"Polygon"===a){for(s=n.geoArea(t.coordinates[0],i),o=1,r=t.coordinates.length;r>o;o++)s-=n.geoArea(t.coordinates[o],i);return s}if(t.length){var l=[],h="number"==typeof t[0]?2:1;for(o=0,r=t.length;r>o;o+=h){var u=1===h?t[o]:[t[o],t[o+1]];l.push(i?e.Projection.Mercator.unproject({y:u[1],x:u[0]}):{lat:u[1],lng:u[0]})}return n.getArea(l)}return 0},getGeoJSONSummary:function(t,e){var i,o,r,s=t.type,a=e||{},l=0;if("Point"===s)r=t.coordinates,l=n.formatCoordinates(r[0],r[1]);else if("Polygon"===s)l=n.prettifyArea(n.geoArea(t,!1),a.squareUnit);else if("MultiPolygon"===s){for(r=t.coordinates,i=0,o=r.length;o>i;i++)l+=n.geoArea({type:"Polygon",coordinates:r[i]},!1);l=n.prettifyArea(l,a.squareUnit)}else if("LineString"===s)l=n.prettifyDistance(n.geoJSONGetLength(t),a.distanceUnit);else if("MultiLineString"===s){for(r=t.coordinates,i=0,o=r.length;o>i;i++)l+=n.geoJSONGetLength({type:"LineString",coordinates:r[i]});l=n.prettifyDistance(l,a.distanceUnit)}return l},getCoordinatesString:function(t,i){var o,r=t.lng,s=t.lat,a=["",""," (EPSG:3395)"," (EPSG:3857)"],l=a.length,h="";return i=i||0,r>180&&(r-=360),-180>r&&(r+=360),0===i%l?h=n.formatCoordinates2(r,s):1===i%l?h=n.formatCoordinates(r,s):2===i%l?(o=e.Projection.Mercator.project(new e.LatLng(s,r)),h=""+Math.round(o.x)+", "+Math.round(o.y)+a[2]):(o=e.CRS.EPSG3857.project(new e.LatLng(s,r)),h=""+Math.round(o.x)+", "+Math.round(o.y)+a[3]),h},getGeometriesSummary:function(t,i){var o="",r="",s=0;return i||(i={}),t&&t.forEach(function(t){if(t)if(r=t.type.toUpperCase(),-1!==r.indexOf("POINT")){var a=e.Projection.Mercator.unproject({y:t.coordinates[1],x:t.coordinates[0]});o="<b>"+e.gmxLocale.getText("Coordinates")+"</b>: "+n.getCoordinatesString(a,i.coordinatesFormat)}else-1!==r.indexOf("LINESTRING")?s+=n.geoLength(t):-1!==r.indexOf("POLYGON")&&(s+=n.geoArea(t))}),o||(-1!==r.indexOf("LINESTRING")?o="<b>"+e.gmxLocale.getText("Length")+"</b>: "+n.prettifyDistance(s,i.distanceUnit):-1!==r.indexOf("POLYGON")&&(o="<b>"+e.gmxLocale.getText("Area")+"</b>: "+n.prettifyArea(s,i.squareUnit))),o},getGeometrySummary:function(t,e){return n.getGeometriesSummary([t],e||{})},chkOnEdge:function(t,e,i){return t[0]<i.min.x&&e[0]<i.min.x||t[0]>i.max.x&&e[0]>i.max.x?!0:t[1]<i.min.y&&e[1]<i.min.y||t[1]>i.max.y&&e[1]>i.max.y?!0:!1},getHidden:function(t,e){for(var i=[],o="number"==typeof t[0]?2:1,r=null,s=0,a=t.length;a>s;s+=o){var l=1===o?t[s]:[t[s],t[s+1]];r&&n.chkOnEdge(l,r,e)&&i.push(s),r=l}return i},getNormalizeBounds:function(t,i){var o=t.getNorthWest(),r=t.getSouthEast(),s=o.lng,a=r.lng,l=(a-s)/2,h=null,u=null,c=[];if(l>=180)s=-180,a=180;else if(a>180||-180>s){var d=(a+s)/2%360;d>180?d-=360:-180>d&&(d+=360),s=d-l,a=d+l,-180>s?(h=s+360,u=180,s=-180):a>180&&(h=-180,u=a-360,a=180)}var p={x:s,y:r.lat},m={x:a,y:o.lat};if(void 0!==i&&(p=e.Projection.Mercator.project(new e.LatLng([r.lat,s])),m=e.Projection.Mercator.project(new e.LatLng([o.lat,a])),p.y-=i,m.y-=i),c.push(n.bounds([[p.x,p.y],[m.x,m.y]])),h){var f={x:h,y:r.lat},g={x:u,y:o.lat};void 0!==i&&(f=e.Projection.Mercator.project(new e.LatLng([r.lat,h])),g=e.Projection.Mercator.project(new e.LatLng([o.lat,u])),f.y-=i,g.y-=i),c.push(n.bounds([[f.x,f.y],[g.x,g.y]]))}return c},toPrecision:function(t,e){var i=Math.pow(10,e?e:4);return Math.round(i*t)/i},getTileBounds:function(t,e,i){var o=n.tileSizes[i],r=t*o,s=e*o;return n.bounds([[r,s],[r+o,s+o]])},parseTemplate:function(t,e){var i=t.match(/\[([^\]]+)\]/gi);if(i)for(var n=0,o=i.length;o>n;n++){var r=i[n],s=r.substr(1,r.length-2),a=s in e?e[s]:"";t=t.replace(r,a)}return t},getDefaultBalloonTemplate:function(t){var e="";for(var i in t)e+="<b>"+i+":</b> ["+i+"]<br />";return e+="<br />[SUMMARY]<br />"},parseBalloonTemplate:function(t,i){var o=i.properties;t||(t=n.getDefaultBalloonTemplate(o));var r=t.match(/\[([^\]]+)\]/gi);if(r)for(var s=i.tileAttributeTypes,a=i.unitOptions,l=i.geometries,h=0,u=r.length;u>h;h++){var c=r[h],d=c.substr(1,c.length-2),p="";d in o?p=e.gmxUtil.attrToString(s[d],o[d]):"SUMMARY"===d&&(p=i.summary||e.gmxUtil.getGeometriesSummary(l,a)),t=t.replace(c,p)}return t},styleKeys:{marker:{server:["image","angle","scale","minScale","maxScale","size","circle","center","color"],client:["iconUrl","iconAngle","iconScale","iconMinScale","iconMaxScale","iconSize","iconCircle","iconCenter","iconColor"]},outline:{server:["color","opacity","thickness","dashes"],client:["color","opacity","weight","dashArray"]},fill:{server:["color","opacity","image","pattern","radialGradient","linearGradient"],client:["fillColor","fillOpacity","fillIconUrl","fillPattern","fillRadialGradient","fillLinearGradient"]},label:{server:["text","field","template","color","haloColor","size","spacing","align"],client:["labelText","labelField","labelTemplate","labelColor","labelHaloColor","labelFontSize","labelSpacing","labelAlign"]}},styleFuncKeys:{iconSize:"iconSizeFunction",iconAngle:"rotateFunction",iconScale:"scaleFunction",iconColor:"iconColorFunction",opacity:"opacityFunction",fillOpacity:"fillOpacityFunction",color:"colorFunction",fillColor:"fillColorFunction"},styleFuncError:{iconSize:function(){return 8},iconAngle:function(){return 0},iconScale:function(){return 1},iconColor:function(){return 255},opacity:function(){return 1},fillOpacity:function(){return.5},color:function(){return 255},fillColor:function(){return 255}},defaultStyles:{MinZoom:1,MaxZoom:21,Filter:"",Balloon:"",DisableBalloonOnMouseMove:!0,DisableBalloonOnClick:!1,RenderStyle:{point:{color:255,weight:1,iconSize:8},linestring:{color:255,weight:1},polygon:{color:255,weight:1}}},getDefaultStyle:function(t){var i=n.defaultStyles,o=e.extend({},i);return o.RenderStyle=i.RenderStyle[t],o},toServerStyle:function(t){var e={};for(var i in n.styleKeys)for(var o=n.styleKeys[i],r=0,s=o.client.length;s>r;r++){var a=o.client[r];if(a in t){e[i]||(e[i]={});var l=t[a];("opacity"===a||"fillOpacity"===a)&&(l*=100),e[i][o.server[r]]=l}}return"iconAnchor"in t&&(e.marker||(e.marker={}),e.marker.dx=-t.iconAnchor[0],e.marker.dy=-t.iconAnchor[1]),e},fromServerStyle:function(t){var i,o,r,s,a={type:""};for(var l in n.styleKeys){var h=n.styleKeys[l];for(o=0,r=h.client.length;r>o;o++)s=h.client[o],s in t&&(a[s]=t[s]);if(i=t[l],i&&"object"==typeof i)for(o=0,r=h.server.length;r>o;o++)if(s=h.server[o],s in i){var u=h.client[o],c=i[s];if("string"==typeof c){if(n.styleFuncKeys[u])if(null===c.match(/[^\d\.]/))c=Number(c);else{var d=e.gmx.Parsers.parseExpression(c);null===d?c=n.styleFuncError[u]():a[n.styleFuncKeys[u]]=d}}else"opacity"===s&&(c/=100);a[u]=c}}if(t.marker&&(i=t.marker,"dx"in i||"dy"in i)){var p=i.dx||0,m=i.dy||0;a.iconAnchor=[-p,-m]}return a},getUnixTimeFromStr:function(t){var i=e.Util.trim(t).split(" ");return i=i[0].split("."),4===i[2].length&&(i=i.reverse()),Date.UTC(i[0],i[1]-1,i[2])/1e3},getDateFromStr:function(t){var i=e.Util.trim(t).split(" ");i=i[0].split("."),4===i[2].length&&(i=i.reverse());var n=new Date(i[0],i[1]-1,i[2]);return n},getUTCdate:function(t){var e=new Date(1e3*t);return[e.getUTCFullYear(),n.pad2(e.getUTCMonth()+1),n.pad2(e.getUTCDate())].join(".")},getUTCtime:function(t){var e=Math.floor(t/3600),i=Math.floor((t-3600*e)/60),o=Math.floor(t-3600*e-60*i);return[n.pad2(e),n.pad2(i),n.pad2(o)].join(":")},getUTCdateTime:function(t){var e=t%86400;return e?[n.getUTCdate(t),n.getUTCtime(t%86400)].join(" "):n.getUTCdate(t)},attrToString:function(t,i){return"date"===t?i?e.gmxUtil.getUTCdate(i):i:"time"===t?i?e.gmxUtil.getUTCtime(i):i:"datetime"===t?i?e.gmxUtil.getUTCdateTime(i):i:i},getTileAttributes:function(t){var e={},i={};if(t.attributes){var n=t.attributes,o=t.attrTypes||null;t.identityField&&(e[t.identityField]=0);for(var r=0;r<n.length;r++){var s=n[r];e[s]=r+1,i[s]=o?o[r]:"string"}}return{tileAttributeTypes:i,tileAttributeIndexes:e}}};n.lambertCoefX=100*n.distVincenty(0,0,.01,0),n.lambertCoefY=180*100*n.distVincenty(0,0,0,.01)/Math.PI,function(){for(var t=0;30>t;t++)n.tileSizes[t]=40075016.685578495/Math.pow(2,t)}(),n.Bounds=function(t){this.min={x:Number.MAX_VALUE,y:Number.MAX_VALUE},this.max={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},this.extendArray(t)},n.Bounds.prototype={extend:function(t,e){return t<this.min.x&&(this.min.x=t),t>this.max.x&&(this.max.x=t),e<this.min.y&&(this.min.y=e),e>this.max.y&&(this.max.y=e),this},extendBounds:function(t){return this.extendArray([[t.min.x,t.min.y],[t.max.x,t.max.y]])},extendArray:function(t){if(!t||!t.length)return this;var e,i;if("number"==typeof t[0])for(e=0,i=t.length;i>e;e+=2)this.extend(t[e],t[e+1]);else for(e=0,i=t.length;i>e;e++)this.extend(t[e][0],t[e][1]);return this},addBuffer:function(t,e,i,n){return this.min.x-=t,this.min.y-=e||t,this.max.x+=i||t,this.max.y+=n||e||t,this},contains:function(t){var e=this.min,i=this.max,n=t[0],o=t[1];return n>=e.x&&n<=i.x&&o>=e.y&&o<=i.y},getCenter:function(){var t=this.min,e=this.max;return[(t.x+e.x)/2,(t.y+e.y)/2]},addOffset:function(t){return this.min.x+=t[0],this.max.x+=t[0],this.min.y+=t[1],this.max.y+=t[1],this},intersects:function(t){var e=this.min,i=this.max,n=t.min,o=t.max;return o.x>e.x&&n.x<i.x&&o.y>e.y&&n.y<i.y},intersectsWithDelta:function(t,e,i){var n=this.min,o=this.max,r=e||0,s=i||0,a=t.min,l=t.max;return l.x+r>n.x&&a.x-r<o.x&&l.y+s>n.y&&a.y-s<o.y},isEqual:function(t){var e=this.min,i=this.max,n=t.min,o=t.max;return o.x===i.x&&n.x===e.x&&o.y===i.y&&n.y===e.y},isNodeIntersect:function(t){for(var e=0,i=t.length;i>e;e++)if(this.contains(t[e]))return{num:e,point:t[e]};return null},clipPolygon:function(t){var e,i,n,o,r=this.min,s=this.max,a=[[r.x,r.y],[s.x,r.y],[s.x,s.y],[r.x,s.y]],l=function(t){return(i[0]-e[0])*(t[1]-e[1])>(i[1]-e[1])*(t[0]-e[0])},h=function(){var t=[e[0]-i[0],e[1]-i[1]],r=[n[0]-o[0],n[1]-o[1]],s=e[0]*i[1]-e[1]*i[0],a=n[0]*o[1]-n[1]*o[0],l=1/(t[0]*r[1]-t[1]*r[0]);return[(s*r[0]-a*t[0])*l,(s*r[1]-a*t[1])*l]},u=t;e=a[3];for(var c=0;4>c;c++){i=a[c];var d=u,p=d.length;u=[],n=d[p-1];for(var m=0;p>m;m++)o=d[m],l(o)?(l(n)||u.push(h()),u.push(o)):l(n)&&u.push(h()),n=o;e=i}return u},clipPolyLine:function(t,e,i){i=i||0;var n,o,r,s,a,l,h=this.min,u=this.max,c=[h.x-i,h.y-i,u.x+i,u.y+i],d=function(t){var e=0;return t[0]<c[0]?e|=1:t[0]>c[2]&&(e|=2),t[1]<c[1]?e|=4:t[1]>c[3]&&(e|=8),e},p=function(t,e){return Math.PI/2+Math.atan2(e[1]-t[1],t[0]-e[0])},m=function(t,e,i){return 8&i?[t[0]+(e[0]-t[0])*(c[3]-t[1])/(e[1]-t[1]),c[3]]:4&i?[t[0]+(e[0]-t[0])*(c[1]-t[1])/(e[1]-t[1]),c[1]]:2&i?[c[2],t[1]+(e[1]-t[1])*(c[2]-t[0])/(e[0]-t[0])]:1&i?[c[0],t[1]+(e[1]-t[1])*(c[0]-t[0])/(e[0]-t[0])]:null},f=[],g=t.length,_=d(t[0],c),v=[];for(n=1;g>n;n++)if(o=t[n-1],r=t[n],o[0]!==r[0]||o[1]!==r[1]){for(a=l=d(r,c);;){if(!(_|a)){e&&(o[2]=p(o,r),s=t[n+1],r[2]=s?p(r,s):o[2]),v.push(o),a!==l?(v.push(r),g-1>n&&(f.push(v),v=[])):n===g-1&&v.push(r);break}if(_&a)break;_?(o=m(o,r,_,c),_=d(o,c)):(r=m(o,r,a,c),a=d(r,c))}_=l}return v.length&&f.push(v),f}},n.bounds=function(t){return new n.Bounds(t)},n.parseUri=function(t){for(var e=n.parseUri.options,i=e.parser[e.strictMode?"strict":"loose"].exec(t),o={},r=14;r--;)o[e.key[r]]=i[r]||"";return o[e.q.name]={},o[e.key[12]].replace(e.q.parser,function(t,i,n){i&&(o[e.q.name][i]=n)}),o.hostOnly=o.host,o.host=o.authority,o},n.parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},e.gmxUtil||(e.gmxUtil={}),e.extend(e.gmxUtil,{newId:n.newId,loaderStatus:function(){},isIE9:n.isIE(9),isIE10:n.isIE(10),isIE11:n.isIE(11),gtIE11:n.gtIE(11),requestJSONP:n.requestJSONP,getCadastreFeatures:n.getCadastreFeatures,request:n.request,getLayerItemFromServer:n.getLayerItemFromServer,fromServerStyle:n.fromServerStyle,toServerStyle:n.toServerStyle,getDefaultStyle:n.getDefaultStyle,bounds:n.bounds,getGeometryBounds:n.getGeometryBounds,tileSizes:n.tileSizes,getDateFromStr:n.getDateFromStr,getUnixTimeFromStr:n.getUnixTimeFromStr,getUTCdate:n.getUTCdate,getUTCtime:n.getUTCtime,getUTCdateTime:n.getUTCdateTime,attrToString:n.attrToString,getTileAttributes:n.getTileAttributes,formatCoordinates:function(t,e){return n["formatCoordinates"+(e?"2":"")](t.lng,t.lat)},formatDegrees:n.formatDegrees,pad2:n.pad2,dec2hex:n.dec2hex,dec2rgba:n.dec2rgba,trunc:n.trunc,latLonFormatCoordinates:n.latLonFormatCoordinates,latLonFormatCoordinates2:n.latLonFormatCoordinates2,getLength:n.getLength,geoLength:n.geoLength,prettifyDistance:n.prettifyDistance,getArea:n.getArea,prettifyArea:n.prettifyArea,geoArea:n.geoArea,parseBalloonTemplate:n.parseBalloonTemplate,getSVGIcon:n.getSVGIcon,getCoordinatesString:n.getCoordinatesString,getGeometriesSummary:n.getGeometriesSummary,getGeometrySummary:n.getGeometrySummary,getGeoJSONSummary:n.getGeoJSONSummary,getPropertiesHash:n.getPropertiesHash,distVincenty:n.distVincenty,parseCoordinates:n.parseCoordinates,geometryToGeoJSON:n.geometryToGeoJSON,convertGeometry:n.convertGeometry,transformGeometry:n.transformGeometry,geoJSONtoGeometry:n.geoJSONtoGeometry,geoJSONGetArea:n.geoJSONGetArea,geoJSONGetLength:n.geoJSONGetLength,geoJSONGetLatLng:n.geoJSONGetLatLng,parseUri:n.parseUri,isRectangle:n.isRectangle,isClockwise:n.isClockwise,isPointInPolygonWithHoles:n.isPointInPolygonWithHoles,getPatternIcon:n.getPatternIcon,getCircleLatLngs:n.getCircleLatLngs,normalizeHostname:n.normalizeHostname,getTileBounds:n.getTileBounds,parseTemplate:n.parseTemplate}),function(){function t(t,r,s){var a="gmxAPIutils_id"+o++,l=e.DomUtil.create("iframe");l.style.display="none",l.setAttribute("id",t),l.setAttribute("name",t),l.src="javascript:true",l.callbackName=a;var h=n.parseUri(s),u=(h.protocol?h.protocol+":":window.location.protocol)+"//"+(h.host||window.location.host);return i[u]=i[u]||{},i[u][a]={callback:r,iframe:l},l}var i={},o=0,r=function(t){if(t.origin in i){var e=decodeURIComponent(t.data.replace(/\n/g,"\n\\"));try{var n=JSON.parse(e)}catch(o){console.log({Status:"error",ErrorInfo:{ErrorMessage:"JSON.parse exeption",ExceptionType:"JSON.parse",StackTrace:e}})}var r=i[t.origin][n.CallbackName];r&&(delete i[t.origin][n.CallbackName],delete n.CallbackName,r.iframe.parentNode&&r.iframe.parentNode.removeChild(r.iframe),"callback"in r&&r.callback(n))}};e.DomEvent.on(window,"message",r),n.createPostIframe2=t}(),function(){function t(t,i,o,r){var s,a,l="$$iframe_"+n.newId(),h=n.createPostIframe2(l,o,t);if(r)s=r,a=s.getAttribute("action"),s.setAttribute("action",t),s.target=l;else if(e.Browser.ielt9){var u="<form id="+l+'" enctype="multipart/form-data" style="display:none" target="'+l+'" action="'+t+'" method="post"></form>';s=document.createElement(u)}else s=document.createElement("form"),s.style.display="none",s.setAttribute("enctype","multipart/form-data"),s.target=l,s.setAttribute("method","POST"),s.setAttribute("action",t),s.id=l;var c=document.createElement("div");c.style.display="none","window"===i.WrapStyle&&(i.WrapStyle="message"),"message"===i.WrapStyle&&(i.CallbackName=h.callbackName);for(var d in i){var p=document.createElement("input"),m="undefined"!=typeof i[d]?i[d]:"";p.setAttribute("type","hidden"),p.setAttribute("name",d),p.setAttribute("value",m),c.appendChild(p)}s.appendChild(c),r||document.body.appendChild(s),document.body.appendChild(h),s.submit(),r?(s.removeChild(c),null!==a?s.setAttribute("action",a):s.removeAttribute("action")):s.parentNode.removeChild(s)}e.gmxUtil.sendCrossDomainPostRequest=n.sendCrossDomainPostRequest=t}();var o=["strokeStyle","fillStyle","lineWidth"],r=o.length,s=n,a=function(t,e,i,n){for(var a=0;r>a;a++){var l=o[a],h=n[l];h!==i[l]&&(i[l]=h)}if(n.dashArray){var u=n.dashArray,c=n.dashOffset||0;"setLineDash"in i&&(i.setLineDash(u),i.lineDashOffset!==c&&(i.lineDashOffset=c))}else"getLineDash"in i&&i.getLineDash().length>0&&i.setLineDash([]);if("round"!==i.lineCap&&(i.lineCap="round"),"round"!==i.lineJoin&&(i.lineJoin="round"),n.canvasPattern)i.fillStyle=i.createPattern(n.canvasPattern.canvas,"repeat");else if(n.fillLinearGradient){for(var d=n.fillLinearGradient,p=d.x1Function?d.x1Function(t,e):d.x1,m=d.y1Function?d.y1Function(t,e):d.y1,f=d.x2Function?d.x2Function(t,e):d.x2,g=d.y2Function?d.y2Function(t,e):d.y2,_=i.createLinearGradient(p,m,f,g),v=0,y=d.addColorStop.length;y>v;v++){var x=d.addColorStop[v],L=d.addColorStopFunctions[v],b=L[0]?L[0](t,e):x[0],P=x.length<3?100:L[2]?L[2](t,e):x[2],S=s.dec2color(L[1]?L[1](t,e):x[1],P>1?P/100:P);_.addColorStop(b,S)}i.fillStyle=n.fillStyle=_}};e.gmxUtil.drawGeoItem=function(t,i,n,o,r){var l,h,u,c,d=t.properties,p=d[0],m=n.gmx,f=n.ctx,g=d[d.length-1],_=null,v=t.dataOption,y=n.rasters||{},x=n.tbounds;if(i.currentStyle=e.extend({},o),r){if(m.styleHook){if(t.styleExtend||(t.styleExtend=m.styleHook(i,m.lastHover&&p===m.lastHover.id)),!t.styleExtend)return!1;
i.currentStyle=e.extend(i.currentStyle,t.styleExtend)}a(d,m.tileAttributeIndexes,f,i.currentStyle)}else r={};var L=g.type,b={gmx:m,item:i,style:r,styleExtend:t.styleExtend||{},ctx:f,tpx:n.tpx,tpy:n.tpy};if("POINT"===L&&(b.pointAttr=s.getPixelPoint(b,g.coordinates),!b.pointAttr))return!1;if("POINT"===L||"MULTIPOINT"===L)if(_=g.coordinates,"iconColor"in r&&r.image&&(r.lastImage!==r.image&&(r.lastImage=r.image,r.lastImageData=s.getImageData(r.image)),b.imageData=r.lastImageData),"MULTIPOINT"===L)for(l=0,h=_.length;h>l;l++)b.coords=_[l],s.pointToCanvas(b);else b.coords=_,s.pointToCanvas(b);else if("POLYGON"===L||"MULTIPOLYGON"===L)if(r.image)b.coords=[(v.bounds.min.x+v.bounds.max.x)/2,(v.bounds.min.y+v.bounds.max.y)/2],b.pointAttr=s.getPixelPoint(b,b.coords),b.pointAttr&&s.pointToCanvas(b);else{_=g.coordinates,"POLYGON"===L&&(_=[_]);var P=v.hiddenLines||[],S=v.pixels,T=!0;S&&S.z===m.currentZoom||(S=v.pixels=s.getCoordsPixels({gmx:m,coords:_,tpx:n.tpx,tpy:n.tpy,hiddenLines:P}));var w=function(t,e){for(_=S.coords,P=S.hidden||[],b.flagPixels=T,l=0,h=_.length;h>l;l++){var i=_[l],n=P[l]||[];for(f.beginPath(),u=0,c=i.length;c>u;u++)b.coords=i[u],b.hiddenLines=n[u]||[],t(b);f.closePath(),e&&f.fill()}},C=i.currentStyle.strokeStyle||r.strokeStyle,M=i.currentStyle.lineWidth||r.lineWidth;C&&M&&w(s.polygonToCanvas),n.bgImage?b.bgImage=n.bgImage:y[p]&&(b.bgImage=y[p]),(b.styleExtend.skipRasters||i.skipRasters)&&delete b.bgImage,r.imagePattern?i.currentStyle.fillStyle=f.createPattern(r.imagePattern,"repeat"):b.bgImage&&x.intersectsWithDelta(v.bounds,-1,-1)&&(s.isPatternNode(b.bgImage)&&("rasterOpacity"in m&&(f.globalAlpha=m.rasterOpacity),f.fillStyle=f.createPattern(b.bgImage,"no-repeat"),r.bgImage=!0),w(s.polygonToCanvasFill,!0),f.globalAlpha=1),(i.currentStyle.fillStyle||i.currentStyle.canvasPattern)&&(f.fillStyle=i.currentStyle.canvasPattern||i.currentStyle.fillStyle,w(s.polygonToCanvasFill,!0))}else if("LINESTRING"===L||"MULTILINESTRING"===L){_=g.coordinates,"LINESTRING"===L&&(_=[_]);var D=(i.currentStyle.maxSize||i.currentStyle.lineWidth)/m.mInPixel;for(l=0,h=_.length;h>l;l++){var I=x.clipPolyLine(_[l],!0,D);for(u=0,c=I.length;c>u;u++){b.coords=I[u];var k=s.lineToCanvas(b);k&&(f.save(),s.lineToCanvasAsIcon(k,b),f.restore())}}}return!0};var l={APIKEY_PARAM:"key",SCRIPT_REGEXP:[/\bleaflet-geomixer(-\w*)?\.js\b/,/\bgeomixer(-\w*)?\.js\b/],_scriptSearched:!1,_scriptAPIKey:null,_searchScriptAPIKey:function(){var t=this;if(this._scriptSearched)return this._scriptAPIKey;for(var e=document.getElementsByTagName("script"),i=0;i<e.length;i++){for(var n=e[i].getAttribute("src"),o=this.SCRIPT_REGEXP,r=0,s=o.length;s>r;r++)if(o[r].exec(n)){var a=n.split("?")[1];if(a)for(var l=a.split("&"),h=0;h<l.length;h++){var u=l[h].split("=");if(u[0]===t.APIKEY_PARAM){t._scriptAPIKey=u[1];break}}break}if(t._scriptAPIKey)break}return this._scriptSearched=!0,this._scriptAPIKey},requestSessionKey:function(t,i){var o=this._sessionKeys;return t in o||(i="undefined"==typeof i?this._searchScriptAPIKey():i,o[t]=new e.gmx.Deferred,i?n.requestJSONP("http://"+t+"/ApiKey.ashx",{WrapStyle:"func",Key:i}).then(function(e){e&&"ok"===e.Status?o[t].resolve(e.Result.Key):o[t].reject()},o[t].reject):o[t].resolve("")),o[t]},getSessionKey:function(t){var e=this._sessionKeys[t];return e&&e.getFulfilledData()&&e.getFulfilledData()[0]},_sessionKeys:{}};e.gmx=e.gmx||{},e.gmx.gmxSessionManager=l;var h={getMap:function(t,i,o,r){var s=this._maps;if(!s[t]||!s[t][o]){var a=new e.gmx.Deferred;s[t]=s[t]||{},s[t][o]={promise:a},l.requestSessionKey(t,i).then(function(e){n.requestJSONP("http://"+t+"/TileSender.ashx",{WrapStyle:"func",skipTiles:r||"None",key:e,MapName:o,ModeKey:"map"}).then(function(e){e&&"ok"===e.Status&&e.Result?(e.Result.properties.hostName=t,a.resolve(e.Result)):a.reject(e)},a.reject)},a.reject)}return s[t][o].promise},findLayerInfo:function(t,e,i){var n=this._maps[t],o=n&&n[e];if(!o)return null;if(o.layers)return o.layers[i];var r=o.promise.getFulfilledData();return r?(o.layers={},h.iterateLayers(r[0],function(t){o.layers[t.properties.name]=t}),o.layers[i]):null},iterateLayers:function(t,e){var i=function(t){for(var n=0,o=t.length;o>n;n++){var r=t[n];"group"===r.type?i(r.content.children):"layer"===r.type&&e(r.content)}};t&&i(t.children)},_maps:{}};e.gmx.gmxMapManager=h;var u=function(t,i){this.layers=[],this.layersByTitle={},this.layersByID={},this.dataManagers={};var n=this;this.properties=e.extend({},t.properties),this.properties.BaseLayers=this.properties.BaseLayers?JSON.parse(this.properties.BaseLayers):[],this.rawTree=t,this.layersCreated=new e.gmx.Deferred;var o={},r={};h.iterateLayers(t,function(s){var a=s.properties,l=a.MetaProperties||{},h={mapID:t.properties.name,layerID:a.name};a.hostName=t.properties.hostName;var u=a.ContentID||a.type,c=e.extend(h,i);"parentLayer"in l?(c.parentLayer=l.parentLayer.Value||"",r[h.layerID]={info:s,options:c}):u in e.gmx._layerClasses?n.addLayer(e.gmx.createLayer(s,c)):(o[u]=o[u]||[],o[u].push({info:s,options:c}))});var s=[];for(var a in o)s.push(e.gmx._loadLayerClass(a).then(function(t){for(var i=o[t],r=0,s=i.length;s>r;r++)n.addLayer(e.gmx.createLayer(i[r].info,i[r].options))}.bind(null,a)));var l,u,c,d={};for(u in r){c=r[u];var p=c.options,m=p.parentLayer,f=this.layersByID[m];f?(c.options.parentOptions=f.getGmxProperties(),c.options.dataManager=this.dataManagers[m]||new g(c.options.parentOptions),this.dataManagers[m]=c.options.dataManager,this.addLayer(e.gmx.createLayer(c.info,c.options))):(l=p.hostName,d[l]||(d[l]={}),d[l][m]||(d[l][m]=[]),d[l][m].push(u))}for(l in d){var _=[],v="http://"+l;for(u in d[l])_.push({Layer:u});s.push(e.gmxUtil.requestJSONP(v+"/Layer/GetLayerJson.ashx",{WrapStyle:"func",Layers:JSON.stringify(_)},{ids:d[l]}).then(function(t,i){if(t&&"ok"===t.Status&&t.Result)t.Result.forEach(function(t){var o=n.addDataManager(t),s=t.properties,a=s.name;i&&i.ids&&i.ids[a]&&i.ids[a].forEach(function(i){var s=r[i];s.options.parentOptions=t.properties,s.options.dataManager=o,n.addLayer(e.gmx.createLayer(s.info,s.options))})});else if(console.info("Error: loading ",v+"/Layer/GetLayerJson.ashx",t.ErrorInfo),i&&i.ids)for(var o in i.ids)i.ids[o].forEach(function(t){n.addLayer(new e.gmx.DummyLayer(r[t].info.properties))})}))}e.gmx.Deferred.all.apply(null,s).then(this.layersCreated.resolve)};u.prototype={addDataManager:function(t){var e=t.properties.name;return this.dataManagers[e]||(this.dataManagers[e]=new g(t.properties)),this.dataManagers[e]},getDataManager:function(t){return this.dataManagers[t]},addLayer:function(t){var e=t.getGmxProperties();return this.layers.push(t),this.layersByTitle[e.title]=t,this.layersByID[e.name]=t,this},removeLayer:function(t){for(var e=t.getGmxProperties(),i=0;i<this.layers.length;i++)if(this.layers[i].getGmxProperties().name===e.name){this.layers.splice(i,1);break}return delete this.layersByTitle[e.title],delete this.layersByID[e.name],this},addLayersToMap:function(t){for(var e=this.layers.length-1;e>=0;e--){var i=this.layers[e];i.getGmxProperties().visible&&t.addLayer(i)}return this}};var c=e.Handler.extend({options:{},initialize:function(t){this._map=t,this._layers={},this._lastLayer=null,this._lastId=null;var i=this;this._drawstart=null,this._lastCursor="";var n=function(){if(i._drawstart)return!0;if(null===i._drawstart){if(t.gmxControlsManager){var e=t.gmxControlsManager.get("drawing");e&&e.on("activechange",function(e){i._drawstart=e.activeIcon,t._container.style.cursor=i._drawstart?"pointer":""})}i._drawstart=!1}return!1},o=function(t){var e=t._container;if(e)for(var i=e.parentNode.childNodes,n=0,o=i.length;o>n;n++)if(e===i[n])return n;return 0},r={IMG:!0,DIV:!0,path:!0},s=function(){i._lastLayer&&(i._lastLayer.gmxEventCheck({type:"mousemove"},!0),i._lastLayer=null)},a=function(t){var o=t.type,a=i._map,l=!1;if(t.originalEvent){a.gmxMouseDown=e.Browser.webkit?t.originalEvent.which:t.originalEvent.buttons;var h=t.originalEvent.target;l=r[h.nodeName]&&!e.DomUtil.hasClass(h,"leaflet-tile")&&!e.DomUtil.hasClass(h,"leaflet-popup-tip-container")}if(a._animatingZoom||n()||l||"click"===o&&a._skipClick||"mousemove"===o&&a.gmxMouseDown)return s(),a._skipClick=!1,void 0;t.layerPoint&&(a._gmxMouseLatLng=t.latlng,a.gmxMousePos=a.getPixelOrigin().add(t.layerPoint));for(var u,c=Object.keys(i._layers).sort(function(t,e){var n=a._layers[t],o=a._layers[e];if(n&&o){var r=n.options,s=o.options,l=(r.zIndexOffset||0)+(r.zIndex||0),h=(s.zIndexOffset||0)+(s.zIndex||0),u=h-l;return u?u:i._layers[e]-i._layers[t]}return 0}),d=null,p="",m=0,f=c.length;f>m;m++){var g=c[m];if(u=a._layers[g],u&&u._map&&!u._animating&&u.options.clickable&&u.gmxEventCheck(t)){u.hasEventListeners("mouseover")&&(p="pointer"),d=u;break}}i._lastCursor===p||n()||(a._container.style.cursor=p),i._lastCursor=p,"zoomend"!==o&&(d?(i._lastLayer!==d&&s(),i._lastLayer=d):s())};t.on({zoomend:function(){t._gmxMouseLatLng&&setTimeout(function(){a({type:"mousemove",latlng:t._gmxMouseLatLng})},0)},click:a,dblclick:a,mousedown:a,mouseup:a,mousemove:a,contextmenu:a,layeradd:function(t){var e=t.layer;"gmxEventCheck"in e&&e.options.clickable&&(i._layers[e._leaflet_id]=o(e))},layerremove:function(t){var e=t.layer._leaflet_id;delete i._layers[e],i._lastLayer&&i._lastLayer._leaflet_id===e&&(i._lastLayer=null,i._lastId=0)}},this)}});e.Map.addInitHook(function(){this._gmxEventsManager||(this._gmxEventsManager=new c(this),this.isGmxDrawing=function(){return this._gmxEventsManager._drawstart},this.on("remove",function(){this._gmxEventsManager&&this._gmxEventsManager.removeHooks()}))}),function(){var t="rus",i=function(t,e,i,n){n[t]||(n[t]={}),n[t][e]=i};e.gmxLocale={setLanguage:function(t){this._language=t},getLanguage:function(){return window.language||this._language||t}},e.gmxLocaleMixin={addText:function(){var t=arguments[0],e=arguments[1];1===arguments.length&&(e=t,t=null);for(var n in e)if(null===t)for(var o in e[n])i(n,o,e[n][o],this);else i(t,n,e[n],this);return this},getText:function(t){for(var i=e.gmxLocale.getLanguage(),n=this[i]||{},o=t?t.split(/\./):[],r=0,s=o.length;s>r&&n;r++)n=n[o[r]];return n}},e.extend(e.gmxLocale,e.gmxLocaleMixin)}(),e.extend(e.gmxLocale,{rus:{Coordinates:"",Length:"",nodeLength:"  ",edgeLength:" ",Area:"",Perimeter:"",units:{m:"",nm:".",km:"",m2:". ",km2:". ",ha:"",m2html:"<sup>2",km2html:"<sup>2"}}}),e.extend(e.gmxLocale,{eng:{Coordinates:"Coordinates",Length:"Length",nodeLength:"From start point",edgeLength:"Segment length",Area:"Area",Perimeter:"Perimeter",units:{m:"m",nm:"nmi",km:"km",m2:"sq. m",km2:"sq. km",ha:"ha",m2html:"m<sup>2",km2html:"km<sup>2"}}});var d={_loadedTiles:{},_getKey:function(t){return[t.layerID,t.x,t.y,t.z,"undefined"==typeof t.d?-1:t.d,"undefined"==typeof t.s?-1:t.s,t.v].join(":")},load:function(t,i){var o=d._getKey(i);if(!this._loadedTiles[o]){var r=new e.gmx.Deferred;this._loadedTiles[o]=r;var s={ModeKey:"tile",r:"j",LayerName:i.layerID,z:i.z,x:i.x,y:i.y,v:i.v};-1!==i.d&&(s.Level=i.d,s.Span=i.s),n.requestJSONP(t,s,{callbackParamName:null}).then(null,function(){r.reject()})}return this._loadedTiles[o]}};window.gmxAPI=window.gmxAPI||{},window.gmxAPI._vectorTileReceiver=window.gmxAPI._vectorTileReceiver||function(t){var e=d._getKey({layerID:t.LayerName,x:t.x,y:t.y,z:t.z,d:t.level,s:t.span,v:t.v});d._loadedTiles[e]&&d._loadedTiles[e].resolve(t.values,t.bbox)};var p=function(t,i){this.dataProvider=t,this.loadDef=new e.gmx.Deferred,this.data=null,this.dataOptions=null,this.x=i.x,this.y=i.y,this.z=i.z,this.v=i.v,this.s=i.s||-1,this.d=i.d||-1,this.isGeneralized=i.isGeneralized,this.isFlatten=i.isFlatten,this.bounds=n.getTileBounds(this.x,this.y,this.z),this.gmxTilePoint={x:this.x,y:this.y,z:this.z,s:this.s,d:this.d},this.vectorTileKey=p.makeTileKey(this.x,this.y,this.z,this.v,this.s,this.d),this.s>=0&&i.dateZero&&(this.beginDate=new Date(i.dateZero.valueOf()+1e3*this.s*this.d*n.oneDay),this.endDate=new Date(i.dateZero.valueOf()+1e3*(this.s+1)*this.d*n.oneDay)),this.state="notLoaded"};p.prototype={addData:function(t,e){e&&this.removeData(e,!0);for(var i=t.length,o=new Array(i),r=n.bounds(),s=0;i>s;s++){var a=this._parseItem(t[s]);o[s]=a,r.extendBounds(a.bounds)}return this.data?(this.data=this.data.concat(t),this.dataOptions=this.dataOptions.concat(o)):(this.data=t,this.dataOptions=o),this.state="loaded",this.loadDef.resolve(this.data),r},removeData:function(t){for(var e=this.data||[],i=e.length-1;i>=0;i--)t[e[i][0]]&&(e.splice(i,1),this.dataOptions&&this.dataOptions.splice(i,1))},load:function(){if("notLoaded"===this.state){this.state="loading";var t=this;this.dataProvider.load(t.x,t.y,t.z,t.v,t.s,t.d,function(e,i){t.bbox=i,t.addData(e)})}return this.loadDef},clear:function(){this.state="notLoaded",this.data=null,this.dataOptions=null,this.loadDef=new e.gmx.Deferred},_parseItem:function(t){var e,i=t.length;for(e=0;i>e;e++)null===t[e]&&(t[e]="");var o=t[i-1],r=this.isFlatten,s=o.type,a=-1!==s.indexOf("POLYGON")||-1!==s.indexOf("Polygon"),l="POLYGON"===s||"Polygon"===s,h=o.coordinates,u=[],c=null,d=[];if(a){l&&(h=[h]),c=n.bounds();var p=n.bounds().extendBounds(this.bounds).addBuffer(-.05),m=!1;for(e=0,i=h.length;i>e;e++){for(var f=[],g=[],_=0,v=h[e].length;v>_;_++){r&&"number"!=typeof h[e][_][0]&&(h[e][_]=n.flattenRing(h[e][_]));var y=n.bounds(h[e][_]);f.push(y),0===_&&c.extendBounds(y);var x=n.getHidden(h[e][_],p);g.push(x),x.length&&(m=!0)}d.push(f),u.push(g)}m||(u=null),l&&(d=d[0])}else if("POINT"===s||"Point"===s)c=n.bounds([h]);else if("MULTIPOINT"===s||"MultiPoint"===s)for(c=n.bounds(),e=0,i=h.length;i>e;e++)c.extendBounds(n.bounds([h[e]]));else if("LINESTRING"===s||"LineString"===s)c=n.bounds(h);else if("MULTILINESTRING"===s||"MultiLineString"===s)for(c=n.bounds(),e=0,i=h.length;i>e;e++)c.extendBounds(n.bounds(h[e]));var L={bounds:c,boundsArr:d};return u&&(L.hiddenLines=u),L}},p.makeTileKey=function(t,e,i,n,o,r){return i+"_"+t+"_"+e+"_"+n+"_"+o+"_"+r},p.createTileKey=function(t){return[t.z,t.x,t.y,t.v,t.s,t.d].join("_")},p.parseTileKey=function(t){var e=t.split("_").map(function(t){return Number(t)});return{z:e[0],x:e[1],y:e[2],v:e[3],s:e[4],d:e[5]}},p.boundsFromTileKey=function(t){var e=p.parseTileKey(t);return n.getTileBounds(e.x,e.y,e.z)};var m=e.Class.extend({includes:e.Mixin.Events,initialize:function(t){this.type=t.type||"update",this._callback=t.callback,this._items=null,this.bbox=t.bbox,this.filters=t.filters||[],this.targetZoom=t.targetZoom||null,this.active="active"in t?t.active:!0,t.bounds&&this.setBounds(t.bounds);var e,i=n.worldWidthMerc;this.bbox?this.bbox.max.x>i?(e=this.bbox.max.x-i,this.bbox1=n.bounds([[e-i,this.bbox.max.y],[-(e+i),this.bbox.min.y]])):this.bbox.min.x<-i&&(e=this.bbox.min.x+i,this.bbox1=n.bounds([[e+i,this.bbox.max.y],[i-e,this.bbox.min.y]])):(this.bbox=n.bounds([[-i,-i],[i,i]]),this.world=!0),t.dateInterval&&this._setDateInterval(t.dateInterval[0],t.dateInterval[1])},hasFilter:function(t){for(var e=0,i=this.filters.length;i>e;e++)if(this.filters[e]===t)return!0;return!1},activate:function(){return this.active||(this.active=!0,this.fire("activate")),this},deactivate:function(){return this.active&&(this.active=!1,this.fire("activate")),this},toggleActive:function(t){return t?this.activate():this.deactivate()},isActive:function(){return this.active},updateData:function(t){var e=t.length,i={count:e};if("update"===this.type){this._items||(this._items={});for(var n,o=this._items,r={},s=[],a=[],l=0;e>l;l++){var h=t[l];n=h.id+"_"+h.tileKey,r[n]=h,o[n]||s.push(h)}for(n in o)r[n]||a.push(o[n]);s.length&&(i.added=s),a.length&&(i.removed=a),this._items=r}else i.added=t;return this._callback(i),i=null,t=null,this},removeData:function(t){if("update"!==this.type||!this._items)return this;var e=this._items,i=[];for(var n in t)e[n]&&(i.push(e[n]),delete e[n]);return i.length&&this._callback({removed:i}),this},setBounds:function(t){var i;if(!t)return this.world||(i=n.worldWidthMerc,this.bbox=n.bounds([[-i,-i],[i,i]]),this.bbox1=null,this.world=!0,this.fire("update")),this;var o=t.min,r=t.max;if(!o||!r){var s=e.latLngBounds(t),a=s.getSouthWest(),l=s.getNorthEast();o={x:a.lng,y:a.lat},r={x:l.lng,y:l.lat}}var h=o.x,u=r.x,c=o.y,d=r.y,p=null,m=null;if(this.world=!1,i=(u-h)/2,i>=180)h=-180,u=180,this.world=!0;else if(u>180||-180>h){var f=(u+h)/2%360;f>180?f-=360:-180>f&&(f+=360),h=f-i,u=f+i,-180>h?(p=h+360,m=180,h=-180):u>180&&(p=-180,m=u-360,u=180)}var g=e.Projection.Mercator.project(e.latLng(c,h)),_=e.Projection.Mercator.project(e.latLng(d,u));return this.bbox=n.bounds([[g.x,g.y],[_.x,_.y]]),this.bbox1=null,p&&(g=e.Projection.Mercator.project(e.latLng(c,p)),_=e.Projection.Mercator.project(e.latLng(d,m)),this.bbox1=n.bounds([[g.x,g.y],[_.x,_.y]])),this.fire("update"),this},intersects:function(t){return this.world||this.bbox.intersects(t)||!(!this.bbox1||!this.bbox1.intersects(t))},intersectsWithTile:function(t){if(this.targetZoom){var e=this.targetZoom+(this.targetZoom%2?1:0);if(t.isGeneralized&&t.z!==e||t.z>e)return!1}var i=this.dateInterval;return this.intersects(t.bounds)&&(!t.beginDate||i&&i.endDate>=t.beginDate&&i.beginDate<=t.endDate)},_setDateInterval:function(t,e){this.dateInterval=t&&e?{beginDate:t,endDate:e}:null},setDateInterval:function(t,e){var i=t&&e;return(!this.dateInterval!=!i||i&&(this.dateInterval.beginDate.valueOf()!==t.valueOf()||this.dateInterval.endDate.valueOf()!==e.valueOf()))&&(this._setDateInterval(t,e),this.fire("update",{temporalFilter:!0})),this}});e.gmx.observer=function(t){return new m(t)},function(){var t=function(t){var e=[],i=t.TemporalTiles||[],o=t.TemporalVers||[],r=t.TemporalPeriods||[],s=r[r.length-1],a=Number.MAX_VALUE,l=t.ZeroDate.split("."),h=new Date(l.length>2?l[2]:2008,l.length>1?l[1]-1:0,l.length>0?l[0]:1),u=new Date(h.getTime()-6e4*h.getTimezoneOffset()),c=u.getTime()/1e3;this.dateZero=u;var d,m,f=function(t,e,i){var o=t.d;if(e.d===r[o])return t.count++,t.tiles.push(i),void 0;var s=r[o-1],a=r[o]/s;"children"in t||(t.children=new Array(a));var l=Math.floor(e.s*e.d/s),h=l-t.s*a;if(!t.children[h]){var u=s*n.oneDay,d=l*u+c;t.children[h]={d:o-1,s:l,t1:d,t2:d+u,count:0,tiles:[]}}f(t.children[h],e,i)},g=r.length-1,_=r[g]*n.oneDay;for(d=0,m=i.length;m>d;d++){l=i[d];var v=Number(l[1]),y=Number(l[0]);y===s&&(a=Math.min(a,v))}for(d=0,m=i.length;m>d;d++){l=i[d];var x={x:Number(l[2]),y:Number(l[3]),z:Number(l[4]),v:Number(o[d]),s:Number(l[1]),d:Number(l[0])};if(!(x.d<0)){var L=Math.floor(x.s*x.d/r[g])-a,b=L+a;e[L]=e[L]||{d:g,s:b,t1:b*_+c,t2:(b+1)*_+c,count:0,tiles:[]};var P=p.createTileKey(x);f(e[L],x,P)}}i=o=null,this.selectTiles=function(t,i,n){n=n||{};for(var o=t.valueOf()/1e3,s=i.valueOf()/1e3,a=0,l=(s-o)/3600/24,h=0;h<r.length;h++)if(r[h]>l){a=Math.max(0,h-1);break}r[r.length-1]<=l&&(a=r.length-1);for(var u=Math.min(r.length-1,a+Number(l>r[a])),c=function(t,e){for(var i=0,n=0;n<t.length;n++)t[n].intersects(e)&&i++;return i},d=function(t,e,i){if(e>=t.t2||i<=t.t1)return{count:0,tiles:[],nodes:[]};if(n.bounds&&!t.tileBounds&&(t.tileBounds=t.tiles.map(function(t){return p.boundsFromTileKey(t)})),t.d===a){var o=n.bounds?c(t.tileBounds,n.bounds):t.count;return{tiles:t.tiles,count:o,nodes:[t]}}var r,s=0,l=[];for(r=0;r<t.children.length;r++)l[r]=t.children[r]?d(t.children[r],Math.max(e,t.t1),Math.min(i,t.t2)):{count:0,tiles:[],nodes:[]},s+=l[r].count;var h=n.bounds?c(t.tileBounds,n.bounds):t.count;if(t.d>u||h>s){var m=[],f=[];for(r=0;r<l.length;r++)f.push(l[r].nodes),m.push(l[r].tiles);return{tiles:[].concat.apply([],m),count:s,nodes:[].concat.apply([],f)}}return{tiles:t.tiles,count:h,nodes:[t]}},m=[],f=0;f<e.length;f++)if(e[f]){var g=d(e[f],o,s);g.tiles.length&&(m=m.concat(g.tiles))}for(var _={},v=0;v<m.length;v++)_[m[v]]=!0;return{tiles:_}},this.getNode=function(t,i){if(0>t||0>i)return null;for(var n=function(t,e,i){if(!t)return null;if(r[t.d]===e)return t.s===i?t:null;var o=r[t.d]/r[t.d-1],s=Math.floor(i*e/r[t.d-1]),a=s-t.s*o;return t.children[a]?n(t.children[a],e,i):null},o=0;o<e.length;o++){var s=n(e[o],t,i);if(s)return s}return null}};e.gmx.tilesTree=function(e){return new t(e)}}();var f=e.Class.extend({includes:e.Mixin.Events,initialize:function(t){this._dataManager=t,this._observerData={},this._tileData={}},addObserver:function(t){return this._observerData[t.id]={observer:t,tiles:{},leftToLoad:0,loadingState:!1},t.on("update",this._updateObserver.bind(this,t)),this._updateObserver(t),this},removeObserver:function(t){var e=this._observerData[t].tiles;for(var i in e)delete this._tileData[i].observers[t];return delete this._observerData[t],this},addTile:function(t){var e="loaded"===t.state?0:1;t.loadDef.then(this._tileLoadedCallback.bind(this,t));var i={};for(var n in this._observerData){var o=this._observerData[n];o.observer.intersectsWithTile(t)&&(o.tiles[t.vectorTileKey]=!0,o.leftToLoad+=e,i[n]=!0)}return this._tileData[t.vectorTileKey]={observers:i,tile:t},this},removeTile:function(t){var e=this._tileData[t],i="loaded"===e.tile.state?0:1;for(var n in e.observers){var o=this._observerData[n];o.leftToLoad-=i,delete o.tiles[t]}return delete this._tileData[t],this},startLoadTiles:function(t){this._dataManager._getActiveTileKeys();var e=this._observerData[t.id];if(0===e.leftToLoad)return this.fire("observertileload",{observer:t}),this;e.loadingState||(e.loadingState=!0,t.fire("startLoadingTiles"));for(var i in e.tiles)this._tileData[i].tile.load();return this},getTileObservers:function(t){return this._tileData[t].observers},getObserverLoadingState:function(t){return this._observerData[t.id].loadingState},_updateObserver:function(t){var e,i=this._observerData[t.id],n={},o=0;for(e in this._tileData){var r=this._tileData[e].tile;t.intersectsWithTile(r)&&(n[e]=!0,"loaded"!==r.state&&o++,this._tileData[e].observers[t.id]=!0)}for(e in i.tiles)e in n||delete this._tileData[e].observers[t.id];i.tiles=n,i.leftToLoad=o},_tileLoadedCallback:function(t){if(this.fire("tileload",{tile:t}),t.vectorTileKey in this._tileData){var e=this._tileData[t.vectorTileKey].observers;for(var i in e){var n=this._observerData[i];n.leftToLoad--,0===n.leftToLoad&&(n.loadingState&&(n.loadingState=!1,n.observer.fire("stopLoadingTiles")),this.fire("observertileload",{observer:n.observer}))}}}}),g=e.Class.extend({includes:e.Mixin.Events,options:{name:null,identityField:"",attributes:[],attrTypes:[],tiles:null,tilesVers:null,LayerVersion:0,GeoProcessing:null,Temporal:!1,TemporalColumnName:"",ZeroDate:"01.01.2008",TemporalPeriods:[],TemporalTiles:[],TemporalVers:[],hostName:"maps.kosmosnimki.ru",sessionKey:"",isGeneralized:!1,isFlatten:!1},setOptions:function(t){this._clearProcessing(),t.GeoProcessing&&(this.processingTile=this.addData([]),this._chkProcessing(t.GeoProcessing)),e.setOptions(this,t),this.optionsLink=t,this._isTemporalLayer=this.options.Temporal;var i=e.gmxUtil.getTileAttributes(this.options);this.tileAttributeIndexes=i.tileAttributeIndexes;var n=this.options.hostName,o=this.options.sessionKey;o||(o=e.gmx.gmxSessionManager.getSessionKey(n)),this.tileSenderPrefix="http://"+n+"/"+"TileSender.ashx?WrapStyle=None"+"&key="+encodeURIComponent(o),this._needCheckActiveTiles=!0},_vectorTileDataProviderLoad:function(t,e,i,n,o,r,s){var a=this;d.load(a.tileSenderPrefix,{x:t,y:e,z:i,v:n,s:o,d:r,layerID:a.options.name}).then(s,function(){console.log("Error loading vector tile"),s([]),a.fire("chkLayerUpdate",{dataProvider:a})})},initialize:function(t){this._tilesTree=null,this._activeTileKeys={},this._endDate=null,this._beginDate=null,this._tiles={},this._filters={},this._freeSubscrID=0,this._items={},this._observers={},this._needCheckDateInterval=!1,this._needCheckActiveTiles=!0;var e=this;this._vectorTileDataProvider={load:this._vectorTileDataProviderLoad.bind(this)},this._observerTileLoader=new f(this),this._observerTileLoader.on("tileload",function(t){var i=t.tile;if(e._updateItemsFromTile(i),e._tilesTree){var n=e._tilesTree.getNode(i.d,i.s);n&&n.count--}}),this._observerTileLoader.on("observertileload",function(t){var i=t.observer;i.isActive()&&(i.needRefresh=!1,i.updateData(e.getItems(i.id)))}),this.setOptions(t),this._isTemporalLayer&&this.addFilter("TemporalFilter",function(t,e,i){var n=t.options.unixTimeStamp,o=i.dateInterval;return o&&n>=o.beginDate.valueOf()&&n<o.endDate.valueOf()})},_getActiveTileKeys:function(){if(this._chkMaxDateInterval(),!this._needCheckActiveTiles)return this._activeTileKeys;if(this._needCheckActiveTiles=!1,this._isTemporalLayer){var t={};this._beginDate&&this._endDate&&(this._tilesTree||this.initTilesTree(),t=this._tilesTree.selectTiles(this._beginDate,this._endDate).tiles),this._updateActiveTilesList(t)}else this.initTilesList();return this._activeTileKeys},_getObserversByFilterName:function(t){var e={};for(var i in this._observers)this._observers[i].hasFilter(t)&&(e[i]=!0);return e},addFilter:function(t,e){this._filters[t]=e,this._triggerObservers(this._getObserversByFilterName(t))},removeFilter:function(t){if(this._filters[t]){var e=this._getObserversByFilterName(t);delete this._filters[t],this._triggerObservers(e)}},getItems:function(t){var e=[],i=this._observers[t];if(!i)return[];var n=i.filters.concat("processingFilter");this._isTemporalLayer&&n.push("TemporalFilter"),n=n.filter(function(t){return t in this._filters}.bind(this));var o=this,r=function(t){for(var r=t.data,s=0,a=r.length;a>s;s++){var l=t.dataOptions[s];if(i.intersects(l.bounds)){for(var h=r[s],u=h[0],c=o.getItem(u),d=h[h.length-1],p=!1,m=0;m<n.length;m++){var f=o._filters[n[m]];if(!f(c,t,i,d,l)){p=!0;break}}p||e.push({id:u,properties:h,item:c,dataOption:l,tileKey:t.vectorTileKey})}}},s=this._getActiveTileKeys();for(var a in s){var l=o._tiles[a].tile;l.data&&l.data.length>0&&(0===l.z||i.intersectsWithTile(l))&&r(l)}return e},_updateItemsFromTile:function(t){for(var e=t.vectorTileKey,i=t.data||[],n=i.length,o=i[0]&&i[0].length-1,r=0;n>r;r++){var s=i[r],a=s[o],l=s[0],h=this._items[l];if(h?(h.processing?t.data[r]=h.properties:(h.properties=s,-1===h.type.indexOf("MULTI")&&(h.type="MULTI"+h.type)),delete h.bounds,h.currentFilter=null):(h={id:l,type:a.type,properties:s,options:{fromTiles:{}}},this._items[l]=h),h.options.fromTiles[e]=r,t.isGeneralized&&(h.options.isGeneralized=!0),this.options.TemporalColumnName){var u=s[this.tileAttributeIndexes[this.options.TemporalColumnName]];h.options.unixTimeStamp=1e3*u}}return n},getMaxDateInterval:function(){return this._chkMaxDateInterval(),{beginDate:this._beginDate,endDate:this._endDate}},_chkMaxDateInterval:function(){if(this._isTemporalLayer&&this._needCheckDateInterval){this._needCheckDateInterval=!1;var t=this._observers,e=null,i=null;for(var n in t){var o=t[n],r=o.dateInterval;r&&((!e||r.beginDate<e)&&(e=r.beginDate),(!i||r.endDate>i)&&(i=r.endDate))}e&&i&&(this._beginDate!==e||this._endDate!==i)&&(this._beginDate=e,this._endDate=i,this._needCheckActiveTiles=!0)}},addObserver:function(t,e){e=e||"s"+ ++this._freeSubscrID;var i=this,n=new m(t);return n.id=e,n.needRefresh=!0,this._observerTileLoader.addObserver(n),n.on("update",function(t){n.needRefresh=!0,t.temporalFilter&&(i._needCheckDateInterval=!0),i._waitCheckObservers()}).on("activate",function(){i.fire("observeractivate"),i.checkObserver(n)}),i._needCheckDateInterval=!0,this._observers[e]=n,this._waitCheckObservers(),n.isActive()&&this.fire("observeractivate"),n},getActiveObserversCount:function(){var t=0;for(var e in this._observers)this._observers[e].isActive()&&t++;return t},getObserver:function(t){return this._observers[t]},removeObserver:function(t){if(this._observers[t]){this._observerTileLoader.removeObserver(t);var e=this._observers[t].isActive();delete this._observers[t],e&&this.fire("observeractivate")}},getObserverLoadingState:function(t){return this._observerTileLoader.getObserverLoadingState(t)},getItemsBounds:function(){if(!this._itemsBounds){this._itemsBounds=n.bounds();for(var t in this._items){var e=this.getItem(t);this._itemsBounds.extendBounds(e.bounds)}}return this._itemsBounds},getItem:function(t){var e=this._items[t];if(e&&!e.bounds){var i=e.options.fromTiles,o=[];for(var r in i)if(this._tiles[r]){var s=i[r],a=this._tiles[r].tile;"loaded"===a.state&&a.dataOptions[s]?o.push(a.dataOptions[s].bounds):delete i[r]}if(1===o.length)e.bounds=o[0];else{e.bounds=n.bounds();for(var l=n.worldWidthMerc,h=0,u=o.length;u>h;h++){var c=o[h];e.bounds.max.x-c.min.x>l&&(c=n.bounds([[c.min.x+2*l,c.min.y],[c.max.x+2*l,c.max.y]])),e.bounds.extendBounds(c)}}}return e},getItemMembers:function(t){var e=this._items[t].options.fromTiles,i=[];for(var n in e)if(this._tiles[n]){var o=this._tiles[n].tile;if(o.data){var r=e[n],s=o.data[r],a=o.dataOptions[r],l=a.bounds;i.push({geo:s[s.length-1],width:l.max.x-l.min.x,dataOption:a})}}return i.sort(function(t,e){return e.width-t.width})},getItemGeometries:function(t){var e=this._items[t]?this._items[t].options.fromTiles:{},i=[];for(var o in e)if(this._tiles[o]&&this._tiles[o].tile.data){var r=this._tiles[o].tile.data,s=r[e[o]];i.push(n.getUnFlattenGeo(s[s.length-1]))}return i},addTile:function(t){this._tiles[t.vectorTileKey]={tile:t},this._getActiveTileKeys()[t.vectorTileKey]=!0,this._observerTileLoader.addTile(t),this.checkObservers()},checkObserver:function(t){t.needRefresh&&t.isActive()&&this._observerTileLoader.startLoadTiles(t)},checkObservers:function(){var t=this._observers;for(var e in this._observers)this.checkObserver(t[e])},_waitCheckObservers:function(){this._checkObserversTimer&&clearTimeout(this._checkObserversTimer),this._checkObserversTimer=setTimeout(e.bind(this.checkObservers,this),0)},_triggerObservers:function(t){var e=t||this._observers;for(var i in e)this._observers[i]&&(this._observers[i].needRefresh=!0);this._waitCheckObservers()},_removeDataFromObservers:function(t){var e=this._observers;for(var i in e)this._observers[i].removeData(t);this._waitCheckObservers()},preloadTiles:function(t,e,n){var o={};this._isTemporalLayer?(this._tilesTree||this.initTilesTree(),o=this._tilesTree.selectTiles(t,e).tiles):(this._needCheckActiveTiles=!0,o=this._getActiveTileKeys());var r=[];for(var s in o){var a=this._getVectorTile(s,!0).tile;if("notLoaded"===a.state&&(!n||n.intersects(a.bounds))){var l=a.load();r.push(l)}}return i.all.apply(null,r)},_updateActiveTilesList:function(t){if(this._tileFilteringHook){var e={};for(var i in t)this._tileFilteringHook(this._getVectorTile(i,!0).tile)&&(e[i]=!0);t=e}var n,o=this._activeTileKeys||{},r={},s=this;this.processingTile&&(t[this.processingTile.vectorTileKey]=!0);var a=function(t){var e=s._observerTileLoader.getTileObservers(t);for(var i in e)r[i]=!0};for(n in t)o[n]||(this._observerTileLoader.addTile(this._getVectorTile(n,!0).tile),a(n));for(n in o)t[n]||(a(n),this._observerTileLoader.removeTile(n));this._activeTileKeys=t,this._triggerObservers(r)},_propertiesToArray:function(t){var e=t.properties,i=this.tileAttributeIndexes,n=[];for(var o in i)n[i[o]]=e[o];return n[n.length]=t.geometry,n[0]=t.id,n},_clearProcessing:function(){if(this.processingTile){for(var t=this._items,e=this.processingTile,i=e.vectorTileKey,n=e.data||[],o=0,r=n.length;r>o;o++){var s=n[o][0];if(t[s]){var a=t[s];a.processing=null,a.currentFilter=null,delete a.options.fromTiles[i],delete a.fromServerProps,delete a.geometry}}e.clear()}},_chkProcessing:function(t){var e,i,n,o,r,s=this._items,a=!1,l={};if(t){if(t.Deleted)for(i=0,n=t.Deleted.length;n>i;i++)e=t.Deleted[i],l[e]=!0,s[e]&&(s[e].processing=!0,s[e].currentFilter=null),n>0&&(a=!0);var h={};if(t.Inserted)for(i=0,n=t.Inserted.length;n>i;i++)o=t.Inserted[i],l[o[0]]||(h[o[0]]=o);if(t.Updated){for(i=0,n=t.Updated.length;n>i;i++)o=t.Updated[i],l[o[0]]||(h[o[0]]=o);!a&&n>0&&(a=!0)}r=[];for(e in h)this._items[e]&&(this._items[e].properties=h[e],this._items[e].processing=!0,this._items[e].currentFilter=null),r.push(h[e]);r.length>0&&(this.processingTile=this.addData(r))}a?this.addFilter("processingFilter",function(t,e){return 0===e.z||!t.processing}):this.removeFilter("processingFilter")},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._resetTilesTree())},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._resetTilesTree())
},_resetTilesTree:function(){this._tilesTree=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},updateVersion:function(t){t&&this.setOptions(t),this._resetTilesTree()},_getDataKeys:function(t){for(var e={},i=0,n=t.length;n>i;i++)e[t[i][0]]=!0;return e},_getProcessingTile:function(){if(!this.processingTile){var t=-.5,e=-.5,i=0,n=0,o=-1,r=-1,s=this.options.isFlatten;this.processingTile=new p({load:function(t,e,i,n,o,r,s){s([])}},{x:t,y:e,z:i,v:n,s:o,d:r,isFlatten:s}),this.addTile(this.processingTile)}return this.processingTile},addData:function(t){t||(t=[]);var e=this._getProcessingTile(),i=this._getDataKeys(t),n=e.addData(t,i);return this._itemsBounds&&this._itemsBounds.extendBounds(n),this._updateItemsFromTile(e),this._triggerObservers(),e},removeData:function(t){this._itemsBounds=null;var e=this.processingTile;if(e){var i={};if(!t||!t.length)return e;for(var n=0,o=t.length;o>n;n++){var r=t[n];i[r]=!0,delete this._items[r]}this._removeDataFromObservers(i),e.removeData(i,!0),this._updateItemsFromTile(e),this._triggerObservers()}return e},initTilesTree:function(){this._tilesTree=e.gmx.tilesTree(this.options),this.options.TemporalTiles=this.options.TemporalVers=null,"TemporalTiles"in this.optionsLink&&(this.optionsLink.TemporalVers=this.optionsLink.TemporalTiles=null),this.dateZero=this._tilesTree.dateZero,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})},_getVectorTile:function(t,e){if(!this._tiles[t]&&e){var i=p.parseTileKey(t);i.dateZero=this.dateZero,this._addVectorTile(i)}return this._tiles[t]},_addVectorTile:function(t){t.isFlatten=this.options.isFlatten;var e=new p(this._vectorTileDataProvider,t),i=e.vectorTileKey;return this._tiles[i]={tile:e},i},_getGeneralizedTileKeys:function(t){for(var i=t.z%2?1:2,n=Math.pow(2,i),o=t.z-i,r=Math.floor(t.x/n),s=Math.floor(t.y/n),a={v:t.v,s:-1,d:-1,isGeneralized:!0},l={};o>1;){var h=[o,r,s].join("_");l[h]=e.extend({},a,{x:r,y:s,z:o}),o-=2,r=Math.floor(r/4),s=Math.floor(s/4)}return l},initTilesList:function(){var t={};if(this.options.tiles){for(var e,i,n,o,r=this.options.tiles||[],s=this.options.tilesVers,a=this.options.isGeneralized?{}:null,l={},h=0,u=0,c=r.length;c>h;h+=3,u++)if(n={x:Number(r[h]),y:Number(r[h+1]),z:Number(r[h+2]),v:Number(s[u]),s:-1,d:-1},o=this._getVectorTile(p.createTileKey(n),!0),i=o.tile.vectorTileKey,l[i]=o,t[i]=!0,a){var d=this._getGeneralizedTileKeys(n);for(e in d){var m=d[e];a[e]?a[e].v=Math.max(m.v,a[e].v):a[e]=m}}if(a)for(e in a)n=a[e],i=p.createTileKey(n),l[i]||(this._tiles[i]||this._addVectorTile(n),l[i]=this._tiles[i],t[i]=!0);this._tiles=l,this.processingTile&&(this._tiles[this.processingTile.vectorTileKey]={tile:this.processingTile})}this._updateActiveTilesList(t)},setTileFilteringHook:function(t){this._tileFilteringHook=t,this._needCheckActiveTiles=!0,this._getActiveTileKeys()},removeTileFilteringHook:function(){this._tileFilteringHook=null,this._needCheckActiveTiles=!0,this._getActiveTileKeys()}});e.gmx=e.gmx||{},e.gmx.DataManager=g,e.gmx.VectorLayer=e.TileLayer.Canvas.extend({options:{openPopups:[],minZoom:1,zIndexOffset:0,isGeneralized:!0,isFlatten:!1,useWebGL:!1,clickable:!0},initialize:function(t){t=e.setOptions(this,t),this.initPromise=new e.gmx.Deferred,this._drawQueue=[],this._drawQueueHash={},this._drawInProgress={},this._anyDrawings=!1,this.repaintObservers={};var i=this;this._gmx={hostName:n.normalizeHostname(t.hostName||"maps.kosmosnimki.ru"),mapName:t.mapID,useWebGL:t.useWebGL,layerID:t.layerID,beginDate:t.beginDate,endDate:t.endDate,sortItems:t.sortItems||null,styles:t.styles||[],tileSubscriptions:{},_tilesToLoad:0,shiftXlayer:0,shiftYlayer:0,renderHooks:[],preRenderHooks:[],_needPopups:{}},t.crossOrigin&&(this._gmx.crossOrigin=t.crossOrigin),this.on("tileunload",function(t){i._clearTileSubscription(t.tile.zKey)})},_removeTile:function(t){var e=this._tiles[t];if(e){var i=e.el;i&&i.parentNode&&i.parentNode.removeChild(i),delete this._tiles[t]}},onAdd:function(t){if(t.options.crs!==e.CRS.EPSG3857&&t.options.crs!==e.CRS.EPSG3395)throw"GeoMixer-Leaflet: map projection is incompatible with GeoMixer layer";var i=this._gmx;i.shiftY=0,i.applyShift=t.options.crs===e.CRS.EPSG3857,i.currentZoom=t.getZoom(),i.styleManager.initStyles(),e.TileLayer.Canvas.prototype.onAdd.call(this,t),t.on("zoomstart",this._zoomStart,this),t.on("zoomend",this._zoomEnd,this),"Vector"===i.properties.type&&t.on("moveend",this._moveEnd,this),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),i.balloonEnable&&!this._popup&&this.bindPopup(""),this.on("stylechange",this._onStyleChange,this),this.on("versionchange",this._onVersionChange,this),this._zIndexOffsetCheck(),e.gmx.layersVersion.add(this),this.fire("add")},onRemove:function(t){this._container&&this._container.parentNode.removeChild(this._container),t.off({viewreset:this._reset,moveend:this._update},this),this._animated&&t.off({zoomanim:this._animateZoom,zoomend:this._endZoomAnim},this),this.options.updateWhenIdle||t.off("move",this._limitedUpdate,this),this._container=null,this._map=null,this._clearAllSubscriptions(),t.off("zoomstart",this._zoomStart,this),t.off("zoomend",this._zoomEnd,this),this.off("stylechange",this._onStyleChange,this);var i=this._gmx;delete i.map,"Vector"===i.properties.type&&t.off("moveend",this._moveEnd,this),i.dataManager&&!i.dataManager.getActiveObserversCount()&&e.gmx.layersVersion.remove(this),this.fire("remove")},_initContainer:function(){e.TileLayer.Canvas.prototype._initContainer.call(this),this._prpZoomData(),this.setZIndexOffset()},_updateZIndex:function(){if(this._container){var t=this.options,e=t.zIndex||0,i=t.zIndexOffset||0;this._container.style.zIndex=i+e}},_update:function(){return!this._map||this.isExternalVisible&&this.isExternalVisible(this._map._zoom)?(this._clearAllSubscriptions(),void 0):(this._gmx.styleManager.deferred.then(this.__update.bind(this)),void 0)},_addTile:function(t){var e=this,i=this._map._zoom,o=this._gmx;if(!o.layerType||!o.styleManager.isVisibleAtZoom(i))return this._tileLoaded(),void 0;var r=this._tileCoordsToKey(t,i);if(!o.tileSubscriptions[r]){o._tilesToLoad++;var s=!1,a=n.getTileNumFromLeaflet(t,i),l=function(){s||(o._tilesToLoad--,e._tileLoaded(),s=!0)},h={type:"resend",active:!1,bbox:o.styleManager.getStyleBounds(a),filters:["clipFilter","userFilter_"+o.layerID,"styleFilter","userFilter"],callback:function(n){e._drawTileAsync(t,i,n).always(l)}};this.options.isGeneralized&&(h.targetZoom=i),"VectorTemporal"===o.layerType&&(h.dateInterval=[o.beginDate,o.endDate]);var u=o.dataManager.addObserver(h,r);u.on("activate",function(){u.isActive()||l()}),u.on("startLoadingTiles",this._chkDrawingState,this),o.tileSubscriptions[r]={z:i,x:t.x,y:t.y,px:256*a.x,py:256*(1+a.y)},u.activate()}},_chkDrawingState:function(){var t=this._gmx,e=this._drawQueue.length>0||Object.keys(this._drawInProgress).length>0;if(!e)for(var i in t.tileSubscriptions){var n=t.dataManager.getObserver(i);if(n&&t.dataManager.getObserverLoadingState(n)){e=!0;break}}!e&&this._anyDrawings?this.fire("doneDraw"):e&&!this._anyDrawings&&this.fire("startDraw"),this._anyDrawings=e},_getLoadedTilesPercentage:function(t){if(!t)return 0;var e=0,i=0,n=["img","canvas"];for(var o in n){var r=t.getElementsByTagName(n[o]);if(r&&r.length>0){e+=r.length;for(var s=0,a=r.length;a>s;s++)r[s]._tileComplete&&i++}}return 1>e?0:i/e},_tileLoaded:function(){this._animated&&e.DomUtil.addClass(this._tileContainer,"leaflet-zoom-animated"),0===this._gmx._tilesToLoad&&(this.fire("load"),this._animated&&this._setClearBgBuffer(0))},_tileOnLoad:function(t){t&&e.DomUtil.addClass(t,"leaflet-tile-loaded"),this._tileLoaded()},_tileOnError:function(){},tileDrawn:function(t){this._tileOnLoad(t)},_tileCoordsToKey:function(t,e){return t.x+":"+t.y+":"+(t.z||e)},_getTiledPixelBounds:function(t){var i=this._map,n=this._gmx,o=new e.Point(n.shiftX,n.shiftY),r=i.project(t,this._tileZoom).add(o)._floor(),s=i.getSize().divideBy(2);return new e.Bounds(r.subtract(s),r.add(s))},_pxBoundsToTileRange:function(t){var i=this.options.tileSize;return new e.Bounds(t.min.divideBy(i)._floor(),t.max.divideBy(i)._round())},initFromDescription:function(t){var i=this._gmx;if(i.properties=t.properties,i.geometry=t.geometry,i.properties._initDone&&delete i.properties[i.properties.Temporal?"TemporalTiles":"tiles"],i.properties._initDone=!0,!i.geometry){var o=n.tileSizes[1];i.geometry={type:"POLYGON",coordinates:[[[-o,-o],[-o,o],[o,o],[o,-o],[-o,-o]]]}}if(i.rawProperties=t.rawProperties||t.properties,this._updateProperties(t.properties),t.properties.isGeneralized=this.options.isGeneralized,t.properties.isFlatten=this.options.isFlatten,i.dataManager=this.options.dataManager||new g(t.properties),this.options.parentOptions&&(t.properties.styles||(t.properties.styles=this.options.parentOptions.styles),i.dataManager.on("versionchange",this._onVersionChange,this)),i.styleManager=new _(i),this.options.minZoom=i.styleManager.minZoom,this.options.maxZoom=i.styleManager.maxZoom,i.dataManager.on("observeractivate",function(){i.dataManager.getActiveObserversCount()?e.gmx.layersVersion.add(this):e.gmx.layersVersion.remove(this)},this),"Vector"!==i.properties.type||"chkUpdate"in this.options||(this.options.chkUpdate=!0),"Raster"!==i.rawProperties.type&&this._objectsReorderInit&&this._objectsReorderInit(this),i.clusters&&this.bindClusters(JSON.parse(i.clusters)),i.filter){var r=e.gmx.Parsers.parseSQL(i.filter.replace(/[\[\]]/g,'"'));r&&i.dataManager.addFilter("userFilter_"+i.layerID,function(t){return i.layerID!==this._gmx.layerID||!r||r(t.properties,i.tileAttributeIndexes)?t.properties:null}.bind(this))}return i.dateBegin&&i.dateEnd&&this.setDateInterval(i.dateBegin,i.dateEnd),this.initPromise.resolve(),this},getDataManager:function(){return this._gmx.dataManager},enableGeneralization:function(){this.options.isGeneralized||(this.options.isGeneralized=!0,this._gmx.dataManager&&(this._clearAllSubscriptions(),this._gmx.dataManager.enableGeneralization(),this.redraw()))},disableGeneralization:function(){this.options.isGeneralized&&(this.options.isGeneralized=!1,this._gmx.dataManager&&(this._clearAllSubscriptions(),this._gmx.dataManager.disableGeneralization(),this.redraw()))},setRasterOpacity:function(t){var e=this;return this._gmx.rasterOpacity!==t&&(this._gmx.rasterOpacity=t,this.initPromise.then(function(){e.repaint()})),this},getStyles:function(){return this._gmx.styleManager.getStyles()},getIcons:function(t){return this._gmx.styleManager.getIcons(t),this},setStyles:function(t){var e=this;return this.initPromise.then(function(){e._gmx.styleManager.clearStyles(),t?t.forEach(function(t,i){e.setStyle(t,i,!0)}):e.fire("stylechange")}),this},getStyle:function(t){return this.getStyles()[t]},setStyle:function(t,e,i){var n=this,o=this._gmx;return this.initPromise.then(function(){o.styleManager.setStyle(t,e,i).then(function(){n.fire("stylechange",{num:e||0})})}),this},setStyleHook:function(t){return this._gmx.styleHook=t,this.repaint(),this},removeStyleHook:function(){return this._gmx.styleHook=null,this},setRasterHook:function(t){return this._gmx.rasterProcessingHook=t,this.repaint(),this},removeRasterHook:function(){return this._gmx.rasterProcessingHook=null,this.repaint(),this},setFilter:function(t){var e=this._gmx;return e.dataManager.addFilter("userFilter",function(i){return e.layerID!==this._gmx.layerID||!t||t(i)?i.properties:null}.bind(this)),this},removeFilter:function(){return this._gmx.dataManager.removeFilter("userFilter"),this},setDateInterval:function(t,i){var n=this._gmx;if(n.dateBegin&&n.dateEnd&&(t=n.dateBegin,i=n.dateEnd),!n.beginDate!=!t||!n.endDate!=!i||t&&n.beginDate.valueOf()!==t.valueOf()||i&&n.endDate.valueOf()!==i.valueOf()){if(n.rawProperties.maxShownPeriod&&t){var o=1e3*3600*24*n.rawProperties.maxShownPeriod;t=new Date(Math.max(t.valueOf(),i.valueOf()-o))}n.beginDate=t,n.endDate=i;var r=null;for(var s in n.tileSubscriptions)r=n.dataManager.getObserver(s),r.setDateInterval(t,i);r=n.dataManager.getObserver("_Labels"),r&&r.setDateInterval(t,i),("NotVisible"===window.gmxSkipTiles||n.properties.UseTiles===!1)&&(n.properties.LayerVersion=-1,this._map&&e.gmx.layersVersion.now()),this.fire("dateIntervalChanged")}return this},getDateInterval:function(){return{beginDate:this._gmx.beginDate,endDate:this._gmx.endDate}},addObserver:function(t){return this._gmx.dataManager.addObserver(t)},removeObserver:function(t){return this._gmx.dataManager.removeObserver(t.id)},setPositionOffset:function(t,e){var i=this._gmx;return i.shiftXlayer=t,i.shiftYlayer=e,this._update(),this},getPositionOffset:function(){var t=this._gmx;return{shiftX:t.shiftXlayer,shiftY:t.shiftYlayer}},setZIndexOffset:function(t){return arguments.length&&(this.options.zIndexOffset=t),this._updateZIndex(),this},repaint:function(t){if(this._map){if(!t){t={};for(var i in this._gmx.tileSubscriptions)t[i]=!0;e.extend(t,this.repaintObservers)}this._gmx.dataManager._triggerObservers(t)}},redrawItem:function(t){if(this._map){var e=this._gmx.dataManager.getItem(t),i=this._getTilesByBounds(e.bounds);this.repaint(i)}},gmxGetCanvasTile:function(t){var e=this._tileCoordsToKey(t);if(e in this._tiles)return this._tiles[e];var i=this._getTile();return this._tiles[e]={el:i,coords:t,current:!0},i._zoom=this._map._zoom,i._tileComplete=!0,i._tilePoint=t,this.tileDrawn(i),this._tiles[e]},appendTileToContainer:function(t){this._tileContainer.appendChild(t);var i=this._getTilePos(t._tilePoint);e.DomUtil.setPosition(t,i,e.Browser.chrome||e.Browser.android23)},addData:function(t,e){return this._gmx.mapName||(this._gmx.dataManager.addData(t,e),this.repaint()),this},removeData:function(t,e){return this._gmx.mapName||(this._gmx.dataManager.removeData(t,e),this.repaint()),this},getStylesByProperties:function(t,e){return this._gmx.styleManager.getCurrentFilters(t,e)},getItemStyle:function(t){var e=this._gmx,i=e.dataManager.getItem(t);return e.styleManager.getObjStyle(i)},getTileAttributeTypes:function(){return this._gmx.tileAttributeTypes},getTileAttributeIndexes:function(){return this._gmx.tileAttributeIndexes},getItemBalloon:function(t){var i=this._gmx,n=i.dataManager.getItem(t),o=this.getStyles(),r="";if(n&&o[n.currentFilter]){var s=n.properties;r=e.gmxUtil.parseBalloonTemplate(o[n.currentFilter].Balloon,{properties:this.getItemProperties(s),geometries:[s[s.length-1]],tileAttributeTypes:i.tileAttributeTypes,unitOptions:this._map?this._map.options:{}})}return r},getItemProperties:function(t){var e={},i=this._gmx.tileAttributeIndexes;for(var n in i)e[n]=t[i[n]];return e},addPreRenderHook:function(t){this._gmx.preRenderHooks.push(t),this.repaint()},removePreRenderHook:function(t){for(var e=this._gmx.preRenderHooks,i=0,n=e.length;n>i;i++)if(e[i]===t){e.splice(i,1),this.repaint();break}},addRenderHook:function(t){this._gmx.renderHooks.push(t),this.repaint()},removeRenderHook:function(t){for(var e=this._gmx.renderHooks,i=0,n=e.length;n>i;i++)if(e[i]===t){e.splice(i,1),this.repaint();break}},getGmxProperties:function(){return this._gmx.rawProperties},getBounds:function(){var t=e.Projection.Mercator,i=this._gmx.layerID?n.geoItemBounds(this._gmx.geometry).bounds:this._gmx.dataManager.getItemsBounds();return i?e.latLngBounds([t.unproject(i.min),t.unproject(i.max)]):new e.LatLngBounds},getGeometry:function(){return this._gmx.latLngGeometry||(this._gmx.latLngGeometry=e.gmxUtil.geometryToGeoJSON(this._gmx.geometry,!0)),this._gmx.latLngGeometry},_clearTileSubscription:function(t){var e=this._gmx;if(t in e.tileSubscriptions){var i=e.tileSubscriptions[t];i.screenTile&&i.screenTile.destructor();var n=e.dataManager.getObserver(t);n&&n.deactivate(),delete e.tileSubscriptions[t],this._removeTile(t),this._anyDrawings&&this._chkDrawingState()}t in this._drawQueueHash&&this._drawQueueHash[t].cancel()},_clearAllSubscriptions:function(){for(;this._drawQueue.length;)this._drawQueue[0].def.cancel();var t=this._gmx;for(var e in t.tileSubscriptions){var i=t.tileSubscriptions[e];i.screenTile&&i.screenTile.destructor();var n=t.dataManager.getObserver(e);n&&n.deactivate(),t.dataManager.removeObserver(e),delete t.tileSubscriptions[e],delete this._tiles[e]}this._anyDrawings&&this._chkDrawingState(),t._tilesToLoad=0},_zoomStart:function(){this._gmx.zoomstart=!0},_zoomEnd:function(){this._gmx.zoomstart=!1,this.setCurrentZoom(this._map),this._zIndexOffsetCheck()},_moveEnd:function(){"dataManager"in this._gmx&&this._gmx.dataManager.fire("moveend")},_onStyleChange:function(){var t=this._gmx;if(!t.balloonEnable&&this._popup?this.unbindPopup():t.balloonEnable&&!this._popup&&this.bindPopup(""),this._map)if((this.options.minZoom!==t.styleManager.minZoom||this.options.maxZoom!==t.styleManager.maxZoom)&&(this.options.minZoom=t.styleManager.minZoom,this.options.maxZoom=t.styleManager.maxZoom,this._map._updateZoomLevels()),t.labelsLayer?this._map._labelsLayer.add(this):t.labelsLayer||this._map._labelsLayer.remove(this),Object.keys(t.tileSubscriptions).length>0)for(var i in t.tileSubscriptions){var o=t.dataManager.getObserver(i),r=t.tileSubscriptions[i],s=n.getTileNumFromLeaflet(r,r.z),a=t.styleManager.getStyleBounds(s);if(!o.bbox.isEqual(a)){var l=e.Projection.Mercator;o.setBounds(e.latLngBounds([l.unproject(a.min),l.unproject(a.max)]))}}else this.redraw()},_removeInProgressDrawing:function(t){delete this._drawInProgress[t],this._chkDrawingState()},_drawTileAsync:function(t,i,o){var r=this._drawQueue,s=0===r.length,a=this._tileCoordsToKey(t,i),l=this;this._drawQueueHash[a]&&this._drawQueueHash[a].cancel();var h=function(){if(l._chkDrawingState(),r.length){var t=r.shift();delete l._drawQueueHash[t.zKey],l._map&&t.z===l._map._zoom?(t.drawDef=l._gmxDrawTile(t.tp,t.z,t.data),l._drawInProgress[t.zKey]=!0,t.drawDef.always(l._removeInProgressDrawing.bind(l,t.zKey)),t.drawDef.then(t.def.resolve.bind(t.def,t.data),t.def.reject)):t.def.reject(),setTimeout(h,0)}},u=n.getTileNumFromLeaflet(t,i),c={gtp:u,tp:t,z:i,zKey:a,data:o},d=c.def=new e.gmx.Deferred(function(){c.drawDef&&c.drawDef.cancel(),l._removeInProgressDrawing(a),delete l._drawQueueHash[a];for(var t=r.length-1;t>=0;t--){var e=r[t];if(e.zKey===a){r.splice(t,1);break}}});return r.push(c),this._drawQueueHash[a]=d,s&&setTimeout(h,0),d},_updateShiftY:function(){var t=this._gmx,i=this._map,n=0;if(i){var o=i.getCenter();n=i.options.crs.project(o).y-e.Projection.Mercator.project(o).y}t.shiftX=Math.floor(t.mInPixel*(t.shiftXlayer||0)),t.shiftY=Math.floor(t.mInPixel*(n+(t.shiftYlayer||0))),t.shiftPoint=new e.Point(t.shiftX,-t.shiftY),e.DomUtil.setPosition(this._tileContainer,t.shiftPoint)},_prpZoomData:function(){this.setCurrentZoom(this._map)},setCurrentZoom:function(t){var e=this._gmx;e.currentZoom=t._zoom,e.tileSize=n.tileSizes[e.currentZoom],e.mInPixel=256/e.tileSize},_zIndexOffsetCheck:function(){var t=this._gmx;if("Raster"!==t.properties.fromType&&(t.IsRasterCatalog||t.Quicklook)){var i=t.IsRasterCatalog?t.minZoomRasters:t.minZoomQuicklooks,n=this._map._zoom<i?e.gmx.VectorLayer.prototype.options.zIndexOffset:0;n!==this.options.zIndexOffset&&this.setZIndexOffset(n)}},_setClearBgBuffer:function(t){this._clearBgBufferTimer&&clearTimeout(this._clearBgBufferTimer);var e=this;this._clearBgBufferTimer=setTimeout(function(){e._bgBuffer&&e._clearBgBuffer()},t||0)},_getNeedPopups:function(){for(var t={},e=this.options.openPopups,i=0,n=e.length;n>i;i++)t[e[i]]=!1;return t},__update:function(){var t=this._map;if(t){var i=t.getZoom(),n=t.getCenter();this._gmx.applyShift&&this._updateShiftY(),this._tileZoom=i,this.options.openPopups.length&&(this._gmx._needPopups=this._getNeedPopups(),this.options.openPopups=[]);var o=this._getTiledPixelBounds(n),r=this._pxBoundsToTileRange(o),s=this._getWrapTileNum();if(r.min.y<0&&(r.min.y=0),r.max.y>=s.y&&(r.max.y=s.y-1),this._chkTileSubscriptions(i,r),i>this.options.maxZoom||i<this.options.minZoom)return this._setClearBgBuffer(500),void 0;for(var a=r.min.y;a<=r.max.y;a++)for(var l=r.min.x;l<=r.max.x;l++){var h=new e.Point(l,a);h.z=this._tileZoom,this._tiles[this._tileCoordsToKey(h)]||this._addTile(h)}}},_chkTileSubscriptions:function(t,e){var i=this._gmx,n=e.min,o=e.max;for(var r in i.tileSubscriptions){var s=i.tileSubscriptions[r];(s.z!==t||s.x<n.x||s.x>o.x||s.y<n.y||s.y>o.y)&&this._clearTileSubscription(r)}},_getScreenTile:function(e,i){var n=this._gmx,o=this._tileCoordsToKey(e,i),r=n.tileSubscriptions[o],s=null;return r&&(r.screenTile?s=r.screenTile:r.screenTile=s=new t(this,e,i)),s},_gmxDrawTile:function(t,i,n){var o=this._gmx,r=!1,s=null,a=new e.gmx.Deferred(function(){r=!0,s&&s.cancel()});if(!this._map)return a.reject(),a;var l=this._getScreenTile(t,i||this._map._zoom);return l&&o.styleManager.deferred.then(function(){r||(s=l.drawTile(n),s.then(a.resolve.bind(a,n),a.reject))}),a},_getTilesByBounds:function(t){var i=this._gmx,n=this._map._zoom,o=i.shiftX||0,r=i.shiftY||0,s=e.Projection.Mercator.unproject(new e.Point(t.min.x,t.min.y)),a=e.Projection.Mercator.unproject(new e.Point(t.max.x,t.max.y)),l=this._map.getBounds(),h=l.getSouthWest(),u=l.getNorthEast(),c=0;u.lng-h.lng<360&&(a.lng<h.lng?c=360*(1+Math.floor((h.lng-a.lng)/360)):s.lng>u.lng&&(c=360*Math.floor((u.lng-s.lng)/360))),s.lng+=c,a.lng+=c;var d,p,m,f,g=this._map.getPixelBounds(),_=this._map.project(s),v=this._map.project(a);g?(d=Math.floor((Math.max(v.y,g.min.y)+r)/256),p=Math.floor((Math.min(_.y,g.max.y)+r)/256),m=s.lng<=-180?g.min.x:Math.max(_.x,g.min.x),m=Math.floor((m+o)/256),f=a.lng>=180?g.max.x:Math.min(v.x,g.max.x),f=Math.floor((f+o)/256)):(d=Math.floor((v.y+r)/256),p=Math.floor((_.y+r)/256),m=Math.floor((_.x+o)/256),f=Math.floor((v.x+o)/256));for(var y={},x=m;f>=x;x++)for(var L=d;p>=L;L++){var b=this._tileCoordsToKey({x:x,y:L},n);y[b]=!0}return y},_updateProperties:function(t){var i=this._gmx,n=this.options.apikeyRequestHost||i.hostName;i.sessionKey=t.sessionKey=this.options.sessionKey||l.getSessionKey(n),this.options.parentOptions&&(t=this.options.parentOptions),i.identityField=t.identityField,i.GeometryType=(t.GeometryType||"").toLowerCase(),i.minZoomRasters=t.RCMinZoomForRasters||1,i.minZoomQuicklooks=i.minZoomRasters;var o=t.type||"Vector";if(t.Temporal&&(o+="Temporal"),i.layerType=o,i.items={},e.extend(i,e.gmxUtil.getTileAttributes(t)),i.dataManager&&i.dataManager.setOptions(t),"ZIndexField"in t&&t.ZIndexField in i.tileAttributeIndexes&&(i.zIndexField=i.tileAttributeIndexes[t.ZIndexField]),this._objectsReorder&&this._objectsReorder.initialize(),"MetaProperties"in i.rawProperties){var r=i.rawProperties.MetaProperties;"filter"in r&&(i.filter=r.filter.Value||""),"dateBegin"in r&&(i.dateBegin=e.gmxUtil.getDateFromStr(r.dateBegin.Value||"01.01.1980")),"dateEnd"in r&&(i.dateEnd=e.gmxUtil.getDateFromStr(r.dateEnd.Value||"01.01.1980")),("shiftX"in r||"shiftY"in r)&&(i.shiftXlayer=r.shiftX?Number(r.shiftX.Value):0,i.shiftYlayer=r.shiftY?Number(r.shiftY.Value):0),("shiftXfield"in r||"shiftYfield"in r)&&(r.shiftXfield&&(i.shiftXfield=r.shiftXfield.Value),r.shiftYfield&&(i.shiftYfield=r.shiftYfield.Value)),"quicklookPlatform"in r&&(i.quicklookPlatform=r.quicklookPlatform.Value,"image"===i.quicklookPlatform&&delete i.quicklookPlatform),"quicklookX1"in r&&(i.quicklookX1=r.quicklookX1.Value),"quicklookY1"in r&&(i.quicklookY1=r.quicklookY1.Value),"quicklookX2"in r&&(i.quicklookX2=r.quicklookX2.Value),"quicklookY2"in r&&(i.quicklookY2=r.quicklookY2.Value),"quicklookX3"in r&&(i.quicklookX3=r.quicklookX3.Value),"quicklookY3"in r&&(i.quicklookY3=r.quicklookY3.Value),"quicklookX4"in r&&(i.quicklookX4=r.quicklookX4.Value),"quicklookY4"in r&&(i.quicklookY4=r.quicklookY4.Value),"multiFilters"in r&&(i.multiFilters="1"===r.multiFilters.Value?!0:!1),"isGeneralized"in r&&(this.options.isGeneralized="false"!==r.isGeneralized.Value),"isFlatten"in r&&(this.options.isFlatten="false"!==r.isFlatten.Value)}if(t.Temporal&&(this.options.isGeneralized=!1),t.IsRasterCatalog){i.IsRasterCatalog=t.IsRasterCatalog;var s=i.tileAttributeIndexes.GMX_RasterCatalogID;s&&(i.rasterBGfunc=function(t,e,n,o){var r=o.properties;return"http://"+i.hostName+"/TileSender.ashx?ModeKey=tile"+"&x="+t+"&y="+e+"&z="+n+"&LayerName="+r[s]+"&key="+encodeURIComponent(i.sessionKey)})}if(t.Quicklook){var a;a="{"===t.Quicklook[0]?JSON.parse(t.Quicklook):{minZoom:i.minZoomRasters,template:t.Quicklook},"X1"in a&&(i.quicklookX1=a.X1),"Y1"in a&&(i.quicklookY1=a.Y1),"X2"in a&&(i.quicklookX2=a.X2),"Y2"in a&&(i.quicklookY2=a.Y2),"X3"in a&&(i.quicklookX3=a.X3),"Y3"in a&&(i.quicklookY3=a.Y3),"X4"in a&&(i.quicklookX4=a.X4),"Y4"in a&&(i.quicklookY4=a.Y4);var h=i.Quicklook=a.template;"minZoom"in a&&(i.minZoomQuicklooks=a.minZoom),i.quicklookBGfunc=function(t){for(var e=h,n=/\[([^\]]+)\]/,o=n.exec(e);o&&o.length>1;)e=e.replace(o[0],t.properties[i.tileAttributeIndexes[o[1]]]),o=n.exec(e);return e},i.imageQuicklookProcessingHook=e.gmx.gmxImageTransform}this.options.attribution=t.Copyright||""},_onVersionChange:function(){this._updateProperties(this._gmx.rawProperties)},getPropItem:function(t,e){return n.getPropItem(t,e,this._gmx.tileAttributeIndexes)}}),t.prototype={_loadTileRecursive:function(t,i){var n,o=this.gmx,r=this,s=null,a=new e.gmx.Deferred(function(){s&&(delete r.rasterRequests[n],s.cancel())}),l=function(t,h){var u=i(t),c=function(){t.z>1?l({x:Math.floor(t.x/2),y:Math.floor(t.y/2),z:t.z-1},""):a.reject()};if(o.badTiles[u]||o.maxNativeZoom&&o.maxNativeZoom<t.z)return c(),void 0;var d=r.rasterRequests[u];d?d.options.tileRastersId=r._uniqueID:(o.rasterProcessingHook&&(h="anonymous"),d=e.gmx.imageLoader.push(u,{tileRastersId:r._uniqueID,zoom:r.zoom,cache:!0,crossOrigin:h||""}),r.rasterRequests[u]=d),n=u,s=d.def,s.then(function(e){a.resolve({gtp:t,image:e})},function(){o.badTiles[u]=!0,c()})};return l(t),a},_rasterHook:function(t){var e=t.sourceTilePoint||t.destinationTilePoint,i={geoItem:t.geoItem,destination:{z:t.destinationTilePoint.z,x:t.destinationTilePoint.x,y:t.destinationTilePoint.y},source:{z:e.z,x:e.x,y:e.y}};return t.url&&(i.quicklook=t.url),(this.gmx.rasterProcessingHook||this._defaultRasterHook)(t.res,t.image,t.sx||0,t.sy||0,t.sw||256,t.sh||256,t.dx||0,t.dy||0,t.dw||256,t.dh||256,i)},_defaultRasterHook:function(t,e,i,n,o,r,s,a,l,h){var u=t.getContext("2d");u.drawImage(e,i,n,o,r,s,a,l,h)},_getShiftPixels:function(t){var e=t.dx+(t.dx<0?256:0),i=t.dy+(t.dy<0?256:0),n=0,o=256-e,r=e,s=o;if(t.tx>t.x&&(n=o,o=e,r=0,s=o),256===n||1>o)return null;var a=i,l=256-i,h=0,u=l;return t.ty>t.y&&(a=0,h=l,l=i,u=l),256===a||1>l?null:{sx:n,sy:a,sw:o,sh:l,dx:r,dy:h,dw:s,dh:u}},_getShiftTilesArray:function(t,e,i){var n=this.gmx.mInPixel,o=this.gmxTilePoint,r=e*n,s=i*n,a=Math.floor(.5+r%256),l=Math.floor(.5+s%256),h=256/n,u=o.x-e/h,c=o.y-i/h,d=Math.floor(u),p=d+(u===d?0:1),m=Math.floor(c),f=m+(c===m?0:1),g=Math.floor((t.min.x-e)/h),_=Math.floor((t.max.x-e)/h),v=Math.floor((t.min.y-i)/h),y=Math.floor((t.max.y-i)/h);g>d&&(d=g),p>_&&(p=_),v>m&&(m=v),f>y&&(f=y);for(var x=[],L=m;f>=L;L++)for(var b=d;p>=b;b++)x.push({z:o.z,x:b,y:L,dx:a,dy:l,tx:u,ty:c});return x},_getItemRasters:function(t){var i,o=t.properties,r=o[0],s=this,a=this.gmx,l=a.tileAttributeIndexes,h=this.rasters,u=null,c=Number(a.shiftXfield?n.getPropItem(a.shiftXfield,o,l):0)%this.worldWidthMerc,d=Number(a.shiftYfield?n.getPropItem(a.shiftYfield,o,l):0),p=c||d,m=n.getPropItem("urlBG",o,l),f="",g=null,_=!1,v=a.dataManager.getItem(r),y=this.gmxTilePoint,x=null,L=null;if(a.IsRasterCatalog&&("Raster"===a.rawProperties.type||n.getPropItem("GMX_RasterCatalogID",o,l))?_=!0:a.quicklookBGfunc?(f=a.quicklookBGfunc(v),g=a.imageQuicklookProcessingHook):m&&(f=m,g=a.imageQuicklookProcessingHook),_)u=new e.gmx.Deferred(function(){i.forEach(function(t){t.cancel()}),i=null});else{f+=(-1===f.indexOf("?")?"?":"&")+a.sessionKey;var b=this.rasterRequests[f];b?b.options.tileRastersId=this._uniqueID:(b=e.gmx.imageLoader.push(f,{tileRastersId:s._uniqueID,crossOrigin:a.crossOrigin||"anonymous"}),this.rasterRequests[f]=b),u=new e.gmx.Deferred(function(){delete s.rasterRequests[f],b.def.cancel()}),b.def.then(u.resolve,u.reject)}var P=new e.gmx.Deferred(function(){u&&(u.cancel(),u=null)});if(_){var S=t.dataOption||{},T=p?this._getShiftTilesArray(S.bounds,c,d):[y],w=T.length,C=function(){1>w&&u.resolve()},M=function(){w--,C()},D=function(t){return a.rasterBGfunc(t.x,t.y,t.z,v)},I=function(i,o,r){v.skipRasters=!1;var l=!0;g&&(r=g(r,{gmx:a,geoItem:t,item:v,gmxTilePoint:i}),l=!1);var h={geoItem:t,image:r,destinationTilePoint:y,sourceTilePoint:i,sx:0,sy:0,sw:256,sh:256,dx:0,dy:0,dw:256,dh:256};if(p){var u=s._getShiftPixels(o);if(null===u)return M(),void 0;e.extend(h,u),l=!1}if(i.z!==y.z){var c=n.getTilePosZoomDelta(y,y.z,i.z);if(c.size<1/256)return C(),void 0;if(l=!1,h.sx=Math.floor(c.x),h.sy=Math.floor(c.y),h.sw=h.sh=c.size,p){var d=Math.floor(h.dw/c.zDelta);h.sx=(0===h.dx?h.sw:256)-d,h.sw=d;var m=Math.floor(h.dh/c.zDelta);h.sy=(0===h.dy?h.sh:256)-m,h.sh=m}}if(l&&!a.rasterProcessingHook)w--,x=r,C();else{x||(x=document.createElement("canvas"),x.width=x.height=256),h.res=x;var f=s._rasterHook(h),_=function(){w--,o.resImage=x,C()};f?f instanceof e.gmx.Deferred&&f.then(_):null===f?(v.skipRasters=!0,M()):_()}};i=T.map(function(t){var e=s._loadTileRecursive(t,D);return e.then(function(e){I(e.gtp,t,e.image)},M),e}),u.then(function(){h[r]=x,P.resolve()})}else{v.skipRasters=!1;var k=function(i){var n={gmx:a,geoItem:t,item:v,gmxTilePoint:y};x||(x=document.createElement("canvas"),x.width=x.height=256);var o=function(i){var o=s._rasterHook({geoItem:t,res:x,image:g?g(i,n):i,destinationTilePoint:y,url:f}),a=function(){h[r]=x,P.resolve()};o?o instanceof e.gmx.Deferred&&o.then(a):null===o?(v.skipRasters=!0,P.resolve()):a()};o(i),delete s.rasterRequests[f]};L?k(L):u.then(k.bind(this),P.resolve)}return P.always(function(){u=null,i&&(i=null)}),P},_getVisibleItems:function(t){if(t.length<2)return t;n._tileCanvas||(n._tileCanvas=document.createElement("canvas"),n._tileCanvas.width=n._tileCanvas.height=256);var i,o,r=this.gmx,s=r.dataManager,a=n._tileCanvas,l=a.getContext("2d"),h={tbounds:this.tbounds,gmx:r,tpx:this.tpx,tpy:this.tpy,ctx:l};for(l.clearRect(0,0,256,256),l.imageSmoothingEnabled=!1,i=0,o=t.length;o>i;i++){l.fillStyle=n.dec2rgba(i+1,1);var u=t[i];e.gmxUtil.drawGeoItem(u,s.getItem(u.properties[0]),h,{fillStyle:l.fillStyle})}var c={},d=l.getImageData(0,0,256,256).data;for(i=0,o=d.length;o>i;i+=4)if(255===d[i+3]){var p=d[i+2];d[i+1]&&(p+=d[i+1]<<8),d[i]&&(p+=d[i]<<16),p&&(c[p]=!0)}var m=[];for(var f in c){var g=t[Number(f)-1];g&&m.push(g)}return m},_getNeedRasterItems:function(t){for(var e=this.gmx,i=e.tileAttributeIndexes,o=this.tbounds,r=[],s=0,a=t.length;a>s;s++){var l=t[s],h=l.properties,u=h[0],c=l.dataOption||{},d=!1;if(e.quicklookBGfunc&&!n.getPropItem("GMX_RasterCatalogID",h,i)){if(e.minZoomQuicklooks&&this.zoom<e.minZoomQuicklooks)continue;var p=n.getPropItem(e.quicklookPlatform,h,i)||e.quicklookPlatform||"";if(!(p&&"imageMercator"!==p||n.getQuicklookPointsFromProperties(h,e)))continue}e.styleHook&&(l.styleExtend=e.styleHook(e.dataManager.getItem(u),e.lastHover&&u===e.lastHover.id),d=l.styleExtend&&l.styleExtend.skipRasters),!d&&o.intersectsWithDelta(c.bounds,-1,-1)&&r.push(l)}return this._getVisibleItems(r)},_getTileRasters:function(t){var i=[],n=new e.gmx.Deferred(function(){i.forEach(function(t){t.cancel()}),i=null}),o=this._getNeedRasterItems(t),r=o.length;if(r){var s=this,a=function(){1>r&&n.resolve()};o.forEach(function(t){var e=s._getItemRasters(t);e.then(function(){r--,a()}),i.push(e)})}else n.resolve();return n},_chkItems:function(t){var e=this.layer;if(!e._map)return null;var i=t&&t.added&&t.added.length?t.added:null;if(!i){var n=e._tiles[this.zKey];return n&&n.el&&n.el.getContext("2d").clearRect(0,0,256,256),null}return this.gmx.sortItems?e.getSortedItems(i):i},_cancelRastersPromise:function(){this.rastersPromise&&(this.rastersPromise.cancel(),this.rastersPromise=null)},drawTile:function(t){var i=this.currentDrawPromise,n=this;this._uniqueID++,i&&(this._cancelRastersPromise(),this._preRenderPromise&&this._preRenderPromise.cancel(),this._renderPromise&&this._renderPromise.cancel(),i.reject()),i=new e.gmx.Deferred(this._cancelRastersPromise.bind(this)),i.always(function(){n._drawDone(),n.currentDrawPromise=null,n.rastersPromise=null,n._preRenderPromise=null,n._renderPromise=null
}),this.currentDrawPromise=i;var o=this._chkItems(t);if(!o)return i.resolve(),i;var r=this.layer.gmxGetCanvasTile(this.tilePoint),s=r.el,a=s.getContext("2d"),l=this.gmx,h={tbounds:this.tbounds,rasters:this.rasters,gmx:l,tpx:this.tpx,tpy:this.tpy,ctx:a};s.zKey=r.el._zKey=this.zKey;var u=function(){a.clearRect(0,0,256,256);var t={tpx:n.tpx,tpy:n.tpy,x:n.tilePoint.x,y:n.tilePoint.y,z:n.zoom},r=null;n._preRenderPromise=new e.gmx.Deferred,n._preRenderPromise.resolve(r),l.preRenderHooks.forEach(function(e){n._preRenderPromise=n._preRenderPromise.then(function(i){return r=i||r,r||(r=document.createElement("canvas"),r.width=r.height=256),e(r,t)})}),n._preRenderPromise.then(function(a){r=a||r,r&&(h.bgImage=r);for(var u=0,c=o.length;c>u;u++){var d=o[u],p=d.id,m=l.dataManager.getItem(p);if(m){var f=l.styleManager.getObjStyle(m),g=l.lastHover&&l.lastHover.id===d.id&&f;if(l.multiFilters)for(var _=0,v=m.multiFilters.length;v>_;_++){var y=m.multiFilters[_];e.gmxUtil.drawGeoItem(d,m,h,g?y.parsedStyleHover:y.parsedStyle,y.style)}else e.gmxUtil.drawGeoItem(d,m,h,g?m.parsedStyleHover:m.parsedStyleKeys,f);p in l._needPopups&&!l._needPopups[p]&&(l._needPopups[p]=!0)}}n.rasters={},n.layer._map&&!s.parentNode&&n.layer.appendTileToContainer(s),n._renderPromise=new e.gmx.Deferred,n._renderPromise.resolve(s),l.renderHooks.forEach(function(e){n._renderPromise=n._renderPromise.then(function(i){return s=i||s,e(s,t)})}),n._renderPromise.then(i.resolve,i.reject)},i.reject)};return this.showRaster?(this.rastersPromise=this._getTileRasters(o),this.rastersPromise.then(u,i.reject)):u(),i},destructor:function(){this._cancelRastersPromise(),this._clearCache(),this.currentDrawPromise&&this.currentDrawPromise.reject()},_drawDone:function(){for(var t in this.rasterRequests){var e=this.rasterRequests[t];this._uniqueID!==e.options.tileRastersId&&(e.remove(),delete this.rasterRequests[t])}},_clearCache:function(){for(var t in this.rasterRequests)this.rasterRequests[t].remove();this.rasterRequests={}}},function(){var t=1e6,i=function(t){this.all={},this.userSetSortFunc=!1,this.sortFunc=null,this.count=0,this.disabled=!1,this.layer=t,t.on("add",this.onAdd,this),t.on("remove",this.onRemove,this)};i.prototype={addToReorder:function(t,e){++this.count,this.all[t]=e?-this.count:this.count},clickFunc:function(t){if(!this.disabled){var e=t.gmx.id;this.addToReorder(e,t.originalEvent.ctrlKey),this.layer.redrawItem(e)}},sortItems:function(e,i){var n=this._objectsReorder;if(n.count>0){var o=n.all[e.id],r=n.all[i.id];if(o||r)return o=o?o+(o>0?t:-t):0,r=r?r+(r>0?t:-t):0,o-r}return n.sortFunc?n.sortFunc.call(this,e,i):0},resetSortFunc:function(){var t=this.layer,e=t._gmx,i=e.zIndexField;e.sortItems=this.sortItems,this.sortFunc=i&&!this.userSetSortFunc?function(t,e){var n=Number(t.properties[i])-Number(e.properties[i]);return n?n:t.id-e.id}:function(t,e){return t.id-e.id}},initialize:function(){var t=this.layer._gmx;this.userSetSortFunc||"polygon"!==t.GeometryType&&"linestring"!==t.GeometryType||this.resetSortFunc()},onAdd:function(){this.initialize(),this.layer.on("click",this.clickFunc,this)},onRemove:function(){this.layer.off("click",this.clickFunc,this)}},e.gmx.VectorLayer.include({_objectsReorder:null,_objectsReorderInit:function(){this._objectsReorder||(this._objectsReorder=new i(this))},getReorderArrays:function(){var t={top:[],bottom:[]};if(this._objectsReorder)for(var e=this._objectsReorder,i=Object.keys(e.all).sort(function(t,i){return e.all[t]-e.all[i]}),n=0,o=i.length;o>n;n++){var r=i[n];e.all[r]>0?t.top.push(r):t.bottom.push(r)}return t},bringToTopItem:function(t){return this._objectsReorderInit(),this._objectsReorder.addToReorder(t),this.redrawItem(t),this},bringToBottomItem:function(t){return this._objectsReorderInit(),this._objectsReorder.addToReorder(t,!0),this.redrawItem(t),this},clearReorderArrays:function(){if(this._objectsReorder){var t=this._objectsReorder;t.all={},t.count=0,this.repaint()}return this},setReorderArrays:function(t,e){this._objectsReorderInit();var i=this._objectsReorder;return i.all={},i.count=0,e.forEach(function(t){i.addToReorder(t,!0)}),t.forEach(function(t){i.addToReorder(t)}),this.repaint(),this},getSortedItems:function(t){return this._objectsReorderInit(),t.sort(e.bind(this._objectsReorder.count>0?this._gmx.sortItems:this._objectsReorder.sortFunc,this))},setSortFunc:function(t){this._objectsReorderInit();var e=this._objectsReorder;return e.sortFunc=t,e.userSetSortFunc=t?!0:!1,this._gmx.sortItems=e.sortItems,this.repaint(),this},disableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!0,this},enableFlip:function(){return this._objectsReorderInit(),this._objectsReorder.disabled=!1,this}})}();var _=function(t){this.gmx=t,this.deferred=new e.gmx.Deferred,this._maxVersion=0,this._maxStyleSize=0,this._styles=[],this._deferredIcons=[],this._parserFunctions={},this._serverStylesParsed=!1;for(var i=1/0,n=-1/0,o=t.properties.styles||[],r=0,s=o.length;s>r;r++){var a=o[r];i=Math.min(i,a.MinZoom),n=Math.max(n,a.MaxZoom)}this.minZoom=1/0===i?0:i,this.maxZoom=n===-1/0?18:n};_.prototype={_getMaxStyleSize:function(t){for(var e=0,i=0,n=this._styles.length;n>i;i++){var o=this._styles[i];if(!(t>o.MaxZoom||t<o.MinZoom)){var r=o.RenderStyle;if(this._needLoadIcons||!r||!("maxSize"in r)){e=_.MAX_STYLE_SIZE;break}var s=0;"iconAnchor"in r&&!r.iconCenter&&(s=Math.max(Math.abs(r.iconAnchor[0]),Math.abs(r.iconAnchor[1]))),e=Math.max(r.maxSize+s,e)}}return e},getStyleBounds:function(t){if(!t)return n.bounds();this._maxStyleSize=this._getMaxStyleSize(this.gmx.currentZoom);var e=2*this._maxStyleSize*n.tileSizes[t.z]/256;return n.getTileBounds(t.x,t.y,t.z).addBuffer(e)},isVisibleAtZoom:function(t){for(var e=0,i=this._styles.length;i>e;e++){var n=this._styles[e];if(t>=n.MinZoom&&t<=n.MaxZoom)return!0}return!1},getIcons:function(t){var e=this;this.deferred.then(function(){for(var i=[],n=0,o=e._styles.length;o>n;n++){var r=e._styles[n],s={};r.RenderStyle&&(s.RenderStyle={image:r.RenderStyle.image}),r.HoverStyle&&(s.HoverStyle={image:r.HoverStyle.image}),i.push(s)}t&&t(i)}),this.initStyles()},_chkReady:function(){if(this._needLoadIcons<1){var t=this;this.gmx.dataManager&&this.gmx.dataManager.addFilter("styleFilter",function(e){return t._chkStyleFilter(e)}),this.deferred.resolve()}},initStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var t=0,e=this._deferredIcons.length;e>t;t++)this._getImageSize(this._deferredIcons[t]);return this._deferredIcons=[],this._chkReady(),this.deferred},getStyles:function(){this._serverStylesParsed||this._parseServerStyles();for(var t=[],i=0,n=this._styles.length;n>i;i++){var o=e.extend({},this._styles[i]);o.RenderStyle=_.getStyleKeys(o.RenderStyle),o.HoverStyle&&(o.HoverStyle=_.getStyleKeys(o.HoverStyle)),delete o.filterFunction,delete o.version,delete o.common,delete o.type,t.push(o)}return t},clearStyles:function(){this._styles=[],this.gmx.balloonEnable=!1,this.gmx.labelsLayer=!1},_changeStylesVersion:function(){var t=this;this._styles.map(function(e){e.version=++t._maxVersion})},setStyle:function(t,i,n){if(i=i||0,i<this._styles.length||n){var o=this._styles[i];if(o||(o=this._prepareItem({}),this._styles[i]=o),this.deferred=new e.gmx.Deferred,o.version=++this._maxVersion,"Filter"in t){o.Filter=t.Filter;var r=typeof t.Filter;o.filterFunction="string"===r?e.gmx.Parsers.parseSQL(o.Filter.replace(/[\[\]]/g,'"')):"function"===r?o.Filter:null,this._changeStylesVersion()}for(var s=0,a=_.DEFAULT_KEYS.length;a>s;s++){var l=_.DEFAULT_KEYS[s];l in t&&(o[l]=t[l])}t.RenderStyle&&(o.RenderStyle=this._parseStyle(t.RenderStyle)),t.HoverStyle&&(o.HoverStyle=this._parseStyle(t.HoverStyle,o.RenderStyle)),this._checkStyles()}return this.initStyles()},getItemBalloon:function(t){var e=this.gmx.dataManager.getItem(t),i=e?e.currentFilter:0,n=this._styles[i];return n?{DisableBalloonOnMouseMove:n.DisableBalloonOnMouseMove||!1,DisableBalloonOnClick:n.DisableBalloonOnClick||!1,templateBalloon:n.Balloon||null,isSummary:/\[SUMMARY\]/.test(n.Balloon)}:null},getObjStyle:function(t){this._chkStyleFilter(t);var e,i=this._styles[t.currentFilter];return i?i.hoverDiff&&this.gmx.lastHover&&t.id===this.gmx.lastHover.id?i.HoverStyle?(e=i.HoverStyle.version||-1,e!==t.styleVersion&&(t.parsedStyleHover=this._itemStyleParser(t,i.HoverStyle)),i.HoverStyle):(delete t.parsedStyleHover,null):(e=i.version||-1,e!==t.styleVersion&&(t.parsedStyleKeys=this._itemStyleParser(t,i.RenderStyle)),i.RenderStyle):null},_needLoadIcons:0,_getImageSize:function(t){var i=t.iconUrl||t.fillIconUrl,n=t.iconAngle||t.iconScale?{crossOrigin:"anonymous"}:{},o=this;e.gmxUtil.isIE11&&/\.svg$/.test(i)&&(n={}),n.layerID=this.gmx.layerID,++this._needLoadIcons,e.gmx.imageLoader.unshift(i,n).def.then(function(n){if(t.version=++o._maxVersion,t.fillIconUrl)t.imagePattern=n;else{var r=n.width,s=n.height;e.gmxUtil.isIE11&&/\.svg$/.test(i)&&(document.body.appendChild(n),r=n.offsetWidth,s=n.offsetHeight,document.body.removeChild(n)),t.sx=r,t.sy=s,t.image=n;var a=t.iconAngle?Math.sqrt(t.sx*t.sx+t.sy*t.sy):Math.max(t.sx,t.sy);t.scaleFunction||t.rotateFunction||((t.iconScale||1===t.iconScale)&&(a*=t.iconScale),t.common=!0),t.maxSize=Number(a.toFixed())}o._needLoadIcons--,o._chkReady()},function(){t.version=++o._maxVersion,t.sx=1,t.sy=0,t.image=null,o._needLoadIcons--,o._chkReady(),console.log({url:i,func:"_getImageSize",Error:"image not found"})})},getCurrentFilters:function(t,e){var i=this.gmx,n=i.tileAttributeIndexes,o=i.tileAttributeTypes,r=e||1,s=[];this._serverStylesParsed||this._parseServerStyles();for(var a=0,l=this._styles.length;l>a;a++){var h=this._styles[a];if(!(r>h.MaxZoom||r<h.MinZoom||h.filterFunction&&!h.filterFunction(t,n,o)||(s.push(a),i.multiFilters)))break}return s},_chkStyleFilter:function(t){var e=this.gmx,i=e.currentZoom,n=e.multiFilters?-1:t.currentFilter,o=this._styles[n],r=!o||o.version!==t.styleVersion;if(r||t._lastZoom!==i){t.currentFilter=-1,t.multiFilters=[];for(var s=this.getCurrentFilters(t.properties,i),a=0,l=s.length;l>a;a++){var h=s[a],u=this._styles[h];if(t.hoverDiff=u.hoverDiff,t.currentFilter=h,r||n!==h){var c=u.common&&u.common.RenderStyle||this._itemStyleParser(t,u.RenderStyle),d=null;t.parsedStyleKeys=c,u.HoverStyle&&(d=u.common&&u.common.HoverStyle||this._itemStyleParser(t,u.HoverStyle),t.parsedStyleHover=d),e.multiFilters&&t.multiFilters.push({style:u.RenderStyle,styleHover:u.HoverStyle,parsedStyle:c,parsedStyleHover:d})}if(t.styleVersion=u.version,!e.multiFilters)break}t._lastZoom=i}return this._styles[t.currentFilter]?!0:(t.currentFilter=-1,!1)},_parseServerStyles:function(){for(var t=this.gmx,e=t.properties,i=e.styles||[{MinZoom:1,MaxZoom:21,RenderStyle:_.DEFAULT_STYLE}],n=Math.max(i.length,t.styles.length),o=0;n>o;o++)if(!this._styles[o]){var r=t.styles[o]||i[o];if(r.RenderStyle||(r.RenderStyle=_.DEFAULT_STYLE),void 0===r.HoverStyle){var s=JSON.parse(JSON.stringify(r.RenderStyle));s.outline&&(s.outline.thickness+=1),r.HoverStyle=s}else null===r.HoverStyle&&delete r.HoverStyle;var a=this._prepareItem(r);this._styles.push(a),this._isLabel(a.RenderStyle)&&(t.labelsLayer=!0)}this._checkStyles(),this._serverStylesParsed=!0},_checkStyles:function(){for(var t=1/0,e=-1/0,i=!1,n=!1,o=0,r=this._styles.length;r>o;o++){var s=this._styles[o];s.DisableBalloonOnMouseMove=s.DisableBalloonOnMouseMove===!1?!1:!0,s.DisableBalloonOnClick=s.DisableBalloonOnClick||!1,(s.DisableBalloonOnMouseMove===!1||s.DisableBalloonOnClick===!1)&&(i=!0,s.BalloonEnable=!0),s.hoverDiff=null,s.common={},s.RenderStyle&&(n||this._isLabel(s.RenderStyle)&&(n=!0),s.RenderStyle.common&&(s.common.RenderStyle=this._itemStyleParser({},s.RenderStyle)),s.HoverStyle&&(s.hoverDiff=_.checkDiff(s.RenderStyle,s.HoverStyle))),s.HoverStyle&&s.HoverStyle.common&&(s.common.HoverStyle=this._itemStyleParser({},s.HoverStyle)),t=Math.min(t,s.MinZoom),e=Math.max(e,s.MaxZoom)}1/0!==this.minZoom&&(this.minZoom=t),this.maxZoom!==-1/0&&(this.maxZoom=e),this.gmx.balloonEnable=i,this.gmx.labelsLayer=n},_parseStyle:function(t,i){if(t){t.common=!0;for(var o in t)if(n.styleFuncKeys[o]){var r=n.styleFuncKeys[o],s=t[o];"string"==typeof s?(t.common=!1,i&&i[o]===s?t[r]=i[r]:(this._parserFunctions[s]||(this._parserFunctions[s]=e.gmx.Parsers.parseExpression(s)),t[r]=this._parserFunctions[s])):"function"==typeof s&&(t.common=!1,t[r]=s)}var a="";if("iconUrl"in t)a="image",t.iconUrl&&(t.maxSize=256,this._deferredIcons.push(t));else if(t.fillIconUrl)a="square",this._deferredIcons.push(t);else if(t.fillPattern)a="square",t.common=_.parsePattern(t.fillPattern),t.canvasPattern=n.getPatternIcon(null,t);else if(t.iconCircle)a="circle","iconSize"in t||(t.iconSize=4);else if(t.iconPath){a="iconPath";var l=0,h=e.Util.isArray(t.iconPath)?t.iconPath:_.DEFAULT_ICONPATH;t.iconPath=_.DEFAULT_ICONPATH.map(function(t,e){var i=h[e]||t;return l=Math.max(l,i),i}),t.iconSize=2*l}else if(t.fillRadialGradient){a="circle","iconCenter"in t||(t.iconCenter=!0);var u=_.parseRadialGradient(t.fillRadialGradient);null===u?t.common=!1:t.iconSize=u}else t.fillLinearGradient?(a="square",t.common=_.parseLinearGradient(t.fillLinearGradient)):t.iconSize&&(a="square","iconCenter"in t||(t.iconCenter=!0));t.type=a,t.common&&!t.maxSize&&(t.maxSize=t.iconSize||0,t.maxSize+=t.weight?t.weight:0,"iconScale"in t&&(t.maxSize*=t.iconScale))}return t},_prepareItem:function(t){var i={MinZoom:t.MinZoom||0,MaxZoom:t.MaxZoom||18,Filter:t.Filter||null,Balloon:t.Balloon||"",RenderStyle:t.RenderStyle?this._parseStyle(e.gmxUtil.fromServerStyle(t.RenderStyle)):{},version:++this._maxVersion};if(i.DisableBalloonOnMouseMove=t.DisableBalloonOnMouseMove===!1?!1:!0,i.DisableBalloonOnClick=t.DisableBalloonOnClick||!1,t.HoverStyle&&(i.HoverStyle=this._parseStyle(e.gmxUtil.fromServerStyle(t.HoverStyle),i.RenderStyle)),"Filter"in t){var n=e.gmx.Parsers.parseSQL(t.Filter.replace(/[\[\]]/g,'"'));n&&(i.filterFunction=n)}return i},_isLabel:function(t){var e=this.gmx.tileAttributeIndexes;return t&&(t.labelTemplate||t.labelField&&t.labelField in e)},_itemStyleParser:function(t,e){e=e||{};var i,o,r,s={},a=this.gmx.tileAttributeIndexes,l=t.properties||{},h=t.type,u=e.type,c="color"in e?e.color:255,d="opacity"in e?e.opacity:1;if(s.sx=e.sx,s.sy=e.sy,e.maxSize&&(s.maxSize=e.maxSize),e.iconAngle){var p=e.iconAngle||0;p&&"string"==typeof p&&(p=e.rotateFunction?e.rotateFunction(l,a):0),s.rotate=p||0}if("iconColor"in e&&(s.iconColor="iconColorFunction"in e?e.iconColorFunction(l,a):e.iconColor),"iconScale"in e&&(s.iconScale="scaleFunction"in e?e.scaleFunction?e.scaleFunction(l,a):1:e.iconScale),"image"===u)s.type=u,e.iconUrl&&(s.iconUrl=e.iconUrl),e.image&&(s.image=e.image);else if(e.fillRadialGradient){var m=e.fillRadialGradient,f=m.r1Function?m.r1Function(l,a):m.r1,g=m.r2Function?m.r2Function(l,a):m.r2,_=m.x1Function?m.x1Function(l,a):m.x1,v=m.y1Function?m.y1Function(l,a):m.y1,y=m.x2Function?m.x2Function(l,a):m.x2,x=m.y2Function?m.y2Function(l,a):m.y2;m.r2max&&(g=Math.min(g,m.r2max));var L=[];for(r=m.addColorStop.length,m.addColorStopFunctions||(m.addColorStopFunctions=new Array(r)),o=0;r>o;o++){i=m.addColorStop[o];var b=m.addColorStopFunctions[o]||[],P=b[0]?b[0](l,a):i[0],S=i[3];if(i.length<4){var T=i.length<3?1:b[2]?b[2](l,a):i[2];S=n.dec2color(b[1]?b[1](l,a):i[1],T)}L.push([P,S])}s.maxSize=s.sx=s.sy=s.iconSize=g,s.fillRadialGradient={x1:_,y1:v,r1:f,x2:y,y2:x,r2:g,addColorStop:L},s._radialGradientParsed={create:[_,v,f,y,x,g],colorStop:L}}else if(e.fillLinearGradient)s.fillLinearGradient=e.fillLinearGradient;else{if(e.fillPattern&&(s.canvasPattern=e.canvasPattern?e.canvasPattern:n.getPatternIcon(t,e,a)),"iconPath"===u&&(s.type=u,s.iconPath=e.iconPath),("POLYGON"===h||"MULTIPOLYGON"===h||"polygon"===this.gmx.GeometryType)&&(u="polygon"),e.iconSize){var w="sizeFunction"in e?e.sizeFunction(l,a):e.iconSize;s.sx=s.sy=w,s.iconSize=w,"iconScale"in e&&(s.iconSize*=e.iconScale),s.maxSize=w}s.stroke=!0,("colorFunction"in e||"opacityFunction"in e)&&(c="colorFunction"in e?e.colorFunction(l,a):c,d="opacityFunction"in e?e.opacityFunction(l,a):d),s.strokeStyle=n.dec2color(c,d),s.lineWidth="weight"in e?e.weight:1}if("iconScale"in e&&(s.iconScale="scaleFunction"in e?e.scaleFunction?e.scaleFunction(l,a):1:e.iconScale),"iconAnchor"in e&&(s.iconAnchor=e.iconAnchor),"iconCenter"in e&&(s.iconCenter=e.iconCenter),"square"===u||"polygon"===u||"circle"===u||"iconPath"===u){s.type=u;var C=e.fillOpacity,M=e.fillColor,D="string"==typeof M?parseInt(M.replace(/#/,""),16):M;"fillColor"in e&&(s.fillStyle=n.dec2color(D,1)),"fillColorFunction"in e||"fillOpacityFunction"in e?(c="fillColorFunction"in e?e.fillColorFunction(l,a):M||255,d="fillOpacityFunction"in e?e.fillOpacityFunction(l,a):C||1,s.fillStyle=n.dec2color(c,d)):"fillOpacity"in e&&"fillColor"in e&&(s.fillStyle=n.dec2color(D,C))}if("dashArray"in e&&(s.dashArray=e.dashArray),"dashOffset"in e&&(s.dashOffset=e.dashOffset),this.gmx.labelsLayer){for(i=n.styleKeys.label.client,o=0,r=i.length;r>o;o++){var I=i[o];if(I in e){if("labelField"===I){if(!a[e[I]])continue}else if("labelTemplate"===I){var k=n.getPropertiesHash(l,a);s.labelText=n.parseTemplate(e[I],k)}s[I]=e[I]}}"labelAnchor"in e&&(s.labelAnchor=e.labelAnchor)}return s}},_.MAX_STYLE_SIZE=256,_.DEFAULT_STYLE={outline:{color:255,thickness:1},marker:{size:8}},_.DEFAULT_KEYS=["MinZoom","MaxZoom","Balloon","BalloonEnable","DisableBalloonOnMouseMove","DisableBalloonOnClick"],_.DEFAULT_ICONPATH=[0,10,5,-10,-5,-10,0,10],_.parsePattern=function(t){var i=!0,n=e.gmx.Parsers;if("step"in t&&"string"==typeof t.step&&(t.patternStepFunction=n.parseExpression(t.step),i=!1),"width"in t&&"string"==typeof t.width&&(t.patternWidthFunction=n.parseExpression(t.width),i=!1),"colors"in t){for(var o=[],r=0,s=t.colors.length;s>r;r++){var a=t.colors[r];"string"==typeof a?(o.push(n.parseExpression(a)),i=!1):o.push(null)}t.patternColorsFunction=o}return i},_.getStyleKeys=function(t){var e={};for(var i in n.styleKeys)for(var o=n.styleKeys[i],r=0,s=o.client.length;s>r;r++){var a=o.client[r];a in t&&(void 0!==t[a]&&(e[a]=JSON.parse(JSON.stringify(t[a]))),"fillPattern"===a?delete e[a].patternColorsFunction:"fillLinearGradient"===a&&delete e[a].addColorStopFunctions)}return"iconAnchor"in t&&(e.iconAnchor=t.iconAnchor),"labelAnchor"in t&&(e.labelAnchor=t.labelAnchor),e},_.checkDiff=function(t,e){for(var i in t)if(t[i]!==e[i])return i;return null},_.parseRadialGradient=function(t){var i=!0,o=e.gmx.Parsers,r=0,s=["r1","x1","y1","r2","x2","y2"],a=s.length;for(r=0;a>r;r++){var l=s[r];t[l]||(t[l]=0),"string"==typeof t[l]&&(t[l+"Function"]=o.parseExpression(t[l]),i=!1)}for(t.addColorStop=t.addColorStop||[[0,16711680,.5],[1,16777215,.5]],t.addColorStopFunctions=[],r=0,a=t.addColorStop.length;a>r;r++){s=t.addColorStop[r];var h=["string"==typeof s[0]?o.parseExpression(s[0]):null,"string"==typeof s[1]?o.parseExpression(s[1]):null,"string"==typeof s[2]?o.parseExpression(s[2]):null];t.addColorStopFunctions.push(h),null===h[1]&&null===h[2]?s[3]=n.dec2color(s[1],s[2]>1?s[2]/100:s[2]):i=!1}return"r2Function"in t&&(i=!1),i?Math.max(t.r1,t.r2):null},_.parseLinearGradient=function(t){var i=!0,n=0,o=e.gmx.Parsers,r=["x1","y1","x2","y2"],s=[0,0,0,256],a=r.length;for(n=0;a>n;n++){var l=r[n];l in t?"string"==typeof t[l]&&(t[l+"Function"]=o.parseExpression(t[l]),i=!1):t[l]=s[n]}for(t.addColorStop=t.addColorStop||[[0,16711680],[1,16777215]],t.addColorStopFunctions=[],n=0,a=t.addColorStop.length;a>n;n++)r=t.addColorStop[n],t.addColorStopFunctions.push(["string"==typeof r[0]?o.parseExpression(r[0]):null,"string"==typeof r[1]?o.parseExpression(r[1]):null,"string"==typeof r[2]?o.parseExpression(r[2]):null]);return i},e.gmx.VectorLayer.include({bindPopup:function(t,i){var n=e.extend({maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID},i);return this._popup&&this.unbindPopup(),t instanceof e.Popup?this._popup=t:((!this._popup||i)&&(this._popup=new e.Popup(n)),this._popup.setContent(t)),this._popup._initContent=t,this._popup._state="",this._popupHandlersAdded||(this.on("click",this._openClickPopup,this).on("mousemove",this._movePopup,this).on("mouseover",this._overPopup,this).on("mouseout",this._outPopup,this).on("doneDraw",this._chkNeedOpenPopup,this),this._popupHandlersAdded=!0),n&&n.popupopen&&(this._popupopen=n.popupopen),this._popup.updateLayout=this._popup._updateLayout,this},unbindPopup:function(){return this._popup&&(this._popup=null,this.off("click",this._openClickPopup,this).off("mousemove",this._movePopup,this).off("mouseover",this._overPopup,this).off("mouseout",this._outPopup,this).off("doneDraw",this._chkNeedOpenPopup,this),this._popupopen=null,this._popupHandlersAdded=!1),this._gmx.balloonEnable=!1,this},_chkNeedOpenPopup:function(){for(var t in this._gmx._needPopups)this._gmx._needPopups[t]&&(this.addPopup(t),delete this._gmx._needPopups[t])},disablePopup:function(){return this._popupDisabled=!0,this},enablePopup:function(){return this._popupDisabled=!1,this},openPopup:function(t,e){return this._popup&&(t=t||this._latlng||this._latlngs[Math.floor(this._latlngs.length/2)],e=e||{},e.latlng=t,this._openPopup(e)),this},closePopup:function(){return this._popup&&(this._popup._close(),this.fire("popupclose",{popup:this._popup})),this},_movePopup:function(t){if("mouseover"===this._popup._state){var e=this._popup.options._gmxID||-1;e!==t.gmx.id&&this._setPopupContent(t),this._popup.setLatLng(t.latlng)}},_overPopup:function(t){var e=this._popup;e._map?this.fire("popupopen",{popup:e,gmx:this._setPopupContent(t,e)}):this._openPopup(t),"mouseover"===e._state&&e.setLatLng(t.latlng)},_outPopup:function(t){"mouseover"!==this._popup._state||t.gmx.prevId||this.closePopup()},_callBalloonHook:function(t,e){var i,n,o,r=e.getElementsByTagName("span"),s={};for(i in this._balloonHook){var a=this._balloonHook[i].hookID;for(s[i]=0,n=0,o=r.length;o>n;n++)r[n].id===a&&s[i]++}for(i in this._balloonHook){var l=this._balloonHook[i],h=l.hookID,u=!0;for(n=0,o=r.length;o>n;n++){var c=r[n];c.id===h&&(u=!1,c.id+="_"+n,l.callback(t,e,c,s))}u&&l.callback(t,e,null,s)}},_setPopupContent:function(t,i){i||(i=this._popup);var o=t.gmx||{},r=o.balloonData||{},s=e.extend({},o.properties),a=o.target||{},l=a.geometry||{},h=a.offset,u=i._initContent||r.templateBalloon||"",c=t.type,d=this.options.isGeneralized&&("mouseover"===c||"mousemove"===c),p={id:o.id,type:c,nodePoint:o.nodePoint,latlng:t.latlng,properties:s,templateBalloon:u};if("POINT"===l.type){var m=l.coordinates;p.latlng=e.Projection.Mercator.unproject({x:m[0],y:m[1]})}if(h){var f=e.Popup.prototype.options.offset;i.options.offset=[-f[0]-h[0],f[1]-h[1]]}if(this._popupopen)this._popupopen({popup:i,latlng:p.latlng,layerPoint:t.layerPoint,contentNode:i._contentNode,containerPoint:t.containerPoint,originalEvent:t.originalEvent,gmx:p});else if(!(u instanceof e.Popup)){if(!(u instanceof HTMLElement)){var g,_="",v=this._map?this._map.options:{};if(d||(g=a.geometry?[a.geometry]:o.geometries||this._gmx.dataManager.getItemGeometries(o.id)||[],p.summary=_=e.gmxUtil.getGeometriesSummary(g,v)),this._balloonHook){u||(u=n.getDefaultBalloonTemplate(s));for(var y in this._balloonHook)s[y]=n.parseTemplate(this._balloonHook[y].resStr,s)}u=e.gmxUtil.parseBalloonTemplate(u,{properties:s,tileAttributeTypes:this._gmx.tileAttributeTypes,unitOptions:v,summary:_,geometries:g})}var x=e.DomUtil.create("div","");x.innerHTML=u,i.setContent(x),this._balloonHook&&this._callBalloonHook(o.properties,i.getContent())}return i.options._gmxID=o.id,p},_openClickPopup:function(t){var e=t.originalEvent||{},i=!t.gmx||this._popupDisabled||e.ctrlKey||e.altKey||e.shiftKey;if(!i){var o=t.type,r=t.gmx,s=r.balloonData,a="click"===o&&s.isSummary&&!s.DisableBalloonOnClick,l=r.target;if(a&&l.options.isGeneralized&&!l.geometry){var h=r.layer.getGmxProperties();n.getLayerItemFromServer({options:t,layerID:h.name,value:l.id,field:h.identityField}).then(function(t,e){if(t&&"ok"===t.Status&&t.Result){var i=t.Result.values[0];e.options.gmx.target.fromServerProps=i,e.options.gmx.target.geometry=i[i.length-1],this._openPopup(e.options)}}.bind(this))}else this._openPopup(t)}},_openPopup:function(t,i){var n=this._map,o=t.originalEvent||{},r=i?!i:this._popupDisabled||o.ctrlKey||o.altKey||o.shiftKey;if(!r){var s=t.type,a=this._popup,l=t.gmx||{},h=l.balloonData||{};if("click"===s){if(!i&&h.DisableBalloonOnClick&&!this.hasEventListeners("popupopen"))return;"_gmxPopups"in n||(n._gmxPopups=[]),"maxPopupCount"in n.options||(n.options.maxPopupCount=1),this._gmx._gmxPopupsInit||(this._gmx._gmxPopupsInit=!0,n.on({layerremove:function(t){if(t.layer instanceof e.Popup)this._clearPopup(t.layer);else if(t.layer===this){if(n._gmxPopups){var i=this._gmx.layerID;n._gmxPopups=n._gmxPopups.reduce(function(t,e){return e._map&&(e.options.layerId===i?e._map.removeLayer(e):t.push(e)),t},[])}this.closePopup()}}},this)),this._clearPopup(l.id);var u=this._popup?this._popup.options:{maxWidth:1e4,className:"gmxPopup",layerId:this._gmx.layerID};a=new e.Popup(e.extend({},u,{closeOnClick:1===n.options.maxPopupCount,autoPan:!0}))}else{if("mouseover"!==s)return;if(h.DisableBalloonOnMouseMove)return a._state="",void 0;a.options.autoPan=!1}a.options.objectId=l.id,a._state=s;var c=this._setPopupContent(t,a);if(a.setLatLng(c.latlng),this.fire("popupopen",{popup:a,gmx:c}),"click"===s&&(n._gmxPopups.length>=n.options.maxPopupCount&&n.removeLayer(n._gmxPopups.shift()),n._gmxPopups.push(a)),a.addTo(n),a._closeButton){var d=a._closeButton.style;"mouseover"===s&&"hidden"!==d?(d.visibility="hidden",a._container.style.marginBottom="7px",a._container.style.pointerEvents="none"):"click"===s&&"inherit"!==d&&(d.visibility="inherit",a._container.style.marginBottom="",a._container.style.pointerEvents="")}}},_clearPopup:function(t){var i=this._map;if(i&&i._gmxPopups){var n=this._gmx.layerID,o=t instanceof e.Popup;i._gmxPopups=i._gmxPopups.reduce(function(e,i){return i._map&&(o&&i===t?i._map.removeLayer(i):i.options.layerId===n&&i.options.objectId===t?i._map.removeLayer(i):e.push(i)),e},[])}},getPopups:function(t){var e=this._map,i=[];if(e&&e._gmxPopups){var n=this._gmx.layerID;e._gmxPopups.reduce(function(e,i){return i.options.layerId===n&&e.push(t?i:i.options.objectId),e},i)}return i},addPopup:function(t){var i=this._gmx,n=i.dataManager.getItem(t);if(n&&this._map){var o=n.bounds.getCenter(),r=e.Projection.Mercator.unproject(new e.Point(o[0],o[1]));this._openPopup({type:"click",latlng:r,gmx:this.getHoverOption(n)},!0),delete i._needPopups[t]}else i._needPopups[t]=!1;return this},addPopupHook:function(t,i){if(this._balloonHook||(this._balloonHook={}),!this._balloonHook[t]){var n="_"+e.stamp({});this._balloonHook[t]={key:t,hookID:n,resStr:'<span id="'+n+'"></span>',callback:i}}return this},removePopupHook:function(t){return this._balloonHook&&delete this._balloonHook[t],this}}),e.gmx.VectorLayer.include({_gmxFirstObjectsByPoint:function(t,e,i){for(var o,r,s=this._gmx,a=s.mInPixel,l=t.length-1;l>=0;l--){var h=t[l].properties,u=h[0],c=t[l].dataOption||{},d=s.dataManager.getItem(u),p=d.currentStyle||d.parsedStyleKeys||{},m=p.iconScale||1,f=p.iconCenter,g=!f&&p.iconAnchor?p.iconAnchor:null,_=s.styleManager.getObjStyle(d),v=p.lineWidth||_.lineWidth||0,y=v+(_.sx||p.sx||0),x=v+(_.sy||p.sy||0),L=[m*y/2,m*x/2],b=e,P=h[h.length-1],S=P.type;"POINT"===S&&"circle"===_.type&&(L[0]*=2,L[1]*=2);var T=L[0],w=n.bounds().extendBounds(c.bounds).addBuffer(L[0]/a,L[1]/a);if(g&&(L=[g[0]-L[0],g[1]-L[1]],b=[e[0]+L[0]/a,e[1]-L[1]/a]),w.contains(b)){var C=p.fillStyle||p.canvasPattern||_.bgImage||_.fillColor,M=_&&_.image?_.image:null,D=S,I=c.hiddenLines||[],k=c.boundsArr,E=P.coordinates,O=null,A={point:e,bounds:i,coords:E,boundsArr:k};if(("MULTIPOLYGON"===S||"POLYGON"===S)&&(M?D="POINT":C||("POLYGON"===S?(D="MULTILINESTRING",I=I[0]):D="LIKEMULTILINESTRING",A.hidden=I)),"LINESTRING"===D){if(!n.isPointInPolyLine(e,v/a,E)&&(O=n.bounds([b]).addBuffer(L[0]/a,L[1]/a).isNodeIntersect(E),null===O))continue}else if("LIKEMULTILINESTRING"===D){A.delta=v/a;var N=!1;for(o=0,r=E.length;r>o;o++)if(A.coords=E[o],A.hidden=I?I[o]:null,A.boundsArr=k[o],n.isPointInLines(A)){N=!0;break}if(!N)continue}else if("MULTILINESTRING"===D){if(A.delta=v/a,A.hidden=I,!n.isPointInLines(A)){var B=n.bounds([b]).addBuffer(L[0]/a,L[1]/a);for(o=0,r=E.length;r>o;o++)if(O=B.isNodeIntersect(E[o]),null!==O){O.ring=o;break}if(null===O)continue}}else if("MULTIPOLYGON"===D||"POLYGON"===D){var U=e;for(N=!1,"POLYGON"===D&&(E=[P.coordinates],k=[c.boundsArr]),o=0,r=E.length;r>o;o++)for(var z=E[o],R=k[o],F=0,G=z.length;G>F;F++){var Z=R[F];if(Z.intersects(i)&&n.isPointInPolygonWithHoles(U,z)){N=0===F?!0:!1;break}}if(!N)continue}else if("POINT"===D&&"circle"===_.type){var H=(E[0]-b[0])*a,j=(E[1]-b[1])*a;if(H*H+j*j>T*T)continue}if(this.isPointInClipPolygons(e))return{id:u,properties:d.properties,geometry:P,bounds:d.bounds,nodePoint:O,offset:g?L:null,parsedStyle:_}}}return null},gmxEventCheck:function(t,i){if(!this._map)return 0;var o=this,r=o._gmx,s=t.type,a=r.lastHover,l=function(e){a&&"mousemove"===s&&(e&&o.hasEventListeners(e)&&(t.gmx=a,o.fire(e,t)),a.hoverDiff&&o.redrawItem(a.id))},h=this._map.getZoom();if((h>this.options.maxZoom||h<this.options.minZoom)&&(i=!0),i)a&&(a.prevId=null),l("mouseout"),r.lastHover=null;else if(this.hasEventListeners("mouseover")||this.hasEventListeners("mouseout")||this.hasEventListeners(s)||"mousemove"===s&&"Raster"!==r.properties.fromType){var u=t.latlng.lng%360,c=new e.LatLng(t.latlng.lat,u+(-180>u?360:u>180?-360:0)),d=e.Projection.Mercator.project(c)._subtract({x:r.shiftXlayer||0,y:r.shiftYlayer||0}),p=Math.max(5,r.styleManager._getMaxStyleSize(h))/r.mInPixel,m=[d.x,d.y],f={type:"resend",bbox:n.bounds([m]).addBuffer(p),dateInterval:"VectorTemporal"===r.layerType?[r.beginDate,r.endDate]:null,filters:["clipFilter","userFilter_"+r.layerID,"styleFilter","userFilter"],active:!1};this.options.isGeneralized&&(f.targetZoom=h),r.dataManager.addObserver(f,"hover");var g=r.dataManager.getItems("hover");if(r.dataManager.removeObserver("hover"),g&&g.length){g.length>1&&r.sortItems&&(g=this.getSortedItems(g));var _=this._gmxFirstObjectsByPoint(g,m,f.bbox);if(_){var v=_.id,y=r.dataManager.getItem(v),x=a?a.id:null,L=!a||a.id!==v;if("mousemove"===s&&a){if(!L)return t.gmx=a,this.fire(s,t),v;l(y.currentFilter!==a.currentFilter?"mouseout":""),r.lastHover=null}return t.gmx=e.extend(this.getHoverOption(y),{targets:g,nodePoint:_.nodePoint,prevId:x,hoverDiff:y.hoverDiff}),this.hasEventListeners(s)&&this.fire(s,t),"mousemove"===s&&L&&(a=r.lastHover=t.gmx,l("mouseover"),r.lastMouseover=r.lastHover),this._map.doubleClickZoom.disable(),v}}}return this._map&&this._map.doubleClickZoom.enable(),0},getHoverOption:function(t){return{layer:this,target:t,balloonData:this._gmx.styleManager.getItemBalloon(t.id),properties:this.getItemProperties(t.properties),currentFilter:t.currentFilter||0,id:t.id}}}),function(){var t=2e4,i={},o={},r="/Layer/CheckVersion.ashx",s=null,a=null,l="",h=function(t){var e=t.Temporal?"TemporalTiles":"tiles";return e in t},u=function(t,e,i){var n={Name:t.name,Version:h(t)?t.LayerVersion:-1};if(e&&(t.UseTiles===!1||"NotVisible"===window.gmxSkipTiles)){var o=e.getMaxDateInterval(),r=o.beginDate||i.beginDate,s=o.endDate||i.endDate;r&&(n.dateBegin=Math.floor(r.getTime()/1e3)),s&&(n.dateEnd=Math.floor(s.getTime()/1e3))}return n},c=function(t){var n,o,r,s,a={};if(t)t instanceof e.gmx.DataManager?(r=t,n=r.options):(n=t._gmx.properties,r=t._gmx.dataManager,s=t._gmx),o=n.hostName||t._gmx.hostName,a[o]=[u(n,r,s)];else{var l={};for(var h in i){var c=i[h],d=c instanceof e.gmx.DataManager;if(c.options.chkUpdate||d){r=d?c:c._gmx.dataManager,n=d?c.options:c._gmx.properties,s=d?c:c._gmx,o=n.hostName||c._gmx.hostName;var p=u(n,r,s),m=p.Name+p.Version;l[m]||(a[o]?a[o].push(p):a[o]=[p]),l[m]=!0}}}return a},d=function(t,e){var o=function(n){if(n&&"ok"===n.Status&&n.Result)for(var o=0,r=n.Result.length;r>o;o++){var s=n.Result[o],a=s.properties.name;t&&t._gmx.properties.name===a&&"updateVersion"in t&&t.updateVersion(s);for(var h in i){var u=i[h];t&&t===u||(u._gmx&&u._gmx.properties.name===a&&"updateVersion"in u?u.updateVersion(s):u.updateVersion(s.properties))}}l="",e&&e(n)};if(document.body&&!n.isPageHidden()){var s=c(t),a=function(t){var e="http://"+t+r,a=JSON.stringify(s[t]);
if(l!==a){l=a,"FormData"in window?n.request({url:e,async:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},type:"POST",params:"WrapStyle=None&layers="+encodeURIComponent(a),withCredentials:!0,callback:function(t){o(JSON.parse(t))},onError:function(t){console.log("Error: LayerVersion ",t)}}):n.sendCrossDomainPostRequest(e,{WrapStyle:"message",layers:a},o);var h=Date.now();for(var u in i){var c=i[u],d=c._gmx||c.options;d.hostName===t&&(d._stampVersionRequest=h)}}};for(var h in s)a(h)}},p={addDataManager:function(t){var e=t.options.name;e in i||(t.on("chkLayerUpdate",d.bind(t)),i[e]=t)},removeDataManager:function(t){var e=t.options.name;e in i&&(t.off("chkLayerUpdate",d.bind(t)),delete i[e])},remove:function(t){delete i[t._leaflet_id];var e=t._gmx,n=t.options.parentOptions;if(n){var r=n.name;o[r]&&(delete o[r][e.properties.name],Object.keys(o[r]).length||(p.removeDataManager(e.dataManager),delete o[r]))}else e.dataManager.off("chkLayerUpdate",e._chkVersion)},add:function(t){var e=t._leaflet_id;if(!(e in i)){var n=t._gmx,r=n.properties;if("LayerVersion"in r){i[e]=t,n._chkVersion=function(){d(t)},n.dataManager.on("chkLayerUpdate",n._chkVersion);var s=t.options.parentOptions;if(s){var a=s.name;p.addDataManager(n.dataManager),o[a]||(o[a]={}),o[a][r.name]=t}p.start(),(!n._stampVersionRequest||n._stampVersionRequest<Date.now()-19e3||!h(r))&&p.now()}}},chkVersion:d,now:function(){a&&clearTimeout(a),a=setTimeout(d,0)},stop:function(){s&&clearInterval(s),s=null},start:function(e){e&&(t=e),p.stop(),s=setInterval(d,t)}};e.gmx||(e.gmx={}),e.gmx.layersVersion=p,e.gmx.VectorLayer.include({updateVersion:function(t){if(t){var i=this._gmx;t.geometry&&(i.geometry=t.geometry),t.properties&&(e.extend(i.properties,t.properties),i.properties.GeoProcessing=t.properties.GeoProcessing,i.rawProperties=i.properties,this.fire("versionchange"),i.dataManager.updateVersion(i.rawProperties))}}})}(),e.gmx.RasterLayer=e.gmx.VectorLayer.extend({options:{isGeneralized:!1,zIndexOffset:0},initFromDescription:function(t){var i=t.properties,o=i.styles[0]||{MinZoom:i.MinZoom||0,MaxZoom:i.MaxZoom||21},r={type:"Vector",fromType:i.type,identityField:"ogc_fid",GeometryType:"POLYGON",IsRasterCatalog:!0,Copyright:i.Copyright||"",RCMinZoomForRasters:o.MinZoom,visible:i.visible,styles:[{DisableBalloonOnClick:!0,MinZoom:o.MinZoom,MaxZoom:o.MaxZoom,RenderStyle:{outline:{thickness:0},fill:{opacity:100}},HoverStyle:null}]},s=this._gmx,a=n.tileSizes[1];i.MaxZoom&&(s.maxNativeZoom=i.MaxZoom),t.geometry||(t.geometry={type:"POLYGON",coordinates:[[[-a,-a],[-a,a],[a,a],[a,-a],[-a,-a]]]}),e.gmx.VectorLayer.prototype.initFromDescription.call(this,{geometry:t.geometry,properties:r,rawProperties:t.properties}),s.rasterBGfunc=function(t,e,i){return"http://"+s.hostName+"/"+"TileSender.ashx?ModeKey=tile"+"&key="+encodeURIComponent(s.sessionKey)+"&LayerName="+s.layerID+"&z="+i+"&x="+t+"&y="+e};var l={load:function(e,i,o,r,s,l,h){var u=[[777,t.geometry]],c=n.geoItemBounds(t.geometry),d=c.bounds;if(d.max.x>a){var p=2*a,m=777,f=t.geometry.coordinates,g=c.boundsArr;u=[],"POLYGON"===t.geometry.type&&(f=[f],g=[g]);for(var _=0,v=f.length;v>_;_++){var y=f[_],x=g[_][0],L=y;if(u.push([m++,{type:"POLYGON",coordinates:L}]),x.max.x>a){L=[];for(var b=0,P=y.length;P>b;b++){for(var S=y[b],T=0,w=[],C=S.length;C>T;T++){var M=S[T];w.push([M[0]-p,M[1]])}L.push(w)}u.push([m++,{type:"POLYGON",coordinates:L}])}}}h(u,[d.min.x,d.min.y,d.max.x,d.max.y])}};return s.dataManager.addTile(new p(l,{x:-.5,y:-.5,z:0,v:0,s:-1,d:-1})),this},setZoomBounds:function(t,i){var n=this.getStyles().slice(0);n[0]=e.extend({},n[0]),n[0].MinZoom=t,n[0].MaxZoom=i,this.setStyles(n)}}),e.LabelsLayer=e.Class.extend({options:{pane:"overlayPane"},initialize:function(t,i){e.setOptions(this,i),this._observers={},this._styleManagers={},this._labels={};var o=this;this.bbox=n.bounds();var r=function(i,r){if(i.added||i.removed){for(var s=r.options,a=t._zoom>=s.minZoom&&t._zoom<=s.maxZoom?i.added:[],l="_"+r._leaflet_id,h=r._gmx,u={},c=0,d=a.length;d>c;c++){var p=a[c].item,m="POINT"===p.type||"MULTIPOINT"===p.type,f=p.parsedStyleKeys||p.currentStyle||{};if(h.styleHook){var g=h.styleHook(p,h.lastHover&&p.id===h.lastHover.id);if(!g)continue;f=e.extend({},f,g)}if(p.multiFilters)for(var _=0,v=p.multiFilters.length;v>_;_++){var y=p.multiFilters[_].parsedStyle;if("labelField"in y||"labelText"in y){f=y;break}}var x=h.styleManager.getObjStyle(p)||{},L=f.labelText||x.labelText,b=f.labelField||x.labelField,P=h.tileAttributeTypes[b],S=L||e.gmxUtil.attrToString(P,r.getPropItem(b,p.properties));if(S||0===S){var T=f.labelFontSize||x.labelFontSize||12,w="_"+p.id,C=!0,M=0,D=p.options,I={font:T+'px "Arial"',labelHaloColor:f.labelHaloColor||x.labelHaloColor||0,labelColor:f.labelColor||x.labelColor,labelAlign:f.labelAlign||x.labelAlign,labelAnchor:f.labelAnchor||x.labelAnchor,labelFontSize:T};if(D){if(!("center"in D)){var k=n.getItemCenter(p,h.dataManager.getItemMembers(p.id));if(!k)continue;D.center=k}if(D.label){M=D.label.width;var E=D.label.style;C=D.label.txt!==S||E.labelHaloColor!==I.labelHaloColor||E.labelColor!==I.labelColor||E.labelAlign!==I.labelAlign||E.labelAnchor!==I.labelAnchor||E.labelFontSize!==I.labelFontSize}}if(C){if(M=n.getLabelWidth(S,I),!M){delete u[w];continue}M+=4,p.options.labelStyle=null}D.label={isPoint:m,width:M,sx:x.sx||0,txt:S,style:I},u[w]=p}}o._labels[l]=u}},s=function(t){var e=t._gmx,i=["styleFilter","userFilter"],n={type:"resend",bbox:o.bbox,filters:i,callback:function(e){r(e,t),o.redraw()}};return e.beginDate&&e.endDate&&(n.dateInterval=[e.beginDate,e.endDate]),e.dataManager.addObserver(n,"_Labels")};this.add=function(t){var e=t._leaflet_id,i=t._gmx;!o._observers[e]&&i&&i.labelsLayer&&e&&i.styleManager.deferred.then(function(){var n=s(t);i.styleManager.isVisibleAtZoom(o._map._zoom)||n.deactivate(),o._observers[e]=n,o._styleManagers[e]=i.styleManager,o._labels["_"+e]={},o._updateBbox()})},this.remove=function(t){var e=t._leaflet_id;if(o._observers[e]){var i=t._gmx,n=i.dataManager;n.removeObserver(o._observers[e].id),delete o._observers[e],delete o._styleManagers[e],delete o._labels["_"+e],o.redraw()}},this._layeradd=function(t){o.add(t.layer)},this._layerremove=function(t){o.remove(t.layer)}},redraw:function(){return this._frame||this._map._animating||(this._frame=e.Util.requestAnimFrame(this._redraw,this)),this},_addToPane:function(){var t=this._map.getPanes()[this.options.pane];t&&t.insertBefore(this._canvas,t.firstChild)},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),t.on("moveend",this._reset,this),t.on({layeradd:this._layeradd,layerremove:this._layerremove}),t.options.zoomAnimation&&e.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),t.off("moveend",this._reset,this),t.off("layeradd",this._layeradd),t.off("layerremove",this._layerremove),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=e.DomUtil.create("canvas","leaflet-labels-layer leaflet-layer"),i=this._map.getSize();t.width=i.x,t.height=i.y,t.style.pointerEvents="none",this._canvas=t;var n=this._map.options.zoomAnimation&&e.Browser.any3d;e.DomUtil.addClass(t,"leaflet-zoom-"+(n?"animated":"hide"))},_updateBbox:function(){var t=this._map,i=t.getBounds(),o=i.getSouthWest(),r=i.getNorthEast(),s=e.Projection.Mercator.project(o),a=e.Projection.Mercator.project(r);this.mInPixel=n.getPixelScale(t.getZoom()),this._ctxShift=[s.x*this.mInPixel,a.y*this.mInPixel];for(var l in this._observers)this._observers[l].setBounds({min:{x:o.lng,y:o.lat},max:{x:r.lng,y:r.lat}})},_reset:function(){this._updateBbox();for(var t in this._observers){var e=this._observers[t];!e.isActive()&&this._styleManagers[t].isVisibleAtZoom(this._map.getZoom())&&e.activate(),e.fire("update")}},_redraw:function(){var t=[],i=this._map,o=i.getSize(),r=this._canvas,s=i.latLngToContainerPoint(i.getBounds().getNorthWest()),a=i.containerPointToLayerPoint(s);r.width=o.x,r.height=o.y,e.DomUtil.setPosition(r,a);var l,h,u,c=2*this.mInPixel*n.worldWidthMerc,d=c*Math.floor(i.getPixelBounds().min.x/c),p=r.getContext("2d");for(var m in this._labels){var f=this._labels[m];for(var g in f){u=f[g];var _=u.options,v=_.label,y=v.style,x=v.width,L=x/2,b=y.labelFontSize||12,P=b/2,S=_.center,T=[S[0]*this.mInPixel,S[1]*this.mInPixel],w=!1;if(v.isPoint){var C=y.labelAlign||"center",M=v.sx;"left"===C?T[0]+=L+M:"right"===C&&(T[0]-=x+M)}T[0]-=L+this._ctxShift[0],T[1]=P-T[1]+this._ctxShift[1],y.labelAnchor&&(T[0]+=y.labelAnchor[0],T[1]+=y.labelAnchor[1]);for(var D=T[0]+d;D<o.x;D+=c){var I=[Math.floor(D),Math.floor(T[1])],k=n.bounds([[I[0]-L,I[1]-P],[I[0]+L,I[1]+P]]);for(l=0,h=t.length;h>l;l++)if(k.intersects(t[l].bbox)){w=!0;break}w||(_.labelStyle||(_.labelStyle={font:b+'px "Arial"',fillStyle:n.dec2color(y.labelColor||0,1),shadowBlur:4},-1!==y.labelHaloColor&&(_.labelStyle.strokeStyle=_.labelStyle.shadowColor=n.dec2color(y.labelHaloColor,1))),t.push({arr:u.properties,bbox:k,txt:v.txt,style:_.labelStyle,coord:I}))}}}if(t.length){for(p.clearRect(0,0,r.width,r.height),l=0,h=t.length;h>l;l++)u=t[l],n.setLabel(p,u.txt,u.coord,u.style);r.parentNode||this._addToPane()}else r.parentNode&&r.parentNode.removeChild(r);this._frame=null},_animateZoom:function(t){var i=this._map.getZoomScale(t.zoom),n=this._map.getPixelBounds().min,o=this._map._getCenterOffset(t.center)._multiplyBy(-i).subtract(this._map._getMapPanePos());n.y<0&&(o.y+=n.multiplyBy(-i).y),this._canvas.style[e.DomUtil.TRANSFORM]=e.DomUtil.getTranslateString(o)+" scale("+i+")"}}),e.labelsLayer=function(t,i){return new e.LabelsLayer(t,i)},e.Map.addInitHook(function(){this._labelsLayer||(this._labelsLayer=new e.LabelsLayer(this),this._labelsLayer.addTo(this))}),function(){var t=function(t,e){for(var i in e)for(var n=e[i],o=0,r=n.length;r>o;o++)for(var s=n[o],a=s.geometry.type,l=s.boundsArr,h=0,u=l.length;u>h;h++){var c=l[h];"Polygon"===a&&(c=[c]);for(var d=0,p=c.length;p>d;d++)if(c[d].intersects(t))return!0}return!1},i=function(t,e){for(var i in e)for(var n=e[i],o=0,r=n.length;r>o;o++)for(var s=n[o],a=s.geometry.type,l=s.boundsArr,h=0,u=l.length;u>h;h++){var c=l[h];"Polygon"===a&&(c=[c]);for(var d=0,p=c.length;p>d;d++)if(t.intersects(c[d]))return!0}return!1},o=function(t,e){if(!e||0===Object.keys(e).length)return!0;for(var i in e)for(var o=e[i],r=0,s=o.length;s>r;r++)for(var a=o[r],l=a.geometry.type,h=a.boundsArr,u=0,c=h.length;c>u;u++){var d=h[u];"Polygon"===l&&(d=[d]);for(var p=0,m=d.length;m>p;p++)if(d[p].contains(t)){var f=a.geometry.coordinates,g=!1;"Polygon"===l&&(f=[f]);for(var _=0,v=f.length;v>_;_++)if(n.isPointInPolygonWithHoles(t,f[_])){g=!0;break}if(g)return!0}}return!1},r=function(t){var e=n.convertGeometry(t),i=n.geoItemBounds(e);return i.geometry=e,i},s=function(t){var e=document.createElement("canvas");e.width=e.height=256;var i=e.getContext("2d"),o=t.clipPolygons;t.ctx=i,i.fillStyle=i.createPattern(t.tile,"no-repeat");for(var r in o)for(var s=o[r],a=0,l=s.length;l>a;a++){var h=s[a].geometry,u=h.coordinates;"Polygon"===h.type&&(u=[u]);for(var c=0,d=u.length;d>c;c++){var p=u[c];i.beginPath();for(var m=0,f=p.length;f>m;m++){t.coords=p[m];var g=n.getRingPixels(t);t.coords=g.coords,n.polygonToCanvasFill(t)}i.closePath(),i.fill()}}i=t.tile.getContext("2d"),i.clearRect(0,0,256,256),i.drawImage(e,0,0)};e.gmx.VectorLayer.include({isPointInClipPolygons:function(t){return o(t,this._gmx._clipPolygons)},addClipPolygon:function(n){var a,l,h=[];if("coordinates"in n&&"type"in n)h.push(r(n));else if(n instanceof e.Polygon)h.push(r(n.toGeoJSON().geometry));else if(n instanceof e.GeoJSON){var u=n.getLayers();for(a=0,l=u.length;l>a;a++){var c=u[a];c instanceof e.Polygon&&c.feature?h.push(r(c.feature.geometry)):c instanceof e.MultiPolygon&&c.feature&&h.push(r(c.feature.geometry))}}if(h.length){var d=this._gmx,p=d.dataManager,m=this,f=e.stamp(n);this._gmx._clipPolygons||(this._gmx._clipPolygons={}),this._gmx._clipPolygons[f]=h,p.setTileFilteringHook(function(e){return t(e.bounds,m._gmx._clipPolygons)}),p.addFilter("clipFilter",function(t,e,n){return i(n,m._gmx._clipPolygons)}),p.addFilter("clipPointsFilter",function(t){if("POINT"===t.type){var e=t.properties,i=e[e.length-1];return o(i.coordinates,m._gmx._clipPolygons)}return!0}),1===Object.keys(this._gmx._clipPolygons).length&&d.renderHooks.unshift(function(t,e){t&&Object.keys(m._gmx._clipPolygons).length>0&&s({tile:t,tpx:e.tpx,tpy:e.tpy,gmx:{mInPixel:d.mInPixel},clipPolygons:m._gmx._clipPolygons})})}return this},removeClipPolygon:function(t){var i=e.stamp(t);return this._gmx._clipPolygons&&(delete this._gmx._clipPolygons[i],0===Object.keys(this._gmx._clipPolygons).length&&(this._gmx.dataManager.removeTileFilteringHook(),this._gmx.dataManager.removeFilter("clipFilter"))),this}})}(),e.gmx.gmxImageTransform=function(t,i){var o=i.gmx,r=i.gmxTilePoint,s=o.mInPixel,a=i.geoItem,l=a.properties,h=a.dataOption||{},u=l[l.length-1],c=u.coordinates[0],d=o.tileAttributeIndexes,p=l[d[o.quicklookPlatform]]||o.quicklookPlatform||"",m={};"MULTIPOLYGON"===u.type&&(c=c[0]),"LANDSAT8"===p?(m.x1=h.bounds.min.x,m.y1=h.bounds.max.y,m.x2=h.bounds.max.x,m.y2=h.bounds.max.y,m.x3=h.bounds.max.x,m.y3=h.bounds.min.y,m.x4=h.bounds.min.x,m.y4=h.bounds.min.y):m=n.getQuicklookPointsFromProperties(l,o);var f=s*m.x1,g=s*m.y1,_=s*m.x2,v=s*m.y2,y=s*m.x3,x=s*m.y3,L=s*m.x4,b=s*m.y4,P=n.bounds([[f,g],[_,v],[y,x],[L,b]]),S=Math.round(P.max.x-P.min.x),T=Math.round(P.max.y-P.min.y),w=P.min.x-256*r.x,C=256-P.max.y+256*r.y;f-=P.min.x,g=P.max.y-g,_-=P.min.x,v=P.max.y-v,y-=P.min.x,x=P.max.y-x,L-=P.min.x,b=P.max.y-b;var M=[[f,g],[_,v],[y,x],[L,b]];o.ProjectiveImage||(o.ProjectiveImage=(o.useWebGL?e.gmx.projectiveImageWebGL():null)||e.gmx.projectiveImage());var D=o.ProjectiveImage.getCanvas({imageObj:t,points:M,wView:S,hView:T,deltaX:w,deltaY:C});return D.canvas},function(){function t(t){return[t[4]*t[8]-t[5]*t[7],t[2]*t[7]-t[1]*t[8],t[1]*t[5]-t[2]*t[4],t[5]*t[6]-t[3]*t[8],t[0]*t[8]-t[2]*t[6],t[2]*t[3]-t[0]*t[5],t[3]*t[7]-t[4]*t[6],t[1]*t[6]-t[0]*t[7],t[0]*t[4]-t[1]*t[3]]}function i(t,e){for(var i=Array(9),n=0;3!==n;++n)for(var o=0;3!==o;++o){for(var r=0,s=0;3!==s;++s)r+=t[3*n+s]*e[3*s+o];i[3*n+o]=r}return i}function n(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]]}function o(e){var o=[e[0],e[2],e[4],e[1],e[3],e[5],1,1,1],r=n(t(o),[e[6],e[7],1]);return i(o,[r[0],0,0,0,r[1],0,0,0,r[2]])}var r=e.Class.extend({options:{antialias:!0,depth:!1,preserveDrawingBuffer:!0,shaderVS:"attribute vec2 aVertCoord;            uniform mat4 uTransformMatrix;            varying vec2 vTextureCoord;            void main(void) {                vTextureCoord = aVertCoord;                gl_Position = uTransformMatrix * vec4(aVertCoord, 0.0, 1.0);            }        ",shaderFS:"precision mediump float;            varying vec2 vTextureCoord;            uniform sampler2D uSampler;            void main(void) {                gl_FragColor = texture2D(uSampler, vTextureCoord);            }        "},setOptions:function(t){e.setOptions(this,t)},initialize:function(t){this.setOptions(t);var e=document.createElement("canvas"),i={antialias:this.options.antialias,depth:this.options.depth,preserveDrawingBuffer:this.options.preserveDrawingBuffer},n=e.getContext("webgl",i)||e.getContext("experimental-webgl",i);if(n){var o=this._setupGlContext(n);o&&(e.width=e.height=256,o.canvas=e,this.glResources=o,this.canvas=e,this.gl=n)}},_getShader:function(t,e,i){var n=i.createShader(t);return i.shaderSource(n,e),i.compileShader(n),i.getShaderParameter(n,i.COMPILE_STATUS)?n:(i.deleteShader(n),null)},_setupGlContext:function(t){var e=this._getShader(t.VERTEX_SHADER,this.options.shaderVS,t),i=this._getShader(t.FRAGMENT_SHADER,this.options.shaderFS,t);if(e&&i){var n=t.createProgram();if(t.attachShader(n,e),t.attachShader(n,i),t.linkProgram(n),t.getProgramParameter(n,t.LINK_STATUS)){t.useProgram(n),this.vertices=new Float32Array([0,0,1,0,0,1,1,1]);var o=t.createBuffer(),r=t.getAttribLocation(n,"aVertCoord");return t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),t.enableVertexAttribArray(r),t.vertexAttribPointer(r,2,t.FLOAT,!1,0,0),{transMatUniform:t.getUniformLocation(n,"uTransformMatrix"),samplerUniform:t.getUniformLocation(n,"uSampler"),screenTexture:t.createTexture()}}}return null},_bindTexture:function(t,e,i){t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)},getCanvas:function(t){var e=t.points,i=t.deltaX,n=t.deltaY,o=new Float32Array([(e[0][0]+i)/128-1,1-(e[0][1]+n)/128,(e[1][0]+i)/128-1,1-(e[1][1]+n)/128,(e[3][0]+i)/128-1,1-(e[3][1]+n)/128,(e[2][0]+i)/128-1,1-(e[2][1]+n)/128]),s=r.Utils.general2DProjection(this.vertices,o),a=this.gl,l=this.glResources;return this._bindTexture(a,t.imageObj,l.screenTexture),a.viewport(0,0,256,256),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT),a.uniformMatrix4fv(l.transMatUniform,!1,[s[0],s[3],0,s[6],s[1],s[4],0,s[7],0,0,1,0,s[2],s[5],0,1]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,l.screenTexture),a.uniform1i(l.samplerUniform,0),a.drawArrays(a.TRIANGLE_STRIP,0,4),this}});r.Utils={general2DProjection:function(e,n){var r=i(o(n),t(o(e)));if(r[8])for(var s=0;9!==s;++s)r[s]=r[s]/r[8];return r},getWebGlResources:function(t){var e=new r(t);return e.gl?e:null}},e.gmx.projectiveImageWebGL=function(t){var e=new r(t);return e.gl?e:null}}(),function(){var t=function(){var t=0,e=4,i=64,o=null,r=function(t,e){for(var i=[],n=0;e>n;++n){i[n]=[];for(var o=0;t>o;++o)i[n][o]=0}return i},s=function(t,e,i){this.w=t,this.h=e,this.values=i||r(e)},a=function(t){for(var e=[],i=0;i<t.length;++i)e[i]=[].concat(t[i]);return e};s.prototype={add:function(t){if(t.w!==this.w||t.h!==this.h)throw new Error("Matrix add size mismatch");for(var e=r(this.w,this.h),i=0;i<this.h;++i)for(var n=0;n<this.w;++n)e[i][n]=this.values[i][n]+t.values[i][n];return new s(this.w,this.h,e)},transformProjectiveVector:function(t){var e,i,n=[];for(i=0;i<this.h;++i)for(n[i]=0,e=0;e<this.w;++e)n[i]+=this.values[i][e]*t[e];var o=n[n.length-1];if(o){var r=1/n[n.length-1];for(i=0;i<this.h;++i)n[i]*=r}return n},multiply:function(t){var e,i,n;if(+t!==t){if(t.h!==this.w)throw new Error("Matrix mult size mismatch");for(e=r(this.w,this.h),n=0;n<this.h;++n)for(i=0;i<t.w;++i){for(var o=0,a=0;a<this.w;a++)o+=this.values[n][a]*t.values[a][i];e[n][i]=o}return new s(t.w,this.h,e)}for(e=r(this.w,this.h),n=0;n<this.h;++n)for(i=0;i<this.w;++i)e[n][i]=this.values[n][i]*t;return new s(this.w,this.h,e)},rowEchelon:function(){if(this.w<=this.h)throw new Error("Matrix rowEchelon size mismatch");for(var t=a(this.values),e=0;e<this.h;++e){for(var i=t[e][e];0===i;){for(var n=e+1;n<this.h;++n)if(0!==t[n][e]){var o=t[n];t[n]=t[e],t[e]=o;break}if(n===this.h)return new s(this.w,this.h,t);i=t[e][e]}for(var r=1/i,l=e;l<this.w;++l)t[e][l]*=r;for(var h=0;h<this.h;++h)if(h!==e){var u=t[h][e];for(t[h][e]=0,l=e+1;l<this.w;++l)t[h][l]-=u*t[e][l]}}return new s(this.w,this.h,t)},invert:function(){var t,e;if(this.w!==this.h)throw new Error("Matrix invert size mismatch");var i=r(2*this.w,this.h);for(e=0;e<this.h;++e)for(t=0;t<this.w;++t)i[e][t]=this.values[e][t],i[e][t+this.w]=t===e?1:0;i=new s(2*this.w,this.h,i),i=i.rowEchelon();var n=r(this.w,this.h);for(e=0;e<this.w;++e)for(t=0;t<this.w;++t)n[e][t]=i.values[e][t+this.w];return new s(this.w,this.h,n)}};var l=function(t){var e=new s(9,8,[[1,1,1,0,0,0,-t[2][0],-t[2][0],-t[2][0]],[0,1,1,0,0,0,0,-t[3][0],-t[3][0]],[1,0,1,0,0,0,-t[1][0],0,-t[1][0]],[0,0,1,0,0,0,0,0,-t[0][0]],[0,0,0,-1,-1,-1,t[2][1],t[2][1],t[2][1]],[0,0,0,0,-1,-1,0,t[3][1],t[3][1]],[0,0,0,-1,0,-1,t[1][1],0,t[1][1]],[0,0,0,0,0,-1,0,0,t[0][1]]]),i=e.rowEchelon().values,n=new s(3,3,[[-i[0][8],-i[1][8],-i[2][8]],[-i[3][8],-i[4][8],-i[5][8]],[-i[6][8],-i[7][8],1]]);return n},h=function(e,n,r,s,a,l,u,c,d,p){if(d){var m=[l[0]+u[0]-2*a[0],l[1]+u[1]-2*a[1]],f=[l[0]+u[0]-2*c[0],l[1]+u[1]-2*c[1]],g=[m[0]+f[0],m[1]+f[1]],_=Math.abs((g[0]*g[0]+g[1]*g[1])/(m[0]*f[0]+m[1]*f[1]));m=[l[0]-a[0]+c[0]-u[0],l[1]-a[1]+c[1]-u[1]],f=[u[0]-a[0]+c[0]-l[0],u[1]-a[1]+c[1]-l[1]];var v=Math.abs(m[0]*f[1]-m[1]*f[0]);if(0===e&&1===r||(.25+5*_)*v>i*i){var y=(e+r)/2,x=(n+s)/2,L=o.transformProjectiveVector([y,x,1]),b=o.transformProjectiveVector([y,n,1]),P=o.transformProjectiveVector([y,s,1]),S=o.transformProjectiveVector([e,x,1]),T=o.transformProjectiveVector([r,x,1]);return d--,h.call(this,e,n,y,x,a,b,S,L,d,p),h.call(this,y,n,r,x,b,l,L,T,d,p),h.call(this,e,x,y,s,S,L,u,P,d,p),h.call(this,y,x,r,s,L,T,P,c,d,p),void 0}}var w=p.ctx,C=[l[0]-a[0],l[1]-a[1]],M=[c[0]-l[0],c[1]-l[1]],D=[u[0]-c[0],u[1]-c[1]],I=[a[0]-u[0],a[1]-u[1]],k=Math.abs(C[0]*I[1]-C[1]*I[0]),E=Math.abs(M[0]*C[1]-M[1]*C[0]),O=Math.abs(D[0]*M[1]-D[1]*M[0]),A=Math.abs(I[0]*D[1]-I[1]*D[0]),N=Math.max(Math.max(k,E),Math.max(A,O)),B=0,U=0,z=0,R=0;N===k?(w.setTransform(C[0],C[1],-I[0],-I[1],a[0]+p.deltaX,a[1]+p.deltaY),1!==r&&(z=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(R=1.05/Math.sqrt(I[0]*I[0]+I[1]*I[1]))):N===E?(w.setTransform(C[0],C[1],M[0],M[1],l[0]+p.deltaX,l[1]+p.deltaY),1!==r&&(z=1.05/Math.sqrt(C[0]*C[0]+C[1]*C[1])),1!==s&&(R=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),B=-1):N===O?(w.setTransform(-D[0],-D[1],M[0],M[1],c[0]+p.deltaX,c[1]+p.deltaY),1!==r&&(z=1.05/Math.sqrt(D[0]*D[0]+D[1]*D[1])),1!==s&&(R=1.05/Math.sqrt(M[0]*M[0]+M[1]*M[1])),B=-1,U=-1):N===A&&(w.setTransform(-D[0],-D[1],-I[0],-I[1],u[0]+p.deltaX,u[1]+p.deltaY),1!==r&&(z=1.05/Math.sqrt(D[0]*D[0]+D[1]*D[1])),1!==s&&(R=1.05/Math.sqrt(I[0]*I[0]+I[1]*I[1])),U=-1);var F=r-e,G=s-n;z++,R++;var Z=p.imageObj.width,H=p.imageObj.height,j=Math.floor(e*Z),V=Math.floor(n*H),q=Math.floor(Math.min(z*F,1)*Z),W=Math.floor(Math.min(R*G,1)*H);t++,w.drawImage(p.imageObj,j,V,q,W,B,U,z,R)};this.getCanvas=function(r){t=0,o=l(r.points);var s=o.transformProjectiveVector([0,0,1]),a=o.transformProjectiveVector([1,0,1]),u=o.transformProjectiveVector([0,1,1]),c=o.transformProjectiveVector([1,1,1]),d=document.createElement("canvas");d.width=d.height=256,r.canvas=d,r.ctx=d.getContext("2d");var p=n.bounds([s,a,c,u]),m=Math.max(p.max.x-p.min.x,p.max.y-p.min.y);e="limit"in r?r.limit:200>m?1:4,i="patchSize"in r?r.patchSize:m/8;try{h(0,0,1,1,s,a,u,c,e,r)}catch(f){console.log("Error: ProjectiveImage event:",f),d=null}return{canvas:d,ptl:s,ptr:a,pbl:u,pbr:c,cnt:t}}};e.gmx.projectiveImage=function(){return new t}}(),e.RotatedMarker=e.Marker.extend({options:{angle:0},statics:{TRANSFORM_ORIGIN:e.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"])},_initIcon:function(){e.Marker.prototype._initIcon.call(this),this._icon.style[e.RotatedMarker.TRANSFORM_ORIGIN]=this._getTransformOrigin()},_getTransformOrigin:function(){var t=this.options.icon.options.iconAnchor;return t?t[0]+"px "+t[1]+"px":"50% 50%"},_setPos:function(t){if(e.Marker.prototype._setPos.call(this,t),e.DomUtil.TRANSFORM)this._icon.style[e.DomUtil.TRANSFORM]+=" rotate("+this.options.angle+"deg)";else if(e.Browser.ie){var i=this.options.angle*(Math.PI/180),n=Math.cos(i),o=Math.sin(i);this._icon.style.filter+=" progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11="+n+", M12="+-o+", M21="+o+", M22="+n+")"}},setAngle:function(t){this.options.angle=t}}),e.rotatedMarker=function(t,i){return new e.RotatedMarker(t,i)},e.gmx.ExternalLayer=e.Class.extend({createExternalLayer:function(){return null},isExternalVisible:function(){return!0},updateData:function(){},setDateInterval:function(){if(this._observer){var t=this.parentLayer._gmx;this._observer.setDateInterval(t.beginDate,t.endDate)}},options:{useDataManager:!0,observerOptions:{filters:["clipFilter","userFilter","clipPointsFilter"]}},initialize:function(t,i){e.setOptions(this,t),this.parentLayer=i,i.on("add",this._addEvent,this).on("dateIntervalChanged",this.setDateInterval,this),this.options.useDataManager&&this._addObserver(this.options.observerOptions),this.externalLayer=this.createExternalLayer(),i._map&&(this._addEvent({target:{_map:i._map}}),this._updateBbox())},_addObserver:function(t){this._items={},this._observer=this.parentLayer.addObserver(e.extend({bbox:n.bounds([[Number.MAX_VALUE,Number.MAX_VALUE]]),callback:e.bind(this.updateData,this)},t)).deactivate()},unbindLayer:function(){this.parentLayer.off("add",this._addEvent,this).off("dateIntervalChanged",this.setDateInterval,this),this._observer&&delete this.parentLayer.repaintObservers[this._observer.id];var t=this._map||this.parentLayer._map;this._onRemove(!t),this._removeMapHandlers()},_addMapHandlers:function(t){this._map=t,this._map.on({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this)},_removeMapHandlers:function(){this._map&&this._map.off({moveend:this._updateBbox,zoomend:this._chkZoom,layeradd:this._layeradd,layerremove:this._layerremove},this),this._map=null},_addEvent:function(t){this._addMapHandlers(t.target._map),this._updateBbox(),this._chkZoom()},_isParentLayer:function(t){var e=t.layer;return e._gmx&&e._gmx.layerID===this.parentLayer.options.layerID},_layeradd:function(t){this._isParentLayer(t)&&this._chkZoom()},_layerremove:function(t){this._isParentLayer(t)&&(this._onRemove(!0),this._removeMapHandlers())},_onRemove:function(t){this._observer&&this._observer.deactivate();var e=this._map;e&&(e.hasLayer(this.externalLayer)&&(this._chkZoom(),e.removeLayer(this.externalLayer)),t||this.parentLayer.onAdd(e))},_chkZoom:function(){if(this._map){var t=this.parentLayer,e=this._observer,i=this._map,n=i.hasLayer(this.externalLayer);t.setCurrentZoom(i),this.isExternalVisible(i.getZoom())?t._map&&(t.onRemove(i),n||i.addLayer(this.externalLayer),this.setDateInterval(),e&&t.getIcons(function(){e.activate()}.bind(this)),t.disablePopup()):(e&&e.deactivate(),t._map||(n&&i.removeLayer(this.externalLayer),t.onAdd(i)),t.enablePopup())}},_updateBbox:function(){if(this._map&&this._observer){var t=this._map.getBounds(),i=t.getNorthWest(),n=t.getSouthEast(),o=e.gmxUtil.bounds([[i.lng,i.lat],[n.lng,n.lat]]);this._observer.setBounds(o)}}}),function(){var t=e.gmx.ExternalLayer.extend({options:{minZoom:1,maxZoom:6,useDataManager:!1,format:"png",transparent:!0},createExternalLayer:function(){var t=this.parentLayer.options,i={map:t.mapID,layers:t.layerID,format:this.options.format,transparent:this.options.transparent},n=this.parentLayer.getGmxProperties();return n&&n.Temporal&&this._extendOptionsByDateInterval(i),this.options.apikey&&(i.apikey=this.options.apikey),e.tileLayer.wms("http://"+t.hostName+"/TileService.ashx",i)},_extendOptionsByDateInterval:function(t){var i=this.parentLayer.getDateInterval(),n=i.beginDate,o=i.endDate;e.extend(t,{StartDate:n&&n.toLocaleDateString(),EndDate:o&&o.toLocaleDateString()})},setDateInterval:function(){this._extendOptionsByDateInterval(this.externalLayer.wmsParams),this.externalLayer.redraw()},isExternalVisible:function(t){return!(t<this.options.minZoom||t>this.options.maxZoom)}});e.gmx.VectorLayer.include({bindWMS:function(e){return this._layerWMS&&this._layerWMS.unbindLayer(),this._layerWMS=new t(e,this),this.isExternalVisible=this._layerWMS.isExternalVisible,this},unbindWMS:function(){return this._layerWMS&&(this._layerWMS.unbindLayer(),this._layerWMS=null,this.isExternalVisible=null,this.enablePopup()),this}})}(),function(){var t=e.gmx.ExternalLayer.extend({options:{minHeatMapZoom:1,maxHeatMapZoom:6,intensityField:"",intensityScale:1,observerOptions:{type:"resend"}},createExternalLayer:function(){return e.heatLayer([],e.extend({},this.options))},isExternalVisible:function(t){return!(t<this.options.minHeatMapZoom||t>this.options.maxHeatMapZoom)},updateData:function(t){if(t.added){var i=[],n=this.parentLayer.getTileAttributeIndexes(),o=null,r=this.options.intensityField||"",s=this.options.intensityScale||1;r&&r in n&&(o=n[r]);for(var a=0,l=t.added.length;l>a;a++){var h=t.added[a].properties,u=null!==o?h[o]:1,c=h[h.length-1],d=c.coordinates,p=e.Projection.Mercator.unproject({x:d[0],y:d[1]});i.push([p.lat,p.lng,"function"==typeof s?s(u):s*u])}this.externalLayer.setLatLngs(i)}}});e.gmx.VectorLayer.include({bindHeatMap:function(i){return e.heatLayer&&(this._heatmap&&this._heatmap.unbindLayer(),this._heatmap=new t(i,this)),this},unbindHeatMap:function(){return e.heatLayer&&this._heatmap&&(this._heatmap.unbindLayer(),this._heatmap=null,this.enablePopup()),this}})}(),function(){var t={radiusFunc:function(t){var e=Math.floor(t/15);return e>40?e=40:20>e&&(e=20),e},text:{stroke:"black","stroke-width":1,"text-anchor":"middle",fill:"white"}},i=e.gmx.ExternalLayer.extend({options:{observerOptions:{filters:["clipFilter","styleFilter","userFilter","clipPointsFilter"]},spiderfyOnMaxZoom:!0,minZoom:1,maxZoom:6},createExternalLayer:function(){var i=e.extend({showCoverageOnHover:!1,disableClusteringAtZoom:1+Number(this.options.maxZoom)},this.options);if("clusterIconOptions"in this.options){var n=this.options.clusterIconOptions;if("radialGradient"in n){var o=n.radialGradient,r=n.text||t.text;i.iconCreateFunction=function(i){var n=i.getChildCount();return r.count=n,e.gmxUtil.getSVGIcon({type:"circle",iconSize:2*(o.radiusFunc||t.radiusFunc)(n),text:r,fillRadialGradient:o})}}}this.options.clusterclick&&(i.clusterclick=this.options.clusterclick,i.clusterclick===!0&&(i.zoomToBoundsOnClick=!1)),this._popup=new e.Popup({maxWidth:1e4,className:"gmxPopup"});var s=new e.MarkerClusterGroup(i),a=null;return s.on("click",function(t){var i=t.layer.options.properties,n=this.parentLayer.getItemProperties(i),o=[i[i.length-1]],r=i[0];!a||a.getAllChildMarkers().indexOf(t.layer)+1?this._openPopup(i,t.latlng):(a.unspiderfy(),s.once("unspiderfied",function(){this._openPopup(i,t.latlng)},this)),this.parentLayer.fire("click",e.extend(t,{eventFrom:"markerClusters",originalEventType:"click",gmx:{id:r,layer:this.parentLayer,properties:n,target:{id:r,properties:i,geometry:o}}}))},this).on("animationend",function(){this._popup&&this._popup._map&&this._popup._map.removeLayer(this._popup)},this).on("clusterclick",function(t){this.parentLayer.fire("clusterclick",e.extend(t,{eventFrom:"markerClusters",originalEventType:"clusterclick"}))},this).on("spiderfied",function(t){a=t.cluster},this).on("unspiderfied",function(){a=null},this),i.clusterclick&&s.on("clusterclick",i.clusterclick instanceof Function?i.clusterclick:function(t){t.layer.spiderfy()}),s},isExternalVisible:function(t){return!(t<this.options.minZoom||t>this.options.maxZoom)},updateData:function(t){var i,n,o,r,s,a=[];if(t.removed){for(i=0,n=t.removed.length;n>i;i++)o=t.removed[i],r=o.id,s=this._items[r],s&&a.push(s),delete this._items[r];this.externalLayer.removeLayers(a),a=[]}if(t.added){for(i=0,n=t.added.length;n>i;i++){o=t.added[i],r=o.id,s=this._items[r];var l=o.properties;if(s&&l.processing&&(this.externalLayer.removeLayer(s),s=null),!s){o.item.parsedStyleKeys||(o.item.parsedStyleKeys=this.parentLayer.getItemStyle(r));var h=l[l.length-1],u=o.item.parsedStyleKeys,c=h.coordinates,d=e.Projection.Mercator.unproject({x:c[0],y:c[1]}),p={properties:o.properties,mPoint:c};if(this.options.notClusteredIcon){var m=this.options.notClusteredIcon;p.icon=m instanceof e.Icon?m:e.icon(m)}else if(u)if(u.iconUrl){var f=u.iconAnchor;if(!f){var g=this.parentLayer.getItemStyle(r);f=g.image?[g.sx/2,g.sy/2]:[8,10]}p.icon=e.icon({iconAnchor:f,iconUrl:u.iconUrl})}else p.icon=e.gmxUtil.getSVGIcon(u);s=u.rotate?e.rotatedMarker(d,e.extend(p,{angle:u.rotate})):e.marker(d,e.extend(p,{angle:u.rotate})),this._items[r]=s}a.push(s)}this.externalLayer.addLayers(a)}},_openPopup:function(t,i){var n=this.parentLayer._gmx,o=t[0],r=n.styleManager.getItemBalloon(o),s=this.parentLayer.getItemProperties(t),a=[t[t.length-1]];if(r&&!r.DisableBalloonOnClick){var l=this.parentLayer.getItemStyle(o);
if(l&&l.iconAnchor){var h=e.Popup.prototype.options.offset;this._popup.options.offset=[-h[0]-l.iconAnchor[0]+l.sx/2,h[1]-l.iconAnchor[1]+l.sy/2]}this._popup.setLatLng(i).setContent(e.gmxUtil.parseBalloonTemplate(r.templateBalloon,{properties:s,tileAttributeTypes:n.tileAttributeTypes,unitOptions:this._map.options||{},geometries:a})).openOn(this._map)}}});e.gmx.VectorLayer.include({bindClusters:function(t){return e.MarkerClusterGroup&&(this._clusters&&this._clusters.unbindLayer(),this._clusters=new i(t,this)),this},unbindClusters:function(){return e.MarkerClusterGroup&&this._clusters&&(this._clusters.unbindLayer(),this._clusters=null,this.enablePopup()),this}})}(),e.gmx=e.gmx||{};var v="maps.kosmosnimki.ru",y=2e6;e.gmx._layerClasses={Raster:e.gmx.RasterLayer,Vector:e.gmx.VectorLayer,VectorView:e.gmx.DummyLayer},e.gmx._loadingLayerClasses={},e.gmx.addLayerClass=function(t,i){e.gmx._layerClasses[t]=i},e.gmx._layerClassLoaders=[],e.gmx.addLayerClassLoader=function(t){e.gmx._layerClassLoaders.push(t),e.gmx._loadingLayerClasses={}},e.gmx._loadLayerClass=function(t){if(!e.gmx._loadingLayerClasses[t]){var i=new e.gmx.Deferred;i.resolve(),e.gmx._layerClassLoaders.forEach(function(n){i=i.then(function(i){return i?(e.gmx._layerClasses[t]=i,i):n(t)},function(){})}),i=i.then(function(i){return i?(e.gmx._layerClasses[t]=i,i):void 0},function(){}),e.gmx._loadingLayerClasses[t]=i}return e.gmx._loadingLayerClasses[t]},e.gmx.loadLayer=function(t,i,o){var r=new e.gmx.Deferred,s={mapID:t,layerID:i};o=o||{};for(var a in o)s[a]=o[a];var l=n.normalizeHostname(o.hostName||v);return s.hostName=l,h.getMap(l,o.apiKey,t,o.skipTiles).then(function(){var n=h.findLayerInfo(l,t,i);if(!n)return r.reject("There is no layer "+i+" in map "+t),void 0;n.properties.hostName=l;var o=n.properties.ContentID||n.properties.type,a=function(){var t=e.gmx.createLayer(n,s);t?r.resolve(t):r.reject("Unknown type of layer "+i)};o in e.gmx._layerClasses?a():e.gmx._loadLayerClass(o).then(a)},function(e){r.reject("Can't load layer "+i+" from map "+t+": "+e.error)}),r},e.gmx.loadLayers=function(t,i){var n=t.map(function(t){var n=e.extend({},i,t.options);return e.gmx.loadLayer(t.mapID,t.layerID,n)});return e.gmx.Deferred.all.apply(null,n)},e.gmx.loadMap=function(t,i){i=e.extend({},i),i.hostName=n.normalizeHostname(i.hostName||v);var o=new e.gmx.Deferred;return h.getMap(i.hostName,i.apiKey,t,i.skipTiles,i.isGeneralized).then(function(t){var e=new u(t,i);e.layersCreated.then(function(){if(i.leafletMap||i.setZIndex)for(var n,r,s=0,a=e.layers.length-1;a>=0;a--)n=e.layers[a],r=n.getGmxProperties(),"VectorOnTop"===t.properties.LayerOrder&&n.setZIndexOffset&&"Raster"!==r.type&&n.setZIndexOffset(y),i.setZIndex&&n.setZIndex&&n.setZIndex(++s),i.leafletMap&&r.visible&&n.addTo(i.leafletMap);o.resolve(e)})},function(e){var n=e&&e.ErrorInfo&&e.ErrorInfo.ErrorMessage||"Server error";o.reject("Can't load map "+t+" from "+i.hostName+": "+n)}),o},e.gmx.DummyLayer=function(t){this.onAdd=this.onRemove=function(){},this.getGmxProperties=function(){return t}},e.gmx.createLayer=function(t,i){t||(t={}),t.properties||(t.properties={type:"Vector"});var n,o=t.properties.ContentID||t.properties.type||"Vector";if(o in e.gmx._layerClasses)try{n=new e.gmx._layerClasses[o](i),n=n.initFromDescription(t)}catch(r){n=new e.gmx.DummyLayer(t.properties)}else n=new e.gmx.DummyLayer(t.properties);return n}}(),L.Map.addInitHook(function(){var t=this._controlCorners,e=this._controlContainer,i="leaflet-top leaflet-bottom",n="leaflet-left leaflet-right",o={bottom:"leaflet-bottom "+n,gmxbottomleft:"leaflet-bottom leaflet-left",gmxbottomcenter:"leaflet-bottom "+n,gmxbottomright:"leaflet-bottom leaflet-right",center:i+" "+n,right:"leaflet-right "+i,left:"leaflet-left "+i,top:"leaflet-top "+n};for(var r in o)t[r]||(t[r]=L.DomUtil.create("div",o[r],e))}),L.Map.addInitHook(function(){var t=this,e=null,i="leaflet-control-gmx-hidden",n=["img/svg-symbols.svg"],o=["gmxLoaderStatus","gmxHide","gmxZoom","gmxDrawing","gmxBottom","gmxLocation","gmxCopyright","gmxCenter","gmxLogo"];this.gmxControlsManager={_controls:{},_svgLoaded:{},add:function(t){var n=t.options,o=n.id;return this._controls[o]=t,t instanceof L.Control.GmxHide&&(e=t),!e||e.options.isActive||n.notHide||t._parent||!t._container||L.DomUtil.addClass(t._container,i),this},remove:function(t){return delete this._controls[t.options.id],this},get:function(t){return this._controls[t]},getAll:function(){return this._controls},init:function(e){return e=e||{},t.options.svgSprite!==!1&&this.setSvgSprites(t.options.svgSprite),t.zoomControl&&!e.zoomControl&&t.removeControl(t.zoomControl),t.attributionControl&&!e.attributionControl&&t.removeControl(t.attributionControl),o.forEach(function(i){i in e&&null===e[i]||t.addControl(L.control[i](e[i]))}),this},setSvgSprites:function(e){e=e&&e!==!0?L.Util.isArray(e)?e:[e]:n;var i=this;return e.forEach(function(t){if(!i._svgLoaded[t]){var e=new XMLHttpRequest;e.open("GET",t,!0),e.send(),i._svgLoaded[t]=!0,e.onload=function(){var t=document.createElement("div");t.style.display="none",t.innerHTML=e.responseText,document.body.insertBefore(t,document.body.childNodes[0])}}}),t.options.svgSprite=e,this}},this.gmxControlIconManager=this.gmxControlsManager}),L.Control.GmxIcon=L.Control.extend({includes:L.Mixin.Events,options:{position:"topleft",id:"defaultIcon",isActive:!1},setActive:function(t,e){var i=this.options,n=i.togglable||i.toggle;if(n){var o=i.isActive,r=this._prefix,s=r+"-"+i.id,a=this._container;i.isActive=t,this._img&&(t&&i.activeImageUrl?this._img.src=i.activeImageUrl:!t&&i.regularImageUrl&&(this._img.src=i.regularImageUrl)),t?(L.DomUtil.addClass(a,r+"-active"),L.DomUtil.addClass(a,s+"-active"),a.children.length&&L.DomUtil.addClass(a,r+"-externalImage-active"),i.styleActive&&this.setStyle(i.styleActive)):(L.DomUtil.removeClass(a,r+"-active"),L.DomUtil.removeClass(a,s+"-active"),a.children.length&&L.DomUtil.removeClass(a,r+"-externalImage-active"),i.style&&this.setStyle(i.style)),e||o===t||this.fire("statechange")}},onAdd:function(t){var e=null,i=null,n=this.options,o=n.svgSprite||t.options.svgSprite,r="leaflet-gmx-icon"+(!o||n.regularImageUrl||n.text?"":"Svg"),s=r+"-"+n.id;this._prefix=r;var a=L.DomUtil.create("div",r+" "+s);if(a._id=n.id,this._container=a,n.title&&(a.title=n.title),this.setStyle=function(t){for(var e in t)a.style[e]=t[e]},n.className&&L.DomUtil.addClass(a,n.className),n.regularImageUrl)e=L.DomUtil.create("img","",a),e.src=n.regularImageUrl,this._img=e,L.DomUtil.addClass(a,r+"-img"),L.DomUtil.addClass(a,r+"-externalImage");else if(n.text)L.DomUtil.addClass(a,r+"-text"),i=L.DomUtil.create("span","",a),i.innerHTML=n.text;else if(o){L.DomUtil.addClass(a,"svgIcon");var l="#"+n.id.toLowerCase();a.innerHTML='<svg role="img" class="svgIcon">              <use xlink:href="'+l+'"></use>            </svg>'}else L.DomUtil.addClass(a,r+"-img "+r+"-sprite");n.style&&this.setStyle(n.style),this._iconClick=function(){a.parentNode&&(this.setActive(!this.options.isActive),this.fire("click"),this.options.stateChange&&this.options.stateChange(this))};var h=L.DomEvent.stopPropagation;return L.DomEvent.on(a,"mousemove",h).on(a,"touchstart",h).on(a,"mousedown",h).on(a,"dblclick",h).on(a,"click",h).on(a,"click",this._iconClick,this),n.onAdd&&n.onAdd(this),this.fire("controladd"),t.fire("controladd",this),n.notHide&&(a._notHide=!0),t.gmxControlsManager&&t.gmxControlsManager.add(this),a},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),this.fire("controlremove"),t.fire("controlremove",this);var e=this._container,i=L.DomEvent.stopPropagation;L.DomEvent.off(e,"mousemove",i).off(e,"touchstart",i).off(e,"mousedown",i).off(e,"dblclick",i).off(e,"click",i).off(e,"click",this._iconClick,this)},addTo:function(t){return L.Control.prototype.addTo.call(this,t),this.options.addBefore&&this.addBefore(this.options.addBefore),this},addBefore:function(t){var e=this._parent&&this._parent._container;if(e||(e=this._map&&this._map._controlCorners[this.getPosition()]),e)for(var i=0,n=e.childNodes.length;n>i;i++){var o=e.childNodes[i];if(t===o._id){e.insertBefore(this._container,o);break}}else this.options.addBefore=t;return this}}),L.Control.gmxIcon=L.Control.GmxIcon,L.control.gmxIcon=function(t){return new L.Control.GmxIcon(t)},function(){function t(t){return RegExp("msie"+(isNaN(t)?"":"\\s"+t),"i").test(navigator.userAgent)}var e=32;L.Control.GmxIconGroup=L.Control.GmxIcon.extend({includes:L.Mixin.Events,options:{position:"topleft",id:"defaultIconGroup",isVertical:!0,isCollapsible:!0,isSortable:!1,singleSelection:!1},addIcon:function(t){return this.items.push(t),t._parent=this,this._map&&(this._container.appendChild(t.onAdd(this._map)),t.options.addBefore&&t.addBefore(t.options.addBefore)),t.on("click",function(){this.setActiveIcon(t)},this),this.options.isCollapsible&&!t.options.skipCollapse&&t.on("click",this._minimize,this),this},removeIcon:function(t){for(var e=0,i=this.items.length;i>e;e++)if(t===this.items[e]){var n=t._container;n.parentNode&&n.parentNode.removeChild(n),this.items.splice(e,1);break}return this},getIconById:function(t){for(var e=0,i=this.items.length;i>e;e++){var n=this.items[e];if(n.options.id===t)return n}return null},setActiveIcon:function(t,e){this.activeIcon="";var i=this.items.length;if(i){if(this.options.singleSelection)for(var n=0;i>n;n++){var o=this.items[n],r=t===o&&(e||o.options.isActive);o.setActive(r),r&&(this.activeIcon=o.options.id)}var s=this._container;if(this.options.isSortable&&t&&s.firstChild&&(s.insertBefore(t._container,s.firstChild),t.options.text&&this._chkTriangleStyle(t._container)),this.triangle){var a=this.options.isSortable?t:this.items[0];a&&a.options.isActive?L.DomUtil.addClass(this.triangle,"triangle-active"):L.DomUtil.removeClass(this.triangle,"triangle-active")}this.fire("activechange",this)}return this},_chkTriangleStyle:function(t){for(var e=this._container,i=0,n=this.items.length;n>i;i++){var o=this.items[i];if(o._container===t){o.options.text&&(this.triangle.style.right=e.clientWidth-t.clientWidth-5+"px",this.triangle.style.left="inherit");break}}},_minimize:function(){var t=this._container.style;t.height=e+"px","auto"!==this.options.width&&(t.width=e+4+"px"),t.overflow="hidden",this.bg&&(this.bg.height=e+2),L.DomUtil.removeClass(this._container,"leaflet-gmx-icon-group-maximum"),this.fire("collapse",this)},_maximize:function(){var t=this._container.style,i=this.options,n=1===this.items.length?e:(e+4)*this.items.length;i.isVertical?(this.bg&&(this.bg.height=n),t.height=n+"px","auto"!==i.width&&(t.width=e+4+"px")):(t.height=e+"px",t.width=n+"px"),t.overflow="unset",L.DomUtil.addClass(this._container,"leaflet-gmx-icon-group-maximum"),this.fire("expand",this)},onAdd:function(i){var n=this.options,o=n.svgSprite||i.options.svgSprite,r="leaflet-gmx-icon-group",s=r+"-"+n.id+(o?" "+r+"Svg":"")+" "+r+(n.isVertical?"-vertical":"-horizontal"),a=L.DomUtil.create("div",r+" "+s);if(n.isVertical){if(t(10)||t(9)){var l=L.DomUtil.create("span","icons-vertical",a),h=L.DomUtil.create("img","",l);h.width=h.height=e,h.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABBJREFUeNpi+P//PwNAgAEACPwC/tuiTRYAAAAASUVORK5CYII=",this.bg=h,setTimeout(function(){h.width=a.clientWidth},0)}n.isCollapsible&&(o?(this.triangle=L.DomUtil.create("div","triangleSvg",a),this.triangle.innerHTML='<svg role="img" class="svgIcon">						<use xlink:href="#arrow-down"></use>						</svg>'):(this.triangle=L.DomUtil.create("div","triangle leaflet-gmx-icon-sprite",a),this.triangle.width=this.triangle.height=e))}if(this._map=i,this._container=a,a._id=n.id,n.isCollapsible&&(L.DomEvent.on(a,"mousemove",L.DomEvent.stopPropagation).on(a,"mouseout",function(t){for(var e=t.toElement;e;){if(e===a)return;e=e.parentNode}this._minimize()},this).on(a,"mouseover",function(t){for(var e=t.fromElement;e;){if(e===a)return;e=e.parentNode}this._maximize()},this),this._minimize()),this.items=[],n.items.map(this.addIcon,this),n.onAdd&&n.onAdd(this),this.fire("controladd"),i.fire("controladd",this),n.isVertical&&(a.style.marginLeft=0),n.notHide&&(a._notHide=!0),i.gmxControlsManager&&i.gmxControlsManager.add(this),this.items.length){var u=this.items[0],c=this;u.options.text&&setTimeout(function(){c._chkTriangleStyle(u._container)},0)}return a},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),this.fire("controlremove"),t.fire("controlremove",this)}}),L.Control.gmxIconGroup=L.Control.GmxIconGroup,L.control.gmxIconGroup=function(t){return new L.Control.GmxIconGroup(t)}}(),function(){var t=["Point","Polygon","Polyline","Rectangle"];L.Control.GmxDrawing=L.Control.GmxIconGroup.extend({options:{position:"topleft",singleSelection:!0,isSortable:!0,id:"drawing",items:null},onAdd:function(e){var i=this;this.setActive=function(t){e.gmxDrawing&&(e.gmxDrawing.bringToFront(),e.gmxDrawing.create(t,i.options.drawOptions))},this.on("activechange",function(e){for(var n=e.activeIcon,o=0,r=t.length;r>o;o++)if(n===t[o])return;i.setActive()}),e.gmxDrawing&&e.gmxDrawing.on("drawstop",function(t){var e=t.object._obj.options||{};e.ctrlKey||e.shiftKey?i.setActive(t.object.options.type):i.setActiveIcon()},this);var n=function(t){return L.control.gmxIcon({id:t,title:i._locale&&"getText"in i._locale?i._locale.getText(t):t,togglable:!0}).on("statechange",function(t){var e=t.target.options,n=e.id;n===i.activeIcon?i.setActive():e.isActive&&i.setActive(n)})},o=this.options.items||t;return this.options.items=[],o.forEach(function(t){i.options.items.push(t instanceof L.Control.GmxIcon?t:n(t))}),L.Control.GmxIconGroup.prototype.onAdd.call(this,e)}}),L.Control.gmxDrawing=L.Control.GmxDrawing,L.control.gmxDrawing=function(t){return new L.Control.GmxDrawing(t)},L.Control.GmxDrawing.locale={},L.Control.GmxDrawing.addInitHook(function(){this._locale=L.Control.GmxDrawing.locale,L.extend(this._locale,L.gmxLocaleMixin)})}(),L.extend(L.Control.GmxDrawing.locale,{rus:{Point:"",Polygon:"",Polyline:"",Rectangle:""}}),L.extend(L.Control.GmxDrawing.locale,{eng:{Point:"Point",Polygon:"Polygon",Polyline:"Polyline",Rectangle:"Rectangle"}}),L.Control.GmxCenter=L.Control.extend({options:{position:"center",id:"center",notHide:!0,color:"#216b9c"},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this)},onAdd:function(t){var e="leaflet-gmx-center",i=L.DomUtil.create("div",e),n=L.DomUtil.create("div",e),o=L.Path.prototype._createElement("svg"),r=document.createElementNS(L.Path.SVG_NS,"g"),s=document.createElementNS(L.Path.SVG_NS,"path");return this._container=i,i._id=this.options.id,this.options.notHide&&(i._notHide=!0),s.setAttribute("stroke-width",1),s.setAttribute("stroke-opacity",1),s.setAttribute("d","M6 0L6 12M0 6L12 6"),this._path=s,r.appendChild(s),o.appendChild(r),o.setAttribute("width",12),o.setAttribute("height",12),n.appendChild(o),i.appendChild(n),this.setColor(this.options.color),t.fire("controladd",this),t.gmxControlsManager&&t.gmxControlsManager.add(this),i},setColor:function(t){return this.options.color=t,this._map&&this._path.setAttribute("stroke",t),this}}),L.Control.gmxCenter=L.Control.GmxCenter,L.control.gmxCenter=function(t){return new L.Control.GmxCenter(t)},L.Control.GmxHide=L.Control.GmxIcon.extend({options:{id:"hide",isActive:!0,togglable:!0,notHide:!0,position:"topleft"},setActive:function(t,e){if(this._map){for(var i=this._map._controlContainer,n="leaflet-control-gmx-hidden",o=t?L.DomUtil.removeClass:L.DomUtil.addClass,r=0,s=i.children.length;s>r;r++)for(var a=0,l=i.children[r].children,h=l.length;h>a;a++){var u=l[a];(!u._notHide||e)&&o(u,n)}this.options.isActive=!this.options.isActive;var c=this._container.getElementsByTagName("use");if(c&&c.length){var d=(c[0].getAttribute("xlink:href")||"").replace(/-off$/,"");this.options.isActive||(d+="-off"),c[0].setAttribute("href",d)}this.fire("statechange")}},onAdd:function(t){var e=L.Control.GmxIcon.prototype.onAdd.call(this,t),i="Hide/Show";return L.gmxLocale&&(i=L.gmxLocale.addText({eng:{hide:i},rus:{hide:"/"}}).getText("hide")),e._id=this.options.id,e.title=i,e._notHide=this.options.notHide,e}}),L.Control.gmxHide=L.Control.GmxHide,L.control.gmxHide=function(t){return new L.Control.GmxHide(t)},L.Control.GmxLayers=L.Control.Layers.extend({options:{collapsed:!1,autoZIndex:!1,id:"layers"},initialize:function(t,e){L.setOptions(this,e),this._layers={},this._lastZIndex=0,this._handlingClick=!1,this._blm=t,L.extend(this,{_onBaseLayerActiveIDs:function(t){var e,i;for(e in this._layers)this._layers[e].overlay||delete this._layers[e];for(e=0,i=t.activeIDs.length;i>e;e++)this._addBaseLayer(this._blm.get(t.activeIDs[e]),!0);return this._update(),!0},_onBaseLayerChange:function(t){t.baseLayer&&this.setActiveBaseLayer(t.baseLayer.id)},_onBaseLayerOptionsChange:function(t){this._addBaseLayer(t.baseLayer)}})},addBaseLayer:function(){return console.log("Warning: Use `gmxBaseLayersManager.add` instead `addBaseLayer`!"),this},_addBaseLayer:function(t,e){return t&&(this._addLayer(t,t.options[L.gmxLocale.getLanguage()]||t.id),e||this._update()),this},_addItemObject:function(t){var e=this._addItem(t);t.layer&&t.layer._gmx&&t.layer._gmx.layerID&&(e.className="_"+t.layer._gmx.layerID)},_update:function(){if(this._container){this._baseLayersList.innerHTML="",this._overlaysList.innerHTML="";var t,e,i,n=!1,o=!1,r=this._blm.getActiveIDs(),s={};for(t in this._layers)i=this._layers[t],i.overlay?(this._addItemObject(i),o=!0):(s[i.layer.id]=i,n=!0);for(t=0,e=r.length;e>t;t++)s[r[t]]&&this._addItemObject(s[r[t]]);this.options.hideBaseLayers&&(n=!1,this._baseLayersList.style.display="none"),this._separator.style.display=o&&n?"":"none",this._container.style.display=o||n?"":"none"}},onAdd:function(t){var e=L.Control.Layers.prototype.onAdd.call(this,t);this._container=e,e.id=this.options.id,"activeBaseLayerInput"in this||(this.activeBaseLayerInput=this.getActiveBaseLayer(!0)),L.DomEvent.on(e,"mousemove",L.DomEvent.stopPropagation),t.gmxLayersControl=this,t.fire("controladd",this),this._blm.on("baselayeroptionschange baselayeradd",this._onBaseLayerOptionsChange,this).on("baselayeractiveids",this._onBaseLayerActiveIDs,this).on("baselayerchange",this._onBaseLayerChange,this);var i=this;this._blm.getActiveIDs().map(function(t){i._addBaseLayer(i._blm.get(t))});var n=this._blm.getCurrentID();return n&&this.setActiveBaseLayer(n),t.gmxControlsManager&&t.gmxControlsManager.add(this),e},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),L.Control.Layers.prototype.onRemove.call(this,t),this._blm.off("baselayeroptionschange baselayeradd",this._onBaseLayerOptionsChange,this).off("baselayeractiveids",this._onBaseLayerActiveIDs,this).off("baselayerchange",this._onBaseLayerChange,this),t.fire("controlremove",this)},unSetActiveBaseLayer:function(t){this._toogleActiveBaseLayer(t,!1)},setActiveBaseLayer:function(t){this._toogleActiveBaseLayer(t,!0)},_toogleActiveBaseLayer:function(t,e){for(var i=null,n=this._form.getElementsByTagName("input"),o=null,r=this._getLayerByName(t),s=r&&r.layer._leaflet_id,a=r&&r.overlay,l=0,h=n.length;h>l;l++){var u=n[l],c=u.layerId,d=this._layers[c],p=d.layer,m=this._map.hasLayer(p),f=d.overlay||!1;if(f){if(s===c)return e?m||this._map.addLayer(p):m&&this._map.removeLayer(p),this}else a||s===c&&(e?i=u:m&&(u.checked=!1,i=null,this._map.removeLayer(p)),o=u)}return i&&o&&(this._map.addLayer(this._layers[o.layerId].layer),o.checked=!0),this.activeBaseLayerInput=i,this},getActiveBaseLayer:function(t){for(var e=this._form.getElementsByTagName("input"),i=0,n=e.length;n>i;i++){var o=e[i];if(o.checked){if(t)return o;var r=o.layerId,s=this._layers[r];if(!s.overlay)return s.name}}return null},_getLayerByName:function(t){for(var e in this._layers){var i=this._layers[e];if(t===i.name||t===i.layer.id)return i}return null},_onInputClick:function(t){if(t){var e=t.target,i=this._layers[e.layerId].name,n=this._getLayerByName(i),o=this.activeBaseLayerInput&&e.layerId===this.activeBaseLayerInput.layerId?!1:e.checked;this._handlingClick=!0,o&&n&&!n.overlay?this._blm.setCurrentID(n.layer.id):this._toogleActiveBaseLayer(i,o),this._handlingClick=!1,this._refocusOnMap()}}}),L.Control.gmxLayers=L.Control.GmxLayers,L.control.gmxLayers=function(t,e){return new L.Control.GmxLayers(t,e)},function(){var t={eng:{gmxLocation:{locationChange:"hange the map center:",locationTxt:"Current center coordinates",coordFormatChange:"Toggle coordinates format",scaleBarChange:"Toggle scale bar format"}},rus:{gmxLocation:{locationChange:"  :",locationTxt:"   ",coordFormatChange:"  ",scaleBarChange:"  "}}},e=function(e){var i="";if(L.gmxLocale)i=L.gmxLocale.getText(e);else{var n=e.split(".");i=t.eng.gmxLocation[n[n.length-1]]}return i||""},i=["M 1:500 000 000","M 1:300 000 000","M 1:150 000 000","M 1:80 000 000","M 1:40 000 000","M 1:20 000 000","M 1:10 000 000","M 1:5 000 000","M 1:2500 000","M 1:1 000 000","M 1:500 000","M 1:300 000","M 1:150 000","M 1:80 000","M 1:40 000","M 1:20 000","M 1:10 000","M 1:5 000","M 1:2 500","M 1:1 250","M 1:625"],n=["",""," (EPSG:3395)"," (EPSG:3857)"];L.Control.GmxLocation=L.Control.extend({includes:L.Mixin.Events,options:{position:"gmxbottomright",id:"location",gmxPopup:"internal",notHide:!0,coordinatesFormat:0,scaleFormat:"bar"},setScaleFormat:function(t){this.options.scaleFormat="bar"===t?"bar":"text",this.scaleBar.style.visibility="bar"===t?"visible":"hidden",this._checkPositionChanged()},onAdd:function(o){var r="leaflet-gmx-location",s=L.DomUtil.create("div",r),a=L.Control.GmxLocation.Utils,l=this;this._container=s,s._id=this.options.id,this.options.notHide&&(s._notHide=!0),L.gmxLocale&&L.gmxLocale.addText(t),this.prevCoordinates="";var h=o._controlCorners[this.options.position];if(h){this._window=L.DomUtil.create("div","leaflet-gmx-location-window",s),this._window.style.display="none";var u=L.DomUtil.create("div","closeButton",this._window);u.innerHTML="&#215;",L.DomEvent.disableClickPropagation(this._window),L.DomEvent.on(this._window,"contextmenu",L.DomEvent._fakeStop),L.DomEvent.on(u,"click",function(){var t=l._window.style;t.display="none"===t.display?"block":"none"},this),o.on("click",function(){l._window.style.display="none"},this),this._windowContent=L.DomUtil.create("div","windowContent",this._window)}this.locationTxt=L.DomUtil.create("span","leaflet-gmx-locationTxt",s),this.locationTxt.title=e("gmxLocation.locationTxt"),this.coordFormatChange=L.DomUtil.create("span","leaflet-gmx-coordFormatChange",s),this.coordFormatChange.title=e("gmxLocation.coordFormatChange"),this.scaleBar=L.DomUtil.create("span","leaflet-gmx-scaleBar",s),this.scaleBarTxt=L.DomUtil.create("span","leaflet-gmx-scaleBarTxt",s),this.scaleBarTxt.title=this.scaleBar.title=e("gmxLocation.scaleBarChange"),this._map=o;var c={coordFormat:this.options.coordinatesFormat||0,len:n.length,setCoordinatesFormat:function(t){t=t||this.coordFormat||0,0>t?t=c.len-1:t>=c.len&&(t=0),this.coordFormat=t;var e=a.getCoordinatesString(l._map.getCenter(),this.coordFormat);e&&l.prevCoordinates!==e&&(l.locationTxt.innerHTML=e),l.prevCoordinates=e,this._redrawTimer&&clearTimeout(this._redrawTimer),this._redrawTimer=setTimeout(function(){l._map&&l._map.fire("onChangeLocationSize",{locationSize:s.clientWidth})},100),l.fire("coordinatesformatchange",{coordinatesFormat:this.coordFormat})},goTo:function(t){var e=L.Control.gmxLocation.Utils.parseCoordinates(t);l._map.panTo(e)},showCoordinates:function(t){var i=a.getCoordinatesString(l._map.getCenter(),this.coordFormat);if(l.options.onCoordinatesClick)l.options.onCoordinatesClick(i,t);else if(L.control.gmxPopup){var n=L.DomUtil.create("div","gmxLocation-popup"),o=L.DomUtil.create("div","",n),r=L.DomUtil.create("input","gmxLocation-input",n),s=L.DomUtil.create("button","",n);if(s.innerHTML="Ok",L.DomEvent.on(s,"click",function(){c.goTo(r.value)}),o.innerHTML=e("gmxLocation.locationChange"),r.value=i,L.DomEvent.on(r,"keydown",function(t){13===t.which&&c.goTo(this.value)}),"internal"===l.options.gmxPopup&&l._window){l._windowContent.innerHTML="",l._windowContent.appendChild(n);var h=l._window.style;h.display="none"===h.display?"block":"none"}else{var u={};if("tip"===l.options.gmxPopup){var d=l._map.mouseEventToContainerPoint(t);u={tip:!0,anchor:new L.Point(d.x,d.y-5)}}L.control.gmxPopup(u).setContent(n).openOn(l._map)}}else{var p=window.prompt(l.locationTxt.title+":",i);if(p&&p!==i){var m=a.parseCoordinates(p);m&&l._map.panTo(m)}}},nextCoordinatesFormat:function(){this.coordFormat+=1,this.setCoordinatesFormat(this.coordFormat||0)}};this.getCoordinatesFormat=function(){return c.coordFormat},this._checkPositionChanged=function(){var t=o.getZoom();if(t){var e={txt:i[t],width:0};if("bar"===this.options.scaleFormat&&(e=a.getScaleBarDistance(t,o.getCenter())),!e||e.txt===l._scaleBarText&&e.width===l._scaleBarWidth)return;l._scaleBarText=e.txt,l._scaleBarWidth=e.width,l._scaleBarText&&(l.scaleBar.style.width=l._scaleBarWidth+"px",l.scaleBarTxt.innerHTML=l._scaleBarText),c.setCoordinatesFormat(c.coordFormat||0)}},this._setCoordinatesFormat=function(){c.setCoordinatesFormat(c.coordFormat||0)};var d=function(){this.setScaleFormat("bar"===this.options.scaleFormat?"text":"bar")};return this._toggleHandlers=function(t){var e=t?"on":"off",i=L.DomEvent[e],n=L.DomEvent.stopPropagation;i(s,"mousemove",n),i(this.coordFormatChange,"click",n),i(this.coordFormatChange,"click",c.nextCoordinatesFormat,c),i(this.locationTxt,"click",n),i(this.locationTxt,"click",c.showCoordinates,c),i(this.scaleBarTxt,"click",n),i(this.scaleBarTxt,"click",d,this),i(this.scaleBar,"click",n),i(this.scaleBar,"click",d,this),L.Browser.mobile||L.Browser.ie||(i(this.coordFormatChange,"dblclick",n),i(this.scaleBarTxt,"dblclick",n),i(this.scaleBar,"dblclick",n)),o[e]("moveend",this._checkPositionChanged,this),o[e]("move",this._setCoordinatesFormat,this)},this._toggleHandlers(!0),this.setScaleFormat(this.options.scaleFormat),this._checkPositionChanged(),o.fire("controladd",this),o.gmxControlsManager&&o.gmxControlsManager.add(this),s},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this),this.prevCoordinates=this._scaleBarText=null,this._toggleHandlers(!1)}});var o={getScaleBarDistance:function(t,e){for(var i=L.Projection.Mercator.project(e),n=L.Projection.Mercator.unproject(new L.Point(i.x+40,i.y+30)),o=156543.033928041*Math.pow(2,-t)*this.distVincenty(e.lng,e.lat,n.lng,n.lat)/50,r=0;30>r;r++){var s=[1,2,5][r%3]*Math.pow(10,Math.floor(r/3)),a=Math.floor(s/o);if(a>50)return{txt:this.prettifyDistance(s),width:a}}return null}};L.gmxUtil?(o.getCoordinatesString=L.gmxUtil.getCoordinatesString,o.prettifyDistance=L.gmxUtil.prettifyDistance,o.formatDegrees=L.gmxUtil.formatDegrees,o.pad2=L.gmxUtil.pad2,o.trunc=L.gmxUtil.trunc,o.latLonFormatCoordinates=L.gmxUtil.latLonFormatCoordinates,o.latLonFormatCoordinates2=L.gmxUtil.latLonFormatCoordinates2,o.degRad=L.gmxUtil.degRad,o.distVincenty=L.gmxUtil.distVincenty,o.parseCoordinates=L.gmxUtil.parseCoordinates):(o.prettifyDistance=function(t){var i="",n=e("units.km")||"km",o=" "+n;return"km"===i?Math.round(t)/1e3+o:2e3>t||"m"===i?(n=e("units.m")||"m",Math.round(t)+" "+n):2e5>t?Math.round(t/10)/100+o:Math.round(t/1e3)+o},o.formatDegrees=function(t){t=Math.round(1e7*t)/1e7+1e-8;var e=Math.floor(t),i=Math.floor(60*(t-e)),n=this.pad2(3600*(t-e-i/60)).substring(0,2);return this.pad2(e)+""+this.pad2(i)+"'"+n+'"'},o.pad2=function(t){return 10>t?"0"+t:""+t},o.trunc=function(t){return(""+(Math.round(1e7*t)/1e7+1e-8)).substring(0,9)},o.latLonFormatCoordinates=function(t,e){return this.formatDegrees(Math.abs(e))+(e>0?" N, ":" S, ")+this.formatDegrees(Math.abs(t))+(t>0?" E":" W")},o.latLonFormatCoordinates2=function(t,e){return this.trunc(Math.abs(e))+(e>0?" N, ":" S, ")+this.trunc(Math.abs(t))+(t>0?" E":" W")},o.degRad=function(t){return t*(Math.PI/180)},o.distVincenty=function(t,e,i,n){var o={},r={};o.lon=this.degRad(t),o.lat=this.degRad(e),r.lon=this.degRad(i),r.lat=this.degRad(n);for(var s=6378137,a=6356752.3142,l=1/298.257223563,h=r.lon-o.lon,u=Math.atan((1-l)*Math.tan(o.lat)),c=Math.atan((1-l)*Math.tan(r.lat)),d=Math.sin(u),p=Math.cos(u),m=Math.sin(c),f=Math.cos(c),g=h,_=2*Math.PI,v=20;Math.abs(g-_)>1e-12&&--v>0;){var y=Math.sin(g),x=Math.cos(g),L=Math.sqrt(f*y*f*y+(p*m-d*f*x)*(p*m-d*f*x));if(0===L)return 0;var b=d*m+p*f*x,P=Math.atan2(L,b),S=p*f*y/L,T=1-S*S,w=b-2*d*m/T;isNaN(w)&&(w=0);var C=l/16*T*(4+l*(4-3*T));_=g,g=h+(1-C)*l*S*(P+C*L*(w+C*b*(-1+2*w*w)))}if(0===v)return 0/0;var M=T*(s*s-a*a)/(a*a),D=1+M/16384*(4096+M*(-768+M*(320-175*M))),I=M/1024*(256+M*(-128+M*(74-47*M))),k=I*L*(w+I/4*(b*(-1+2*w*w)-I/6*w*(-3+4*L*L)*(-3+4*w*w))),E=a*D*(P-k);return E=E.toFixed(3)},o.parseCoordinates=function(t){var e=null,i=/\(EPSG:(\d+)\)/g,n=i.exec(t);if(n&&(e=n[1],t=t.replace(i,"")),t.match(/[qrtyuiopadfghjklzxcvbmQRTYUIOPADFGHJKLZXCVBM_:]/))return null;if(-1===t.indexOf(" ")&&-1===t.indexOf(","))return null;-1!==t.indexOf(" ")&&(t=t.replace(/,/g,"."));var o=[];for(i=/(-?\d+(\.\d+)?)([^\d\-]*)/g,n=i.exec(t);n;)o.push(n[1]),n=i.exec(t);if(o.length<2)return null;var r,s=Math.floor(o.length/2),a=0,l=1;for(r=0;s>r;r++)a+=parseFloat(o[r])*l,l/=60;var h=0;for(l=1,r=s;r<o.length;r++)h+=parseFloat(o[r])*l,l/=60;Math.max(t.indexOf("N"),t.indexOf("S"))>Math.max(t.indexOf("E"),t.indexOf("W"))&&(n=h,h=a,a=n);var u;return"3857"===e&&(u=L.Projection.SphericalMercator.unproject(new L.Point(a,h)._divideBy(6378137)),h=u.lng,a=u.lat),(Math.abs(h)>180||Math.abs(a)>180)&&(u=L.Projection.Mercator.unproject(new L.Point(a,h)),h=u.lng,a=u.lat),-1!==t.indexOf("W")&&(h=-h),-1!==t.indexOf("S")&&(a=-a),[a,h]},o.getCoordinatesString=function(t,e){var i,r=t.lng,s=t.lat,a=n,l=a.length,h="";return e=e||0,r>180&&(r-=360),-180>r&&(r+=360),0===e%l?h=o.latLonFormatCoordinates2(r,s):1===e%l?h=o.latLonFormatCoordinates(r,s):2===e%l?(i=L.Projection.Mercator.project(new L.LatLng(s,r)),h=""+Math.round(i.x)+", "+Math.round(i.y)+a[2]):(i=L.CRS.EPSG3857.project(new L.LatLng(s,r)),h=""+Math.round(i.x)+", "+Math.round(i.y)+a[3]),h}),L.Control.GmxLocation.Utils=o,L.Control.gmxLocation=L.Control.GmxLocation,L.control.gmxLocation=function(t){return new L.Control.GmxLocation(t)}}(),L.Control.GmxPopup=L.Control.extend({options:{position:"center",id:"gmxPopup",className:"gmxControlPopup",draggable:!0},onAdd:function(t){return this._map=t,this._container||this._initLayout(),t.on("click",this.remove,this),this._container},openOn:function(t){return t.addControl(this),this.update(),this},remove:function(){return this._map&&(this._map.off("click",this.remove,this),this._map.removeControl(this)),this},setContent:function(t){return this._content=t,this.update(),this},update:function(){return this._container?(this._container.style.visibility="hidden",this._updateContent(),this._updateLayout(),this._updatePosition(),this._container.style.visibility="",this):void 0},_updateContent:function(){if(this._content)if("string"==typeof this._content)this._contentNode.innerHTML=this._content;else{for(;this._contentNode.hasChildNodes();)this._contentNode.removeChild(this._contentNode.firstChild);this._contentNode.appendChild(this._content)}},_updateLayout:function(){var t=this._contentNode,e=t.style;e.width="",e.whiteSpace="nowrap";var i=t.offsetWidth;i=Math.min(i,this.options.maxWidth),i=Math.max(i,this.options.minWidth),e.width=i+1+"px",e.whiteSpace="",e.height="";var n=t.offsetHeight,o=this.options.maxHeight,r="leaflet-popup-scrolled";o&&n>o?(e.height=o+"px",L.DomUtil.addClass(t,r)):L.DomUtil.removeClass(t,r),this._containerWidth=this._container.offsetWidth},_updatePosition:function(){if(this._map){var t=new L.Point(this._container.clientWidth,this._container.clientHeight),e=this.options.anchor&&this.options.anchor._subtract(L.point(10,this._container.clientHeight))||this._map.getSize()._divideBy(2),i=e._subtract(t._divideBy(2));
L.DomUtil.setPosition(this._container,i)}},_initLayout:function(){var t=this._container=L.DomUtil.create("div",this.options.className),e=L.DomUtil.create("div","closeButton",t);e.innerHTML="&#215;",L.DomEvent.disableClickPropagation(e),L.DomEvent.disableClickPropagation(t),L.DomEvent.on(e,"click",this.remove,this),this.options.draggable&&(new L.Draggable(t).enable(),t.style.cursor="move");var i=L.DomUtil.create("div","content-wrapper",t);L.DomEvent.disableClickPropagation(i),this._contentNode=L.DomUtil.create("div","content",i),L.DomEvent.disableScrollPropagation(this._contentNode),L.DomEvent.on(i,"contextmenu",L.DomEvent.stopPropagation),this.options.tip&&(this._tipContainer=L.DomUtil.create("div","tip-container",t),this._tip=L.DomUtil.create("div","tip",this._tipContainer))}}),L.control.gmxPopup=function(t){return new L.Control.GmxPopup(t)},function(){var t=function(t){var e=L.gmxLocale?L.gmxLocale.getText(t):null;return e||""};L.Control.GmxCopyright=L.Control.extend({options:{position:"gmxbottomleft",type:"window",closeButton:!1,notHide:!0,cursorPosition:!1,mapCopyright:"",scanexCopyright:'<a target="_blank" href="http://kosmosnimki.ru/terms.html">&copy; 2007-'+(new Date).getUTCFullYear()+" RDC ScanEx</a> - Terms of Service",leafletCopyright:'<a target="_blank" href="http://leafletjs.com">&copy; Leaflet</a>',id:"copyright"},onAdd:function(e){if(L.gmxLocale&&L.gmxLocale.addText({eng:{gmxCopyright:{showHide:"Show/Hide copyrights"}},rus:{gmxCopyright:{showHide:"/ "}}}),this._currentText="",this._container=L.DomUtil.create("span","leaflet-gmx-copyright"),this.options.notHide&&(this._container._notHide=!0),this._container._id=this.options.id,this._window=L.DomUtil.create("div","leaflet-gmx-copyright-window",this._container),this.options.closeButton){var i=L.DomUtil.create("div","closeButton",this._window);i.innerHTML="&#215;",L.DomEvent.on(i,"click",this.toggleWindow,this)}if(this._windowContent=L.DomUtil.create("div","windowContent",this._window),L.DomEvent.on(this._window,"contextmenu",L.DomEvent._fakeStop),this._copyrights=L.DomUtil.create("span","leaflet-gmx-copyrights",this._container),this.options.cursorPosition){var n=L.gmxUtil||(L.Control.GmxLocation?L.Control.GmxLocation.Utils:null),o=e.gmxControlsManager.get("location")||null;if(n){var r=L.DomUtil.create("span","leaflet-gmx-cursorposition",this._container);this.lastLatLng=L.latLng(0,0),this.cursorPosition=function(t){var e=t.latlng,i=L.Browser.webkit?t.originalEvent.which:t.originalEvent.buttons;i||e.equals(this.lastLatLng)||(this.lastLatLng=e,r.innerHTML=n.getCoordinatesString(e,o?o.getCoordinatesFormat():0))},e.on("mousemove",this.cursorPosition,this)}}this.setFormat=function(e){"window"===e?(this._copyrights.title=t("gmxCopyright.showHide"),this._copyrights.innerHTML=" Copyrights",this._container.style.width="auto"):this._copyrights.title="",this.options.type=e,this.toggleWindow(),this._window.style.display="none"},this.setFormat(this.options.type);var s=L.DomEvent.stopPropagation;return L.DomEvent.on(this._window,"dblclick",s).on(this._window,"click",s).on(this._container,"mousemove",s).on(this._copyrights,"dblclick",s).on(this._copyrights,"click",s).on(this._copyrights,"click",this.toggleWindow,this),e.on("click",this.closeWindow,this).on("onChangeLocationSize",this._chkWidth,this).on("moveend",this._redraw,this).on("layeradd",this._redraw,this).on("layerremove",this._redraw,this),this._redraw(),e.fire("controladd",this),e.gmxControlsManager&&e.gmxControlsManager.add(this),this._container},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this);var e=L.DomEvent.stopPropagation;L.DomEvent.off(this._window,"dblclick",e).off(this._window,"click",e).off(this._container,"mousemove",e).off(this._copyrights,"dblclick",e).off(this._copyrights,"click",e).off(this._copyrights,"click",this.toggleWindow,this),t.off("click",this.closeWindow,this).off("onChangeLocationSize",this._chkWidth,this).off("moveend",this._redraw,this).off("layeradd",this._redraw,this).off("layerremove",this._redraw,this),this.cursorPosition&&t.off("mousemove",this.cursorPosition,this)},toggleWindow:function(){this.setWindowVisible("none"===this._window.style.display?!0:!1)},closeWindow:function(){this.setWindowVisible(!1)},setWindowVisible:function(t){if("window"===this.options.type){var e=this._window.style;e.display=t?"block":"none",this._currentText="",this._redraw()}},_chkWidth:function(t){if("window"!==this.options.type){var e=this._map._size.x-t.locationSize-25;this._container.style.width=(e>0?e:0)+"px"}},setMapCopyright:function(t){this.options.mapCopyright=t||"",this._redraw()},_redrawItems:function(){var t='<a target="_blank"',e=[],i=this._map._layers,n=this._map._zoom,o=this._map.getBounds(),r=[],s={};this.options.scanexCopyright&&e.push(this.options.scanexCopyright),this.options.mapCopyright&&e.push(this.options.mapCopyright);for(var a in i)i[a].options&&r.push(i[a].options);r=r.sort(function(t,e){return t.zIndex-e.zIndex}),r.forEach(function(i){var r=i.attribution;r&&!s[r]&&(s[r]=!0,e.push(r.split("<a").join(t))),i.gmxCopyright&&i.gmxCopyright.forEach(function(i){var r=i.attribution;s[r]||n<i.minZoom||n>i.maxZoom||(!i.bounds||(i.bounds instanceof L.LatLngBounds||(i.bounds=L.latLngBounds(i.bounds)),o.intersects(i.bounds)))&&(s[r]=!0,e.push(r.split("<a").join(t)))})}),this.options.leafletCopyright&&e.push(this.options.leafletCopyright);var l=e.join(" ");this._currentText!==l&&(this._currentText=l,"window"===this.options.type?this._windowContent.innerHTML=e.join("<br>"):this._copyrights.innerHTML=l)},_redraw:function(){var t=this;this._redrawTimer&&clearTimeout(this._redrawTimer),this._redrawTimer=setTimeout(function(){t._redrawTimer=null,t._map&&t._redrawItems()},100)}}),L.Control.gmxCopyright=L.Control.GmxCopyright,L.control.gmxCopyright=function(t){return new L.Control.GmxCopyright(t)}}(),L.Control.GmxZoom=L.Control.Zoom.extend({options:{position:"topleft",id:"zoom",zoomslider:!0},_stepY:7,_minY:9,_maxY:9,onAdd:function(t){var e="leaflet-gmx",i=L.DomUtil.create("div",e+"-zoomParent"),n=this.options,o=n.svgSprite||t.options.svgSprite;this._container=i,i._id=n.id,i._isZoomControl=!0,this._map=t,this._zoomPlaque=L.DomUtil.create("div",e+"-zoomPlaque",i);var r="Zoom in",s="Zoom out";L.gmxLocale&&(L.gmxLocale.addText({eng:{"Zoom in":"Zoom in","Zoom out":"Zoom out"},rus:{"Zoom in":"","Zoom out":""}}),r=L.gmxLocale.getText("Zoom in"),s=L.gmxLocale.getText("Zoom out"));var a=o?e+"-iconSvg":e+"-icon "+e+"-icon-img "+e+"-icon-sprite";return this._zoomInButton=this._createDiv(i,e+(o?"Svg":"")+"-zoom-in "+a,r,this._zoomIn,this),this._zoomOutButton=this._createDiv(i,e+(o?"Svg":"")+"-zoom-out "+a,s,this._zoomOut,this),o&&(L.DomUtil.addClass(this._zoomInButton,"svgIcon"),this._zoomInButton.innerHTML='<svg role="img" class="svgIcon"><use xlink:href="#zoom-in"></use></svg>',L.DomUtil.addClass(this._zoomOutButton,"svgIcon"),this._zoomOutButton.innerHTML='<svg role="img" class="svgIcon"><use xlink:href="#zoom-out"></use></svg>'),t.on("zoomend zoomlevelschange",this._updateDisabled,this),n.zoomslider&&this._chkZoomLevelsChange(i),t.fire("controladd",this),t.gmxControlsManager&&t.gmxControlsManager.add(this),i},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this),L.Control.Zoom.prototype.onRemove.call(this,t)},_createDiv:function(t,e,i,n,o){var r=L.DomUtil.create("div",e,t);i&&(r.title=i);var s=L.DomEvent.stopPropagation;return L.DomEvent.on(r,"click",s).on(r,"mousedown",s).on(r,"dblclick",s).on(r,"click",L.DomEvent.preventDefault).on(r,"click",n||s,o),r},_setPosition:function(){if(this._zoomVal){var t=this._map.getMinZoom(),e=this._maxY-(this._zoom-t)*this._stepY;this._zoomVal.innerHTML=this._zoom,L.DomUtil.setPosition(this._zoomPointer,L.point(4,e))}},_getZoomByY:function(t){return t<this._minY?t=this._minY:t>this._maxY&&(t=this._maxY),Math.floor((this._maxY-t)/this._stepY)},_setSliderSize:function(){var t=this._map,e=this._stepY*(t.getMaxZoom()-t.getMinZoom()+1);this._maxY=e+3,this._zoomSliderBG.style.height=e+"px",e+=72,"block"!==this._zoomSliderCont.style.display?(this._zoomPlaque.style.display="none",e=68):this._zoomPlaque.style.display="block",this._zoomPlaque.style.height=e+"px"},_chkZoomLevelsChange:function(t){var e=this,i=this._map,n="leaflet-gmx",o=i.getMinZoom(),r=i.getMaxZoom();if(o!==this._MinZoom||r!==this._MaxZoom){var s=r-o;if(100>r&&s>=0){if(!this._zoomSliderCont){this._zoomSliderCont=this._createDiv(t,n+"-sliderCont"),this._zoomSliderBG=this._createDiv(this._zoomSliderCont,n+"-sliderBG"),L.DomEvent.on(this._zoomSliderBG,"click",function(t){this._zoom=this._getZoomByY(t.layerY)+i.getMinZoom(),this._map.setZoom(this._zoom),this._zoomPointer.style.display=this._zoom===i._limitZoom(this._zoom)?"block":"none"},this),this._zoomPointer=this._createDiv(this._zoomSliderCont,n+"-zoomPointer "),this._zoomVal=this._createDiv(this._zoomPointer,n+"-zoomVal "+n+"-icon-sprite"),L.DomEvent.on(t,"mouseover",function(){var t=i.getZoom();this._zoomPointer.style.display=t===i._limitZoom(t)?"block":"none",1/0!==i.getMaxZoom()&&(this._zoomSliderCont.style.display="block",this._setSliderSize())},this);var a=function(){e._zoomSliderCont.style.display="none",e._setSliderSize()};L.DomEvent.on(t,"mouseout",function(){this._draggable._moving||a()},this);var l=new L.Draggable(this._zoomPointer);l.on("dragstart",function(){},this),l.on("drag",function(t){var e=t.target._newPos;this._zoom=this._getZoomByY(e.y)+i.getMinZoom(),this._setPosition()},this),l.on("dragend",function(){this._map.setZoom(this._zoom),a()},this),l.enable(),this._draggable=l}this._setSliderSize()}this._MinZoom=o,this._MaxZoom=r}this._zoom=i._zoom,this._setPosition()},_updateDisabled:function(t){L.Control.Zoom.prototype._updateDisabled.call(this,t),this._zoom=this._map._zoom,this.options.zoomslider&&("zoomlevelschange"===t.type&&this._chkZoomLevelsChange(this._container),this._setPosition())},setVisible:function(t){this._container&&(this._container.style.display=t?"block":"none")}}),L.Control.gmxZoom=L.Control.GmxZoom,L.control.gmxZoom=function(t){return new L.Control.GmxZoom(t)},L.Control.GmxBottom=L.Control.extend({options:{position:"bottom",notHide:!0,id:"bottom"},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this);var e=t._controlCorners;["bottomleft","bottomright","right","left"].map(function(t){e[t]&&L.DomUtil.removeClass(e[t],"gmx-bottom-shift")})},onAdd:function(t){var e="leaflet-gmx-copyright-location",i=L.DomUtil.create("div",e);this._container=i,i._id=this.options.id,this.options.notHide&&(i._notHide=!0),L.DomEvent.on(i,"mousemove",L.DomEvent.stopPropagation).on(this._map._controlContainer,"dblclick",L.DomEvent.stopPropagation),L.DomUtil.create("div",e+"-bg",i),t.fire("controladd",this);var n=t._controlCorners;return["bottomleft","bottomright","right","left"].map(function(t){n[t]&&L.DomUtil.addClass(n[t],"gmx-bottom-shift")}),t.gmxControlsManager&&t.gmxControlsManager.add(this),i}}),L.Control.gmxBottom=L.Control.GmxBottom,L.control.gmxBottom=function(t){return new L.Control.GmxBottom(t)},L.Control.GmxLogo=L.Control.extend({options:{position:"gmxbottomcenter",notHide:!0,id:"logo"},onAdd:function(t){var e=L.DomUtil.create("a","");this._container=e,this.options.notHide&&(e._notHide=!0),e.id=this.options.id,e.setAttribute("href","http://geomixer.ru"),e.setAttribute("target","_blank"),this._logoPrefix="leaflet-gmx-logo"+(this.options.type?"-"+this.options.type:"");var i=this._logoPrefix+"-shift";return this._shift=!1,this._updatePosition=function(t){if(e.parentNode){var n=(e.clientWidth-e.parentNode.clientWidth)/2+t.locationSize>0?!0:!1;this._shift!==n&&(this._shift=n,n?L.DomUtil.addClass(e,i):L.DomUtil.removeClass(e,i))}},t.fire("controladd",this),t.gmxControlsManager&&t.gmxControlsManager.add(this),e},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this),t.off("onChangeLocationSize",this._updatePosition,this)},addTo:function(t){return L.Control.prototype.addTo.call(this,t),L.DomUtil.addClass(this._container,this._logoPrefix),t.on("onChangeLocationSize",this._updatePosition,this),this}}),L.Control.gmxLogo=L.Control.GmxLogo,L.control.gmxLogo=function(t){return new L.Control.GmxLogo(t)},L.Map.addInitHook(function(){this._controlCorners.bottom||(this._controlCorners.bottom=L.DomUtil.create("div","leaflet-bottom leaflet-left leaflet-right",this._controlContainer))}),L.Control.GmxSidebar=L.Control.extend({options:{id:"defaultSidebar",position:"right"},onAdd:function(t){var e=document.createElement("div");return this._container=e,e._id=this.options.id,e.className="leaflet-gmx-sidebar","number"==typeof this.options.width&&e.setAttribute("style","width: "+this.options.width+"px"),"string"==typeof this.options.className&&L.DomUtil.addClass(e,this.options.className),L.DomEvent.on(e,"mousemove",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation),t.gmxControlsManager&&t.gmxControlsManager.add(this),e},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this)},expand:function(){L.DomUtil.addClass(this._container,"leaflet-gmx-sidebar_expanded")},collapse:function(){L.DomUtil.removeClass(this._container,"leaflet-gmx-sidebar_expanded")},isExpanded:function(){return L.DomUtil.hasClass(this._container,"leaflet-gmx-sidebar_expanded")},getContentContainer:function(){return this.getContainer()},setWidth:function(t){"number"==typeof t&&this._container.setAttribute("style","width: "+t+"px")}}),L.Control.gmxSidebar=L.Control.GmxSidebar,L.control.gmxSidebar=function(t){return new L.Control.GmxSidebar(t)},L.Control.GmxLoaderStatus=L.Control.extend({options:{id:"loaderStatus",position:"topleft",type:"gif"},_items:{},addItem:function(t,e){var i=t||L.gmxUtil.newId(),n=this._items[i],o="gif"===this.options.type?"icon-refresh-gif":"animate-spin icon-refresh";return o+=e?" leaflet-gmx-loaderStatus-"+e:"",this._div.className=o,L.DomUtil.removeClass(this._container,"leaflet-gmx-visibility-hidden"),n?n++:this._items[i]=1,i},removeItem:function(t){var e=this._items[t];e>1?this._items[t]--:delete this._items[t],0===Object.keys(this._items).length&&("gif"!==this.options.type&&L.DomUtil.removeClass(this._div,"animate-spin"),L.DomUtil.addClass(this._container,"leaflet-gmx-visibility-hidden"))},onRemove:function(t){t.gmxControlsManager&&t.gmxControlsManager.remove(this),t.fire("controlremove",this),delete L.gmx.loaderStatus},onAdd:function(t){var e=this.options,i="leaflet-gmx-visibility-hidden leaflet-gmx-"+e.id,n=L.DomUtil.create("div",i),o=L.DomUtil.create("div","gif"===e.type?"icon-refresh-gif":"animate-spin icon-refresh",n),r="Loader status";L.gmxLocale&&(r=L.gmxLocale.addText({eng:{hide:r},rus:{hide:" "}}).getText("hide")),n._id=this.options.id,n.title=r,this._container=n,this._div=o,this._items={},t.fire("controladd",this),t.gmxControlsManager&&t.gmxControlsManager.add(this);var s=this;return L.gmxUtil||(L.gmxUtil={}),L.gmxUtil.loaderStatus=function(t,e,i){return s[e?"removeItem":"addItem"].apply(s,[t,i])},n}}),L.Control.gmxLoaderStatus=L.Control.GmxLoaderStatus,L.control.gmxLoaderStatus=function(t){return new L.Control.GmxLoaderStatus(t)},function(){var t=1e-7,e="1.0.0";L.GmxDrawing=L.Class.extend({options:{type:""},includes:L.Mixin.Events,initialize:function(t){if(this._map=t,this.items=[],this.current=null,L.gmxUtil&&L.gmxUtil.prettifyDistance){var e=document.createElementNS(L.Path.SVG_NS,"g");L.DomUtil.addClass(e,"gmxTooltip");var i=document.createElementNS(L.Path.SVG_NS,"rect");i.setAttributeNS(null,"rx",4),i.setAttributeNS(null,"ry",4),i.setAttributeNS(null,"height",16),L.DomUtil.addClass(i,"gmxTooltipBG");var n=document.createElementNS(L.Path.SVG_NS,"text"),o=L.DomUtil.testProp(["userSelect","WebkitUserSelect","OUserSelect","MozUserSelect","msUserSelect"]);n.style[o]="none",e.appendChild(i),e.appendChild(n),this.hideTooltip=function(){e.setAttributeNS(null,"visibility","hidden")},this.showTooltip=function(t,o){var r=t.x+11,s=t.y-14;n.setAttributeNS(null,"x",r),n.setAttributeNS(null,"y",s),n.textContent=o,"visible"!==e.getAttributeNS(null,"visibility")&&(this._map._pathRoot.appendChild(e),e.setAttributeNS(null,"visibility","visible"));var a=n.getComputedTextLength();i.setAttributeNS(null,"width",a+8),i.setAttributeNS(null,"x",r-4),i.setAttributeNS(null,"y",s-12)}}var r=function(t){this._drawMode=t.mode};this.on("drawstop drawstart",r)},bringToFront:function(){for(var t=0,e=this.items.length;e>t;t++){var i=this.items[t];i._map&&"bringToFront"in i&&i.bringToFront()}},addGeoJSON:function(t,e){var i=[],n=t instanceof L.GeoJSON;if(n||(t=L.geoJson(t,e)),t instanceof L.GeoJSON){var o=t.getLayers();if(o)for(var r=function(t){var n=null;if(t.setStyle&&e&&e.lineStyle){n={};for(var o in e.lineStyle)n[o]=e.lineStyle[o];t.setStyle(e.lineStyle)}var r=this.add(t,e);r._originalStyle=n,i.push(r)},s=0,a=o.length;a>s;s++){var l=o[s];"GeometryCollection"!==l.feature.geometry.type&&(l=L.layerGroup([l])),l.eachLayer(r,this)}}return i},add:function(t,e){var i=null;if(t){if(t instanceof L.GmxDrawing.Feature)i=t;else{var n={};if(e&&"editable"in e||(n.editable=!0),t.geometry?n.type=t.geometry.type:t instanceof L.Rectangle?n.type="Rectangle":t instanceof L.Polygon?n.type="Polygon":t instanceof L.MultiPolygon?n.type="MultiPolygon":t instanceof L.Polyline?n.type="Polyline":t instanceof L.MultiPolyline?n.type="MultiPolyline":t instanceof L.Marker&&(n.type="Point",n.editable=!1,t.options.draggable=!0),e=this._chkDrawOptions(n.type,e),L.extend(e,n),t.geometry){var o=e.markerStyle&&e.markerStyle.iconStyle;return"Point"===e.type&&!e.pointToLayer&&o&&(e.icon=L.icon(o),e.pointToLayer=function(t,i){return new L.Marker(i,e)}),this.addGeoJSON(t,e)}i=new L.GmxDrawing.Feature(this,t,e)}"map"in e||(e.map=!0),e.map&&!i._map?this._map.addLayer(i):this._addItem(i),"setEditMode"in i&&i.setEditMode()}return i},_disableDrag:function(){this._map.dragging.disable(),L.DomUtil.disableTextSelection(),L.DomUtil.disableImageDrag(),this._map.doubleClickZoom.removeHooks()},_enableDrag:function(){this._map.dragging.enable(),L.DomUtil.enableTextSelection(),L.DomUtil.enableImageDrag(),this._map.doubleClickZoom.addHooks()},_clearCreate:function(){this._createKey&&("Rectangle"===this._createKey.type&&L.Browser.mobile?L.DomEvent.off(this._map._container,"touchstart",this._createKey.fn,this):this._map.off(this._createKey.eventName,this._createKey.fn,this),this._enableDrag()),this._createKey=null},_chkDrawOptions:function(t,e){var i=L.GmxDrawing.utils.defaultStyles,n={};if(e||(e=L.extend({},i)),"Point"===t?L.extend(n,i.markerStyle.options.icon,e):(L.extend(n,e),n.lineStyle=L.extend({},i.lineStyle,e.lineStyle),n.pointStyle=L.extend({},i.pointStyle,e.pointStyle),n.holeStyle=L.extend({},i.holeStyle,e.holeStyle)),n.iconUrl){var o={iconUrl:n.iconUrl};delete n.iconUrl,n.iconAnchor&&(o.iconAnchor=n.iconAnchor,delete n.iconAnchor),n.iconSize&&(o.iconSize=n.iconSize,delete n.iconSize),n.popupAnchor&&(o.popupAnchor=n.popupAnchor,delete n.popupAnchor),n.shadowSize&&(o.shadowSize=n.shadowSize,delete n.shadowSize),n.markerStyle={iconStyle:o}}return n},create:function(e,i){if(this._clearCreate(null),e){var n=this._map,o=this._chkDrawOptions(e,i),r=this;"Rectangle"===e&&(n._initPathRoot(),n.dragging.disable()),this._createKey={type:e,eventName:"Rectangle"===e?L.Browser.mobile?"touchstart":"mousedown":"click",fn:function(i){r._createType="";var n,s,a={},l=i.latlng;for(s in o)s in L.GmxDrawing.utils.defaultStyles||(a[s]=o[s]);if("Point"===e){var h=o.markerStyle||{},u={draggable:!0};i&&i.originalEvent&&(u.ctrlKey=i.originalEvent.ctrlKey,u.shiftKey=i.originalEvent.shiftKey,u.altKey=i.originalEvent.altKey),h.iconStyle&&(u.icon=L.icon(h.iconStyle)),n=r.add(L.marker(l,u),a)}else o.pointStyle&&(a.pointStyle=o.pointStyle),o.lineStyle&&(a.lineStyle=o.lineStyle),"Rectangle"===e?(a.mode="edit",n=r.add(L.rectangle(L.latLngBounds(L.latLng(l.lat+t,l.lng-t),l)),a),L.Browser.mobile?n._startTouchMove(i,!0):n._pointDown(i),n.rings[0].ring._drawstop=!0):"Polygon"===e?(a.mode="add",n=r.add(L.polygon([l]),a),n.setAddMode()):"Polyline"===e&&(a.mode="add",n=r.add(L.polyline([l]),a).setAddMode());r._clearCreate()}},"Rectangle"===e&&L.Browser.mobile?L.DomEvent.on(n._container,"touchstart",this._createKey.fn,this):n.on(this._createKey.eventName,this._createKey.fn,this),this._createType=e,L.DomUtil.addClass(n._mapPane,"leaflet-clickable"),this.fire("drawstart",{mode:e})}this.options.type=e},extendDefaultStyles:function(t){var e=L.GmxDrawing.utils.defaultStyles;if(t=t||{},t.iconUrl){var i=e.markerStyle.options.icon;i.iconUrl=t.iconUrl,delete t.iconUrl,t.iconAnchor&&(i.iconAnchor=t.iconAnchor,delete t.iconAnchor),t.iconSize&&(i.iconSize=t.iconSize,delete t.iconSize),t.popupAnchor&&(i.popupAnchor=t.popupAnchor,delete t.popupAnchor),t.shadowSize&&(i.shadowSize=t.shadowSize,delete t.shadowSize)}return t.lineStyle&&(L.extend(e.lineStyle,t.lineStyle),delete t.lineStyle),t.pointStyle&&(L.extend(e.pointStyle,t.pointStyle),delete t.pointStyle),t.holeStyle&&(L.extend(e.holeStyle,t.holeStyle),delete t.holeStyle),L.extend(e,t),this},getFeatures:function(){for(var t=[],e=0,i=this.items.length;i>e;e++)t.push(this.items[e]);return t},loadState:function(t){var e=this,i=t.featureCollection;L.geoJson(i,{onEachFeature:function(t,i){var n=t.properties,o=n.popupOpened;if("Rectangle"===n.type)i=L.rectangle(i.getBounds());else if("Point"===n.type){n=n.options;var r=n.icon;r&&(delete n.icon,r.iconUrl&&(n.icon=L.icon(r))),i=L.marker(i.getLatLng(),n)}i.setStyle&&n&&n.lineStyle&&i.setStyle(n.lineStyle),e.add(i,n),o&&i.openPopup()}})},saveState:function(){for(var t=L.featureGroup(),i=[],n=0,o=this.items.length;o>n;n++){var r=this.items[n];if("Point"===r.options.type){var s=r.toGeoJSON();s.properties=L.GmxDrawing.utils.getNotDefaults(r.options,L.GmxDrawing.utils.defaultStyles.markerStyle),r._map?r._map.hasLayer(r.getPopup())&&(s.properties.popupOpened=!0):s.properties.map=!1;var a=L.GmxDrawing.utils.getNotDefaults(r._obj.options,L.GmxDrawing.utils.defaultStyles.markerStyle.options);Object.keys(a).length&&(s.properties.options=a),a=L.GmxDrawing.utils.getNotDefaults(r._obj.options.icon.options,L.GmxDrawing.utils.defaultStyles.markerStyle.options.icon),Object.keys(a).length&&(s.properties.options||(s.properties.options={}),s.properties.options.icon=a),i.push(s)}else t.addLayer(r)}var l=t.toGeoJSON();return l.features=l.features.concat(i),{version:e,featureCollection:l}},_addItem:function(t){for(var e=!0,i=0,n=this.items.length;n>i;i++){var o=this.items[i];if(o===t){e=!1;break}}e&&this.items.push(t),this.fire("add",{mode:t.mode,object:t})},_removeItem:function(t,e){for(var i=0,n=this.items.length;n>i;i++){var o=this.items[i];if(o===t){if(e){this.items.splice(i,1);var r={type:o.options.type,mode:o.mode,object:o};this.fire("remove",r),o.fire("remove",r)}return o}}return null},clear:function(){for(var t=0,e=this.items.length;e>t;t++){var i=this.items[t];i&&i._map&&i._map.removeLayer(i);var n={type:i.options.type,mode:i.mode,object:i};this.fire("remove",n),i.fire("remove",n)}return this.items=[],this},remove:function(t){var e=this._removeItem(t,!0);return e&&e._map&&e._map.removeLayer(e),e}}),L.Map.addInitHook(function(){this.gmxDrawing=new L.GmxDrawing(this),L.Mixin.ContextMenu&&L.GmxDrawing.PointMarkers.include(L.Mixin.ContextMenu)})}(),L.GmxDrawing.Feature=L.LayerGroup.extend({options:{mode:""},includes:L.Mixin.Events,simplify:function(){var t,e,i,n,o;for(t=0,i=this.rings.length;i>t;t++){var r=this.rings[t],s=r.ring;for(s.setLatLngs(s.points.getPathLatLngs()),e=0,n=r.holes.length;n>e;e++)o=r.holes[e],o.setLatLngs(o.points.getPathLatLngs())}return this},bringToFront:function(){return this.invoke("bringToFront")},bringToBack:function(){return this.invoke("bringToBack")},onAdd:function(t){if(L.LayerGroup.prototype.onAdd.call(this,t),this._parent._addItem(this),"Point"===this.options.type){t.addLayer(this._obj);var e=this;setTimeout(function(){e._fireEvent("drawstop",e._obj.options)},0)}this._fireEvent("addtomap")},onRemove:function(t){"hideTooltip"in this&&this.hideTooltip(),L.LayerGroup.prototype.onRemove.call(this,t),"Point"===this.options.type&&t.removeLayer(this._obj),this._fireEvent("removefrommap")},remove:function(t){if(t){var e,i,n,o,r;for(e=0,n=this.rings.length;n>e;e++)if(t.options.hole){for(i=0,o=this.rings[e].holes.length;o>i;i++)if(r=this.rings[e].holes[i],t===r){this.rings[e].holes.splice(i,1),r._map&&r._map.removeLayer(r);break}if(!t._map)break}else if(t===this.rings[e].ring){for(i=0,o=this.rings[e].holes.length;o>i;i++)r=this.rings[e].holes[i],r._map&&r._map.removeLayer(r);this.rings.splice(e,1),t._map&&t._map.removeLayer(t);break}}else this.rings=[];return this.rings.length<1&&(this._originalStyle&&this._obj.setStyle(this._originalStyle),this._parent.remove(this)),this},_fireEvent:function(t){if(!("removefrommap"===t&&this.rings.length>1)){var e={mode:this.mode||"",object:this};this.fire(t,e),this._parent.fire(t,e),"drawstop"===t&&this._map&&L.DomUtil.removeClass(this._map._mapPane,"leaflet-clickable")}},getStyle:function(){var t=L.extend({},this._drawOptions);return delete t.holeStyle,"Point"===t.type&&(L.extend(t,t.markerStyle.iconStyle),delete t.markerStyle),t},setOptions:function(t){return t.lineStyle&&this._setStyleOptions(t.lineStyle,"lines"),t.pointStyle&&this._setStyleOptions(t.pointStyle,"points"),"editable"in t&&(t.editable?this.enableEdit():this.disableEdit()),L.setOptions(this,t),this._fireEvent("optionschange"),this},_setStyleOptions:function(t,e){for(var i=0,n=this.rings.length;n>i;i++){var o=this.rings[i].ring[e];o.setStyle(t),o.redraw();for(var r=0,s=this.rings[i].holes.length;s>r;r++)o=this.rings[i].holes[r][e],o.setStyle(t),o.redraw()}this._fireEvent("stylechange")},_setLinesStyle:function(t){this._setStyleOptions(t,"lines")},_setPointsStyle:function(t){this._setStyleOptions(t,"points")},getOptions:function(){var t=this.options,e=L.extend({},t);e.lineStyle=t.lineStyle,e.pointStyle=t.pointStyle;var i=L.GmxDrawing.utils.getNotDefaults(e,L.GmxDrawing.utils.defaultStyles);if(Object.keys(i.lineStyle).length||delete i.lineStyle,Object.keys(i.pointStyle).length||delete i.pointStyle,this._map||(i.map=!1),"Point"===t.type){var n=L.GmxDrawing.utils.getNotDefaults(this._obj.options,L.GmxDrawing.utils.defaultStyles.markerStyle.options);Object.keys(n).length&&(i.options=n),n=L.GmxDrawing.utils.getNotDefaults(this._obj.options.icon.options,L.GmxDrawing.utils.defaultStyles.markerStyle.options.icon),Object.keys(n).length&&(i.options.icon=n)}return i},_latLngsToCoords:function(t,e){var i=L.GeoJSON.latLngsToCoords(t);if(e){var n=i[i.length-1];(n[0]!==i[0][0]||n[1]!==i[0][1])&&i.push(i[0])}return i},_latlngsAddShift:function(t,e){for(var i=[],n=0,o=t.length;o>n;n++)i.push(L.GmxDrawing.utils.getShiftLatlng(t[n],this._map,e));return i},getPixelOffset:function(){var t=this.shiftPixel;if(!t&&this._map){var e=256/L.gmxUtil.tileSizes[this._map._zoom];t=this.shiftPixel=new L.Point(Math.floor(e*this._dx),-Math.floor(e*this._dy))}return t||new L.Point(0,0)},setOffsetToGeometry:function(t,e){var i,n,o,r,s,a,l=256/L.gmxUtil.tileSizes[this._map._zoom],h=new L.Point(l*(this._dx||t||0),-l*(this._dy||e||0));for(i=0,n=this.rings.length;n>i;i++){var u=this.rings[i];if(s=u.ring,a=s.points.getLatLngs(),s.setLatLngs(this._latlngsAddShift(a,h)),u.holes&&u.holes.length)for(o=0,r=u.holes.length;r>o;o++)s=u.holes[o].ring,a=s.points.getLatLngs(),s.setLatLngs(this._latlngsAddShift(a,h))}return this.setPositionOffset(),this},setPositionOffset:function(t,e){if(this._dx=t||0,this._dy=e||0,this._map){this.shiftPixel=null;for(var i=this.getPixelOffset(),n=0,o=this.rings.length;o>n;n++){this.rings[n].ring.setPositionOffset(i);for(var r=0,s=this.rings[n].holes.length;s>r;r++)this.rings[n].holes[r].setPositionOffset(i)}}},_getCoords:function(t){for(var e=this.options.type,i="Polygon"===e||"Rectangle"===e||"MultiPolygon"===e,n=t?null:this.shiftPixel,o=[],r=0,s=this.rings.length;s>r;r++){var a=this.rings[r],l=this._latLngsToCoords(a.ring.points.getLatLngs(),i,n);if(i&&(l=[l]),a.holes&&a.holes.length)for(var h=0,u=a.holes.length;u>h;h++)l.push(this._latLngsToCoords(a.holes[h].points.getLatLngs(),i,n));o.push(l)}return("Polyline"===e||i&&"MultiPolygon"!==e)&&(o=o[0]),o},toGeoJSON:function(){return this._toGeoJSON(!0)},_toGeoJSON:function(t){var e,i=this.options.type,n=this.getOptions();if(delete n.mode,!this.options.editable||"Point"===i){var o=this._obj;o instanceof L.GeoJSON&&(o=L.GmxDrawing.utils._getLastObject(o).getLayers()[0]);var r=o.toGeoJSON();return r.properties=n,r}return this.rings&&(e=this._getCoords(t),"Rectangle"===i?i="Polygon":"Polyline"===i?i="LineString":"MultiPolyline"===i&&(i="MultiLineString")),L.GeoJSON.getFeature({feature:{type:"Feature",properties:n}},{type:i,coordinates:e})},getType:function(){return this.options.type},hideFill:function(){this._fill._map&&this._map.removeLayer(this._fill)},showFill:function(){var t=this.toGeoJSON(),e=L.GeoJSON.geometryToLayer(t,null,null,{weight:0});return this._fill.clearLayers(),e instanceof L.LayerGroup?e.eachLayer(function(t){this._fill.addLayer(t)},this):(e.setStyle({weight:0,fill:!0,fillColor:"#0033ff"}),this._fill.addLayer(e)),this._fill._map||(this._map.addLayer(this._fill),this._fill.bringToBack()),this},getBounds:function(){var t=new L.LatLngBounds;if("Point"===this.options.type){var e=this._obj.getLatLng();t.extend(e)}else t=this._getBounds();return t},_getBounds:function(t){var e,i=t||this,n=new L.LatLngBounds;return i instanceof L.LayerGroup?(i.eachLayer(function(t){e=this._getBounds(t),n.extend(e)},this),n):(e=i instanceof L.Marker?i.getLatLng():i.getBounds(),n.extend(e),n)},initialize:function(t,e,i){i=i||{},i.mode="",this._drawOptions=L.extend({},i);var n=i.type;"Point"===n?(delete i.pointStyle,delete i.lineStyle):(delete i.iconUrl,delete i.iconAnchor,delete i.iconSize,delete i.popupAnchor,delete i.shadowSize,delete i.markerStyle),delete i.holeStyle,L.setOptions(this,i),this._layers={},this._obj=e,this._parent=t,this._dx=0,this._dy=0,this._initialize(t,e)},enableEdit:function(){this.options.mode="edit";var t=this.options.type;if("Point"!==t){for(var e=0,i=this.rings.length;i>e;e++){var n=this.rings[e];n.ring.options.editable=this.options.editable,n.ring.setEditMode();for(var o=0,r=n.holes.length;r>o;o++){var s=n.holes[o];s.options.editable=this.options.editable,s.setEditMode()}}var a=L.geoJson(this.toGeoJSON());this.options.editable=!0,this._initialize(this._parent,a)}return this},disableEdit:function(){var t=this.options.type;if("Point"!==t){this._originalStyle=this.options.lineStyle;for(var e=L.geoJson(this.toGeoJSON().geometry,this._originalStyle).getLayers()[0],i=0,n=this.rings.length;n>i;i++){var o=this.rings[i];o.ring.removeEditMode(),o.ring.options.editable=!1;for(var r=0,s=o.holes.length;s>r;r++){var a=o.holes[r];a.removeEditMode(),a.options.editable=!1}}this._obj=e,this.options.editable=!1,this._initialize(this._parent,this._obj)}return this},getArea:function(){var t=0;return L.gmxUtil.geoJSONGetArea&&(t=L.gmxUtil.geoJSONGetArea(this.toGeoJSON())),t},getLength:function(){var t=0;return L.gmxUtil.geoJSONGetLength&&(t=L.gmxUtil.geoJSONGetLength(this.toGeoJSON())),t},getSummary:function(){var t="",e=this._map.options||{},i=this.options.type;if("Polyline"===i||"MultiPolyline"===i)t=L.gmxUtil.prettifyDistance(this.getLength(),e.distanceUnit);else if("Polygon"===i||"MultiPolygon"===i||"Rectangle"===i)t=L.gmxUtil.prettifyArea(this.getArea(),e.squareUnit);else if("Point"===i){var n=this._obj.getLatLng();t=L.gmxUtil.formatCoordinates(n)}return t},_initialize:function(t,e){if(this.clearLayers(),this.rings=[],this.mode="",this._fill=L.featureGroup(),this.options.editable){for(var i=e.getLayers?L.GmxDrawing.utils._getLastObject(e).getLayers():[e],n=0,o=i.length;o>n;n++){var r=i[n],s=[],a=new L.GmxDrawing.Ring(this,r._latlngs,{ring:!0,editable:this.options.editable});if(this.addLayer(a),r._holes)for(var l=0,h=r._holes.length;h>l;l++){var u=new L.GmxDrawing.Ring(this,r._holes[l],{hole:!0,editable:this.options.editable});
this.addLayer(u),s.push(u)}this.rings.push({ring:a,holes:s})}if(L.gmxUtil&&L.gmxUtil.prettifyDistance&&!this._showTooltip){var c=function(t){var e=L.gmxLocale?L.gmxLocale.getText(t):null;return e||t},d=this;this._showTooltip=function(t,e){var i=e.ring,n=e.originalEvent,o=n.buttons||n.button;if(i&&(i.downObject||!o)){var r=d._map.options||{},s=r.distanceUnit,a=r.squareUnit,l="";if("Area"===t){if(!L.gmxUtil.getArea)return;l=e.originalEvent.ctrlKey?c("Perimeter")+": "+L.gmxUtil.prettifyDistance(d.getLength(),s):c(t)+": "+L.gmxUtil.prettifyArea(d.getArea(),a),d._parent.showTooltip(e.layerPoint,l)}else if("Length"===t){var h=L.GmxDrawing.utils.getDownType.call(d,e,d._map,d),u=i.getLength(h),p=("edit"===h.mode||h.num>1?h.type:"")+t,m=c(p);l=(m===p?c(t):m)+": "+L.gmxUtil.prettifyDistance(u,s),d._parent.showTooltip(e.layerPoint,l)}d._fireEvent("onMouseOver")}},this.hideTooltip=function(){this._parent.hideTooltip(),this._fireEvent("onMouseOut")}}}else"Point"===this.options.type?this._setMarker(e):this.addLayer(e)},_enableDrag:function(){this._parent._enableDrag()},_disableDrag:function(){this._parent._disableDrag()},_setMarker:function(t){var e=this,i=this._parent;t.bindPopup(null,{maxWidth:1e3,closeOnClick:i._map.options.maxPopupCount>1?!1:!0}).on("dblclick",function(){this._map.removeLayer(this),e.remove()}).on("dragstart",function(){e._fireEvent("dragstart")}).on("drag",function(){e._fireEvent("drag"),e._fireEvent("edit")}).on("dragend",function(){e._fireEvent("dragend")}).on("popupopen",function(i){var n=i.popup;n._input||(n._input=L.DomUtil.create("textarea","leaflet-gmx-popup-textarea",n._contentNode),n._input.value=e.options.title||t.options.title||"",n._contentNode.style.width="auto"),L.DomEvent.on(n._input,"keyup",function(){var i=this.value.split("\n"),o=this.cols||0;i.forEach(function(t){t.length>o&&(o=t.length)}),this.rows=i.length,o&&(this.cols=o),n.update(),e.options.title=t.options.title=this.value,this.focus()},n._input),n.update()}),i._map.addLayer(t),e.openPopup=t.openPopup=function(){if(t._popup&&t._map&&!t._map.hasLayer(t._popup)){t._popup.setLatLng(t._latlng);var e=t._map.gmxDrawing;e._drawMode?t._map.fire(e._createType?"click":"mouseup",{latlng:t._latlng,delta:1}):(t._popup.addTo(t._map),t._popup._isOpen=!0)}return t}},setAddMode:function(){return this.rings.length&&this.rings[0].ring.setAddMode(),this},_pointDown:function(t){this.rings.length&&this.rings[0].ring._pointDown(t)},getPopup:function(){return"Point"===this.options.type?this._obj.getPopup():void 0}}),L.GmxDrawing.Ring=L.LayerGroup.extend({options:{className:"leaflet-drawing-ring",opacity:1,shape:"circle",fill:!0,fillColor:"#ffffff",fillOpacity:1,size:L.Browser.mobile?40:8,weight:2},includes:L.Mixin.Events,initialize:function(t,e,i){i=i||{},i.mode="",this._activeZIndex=i.activeZIndex||7,this._notActiveZIndex=i.notActiveZIndex||6,this.options=L.extend({},t.getStyle(),i),this._layers={},this._coords=e,this._legLength=[],this._parent=t,this._initialize(t,e)},_initialize:function(t,e){this.clearLayers(),delete this.lines,delete this.fill,delete this.points,this.downObject=!1,this.mode="",this.lineType=-1!==this.options.type.indexOf("Polyline");var i=this.options.pointStyle,n={opacity:1,weight:2,noClip:!0,clickable:!1,className:"leaflet-drawing-lines"};if(this.lineType||(n.fill="fill"in this.options?this.options.fill:!0),this.options.lineStyle)for(var o in this.options.lineStyle)"fill"===o&&this.lineType||(n[o]=this.options.lineStyle[o]);this.options.hole&&(n=L.extend({},n,L.GmxDrawing.utils.defaultStyles.holeStyle),i=L.extend({},i,L.GmxDrawing.utils.defaultStyles.holeStyle));var r=e,s=this,a=this.options.mode||(r.length?"edit":"add");this.lines=new L.Polyline(r,n),this.addLayer(this.lines),this.fill=new L.Polyline(r,{className:"leaflet-drawing-lines-fill",opacity:0,fill:!1,size:10,weight:10}),this.addLayer(this.fill),this.lineType||"edit"!==a||(this.lines.addLatLng(r[0]),this.fill.addLatLng(r[0])),this.mode=a,this.points=new L.GmxDrawing.PointMarkers(r,i),this.points._parent=this,this.addLayer(this.points),this.points.on("mouseover mousemove",function(t){t.ring=s,"_showTooltip"in this&&this._showTooltip(s.lineType?"Length":"Area",t)},t).on("mouseout",function(){"hideTooltip"in this&&this.hideTooltip()},t),this.fill.on("mouseover mousemove",function(t){t.ring=s,"_showTooltip"in this&&this._showTooltip("Length",t)},t).on("mouseout",function(){"hideTooltip"in this&&this.hideTooltip()},t)},onAdd:function(t){L.LayerGroup.prototype.onAdd.call(this,t),this.setEditMode()},onRemove:function(t){this.points&&(this._pointUp(),this.removeAddMode(),this.removeEditMode(),"hideTooltip"in this._parent&&this._parent.hideTooltip()),L.LayerGroup.prototype.onRemove.call(this,t),"Point"===this.options.type&&t.removeLayer(this._obj),this._fireEvent("removefrommap")},getLength:function(t){var e=0,i=this.points._latlngs,n=i.length;if(n){var o=1,r=i[0];t&&("node"===t.type?n=t.num+1:(o=t.num,o===n?(r=i[o-1],o=0):r=i[o-1],n=o+1));for(var s=o;n>s;s++){var a=this._legLength[s]||null;null===a&&(a=L.gmxUtil.distVincenty(r.lng,r.lat,i[s].lng,i[s].lat),this._legLength[s]=a),r=i[s],e+=a}}return e},_setPoint:function(t,e,i){if(this.points){var n=this.points._latlngs;"Rectangle"===this.options.type?("edge"===i?(e--,0===e?n[0].lng=n[1].lng=t.lng:1===e?n[1].lat=n[2].lat=t.lat:2===e?n[2].lng=n[3].lng=t.lng:3===e&&(n[0].lat=n[3].lat=t.lat)):(n[e]=t,0===e?(n[3].lat=t.lat,n[1].lng=t.lng):1===e?(n[2].lat=t.lat,n[0].lng=t.lng):2===e?(n[1].lat=t.lat,n[3].lng=t.lng):3===e&&(n[0].lat=t.lat,n[2].lng=t.lng)),this._legLength=[]):(n[e]=t,this._legLength[e]=null,this._legLength[e+1]=null),this.setLatLngs(n)}},addLatLng:function(t,e){if(this._legLength=[],this.points){var i=this.points._latlngs,n=i.length,o=i[n-2];o&&o.equals(t)||(e&&(n-=e),this._setPoint(t,n,"node"))}else"addLatLng"in this._obj&&this._obj.addLatLng(t)},setPositionOffset:function(t){L.DomUtil.setPosition(this.points._container,t),L.DomUtil.setPosition(this.fill._container,t),L.DomUtil.setPosition(this.lines._container,t)},setLatLngs:function(t){if(this.points){var e=this.points;this.fill.setLatLngs(t),this.lines.setLatLngs(t),!this.lineType&&"edit"===this.mode&&t.length>2&&(this.lines.addLatLng(t[0]),this.fill.addLatLng(t[0])),e.setLatLngs(t)}else"setLatLngs"in this._obj&&this._obj.setLatLngs(t);this._fireEvent("edit")},_pointDown:function(t){if((L.Browser.ie||L.gmxUtil&&L.gmxUtil.gtIE11)&&this._map.dragging._draggable._onUp(),this._parent._disableDrag(),t.originalEvent){var e=t.originalEvent;if(e.ctrlKey)return this._onDragStart(t),void 0;if(1!==e.which&&1!==e.button)return}var i=L.GmxDrawing.utils.getDownType.call(this,t,this._map,this._parent),n=i.type,o=this.options;if(this._lastDownTime=Date.now()+100,this.down=i,"edge"===n&&"Rectangle"!==o.type){if(o.disableAddPoints)return;this._legLength=[];var r=i.num,s=this.points._latlngs;s.splice(r,0,s[r]),this._setPoint(t.latlng,r,n)}this.downObject=!0,this._map.on("mousemove",this._pointMove,this).on("mouseup",this._pointUp,this)},_pointMove:function(t){this.down&&this._lastDownTime<Date.now()&&(this.lineType||this._parent.showFill(),this._clearLineAddPoint(),this._moved=!0,this._setPoint(t.latlng,this.down.num,this.down.type),"_showTooltip"in this._parent&&this._parent._showTooltip(this.lineType?"Length":"Area",t))},_pointUp:function(t){if(this.downObject=!1,this._parent._enableDrag(),this.points){if(this._map){this._map.off("mousemove",this._pointMove,this).off("mouseup",this._pointUp,this);var e=t&&t.originalEvent?t.originalEvent.target:null;if(e&&e._leaflet_pos&&/leaflet-marker-icon/.test(e.className)){var i=L.GmxDrawing.utils.getMarkerByPos(e._leaflet_pos,this._map.gmxDrawing.getFeatures());this._setPoint(i,this.down.num,this.down.type)}this._map._skipClick=!0}this._drawstop&&this._fireEvent("drawstop"),this._drawstop=!1,this.down=null;var n=this.options.lineStyle||{};n.fill||this.lineType||this._parent.hideFill()}},_lastPointClickTime:0,_removePoint:function(t){var e=this.points._latlngs;e.length>t&&(this._legLength=[],e.splice(t,1),"Rectangle"===this.options.type||e.length<2||e.length<3&&!this.lineType?this._parent.remove(this):this._setPoint(e[0],0))},_clearLineAddPoint:function(){this._lineAddPointID&&clearTimeout(this._lineAddPointID),this._lineAddPointID=null},_pointDblClick:function(t){if(this._clearLineAddPoint(),!this._lastAddTime||Date.now()>this._lastAddTime){var e=L.GmxDrawing.utils.getDownType.call(this,t,this._map,this._parent);this._removePoint(e.num)}},_pointClick:function(t){if(!t.originalEvent||!t.originalEvent.ctrlKey){var e=Date.now(),i=this._lastPointClickTime;if(this._lastPointClickTime=e+300,this._moved||i>e)return this._moved=!1,void 0;var n=L.GmxDrawing.utils.getDownType.call(this,t,this._map,this._parent),o=this.mode;if("node"===n.type){var r=n.num;if(n.end){if("add"===o)this._pointUp(),this.setEditMode(),this.lineType&&0===r&&(this._parent.options.type=this.options.type="Polygon",this.lineType=!1,this._removePoint(this.points._latlngs.length-1)),this._fireEvent("drawstop"),this._removePoint(r);else if(this.lineType){var s=this,a=function(){s._clearLineAddPoint(),0===r&&s.points._latlngs.reverse(),s.points.addLatLng(n.latlng),s.setAddMode(),s._fireEvent("drawstop")};this._lineAddPointID=setTimeout(a,250)}}else"add"===o&&this.addLatLng(t.latlng)}}},_onDragEnd:function(){this._map.off("mouseup",this._onDragEnd,this).off("mousemove",this._onDrag,this),this._parent._enableDrag(),this._fireEvent("dragend")},_onDragStart:function(t){this._dragstartPoint=t.latlng,this._map.on("mouseup",this._onDragEnd,this).on("mousemove",this._onDrag,this),this._fireEvent("dragstart")},_onDrag:function(t){var e=this._dragstartPoint.lat-t.latlng.lat,i=this._dragstartPoint.lng-t.latlng.lng,n=this.points._latlngs;n.forEach(function(t){t.lat-=e,t.lng-=i}),this._dragstartPoint=t.latlng,this._legLength=[],this.setLatLngs(n),this._fireEvent("drag")},_fireEvent:function(t){this._parent._fireEvent(t)},_startTouchMove:function(t,e){var i=L.GmxDrawing.utils.getDownType.call(this,t,this._map,this._parent);if("node"===i.type){this._parent._disableDrag(),this.down=i;var n=this,o=function(t){i=L.GmxDrawing.utils.getDownType.call(n,t,n._map,this._parent),1===t.touches.length&&n._pointMove(i)},r=function(){L.DomEvent.off(n._map._container,"touchmove",o,n).off(n._map._container,"touchend",r,n),n._parent._enableDrag(),e&&n._parent.fire("drawstop",{mode:n.options.type,object:n})};L.DomEvent.on(n._map._container,"touchmove",o,n).on(n._map._container,"touchend",r,n)}},_editHandlers:function(t){var e=L.DomEvent.stopPropagation;if(this.touchstart&&L.DomEvent.off(this.points._container,"touchstart",this.touchstart,this),this.touchstartFill&&L.DomEvent.off(this.fill._container,"touchstart",this.touchstartFill,this),this.touchstart=null,this.touchstartFill=null,t)if(this.points.on("dblclick click",e,this).on("dblclick",this._pointDblClick,this).on("click",this._pointClick,this),L.Browser.mobile){this._EditOpacity&&this._parent._setPointsStyle({fillOpacity:this._EditOpacity});var i=this;this.touchstart=function(t){i._startTouchMove(t)},L.DomEvent.on(this.points._container,"touchstart",this.touchstart,this),this.touchstartFill=function(t){var e=L.GmxDrawing.utils.getDownType.call(i,t,i._map,this._parent);if("edge"===e.type&&"Rectangle"!==i.options.type){var n=i.points._latlngs;n.splice(e.num,0,n[e.num]),i._legLength=[],i._setPoint(e.latlng,e.num,e.type)}},L.DomEvent.on(this.fill._container,"touchstart",this.touchstartFill,this)}else this.points.on("mousemove",e).on("mousedown",this._pointDown,this),this.fill.on("dblclick click",e,this).on("mousedown",this._pointDown,this),this._fireEvent("editmode");else this._pointUp(),this.points.off("dblclick click",e,this).off("dblclick",this._pointDblClick,this).off("click",this._pointClick,this),L.Browser.mobile||(this.points.off("mousemove",e).off("mousedown",this._pointDown,this),this.fill.off("dblclick click",e,this).off("mousedown",this._pointDown,this))},_createHandlers:function(t){if(this.points){var e=L.DomEvent.stopPropagation;if(t)this._parent._enableDrag(),this._map.on("dblclick",e).on("mousedown",this._mouseDown,this).on("mouseup",this._mouseUp,this).on("mousemove",this._moseMove,this),this.points.on("click",this._pointClick,this),this._fireEvent("addmode"),this.lineType||this.lines.setStyle({fill:!0});else{this._map&&(this._map.off("dblclick",e).off("mouseup",this._mouseUp,this).off("mousemove",this._moseMove,this),this.points.off("click",this._pointClick,this));var i=this.options.lineStyle||{};this.lineType||i.fill||this.lines.setStyle({fill:!1})}}},setEditMode:function(){return this.options.editable&&(this._editHandlers(!1),this._createHandlers(!1),this._editHandlers(!0),this.mode="edit"),this},setAddMode:function(){return this.options.editable&&(this._editHandlers(!1),this._createHandlers(!1),this._createHandlers(!0),this.mode="add"),this},removeAddMode:function(){this._createHandlers(!1),this.mode=""},removeEditMode:function(){this._editHandlers(!1),this.mode=""},_moseMove:function(t){if(this.points){var e=this.points._latlngs;1===e.length&&this._setPoint(t.latlng,1),this._setPoint(t.latlng,e.length-1)}},_mouseDown:function(){this._lastMouseDownTime=Date.now()+200},_mouseUp:function(t){var e=Date.now();if(t.delta||e<this._lastMouseDownTime){this._lastAddTime=e+1e3;var i=t._latlng||t.latlng;t.delta&&this.addLatLng(i,t.delta),this.addLatLng(i),this._parent._parent._clearCreate()}}}),L.GmxDrawing.PointMarkers=L.Polygon.extend({options:{className:"leaflet-drawing-points",smoothFactor:0,opacity:1,shape:"circle",fill:!0,fillColor:"#ffffff",fillOpacity:1,size:L.Browser.mobile?40:8,weight:2},getPathLatLngs:function(){for(var t,e,i=[],n=this.options.size,o=this._parts[0],r=0,s=o.length;s>r;r++)e=o[r],(0===r||Math.abs(t.x-e.x)>n||Math.abs(t.y-e.y)>n)&&(i.push(this._latlngs[r]),t=e);return i},_getPathPartStr:function(t){for(var e,i,n=L.Path.VML,o=this.options.size/2,r="add"!==this._parent.mode||L.Browser.mobile?0:1,s="circle"===this.options.shape?!0:!1,a=0,l=t.length-r,h="";l>a;a++)if(i=t[a],n&&i._round(),0===a||Math.abs(e.x-i.x)>this.options.size||Math.abs(e.y-i.y)>this.options.size){if(s)h+="M"+i.x+","+(i.y-o)+" A"+o+","+o+",0,1,1,"+(i.x-.1)+","+(i.y-o)+" ";else{var u=i.x,c=u-o,d=u+o,p=i.y,m=p-o,f=p+o;h+="M"+c+" "+m+"L"+d+" "+m+"L"+d+" "+f+"L"+c+" "+f+"L"+c+" "+m}e=i}return h},_onMouseClick:function(t){this._fireMouseEvent(t)},_isPathChange:function(){this.projectLatlngs();var t=this.getPathString();return t!==this._pathStr?(this._pathStr=t,!0):!1},_updatePath:function(){this._map&&(this._clipPoints(),this._isPathChange()&&("inherit"!==this._path.getAttribute("fill-rule")&&this._path.setAttribute("fill-rule","inherit"),this._path.setAttribute("d",this._pathStr||"M0 0")))}}),L.GmxDrawing.utils={defaultStyles:{mode:"",map:!0,editable:!0,holeStyle:{opacity:.5,color:"#003311"},lineStyle:{opacity:1,weight:2,noClip:!0,clickable:!1,className:"leaflet-drawing-lines",color:"#0033ff",dashArray:null,lineCap:null,lineJoin:null,fill:!1,fillColor:null,fillOpacity:.2,smoothFactor:1,stroke:!0},pointStyle:{className:"leaflet-drawing-points",noClip:!0,smoothFactor:0,opacity:1,shape:"circle",fill:!0,fillColor:"#ffffff",fillOpacity:1,size:L.Browser.mobile?40:8,weight:2,clickable:!0,color:"#0033ff",dashArray:null,lineCap:null,lineJoin:null,stroke:!0},markerStyle:{mode:"",editable:!1,title:"Text example",options:{alt:"",clickable:!0,draggable:!1,keyboard:!0,opacity:1,zIndexOffset:0,riseOffset:250,riseOnHover:!1,icon:{className:"",iconUrl:"",iconAnchor:[12,41],iconSize:[25,41],popupAnchor:[1,-34],shadowSize:[41,41]}}}},getNotDefaults:function(t,e){var i={};for(var n in t)if("icon"!==n&&"map"!==n)if("iconAnchor"===n||"iconSize"===n||"popupAnchor"===n||"shadowSize"===n){if(!e[n])continue;(e[n][0]!==t[n][0]||e[n][1]!==t[n][1])&&(i[n]=t[n])}else"lineStyle"===n||"pointStyle"===n||"markerStyle"===n?i[n]=this.getNotDefaults(t[n],e[n]):e&&e[n]===t[n]&&"fill"!==n||(i[n]=t[n]);return i},getShiftLatlng:function(t,e,i){if(i&&e){var n=e.latLngToLayerPoint(t)._add(i);t=e.layerPointToLatLng(n)}return t},getDownType:function(t,e,i){var n=t.layerPoint,o=!1,r=t.latlng;if(t.originalEvent&&t.originalEvent.ctrlKey&&(o=!0),t.touches&&1===t.touches.length){var s=t.touches[0],a=e.mouseEventToContainerPoint(s);n=e.containerPointToLayerPoint(a),r=e.layerPointToLatLng(n)}var l={type:"",latlng:r,ctrlKey:o},h=this.points?this:t.ring,u=h.points._originalPoints||[],c=u.length;if(0===c)return l;var d=(h.points.options.size||10)/2;d+=1+(h.points.options.weight||2);var p=new L.Bounds(L.point(n.x-d,n.y-d),L.point(n.x+d,n.y+d)),m=u[c-1],f=c-("add"===h.mode?2:1);l={mode:h.mode,layerPoint:t.layerPoint,ctrlKey:o,latlng:r};for(var g=0;c>g;g++){var _=u[g];if(i.shiftPixel&&(_=u[g].add(i.shiftPixel)),p.contains(_)){l.type="node",l.num=g,l.end=0===g||g===f?!0:!1;break}var v=L.LineUtil.pointToSegmentDistance(n,m,_);d>v&&(l.type="edge",l.num=0===g?c:g),m=_}return l},_getLastObject:function(t){if(t.getLayers){var e=t.getLayers().shift();return e.getLayers?this._getLastObject(e):t}return t},getMarkerByPos:function(t,e){for(var i=0,n=e.length;n>i;i++){var o=e[i],r=o._obj?o._obj:null,s=r&&r._icon?r._icon._leaflet_pos:null;if(s&&s.x===t.x&&s.y===t.y)return r._latlng}return null}},function(){var t=[.001,.002,.0025,.005,.01,.02,.025,.05,.1,.2,.25,.5,1,2,2.5,5,10,20,30,60,120,180],e=t.length,i=function(t){return t%=360,t>180?t-=360:-180>t&&(t+=360),Math.round(1e3*t)/1e3};L.GmxGrid=L.Polyline.extend({options:{color:"black",noClip:!0,defaultStep:{x:void 0,y:void 0},customStep:{x:void 0,y:void 0},units:"degrees",clickable:!1},initialize:function(t){L.Polyline.prototype.initialize.call(this,[],t)},setColor:function(t){this.options.color=t,this.repaint()},setStep:function(t,e){if(!(!t||isNaN(t)||0>=t)){if(1===arguments.length)this.options.customStep.y=this.options.customStep.x=Number(t);else{if(!e||isNaN(e)||0>=e)return;this.options.customStep.x=Number(t),this.options.customStep.y=Number(e)}this.repaint()}},clearStep:function(){this.options.customStep.x=this.options.customStep.y=void 0,this.options.units="degrees",this.repaint()},setUnits:function(t){if(t!==this.options.units){var e=this._map.getCenter().lat*Math.PI/180,i=this.options.customStep.x?this.options.customStep.x:this.options.defaultStep.x,n=this.options.customStep.y?this.options.customStep.y:this.options.defaultStep.y;switch(t){case"kilometers":this.options.customStep.x=111.31949*i*Math.cos(e),this.options.customStep.y=111.31949*n;break;case"degrees":this.options.customStep.x=i/111.31949/Math.cos(e),this.options.customStep.y=n/111.31949;break;default:return}this.options.units=t}},onAdd:function(t){L.Polyline.prototype.onAdd.call(this,t),t.on("moveend",this.repaint,this),this.repaint()},onRemove:function(t){t.off("moveend",this.repaint,this),L.Polyline.prototype.onRemove.call(this,t)},repaint:function(){if(!this._map)return!1;var n,o,r,s,a=this._map,l=this.options.customStep.x,h=this.options.customStep.y,u=a._size.x/80,c=a._size.y/80,d=a.getBounds(),p=d.getNorthWest(),m=d.getSouthEast(),f=p.lng,g=m.lng,_=m.lat,v=p.lat,y=g-f,x=v-_,b=0,P=0,S=this.options.units,T=a.getCenter().lat*Math.PI/180;for(n=0;e>n;n++){var w=t[n];if(0===b&&u>y/w&&(b=w),0===P&&c>x/w&&(P=w),b>0&&P>0)break}l||h?"kilometers"===S?(r=l/111.31949/Math.cos(T),s=h/111.31949):(r=l,s=h):(this.options.defaultStep.x=r=b,this.options.defaultStep.y=s=P);var C=[],M=[];for(n=Math.floor(f/r),o=Math.ceil(g/r);o>n;n++)l=n*r,C.push(new L.LatLng(v,l),new L.LatLng(_,l)),b>r||P>s?0===n%Math.ceil(b/r)?M.push(i(l)+"",""):M.push("",""):M.push(i(l)+"","");for(n=Math.floor(_/s),o=Math.ceil(v/s);o>n;n++)h=n*s,C.push(new L.LatLng(h,f),new L.LatLng(h,g)),b>r||P>s?0===n%Math.ceil(P/s)?M.push(i(h)+"",""):M.push("",""):M.push(i(h)+"","");return this.setStyle({stroke:!0,weight:1,color:this.options.color}),this.options.textMarkers=M,this.setLatLngs(C),!1},_getPathPartStr:function(t){this._containerText&&this._container.removeChild(this._containerText),this._containerText=this._createElement("g"),this._containerText.setAttribute("stroke-width",0);var e=this._path.getAttribute("stroke");this._containerText.setAttribute("stroke",e),this._containerText.setAttribute("fill",e),this._containerText.setAttribute("opacity",1),this._container.appendChild(this._containerText);for(var i,n,o=L.Path.VML,r=this.options,s=0,a=t.length,l="";a>s;s+=2)if(i=t[s],n=t[s+1],o&&(i._round(),n._round()),l+="M"+i.x+" "+i.y,l+="L"+n.x+" "+n.y,r.textMarkers&&r.textMarkers[s]){var h=this._createElement("text"),u=0,c=3;i.y===n.y&&(u=20),i.x===n.x&&(h.setAttribute("text-anchor","middle"),c=20),h.setAttribute("x",i.x+u),h.setAttribute("y",i.y+c),h.textContent=r.textMarkers[s],this._containerText.appendChild(h)}return l},_updatePath:function(){this._map&&(this._clipPoints(),L.Path.prototype._updatePath.call(this))}}),L.gmxGrid=function(t){return new L.GmxGrid(t)}}(),L.ImageTransform=L.ImageOverlay.extend({initialize:function(t,e,i){L.ImageOverlay.prototype.initialize.call(this,t,e,i),this.setAnchors(e)},setAnchors:function(t){this._anchors=[],this._bounds=L.latLngBounds(t);for(var e=0,i=t.length;i>e;e++){var n=t[e];this._anchors.push(L.latLng(n))}this._map&&this._reset()},_latLngToLayerPoint:function(t){return this._map.project(t)._subtract(this._map.getPixelOrigin())},setClip:function(t){var e=this._latLngToLayerPoint(this._bounds.getNorthWest()),i=[];this.options.clip=t;for(var n=0;n<t.length;n++){var o=this._latLngToLayerPoint(t[n]),r=L.ImageTransform.Utils.project(this._matrix3dInverse,o.x-e.x,o.y-e.y);i.push(L.point(r[0],r[1]))}this.setClipPixels(i)},setClipPixels:function(t){this._clipDone=!1,this._pixelClipPoints=t,this._drawCanvas()},setUrl:function(t){this._url=t,this._imgNode.src=this._url},getClip:function(){return this.options.clip},_imgLoaded:!1,_initImage:function(){this._image=L.DomUtil.create("div","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._imgNode=L.DomUtil.create("img"),this.options.clip?(this._canvas=L.DomUtil.create("canvas","leaflet-canvas-transform"),this._image.appendChild(this._canvas),this._canvas.style[L.DomUtil.TRANSFORM_ORIGIN]="0 0",this._clipDone=!1):(this._image.appendChild(this._imgNode),this._imgNode.style[L.DomUtil.TRANSFORM_ORIGIN]="0 0",this._imgNode.style.display="none"),this._updateOpacity(),this._imgLoaded=!1,L.extend(this._imgNode,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.bind(this._onImageLoad,this),onerror:L.bind(this._onImageError,this),src:this._url})},_onImageError:function(){this.fire("error")},_onImageLoad:function(){this.options.clip?(this._canvas.width=this._imgNode.width,this._canvas.height=this._imgNode.height):this._imgNode.style.display="inherit",this._imgLoaded=!0,this._reset(),this.fire("load")},_reset:function(){if(!this.options.clip||this._imgLoaded){var t,e,i,n=this._image,o=this.options.clip?this._canvas:this._imgNode,r=this._latLngToLayerPoint(this._bounds.getNorthWest()),s=this._latLngToLayerPoint(this._bounds.getSouthEast())._subtract(r),a=this._anchors,l=o.width,h=o.height,u=[];for(t=0,e=a.length;e>t;t++)i=this._latLngToLayerPoint(a[t]),u.push(L.point(i.x-r.x,i.y-r.y));L.DomUtil.setPosition(n,r),n.style.width=s.x+"px",n.style.height=s.y+"px";var c=this._matrix3d=L.ImageTransform.Utils.general2DProjection(0,0,u[0].x,u[0].y,l,0,u[1].x,u[1].y,l,h,u[2].x,u[2].y,0,h,u[3].x,u[3].y);if(c[8]){for(t=0;9!==t;++t)c[t]=c[t]/c[8];if(this._matrix3dInverse=L.ImageTransform.Utils.adj(c),o.style[L.DomUtil.TRANSFORM]=this._getMatrix3dCSS(this._matrix3d),this.options.clip)if(this._pixelClipPoints){for(this.options.clip=[],i=0;i<this._pixelClipPoints.length;i++){var d=L.ImageTransform.Utils.project(c,this._pixelClipPoints[i].x,this._pixelClipPoints[i].y);this.options.clip.push(this._map.layerPointToLatLng(L.point(d[0]+r.x,d[1]+r.y)))}this._drawCanvas()}else this.setClip(this.options.clip)}}},_getMatrix3dCSS:function(t){var e="matrix3d(";return e+=t[0].toFixed(9)+","+t[3].toFixed(9)+", 0,"+t[6].toFixed(9),e+=","+t[1].toFixed(9)+","+t[4].toFixed(9)+", 0,"+t[7].toFixed(9),e+=",0, 0, 1, 0",e+=","+t[2].toFixed(9)+","+t[5].toFixed(9)+", 0, "+t[8].toFixed(9)+")"},_clipDone:!1,_drawCanvas:function(){if(!this._clipDone&&this._imgNode){var t=this._canvas,e=t.getContext("2d");e.clearRect(0,0,t.width,t.height),e.fillStyle=e.createPattern(this._imgNode,"no-repeat"),e.beginPath();for(var i=0,n=this._pixelClipPoints.length;n>i;i++){var o=this._pixelClipPoints[i];e[i?"lineTo":"moveTo"](o.x,o.y)}e.closePath(),e.fill(),e.fillStyle=null,this.options.disableSetClip&&(this._imgNode=null),this._clipDone=!0}}}),L.imageTransform=function(t,e,i){return new L.ImageTransform(t,e,i)},L.DomUtil.TRANSFORM_ORIGIN=L.DomUtil.testProp(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),function(){function t(t){return[t[4]*t[8]-t[5]*t[7],t[2]*t[7]-t[1]*t[8],t[1]*t[5]-t[2]*t[4],t[5]*t[6]-t[3]*t[8],t[0]*t[8]-t[2]*t[6],t[2]*t[3]-t[0]*t[5],t[3]*t[7]-t[4]*t[6],t[1]*t[6]-t[0]*t[7],t[0]*t[4]-t[1]*t[3]]}function e(t,e){for(var i=Array(9),n=0;3!==n;++n)for(var o=0;3!==o;++o){for(var r=0,s=0;3!==s;++s)r+=t[3*n+s]*e[3*s+o];i[3*n+o]=r}return i}function i(t,e){return[t[0]*e[0]+t[1]*e[1]+t[2]*e[2],t[3]*e[0]+t[4]*e[1]+t[5]*e[2],t[6]*e[0]+t[7]*e[1]+t[8]*e[2]]}function n(n,o,r,s,a,l,h,u){var c=[n,r,a,o,s,l,1,1,1],d=i(t(c),[h,u,1]);return e(c,[d[0],0,0,0,d[1],0,0,0,d[2]])}L.ImageTransform.Utils={general2DProjection:function(i,o,r,s,a,l,h,u,c,d,p,m,f,g,_,v){var y=n(i,o,a,l,c,d,f,g),x=n(r,s,h,u,p,m,_,v);return e(x,t(y))},project:function(t,e,n){var o=i(t,[e,n,1]);return[o[0]/o[2],o[1]/o[2]]},adj:t}}(),function(t){var e;if("undefined"!=typeof module&&module.exports){var i=require("leaflet");e=t(i,require("leaflet-geomixer"));var n=e(i.TileLayer),o=function(t,e){return new n(t,e)};o.Constructor=n,module.exports=o}else e=t(window.L,window.L.gmx),window.L.TileLayer.Mercator=e(window.L.TileLayer),window.L.TileLayer.Canvas.Mercator=e(window.L.TileLayer.Canvas),window.L.tileLayer.Mercator=function(t,e){return new window.L.TileLayer.Mercator(t,e)}}(function(t){return function(e){return e.extend({options:{tilesCRS:t.CRS.EPSG3395},_update:function(){if(this._map){var e=this._map,i=e.getZoom();if(!(i>this.options.maxZoom||i<this.options.minZoom)){var n=e.getPixelBounds();this._shiftY=this._getShiftY(),n.min.y+=this._shiftY,n.max.y+=this._shiftY;var o=this._getTileSize(),r=t.bounds(n.min._divideBy(o)._floor(),n.max._divideBy(o)._floor());this._addTilesFromCenterOut(r),(this.options.unloadInvisibleTiles||this.options.reuseTiles)&&this._removeOtherTiles(r)}}},_addTile:function(t,e){var i=this._getTilePos(t),n=this._getTile();n._pos={x:i.x,y:i.y},this._setShiftPosition(n),n._tilePoint=t,this._tiles[t.x+":"+t.y]=n,this._loadTile(n,t),n.parentNode!==this._tileContainer&&e.appendChild(n)},_getShiftY:function(){var e=this._map,i=t.CRS.scale(e.getZoom()),n=e.getCenter(),o=e.options.crs.project(n).y-this.options.tilesCRS.project(n).y;return Math.floor(i*o/40075016.685578495)},_setShiftPosition:function(e){var i={x:e._pos.x,y:e._pos.y-this._shiftY};t.DomUtil.setPosition(e,i,t.Browser.chrome)},_updateShiftY:function(){this._shiftY=this._getShiftY();for(var t in this._tiles)this._setShiftPosition(this._tiles[t])},onAdd:function(i){e.prototype.onAdd.call(this,i),i.on("moveend",this._updateShiftY,this),this.options.clickable===!1&&(this._container.style.pointerEvents="none"),t.gmxUtil&&this.on("tileloadstart",function(e){e.tile._statusUrl=e.url,t.gmxUtil.loaderStatus(e.url)},this).on("tileload tileunload",function(e){t.gmxUtil.loaderStatus(e.tile._statusUrl,!0)},this)},onRemove:function(t){t.off("moveend",this._updateShiftY,this),e.prototype.onRemove.call(this,t)}})}}),function(t){"undefined"!=typeof module&&module.exports?module.exports=t(require("leaflet"),require("./initBaseLayerManager")):(window.gmxBaseLayersManager=t(window.L,void 0),window.L.gmxBaseLayersManager=window.gmxBaseLayersManager,window.L.Map.addInitHook(function(){this.gmxBaseLayersManager||(this.gmxBaseLayersManager=new window.L.gmxBaseLayersManager(this))}))}(function(t,e){return t.Class.extend({includes:t.Mixin.Events,options:{stateVersion:"1.0.0"},initialize:function(e){this._map=e,this._baseLayers={},this._aliases={},this._currentID=null,this._activeIDs=[],this._zIndexOffset=-1e6;var i=this;this._baseLayer=t.LayerGroup.extend({getLayerId:function(e){return"_"+t.stamp(e)},setOptions:function(e,n){n&&(this.options={}),t.setOptions(this,e),i.fire("baselayeroptionschange",{baseLayer:this})},addLayer:function(e){t.LayerGroup.prototype.addLayer.call(this,e);var n=e.options;return n&&!n._zIndexOffset&&e.setZIndex&&(n._zIndexOffset=i._zIndexOffset,e.setZIndex(n._zIndexOffset+(n.zIndex||0))),i.fire("baselayerlayerschange",{baseLayer:this}),!0},removeLayer:function(e){t.LayerGroup.prototype.removeLayer.call(this,e);var n=e.options;n&&n._zIndexOffset&&e.setZIndex&&(e.setZIndex(e.options.zIndex-n._zIndexOffset),n._zIndexOffset=0),i.fire("baselayerlayerschange",{baseLayer:this})}})},add:function(t,e){if(!t||this._baseLayers[t])return null;e=e||{};var i=new this._baseLayer(e.layers||[]);return delete e.layers,i.id=t||"default",i.options=e,this._baseLayers[t]=i,this._aliases[t]=t,e.rus&&(this._aliases[e.rus]=t),e.eng&&(this._aliases[e.eng]=t),this.fire("baselayeradd",{baseLayer:i}),this._currentID===t&&this._map.addLayer(i),i},remove:function(t){var e=this._baseLayers[t]||null;return t===this._currentID&&(this._currentID=null),e&&(this._map.removeLayer(e),delete this._baseLayers[t],delete this._aliases[t],e.options.rus&&delete this._aliases[e.options.rus],e.options.eng&&delete this._aliases[e.options.eng],this.fire("baselayerremove",{baseLayer:e})),e},get:function(t){return this._baseLayers[t]||null},getAll:function(){var t=[];for(var e in this._baseLayers)t.push(this._baseLayers[e]);return t},getActiveIDs:function(){return this._activeIDs},setActiveIDs:function(t){this._activeIDs=t||[],this.fire("baselayeractiveids",{activeIDs:this._activeIDs});var e=this._baseLayers[this._currentID];return e&&(this.isActiveID(this._currentID)?this._map.hasLayer(e)||this._map.addLayer(e):this._map.hasLayer(e)&&this._map.removeLayer(e)),this},addActiveID:function(t,e){if(!t)return null;for(var i=this._activeIDs.length,n=0;i>n;n++)if(t===this._activeIDs[n]){this._activeIDs.splice(n,1);break}return i=this._activeIDs.length,void 0===e||e>i-1?(e=i,this._activeIDs.push(t)):this._activeIDs.splice(e,0,t),this.fire("baselayeractiveids",{activeIDs:this._activeIDs}),e},isActiveID:function(t){for(var e=0,i=this._activeIDs.length;i>e;e++)if(t===this._activeIDs[e])return!0;return!1},setCurrentID:function(t){var e=this._baseLayers[this._currentID]||null;return e&&this._map.hasLayer(e)&&this.isActiveID(this._currentID)&&this._map.removeLayer(e),this._currentID=t,e=this._baseLayers[t]||null,e&&!this._map.hasLayer(e)&&this.isActiveID(t)&&this._map.addLayer(e),this.fire("baselayerchange",{baseLayer:e}),e},getCurrentID:function(){return this._currentID},getIDByAlias:function(t){return this._aliases[t]},loadState:function(t){return t=t||{},t.activeIDs&&this.setActiveIDs(t.activeIDs),this.setCurrentID(t.currentID),this},saveState:function(){return{version:this.options.stateVersion,currentID:this._currentID||"",activeIDs:this._activeIDs||[]}},initDefaults:e})}),function(t){"undefined"!=typeof module&&module.exports?module.exports=t(require("leaflet"),require("leaflet-geomixer"),require("leaflet-tilelayer-mercator")):window.gmxBaseLayersManager.prototype.initDefaults=t(window.L,window.L.gmx,window.L.tileLayer.Mercator)}(function(t,e,i){return function(e){var n=this,o=2e6,r=e&&e.mapID?e.mapID:"1D30C72D02914C5FB90D1D448159CAB6",s=t.gmxLocale.getLanguage(),a=function(e){return t.gmxLocale.getText(e)||e},l={collinsbartholomew:'&copy; <a href="http://www.collinsbartholomew.com/">Collins Bartholomew Ltd.</a>',geocenter:'&copy; <a href="http://www.geocenter-consulting.ru/">'+a(" -","Geocentre-Consulting")+"</a>",openStreetMap:"&copy; "+a(' OpenStreetMap <a href="http://www.openstreetmap.org/copyright">ODbL</a>','OpenStreetMap contributers <a href="http://opendatacommons.org/licenses/odbl/">ODbL</a>'),cgiar:'&copy; <a href="http://srtm.csi.cgiar.org/">CGIAR-CSI</a>',"2gis":'&copy; <a href="http://help.2gis.ru/api-rules/#kart">'+a(" ","2GIS")+"</a>",naturalearthdata:'&copy; <a href="http://www.naturalearthdata.com/">Natural Earth</a>',nasa:'&copy; <a href="http://www.nasa.gov">NASA</a>',earthstar:'&copy; <a href="http://www.es-geo.com">Earthstar Geographics</a>',antrix:'&copy; <a href="http://www.antrix.gov.in/">ANTRIX</a>',geoeye:'&copy; <a href="http://www.geoeye.com">GeoEye Inc.</a>'},h=function(){return[{minZoom:1,maxZoom:7,attribution:l.collinsbartholomew+", "+a("2014","2012")},{minZoom:1,maxZoom:7,attribution:l.naturalearthdata+", 2013"},{minZoom:8,maxZoom:17,attribution:l.openStreetMap}]
},u=function(t){return"http://{s}.tile.cart.kosmosnimki.ru/"+t+"/{z}/{x}/{y}.png"},c="http://maps.kosmosnimki.ru/api/img/baseLayers/",d={empty:{rus:"",eng:"Empty",layers:[]},sputnik:{rus:" ",eng:"Sputnik RU",icon:c+"basemap_sputnik_ru.png",layers:[t.tileLayer("http://tiles.maps.sputnik.ru/{z}/{x}/{y}.png",{maxZoom:22,maxNativeZoom:18,attribution:'<a href="http://maps.sputnik.ru"></a>  '+("rus"===s?"":"Rostelecom")+' |  <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'})]},mapbox:{rus:"Mapbox",eng:"Mapbox",icon:c+"basemap_mapbox.png",layers:[t.tileLayer("https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoia29zbW9zbmlta2lydSIsImEiOiJjaWhxMHNlZDgwNGFldHBtMjdyejQ3YTJ3In0.3UAAWcIBabrbUhHwmp1WjA",{maxZoom:22,maxNativeZoom:22,attribution:'<a href="https://www.mapbox.com/about/maps/" target="_blank"> Mapbox</a> <a href="http://www.openstreetmap.org/about/" target="_blank"> OpenStreetMap</a>'})]},OSM:{rus:"",eng:"Map",icon:c+"basemap_osm_"+("rus"===s?"ru":"eng")+".png",layers:[t.tileLayer("http://{s}.tile.osm.kosmosnimki.ru/kosmo"+("rus"===s?"":"-en")+"/{z}/{x}/{y}.png",{maxNativeZoom:18,gmxCopyright:h()})]},outline:{rus:" RuMap",eng:"Outline RuMap",icon:c+"basemap_contour.png",layers:[i(u("mo"),{maxNativeZoom:13,gmxCopyright:[{minZoom:1,maxZoom:9,attribution:l.collinsbartholomew+a(", 2014",", 2012")},{minZoom:1,maxZoom:17,attribution:l.geocenter+", 2014"}]})]},osmGrey:{rus:"",eng:"Grey Map",icon:c+"basemap_osm_grey.png",layers:[t.tileLayer(u("winter"+("rus"===s?"":"-en")),{maxZoom:18,gmxCopyright:h()})]},osmPrint:{rus:" ",eng:"Print Map",icon:c+"basemap_print.png",layers:[t.tileLayer("http://{s}.tile.osm.kosmosnimki.ru/bw"+("rus"===s?"":"-en")+"/{z}/{x}/{y}.png",{maxNativeZoom:18,gmxCopyright:h()})]},slope:{rus:"",eng:"Slope",icon:c+"basemap_relief_slope.png",description:'<img src = "'+c+'basemap_relief_slope_legend.svg"></img>',minZoom:9,maxZoom:15,layers:[i(u("ds"),{minZoom:9,maxZoom:15,maxNativeZoom:13,gmxCopyright:h()})]},aspect:{rus:"",eng:"Aspect",icon:c+"basemap_aspect.png",description:'<img src = "'+c+'basemap_aspect_legend.svg"></img>',minZoom:9,maxZoom:15,layers:[i(u("da"),{minZoom:9,maxZoom:15,maxNativeZoom:13,gmxCopyright:h()})]}};d.OSMHybrid={rus:"",eng:"Hybrid",overlayColor:"#ffffff",icon:"http://maps.kosmosnimki.ru/api/img/baseLayers/basemap_osm_hybrid.png",layers:[t.tileLayer("http://{s}.tile.osm.kosmosnimki.ru/kosmohyb"+("rus"===s?"":"-en")+"/{z}/{x}/{y}.png",{maxNativeZoom:18,gmxCopyright:h()})]},d.OSMHybrid.layers[0].setZIndex(o);var p=[{mapID:r,layerID:"C9458F2DCB754CEEACC54216C7D1EB0A",type:"satellite",rus:"",eng:"Satellite",overlayColor:"#ffffff",icon:c+"basemap_satellite.png"}];"rus"===s?(d.map={rus:" RuMap",eng:"RuMap",icon:c+"basemap_rumap.png",layers:[t.tileLayer("http://tile.digimap.ru/rumap/{z}/{x}/{y}.png",{maxNativeZoom:20,attribution:l.geocenter+", 2014"})]},d["2GIS"]={icon:c+"2gis.png",layers:[t.tileLayer("http://tile2.maps.2gis.com/tiles?x={x}&y={y}&z={z}&v=4",{maxNativeZoom:18,attribution:l["2gis"]})]},d.relief={rus:" RuMap",eng:"Relief",icon:c+"basemap_terrain.png",layers:[i(u("r"),{maxNativeZoom:13,gmxCopyright:[{minZoom:1,maxZoom:17,attribution:l.collinsbartholomew+a(", 2014",", 2012")},{minZoom:1,maxZoom:17,attribution:l.geocenter+", 2014"},{minZoom:1,maxZoom:17,attribution:l.cgiar+", 2008"}]})]},d.grey={rus:" RuMap",eng:"Grey",icon:c+"basemap_grey.png",layers:[i(u("mg"),{maxNativeZoom:17,gmxCopyright:[{minZoom:1,maxZoom:9,attribution:l.collinsbartholomew+a(", 2014",", 2012")},{minZoom:1,maxZoom:17,attribution:l.geocenter+", 2014"}]})]},d.osmNight={rus:"",eng:"OSM Night",icon:c+"basemap_night.png",layers:[t.tileLayer("http://{s}.tile.osm.kosmosnimki.ru/night/{z}/{x}/{y}.png",{maxZoom:18,gmxCopyright:h()})]}):(p.push({mapID:r,layerID:"5269E524341E4E7DB9D447C968B20A2C",type:"map",rus:" RuMap",eng:"RuMap",icon:c+"basemap_rumap.png"}),p.push({mapID:r,layerID:"BCCCE2BDC9BF417DACF27BB4D481FAD9",type:"hybrid",rus:" RuMap",eng:"Hybrid RuMap"}));var m=new t.gmx.Deferred;return e=e||{},t.gmx.loadLayers(p,e).then(function(){var t,e,n={},r=null;for(t=0,e=arguments.length;e>t;t++){var a=arguments[t],l=a._gmx,m=l.mapName,f=l.layerID;m in n||(n[m]={}),n[m][f]=a}for(t=0,e=p.length;e>t;t++){var g=p[t],_=g.type;if("hybrid"!==_){if("satellite"===_){var v=n[g.mapID][g.layerID];"rus"===s?r=i(u("o"),{maxNativeZoom:17,clickable:!1}):(r=n[g.mapID].BCCCE2BDC9BF417DACF27BB4D481FAD9,r.options.clickable=!1),r.options.gmxCopyright=h(),d.hybrid={rus:" RuMap",eng:"Hybrid RuMap",overlayColor:"#ffffff",icon:c+"basemap_hybrid.png",layers:[v,r]},d.hybrid.layers[1].setZIndex(o),d.OSMHybrid.layers.unshift(v)}d[_]={rus:g.rus,eng:g.eng,icon:g.icon,overlayColor:g.overlayColor||"#000000",layers:[n[g.mapID][g.layerID]]}}}}).always(function(){for(var t in d){var e=d[t];e.rus||(e.rus=t),e.eng||(e.eng=t),n.add(t,e)}m.resolve()}),m}}),function(t){var e;if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("undefined"!=typeof module)e=require("leaflet"),module.exports=t(e);else{if("undefined"==typeof window.L)throw new Error("Leaflet must be loaded first");t(window.L)}}(function(t){t.Map.mergeOptions({contextmenuItems:[]}),t.Map.ContextMenu=t.Handler.extend({_touchstart:t.Browser.msPointer?"MSPointerDown":t.Browser.pointer?"pointerdown":"touchstart",statics:{BASE_CLS:"leaflet-contextmenu"},initialize:function(e){t.Handler.prototype.initialize.call(this,e),this._items=[],this._visible=!1;var i=this._container=t.DomUtil.create("div",t.Map.ContextMenu.BASE_CLS,e._container);i.style.zIndex=1e4,i.style.position="absolute",e.options.contextmenuWidth&&(i.style.width=e.options.contextmenuWidth+"px"),this._createItems(),t.DomEvent.on(i,"click",t.DomEvent.stop).on(i,"mousedown",t.DomEvent.stop).on(i,"dblclick",t.DomEvent.stop).on(i,"contextmenu",t.DomEvent.stop)},addHooks:function(){var e=this._map.getContainer();t.DomEvent.on(e,"mouseleave",this._hide,this).on(document,"keydown",this._onKeyDown,this),t.Browser.touch&&t.DomEvent.on(document,this._touchstart,this._hide,this),this._map.on({contextmenu:this._show,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},removeHooks:function(){var e=this._map.getContainer();t.DomEvent.off(e,"mouseleave",this._hide,this).off(document,"keydown",this._onKeyDown,this),t.Browser.touch&&t.DomEvent.off(document,this._touchstart,this._hide,this),this._map.off({contextmenu:this._show,mousedown:this._hide,movestart:this._hide,zoomstart:this._hide},this)},showAt:function(e,i){e instanceof t.LatLng&&(e=this._map.latLngToContainerPoint(e)),this._showAtPoint(e,i)},hide:function(){this._hide()},addItem:function(t){return this.insertItem(t)},insertItem:function(t,e){e=void 0!==e?e:this._items.length;var i=this._createItem(this._container,t,e);return this._items.push(i),this._sizeChanged=!0,this._map.fire("contextmenu.additem",{contextmenu:this,el:i.el,index:e}),i.el},removeItem:function(e){var i=this._container;isNaN(e)||(e=i.children[e]),e&&(this._removeItem(t.Util.stamp(e)),this._sizeChanged=!0,this._map.fire("contextmenu.removeitem",{contextmenu:this,el:e}))},removeAllItems:function(){for(var e;this._container.children.length;)e=this._container.children[0],this._removeItem(t.Util.stamp(e))},hideAllItems:function(){var t,e,i;for(e=0,i=this._items.length;i>e;e++)t=this._items[e],t.el.style.display="none"},showAllItems:function(){var t,e,i;for(e=0,i=this._items.length;i>e;e++)t=this._items[e],t.el.style.display=""},setDisabled:function(e,i){var n=this._container,o=t.Map.ContextMenu.BASE_CLS+"-item";isNaN(e)||(e=n.children[e]),e&&t.DomUtil.hasClass(e,o)&&(i?(t.DomUtil.addClass(e,o+"-disabled"),this._map.fire("contextmenu.disableitem",{contextmenu:this,el:e})):(t.DomUtil.removeClass(e,o+"-disabled"),this._map.fire("contextmenu.enableitem",{contextmenu:this,el:e})))},isVisible:function(){return this._visible},_createItems:function(){var t,e,i=this._map.options.contextmenuItems;for(t=0,e=i.length;e>t;t++)this._items.push(this._createItem(this._container,i[t]))},_createItem:function(e,i,n){if(i.separator||"-"===i)return this._createSeparator(e,n);var o=t.Map.ContextMenu.BASE_CLS+"-item",r=i.disabled?o+" "+o+"-disabled":o,s=this._insertElementAt("a",r,e,n),a=this._createEventHandler(s,i.callback,i.context,i.hideOnSelect),l="";return i.icon?l='<img class="'+t.Map.ContextMenu.BASE_CLS+'-icon" src="'+i.icon+'"/>':i.iconCls&&(l='<span class="'+t.Map.ContextMenu.BASE_CLS+"-icon "+i.iconCls+'"></span>'),s.innerHTML=l+i.text,s.href="#",t.DomEvent.on(s,"mouseover",this._onItemMouseOver,this).on(s,"mouseout",this._onItemMouseOut,this).on(s,"mousedown",t.DomEvent.stopPropagation).on(s,"click",a),t.Browser.touch&&t.DomEvent.on(s,this._touchstart,t.DomEvent.stopPropagation),{id:t.Util.stamp(s),el:s,callback:a}},_removeItem:function(e){var i,n,o,r,s;for(o=0,r=this._items.length;r>o;o++)if(i=this._items[o],i.id===e)return n=i.el,s=i.callback,s&&(t.DomEvent.off(n,"mouseover",this._onItemMouseOver,this).off(n,"mouseover",this._onItemMouseOut,this).off(n,"mousedown",t.DomEvent.stopPropagation).off(n,"click",s),t.Browser.touch&&t.DomEvent.off(n,this._touchstart,t.DomEvent.stopPropagation)),this._container.removeChild(n),this._items.splice(o,1),i;return null},_createSeparator:function(e,i){var n=this._insertElementAt("div",t.Map.ContextMenu.BASE_CLS+"-separator",e,i);return{id:t.Util.stamp(n),el:n}},_createEventHandler:function(e,i,n,o){var r=this,s=this._map,a=t.Map.ContextMenu.BASE_CLS+"-item-disabled",o=void 0!==o?o:!0;return function(){t.DomUtil.hasClass(e,a)||(o&&r._hide(),i&&i.call(n||s,r._showLocation),r._map.fire("contextmenu:select",{contextmenu:r,el:e}))}},_insertElementAt:function(t,e,i,n){var o,r=document.createElement(t);return r.className=e,void 0!==n&&(o=i.children[n]),o?i.insertBefore(r,o):i.appendChild(r),r},_show:function(t){this._showAtPoint(t.containerPoint,t)},_showAtPoint:function(e,i){if(this._items.length){var n=this._map,o=n.containerPointToLayerPoint(e),r=n.layerPointToLatLng(o),s=t.extend(i||{},{contextmenu:this});this._showLocation={latlng:r,layerPoint:o,containerPoint:e},i&&i.relatedTarget&&(this._showLocation.relatedTarget=i.relatedTarget),this._setPosition(e),this._visible?this._setPosition(e):(this._container.style.display="block",this._visible=!0),this._map.fire("contextmenu.show",s)}},_hide:function(){this._visible&&(this._visible=!1,this._container.style.display="none",this._map.fire("contextmenu.hide",{contextmenu:this}))},_setPosition:function(e){var i,n=this._map.getSize(),o=this._container,r=this._getElementSize(o);this._map.options.contextmenuAnchor&&(i=t.point(this._map.options.contextmenuAnchor),e=e.add(i)),o._leaflet_pos=e,e.x+r.x>n.x?(o.style.left="auto",o.style.right=Math.max(n.x-e.x,0)+"px"):(o.style.left=Math.max(e.x,0)+"px",o.style.right="auto"),e.y+r.y>n.y?(o.style.top="auto",o.style.bottom=Math.max(n.y-e.y,0)+"px"):(o.style.top=Math.max(e.y,0)+"px",o.style.bottom="auto")},_getElementSize:function(t){var e=this._size,i=t.style.display;return(!e||this._sizeChanged)&&(e={},t.style.left="-999999px",t.style.right="auto",t.style.display="block",e.x=t.offsetWidth,e.y=t.offsetHeight,t.style.left="auto",t.style.display=i,this._sizeChanged=!1),e},_onKeyDown:function(t){var e=t.keyCode;27===e&&this._hide()},_onItemMouseOver:function(e){t.DomUtil.addClass(e.target||e.srcElement,"over")},_onItemMouseOut:function(e){t.DomUtil.removeClass(e.target||e.srcElement,"over")}}),t.Map.addInitHook("addHandler","contextmenu",t.Map.ContextMenu),t.Mixin.ContextMenu={bindContextMenu:function(e){return t.setOptions(this,e),this._initContextMenu(),this},unbindContextMenu:function(){return this.off("contextmenu",this._showContextMenu,this),this},addContextMenuItem:function(t){this.options.contextmenuItems.push(t)},removeContextMenuItemWithIndex:function(t){for(var e=[],i=0;i<this.options.contextmenuItems.length;i++)this.options.contextmenuItems[i].index==t&&e.push(i);for(var n=e.pop();void 0!==n;)this.options.contextmenuItems.splice(n,1),n=e.pop()},replaceConextMenuItem:function(t){this.removeContextMenuItemWithIndex(t.index),this.addContextMenuItem(t)},_initContextMenu:function(){this._items=[],this.on("contextmenu",this._showContextMenu,this)},_showContextMenu:function(e){var i,n,o,r,s;if(this._map.contextmenu){for(n=t.extend({relatedTarget:this},e),o=this._map.mouseEventToContainerPoint(e.originalEvent),this.options.contextmenuInheritItems||this._map.contextmenu.hideAllItems(),r=0,s=this.options.contextmenuItems.length;s>r;r++)i=this.options.contextmenuItems[r],this._items.push(this._map.contextmenu.insertItem(i,i.index));this._map.once("contextmenu.hide",this._hideContextMenu,this),this._map.contextmenu.showAt(o,n)}},_hideContextMenu:function(){var t,e;for(t=0,e=this._items.length;e>t;t++)this._map.contextmenu.removeItem(this._items[t]);this._items.length=0,this.options.contextmenuInheritItems||this._map.contextmenu.showAllItems()}};var e,i,n,o=[t.Marker,t.Path],r={contextmenu:!1,contextmenuItems:[],contextmenuInheritItems:!0};for(i=0,n=o.length;n>i;i++)e=o[i],e.prototype.options?e.mergeOptions(r):e.prototype.options=r,e.addInitHook(function(){this.options.contextmenu&&this._initContextMenu()}),e.include(t.Mixin.ContextMenu);return t.Map.ContextMenu}),!function(){"use strict";function t(e){return this instanceof t?(this._canvas=e="string"==typeof e?document.getElementById(e):e,this._ctx=e.getContext("2d"),this._width=e.width,this._height=e.height,this._max=1,void this.clear()):new t(e)}t.prototype={defaultRadius:25,defaultGradient:{.4:"blue",.6:"cyan",.7:"lime",.8:"yellow",1:"red"},data:function(t){return this._data=t,this},max:function(t){return this._max=t,this},add:function(t){return this._data.push(t),this},clear:function(){return this._data=[],this},radius:function(t,e){e=e||15;var i=this._circle=document.createElement("canvas"),n=i.getContext("2d"),o=this._r=t+e;return i.width=i.height=2*o,n.shadowOffsetX=n.shadowOffsetY=200,n.shadowBlur=e,n.shadowColor="black",n.beginPath(),n.arc(o-200,o-200,t,0,2*Math.PI,!0),n.closePath(),n.fill(),this},gradient:function(t){var e=document.createElement("canvas"),i=e.getContext("2d"),n=i.createLinearGradient(0,0,0,256);e.width=1,e.height=256;for(var o in t)n.addColorStop(o,t[o]);return i.fillStyle=n,i.fillRect(0,0,1,256),this._grad=i.getImageData(0,0,1,256).data,this},draw:function(t){this._circle||this.radius(this.defaultRadius),this._grad||this.gradient(this.defaultGradient);var e=this._ctx;e.clearRect(0,0,this._width,this._height);for(var i,n=0,o=this._data.length;o>n;n++)i=this._data[n],e.globalAlpha=Math.max(i[2]/this._max,t||.05),e.drawImage(this._circle,i[0]-this._r,i[1]-this._r);var r=e.getImageData(0,0,this._width,this._height);return this._colorize(r.data,this._grad),e.putImageData(r,0,0),this},_colorize:function(t,e){for(var i,n=3,o=t.length;o>n;n+=4)i=4*t[n],i&&(t[n-3]=e[i],t[n-2]=e[i+1],t[n-1]=e[i+2])}},window.simpleheat=t}(),L.HeatLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,e){this._latlngs=t,L.setOptions(this,e)},setLatLngs:function(t){return this._latlngs=t,this.redraw()},addLatLng:function(t){return this._latlngs.push(t),this.redraw()},setOptions:function(t){return L.setOptions(this,t),this._heat&&this._updateOptions(),this.redraw()},redraw:function(){return!this._heat||this._frame||this._map._animating||(this._frame=L.Util.requestAnimFrame(this._redraw,this)),this},onAdd:function(t){this._map=t,this._canvas||this._initCanvas(),t._panes.overlayPane.appendChild(this._canvas),t.on("moveend",this._reset,this),t.options.zoomAnimation&&L.Browser.any3d&&t.on("zoomanim",this._animateZoom,this),this._reset()},onRemove:function(t){t.getPanes().overlayPane.removeChild(this._canvas),t.off("moveend",this._reset,this),t.options.zoomAnimation&&t.off("zoomanim",this._animateZoom,this)},addTo:function(t){return t.addLayer(this),this},_initCanvas:function(){var t=this._canvas=L.DomUtil.create("canvas","leaflet-heatmap-layer leaflet-layer"),e=this._map.getSize();t.width=e.x,t.height=e.y;var i=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(t,"leaflet-zoom-"+(i?"animated":"hide")),this._heat=simpleheat(t),this._updateOptions()},_updateOptions:function(){this._heat.radius(this.options.radius||this._heat.defaultRadius,this.options.blur),this.options.gradient&&this._heat.gradient(this.options.gradient),this.options.max&&this._heat.max(this.options.max)},_reset:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t);var e=this._map.getSize();this._heat._width!==e.x&&(this._canvas.width=this._heat._width=e.x),this._heat._height!==e.y&&(this._canvas.height=this._heat._height=e.y),this._redraw()},_redraw:function(){var t,e,i,n,o,r,s,a,l,h=[],u=this._heat._r,c=this._map.getSize(),d=new L.LatLngBounds(this._map.containerPointToLatLng(L.point([-u,-u])),this._map.containerPointToLatLng(c.add([u,u]))),p=void 0===this.options.max?1:this.options.max,m=void 0===this.options.maxZoom?this._map.getMaxZoom():this.options.maxZoom,f=1/Math.pow(2,Math.max(0,Math.min(m-this._map.getZoom(),12))),g=u/2,_=[],v=this._map._getMapPanePos(),y=v.x%g,x=v.y%g;for(t=0,e=this._latlngs.length;e>t;t++)if(d.contains(this._latlngs[t])){i=this._map.latLngToContainerPoint(this._latlngs[t]),o=Math.floor((i.x-y)/g)+2,r=Math.floor((i.y-x)/g)+2;var b=void 0!==this._latlngs[t].alt?this._latlngs[t].alt:void 0!==this._latlngs[t][2]?+this._latlngs[t][2]:1;l=b*f,_[r]=_[r]||[],n=_[r][o],n?(n[0]=(n[0]*n[2]+i.x*l)/(n[2]+l),n[1]=(n[1]*n[2]+i.y*l)/(n[2]+l),n[2]+=l):_[r][o]=[i.x,i.y,l]}for(t=0,e=_.length;e>t;t++)if(_[t])for(s=0,a=_[t].length;a>s;s++)n=_[t][s],n&&h.push([Math.round(n[0]),Math.round(n[1]),Math.min(n[2],p)]);this._heat.data(h).draw(this.options.minOpacity),this._frame=null},_animateZoom:function(t){var e=this._map.getZoomScale(t.zoom),i=this._map._getCenterOffset(t.center)._multiplyBy(-e).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,i,e):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(i)+" scale("+e+")"}}),L.heatLayer=function(t,e){return new L.HeatLayer(t,e)},function(t,e,i){L.MarkerClusterGroup=L.FeatureGroup.extend({options:{maxClusterRadius:80,iconCreateFunction:null,spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,singleMarkerMode:!1,disableClusteringAtZoom:null,removeOutsideVisibleBounds:!0,animate:!0,animateAddingMarkers:!1,spiderfyDistanceMultiplier:1,spiderLegPolylineOptions:{weight:1.5,color:"#222",opacity:.5},chunkedLoading:!1,chunkInterval:200,chunkDelay:50,chunkProgress:null,polygonOptions:{}},initialize:function(t){L.Util.setOptions(this,t),this.options.iconCreateFunction||(this.options.iconCreateFunction=this._defaultIconCreateFunction),this._featureGroup=L.featureGroup(),this._featureGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._nonPointGroup=L.featureGroup(),this._nonPointGroup.on(L.FeatureGroup.EVENTS,this._propagateEvent,this),this._inZoomAnimation=0,this._needsClustering=[],this._needsRemoving=[],this._currentShownBounds=null,this._queue=[];var e=L.DomUtil.TRANSITION&&this.options.animate;L.extend(this,e?this._withAnimation:this._noAnimation),this._markerCluster=e?L.MarkerCluster:L.MarkerClusterNonAnimated},addLayer:function(t){if(t instanceof L.LayerGroup){var e=[];for(var i in t._layers)e.push(t._layers[i]);return this.addLayers(e)}if(!t.getLatLng)return this._nonPointGroup.addLayer(t),this;if(!this._map)return this._needsClustering.push(t),this;if(this.hasLayer(t))return this;this._unspiderfy&&this._unspiderfy(),this._addLayer(t,this._maxZoom),this._topClusterLevel._recalculateBounds();var n=t,o=this._map.getZoom();if(t.__parent)for(;n.__parent._zoom>=o;)n=n.__parent;return this._currentShownBounds.contains(n.getLatLng())&&(this.options.animateAddingMarkers?this._animationAddLayer(t,n):this._animationAddLayerNonAnimated(t,n)),this},removeLayer:function(t){if(t instanceof L.LayerGroup){var e=[];for(var i in t._layers)e.push(t._layers[i]);return this.removeLayers(e)}return t.getLatLng?this._map?t.__parent?(this._unspiderfy&&(this._unspiderfy(),this._unspiderfyLayer(t)),this._removeLayer(t,!0),this._topClusterLevel._recalculateBounds(),this._featureGroup.hasLayer(t)&&(this._featureGroup.removeLayer(t),t.clusterShow&&t.clusterShow()),this):this:(!this._arraySplice(this._needsClustering,t)&&this.hasLayer(t)&&this._needsRemoving.push(t),this):(this._nonPointGroup.removeLayer(t),this)},addLayers:function(t){var e,i,n,o,r=this._featureGroup,s=this._nonPointGroup,a=this.options.chunkedLoading,l=this.options.chunkInterval,h=this.options.chunkProgress;if(this._map){var u=0,c=(new Date).getTime(),d=L.bind(function(){for(var e=(new Date).getTime();u<t.length;u++){if(a&&0===u%200){var i=(new Date).getTime()-e;if(i>l)break}if(o=t[u],o.getLatLng){if(!this.hasLayer(o)&&(this._addLayer(o,this._maxZoom),o.__parent&&2===o.__parent.getChildCount())){var n=o.__parent.getAllChildMarkers(),p=n[0]===o?n[1]:n[0];r.removeLayer(p)}}else s.addLayer(o)}h&&h(u,t.length,(new Date).getTime()-c),u===t.length?(this._topClusterLevel._recalculateBounds(),this._featureGroup.eachLayer(function(t){t instanceof L.MarkerCluster&&t._iconNeedsUpdate&&t._updateIcon()}),this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds)):setTimeout(d,this.options.chunkDelay)},this);d()}else{for(e=[],i=0,n=t.length;n>i;i++)o=t[i],o.getLatLng?this.hasLayer(o)||e.push(o):s.addLayer(o);this._needsClustering=this._needsClustering.concat(e)}return this},removeLayers:function(t){var e,i,n,o=this._featureGroup,r=this._nonPointGroup;if(!this._map){for(e=0,i=t.length;i>e;e++)n=t[e],this._arraySplice(this._needsClustering,n),r.removeLayer(n),this.hasLayer(n)&&this._needsRemoving.push(n);return this}if(this._unspiderfy)for(this._unspiderfy(),e=0,i=t.length;i>e;e++)n=t[e],this._unspiderfyLayer(n);for(e=0,i=t.length;i>e;e++)n=t[e],n.__parent?(this._removeLayer(n,!0,!0),o.hasLayer(n)&&(o.removeLayer(n),n.clusterShow&&n.clusterShow())):r.removeLayer(n);return this._topClusterLevel._recalculateBounds(),this._topClusterLevel._recursivelyAddChildrenToMap(null,this._zoom,this._currentShownBounds),o.eachLayer(function(t){t instanceof L.MarkerCluster&&t._updateIcon()}),this},clearLayers:function(){return this._map||(this._needsClustering=[],delete this._gridClusters,delete this._gridUnclustered),this._noanimationUnspiderfy&&this._noanimationUnspiderfy(),this._featureGroup.clearLayers(),this._nonPointGroup.clearLayers(),this.eachLayer(function(t){delete t.__parent}),this._map&&this._generateInitialClusters(),this},getBounds:function(){var t=new L.LatLngBounds;this._topClusterLevel&&t.extend(this._topClusterLevel._bounds);for(var e=this._needsClustering.length-1;e>=0;e--)t.extend(this._needsClustering[e].getLatLng());return t.extend(this._nonPointGroup.getBounds()),t},eachLayer:function(t,e){var i,n=this._needsClustering.slice();for(this._topClusterLevel&&this._topClusterLevel.getAllChildMarkers(n),i=n.length-1;i>=0;i--)t.call(e,n[i]);this._nonPointGroup.eachLayer(t,e)},getLayers:function(){var t=[];return this.eachLayer(function(e){t.push(e)}),t},getLayer:function(t){var e=null;return t=parseInt(t,10),this.eachLayer(function(i){L.stamp(i)===t&&(e=i)}),e},hasLayer:function(t){if(!t)return!1;var e,i=this._needsClustering;for(e=i.length-1;e>=0;e--)if(i[e]===t)return!0;for(i=this._needsRemoving,e=i.length-1;e>=0;e--)if(i[e]===t)return!1;return!(!t.__parent||t.__parent._group!==this)||this._nonPointGroup.hasLayer(t)},zoomToShowLayer:function(t,e){"function"!=typeof e&&(e=function(){});var i=function(){!t._icon&&!t.__parent._icon||this._inZoomAnimation||(this._map.off("moveend",i,this),this.off("animationend",i,this),t._icon?e():t.__parent._icon&&(this.once("spiderfied",e,this),t.__parent.spiderfy()))};if(t._icon&&this._map.getBounds().contains(t.getLatLng()))e();else if(t.__parent._zoom<this._map.getZoom())this._map.on("moveend",i,this),this._map.panTo(t.getLatLng());else{var n=function(){this._map.off("movestart",n,this),n=null};this._map.on("movestart",n,this),this._map.on("moveend",i,this),this.on("animationend",i,this),t.__parent.zoomToBounds(),n&&i.call(this)}},onAdd:function(t){this._map=t;var e,i,n;if(!isFinite(this._map.getMaxZoom()))throw"Map has no maxZoom specified";for(this._featureGroup.onAdd(t),this._nonPointGroup.onAdd(t),this._gridClusters||this._generateInitialClusters(),this._maxLat=t.options.crs.projection.MAX_LATITUDE,e=0,i=this._needsRemoving.length;i>e;e++)n=this._needsRemoving[e],this._removeLayer(n,!0);this._needsRemoving=[],this._zoom=this._map.getZoom(),this._currentShownBounds=this._getExpandedVisibleBounds(),this._map.on("zoomend",this._zoomEnd,this),this._map.on("moveend",this._moveEnd,this),this._spiderfierOnAdd&&this._spiderfierOnAdd(),this._bindEvents(),i=this._needsClustering,this._needsClustering=[],this.addLayers(i)},onRemove:function(t){t.off("zoomend",this._zoomEnd,this),t.off("moveend",this._moveEnd,this),this._unbindEvents(),this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim",""),this._spiderfierOnRemove&&this._spiderfierOnRemove(),delete this._maxLat,this._hideCoverage(),this._featureGroup.onRemove(t),this._nonPointGroup.onRemove(t),this._featureGroup.clearLayers(),this._map=null},getVisibleParent:function(t){for(var e=t;e&&!e._icon;)e=e.__parent;return e||null},_arraySplice:function(t,e){for(var i=t.length-1;i>=0;i--)if(t[i]===e)return t.splice(i,1),!0},_removeFromGridUnclustered:function(t,e){for(var i=this._map,n=this._gridUnclustered;e>=0&&n[e].removeObject(t,i.project(t.getLatLng(),e));e--);},_removeLayer:function(t,e,i){var n=this._gridClusters,o=this._gridUnclustered,r=this._featureGroup,s=this._map;e&&this._removeFromGridUnclustered(t,this._maxZoom);var a,l=t.__parent,h=l._markers;for(this._arraySplice(h,t);l&&(l._childCount--,l._boundsNeedUpdate=!0,!(l._zoom<0));)e&&l._childCount<=1?(a=l._markers[0]===t?l._markers[1]:l._markers[0],n[l._zoom].removeObject(l,s.project(l._cLatLng,l._zoom)),o[l._zoom].addObject(a,s.project(a.getLatLng(),l._zoom)),this._arraySplice(l.__parent._childClusters,l),l.__parent._markers.push(a),a.__parent=l.__parent,l._icon&&(r.removeLayer(l),i||r.addLayer(a))):i&&l._icon||l._updateIcon(),l=l.__parent;delete t.__parent},_isOrIsParent:function(t,e){for(;e;){if(t===e)return!0;e=e.parentNode}return!1},_propagateEvent:function(t){if(t.layer instanceof L.MarkerCluster){if(t.originalEvent&&this._isOrIsParent(t.layer._icon,t.originalEvent.relatedTarget))return;t.type="cluster"+t.type}this.fire(t.type,t)},_defaultIconCreateFunction:function(t){var e=t.getChildCount(),i=" marker-cluster-";return i+=10>e?"small":100>e?"medium":"large",new L.DivIcon({html:"<div><span>"+e+"</span></div>",className:"marker-cluster"+i,iconSize:new L.Point(40,40)})},_bindEvents:function(){var t=this._map,e=this.options.spiderfyOnMaxZoom,i=this.options.showCoverageOnHover,n=this.options.zoomToBoundsOnClick;(e||n)&&this.on("clusterclick",this._zoomOrSpiderfy,this),i&&(this.on("clustermouseover",this._showCoverage,this),this.on("clustermouseout",this._hideCoverage,this),t.on("zoomend",this._hideCoverage,this))},_zoomOrSpiderfy:function(t){for(var e=t.layer,i=e;1===i._childClusters.length;)i=i._childClusters[0];i._zoom===this._maxZoom&&i._childCount===e._childCount?this.options.spiderfyOnMaxZoom&&e.spiderfy():this.options.zoomToBoundsOnClick&&e.zoomToBounds(),t.originalEvent&&13===t.originalEvent.keyCode&&this._map._container.focus()},_showCoverage:function(t){var e=this._map;this._inZoomAnimation||(this._shownPolygon&&e.removeLayer(this._shownPolygon),t.layer.getChildCount()>2&&t.layer!==this._spiderfied&&(this._shownPolygon=new L.Polygon(t.layer.getConvexHull(),this.options.polygonOptions),e.addLayer(this._shownPolygon)))},_hideCoverage:function(){this._shownPolygon&&(this._map.removeLayer(this._shownPolygon),this._shownPolygon=null)},_unbindEvents:function(){var t=this.options.spiderfyOnMaxZoom,e=this.options.showCoverageOnHover,i=this.options.zoomToBoundsOnClick,n=this._map;(t||i)&&this.off("clusterclick",this._zoomOrSpiderfy,this),e&&(this.off("clustermouseover",this._showCoverage,this),this.off("clustermouseout",this._hideCoverage,this),n.off("zoomend",this._hideCoverage,this))},_zoomEnd:function(){this._map&&(this._mergeSplitClusters(),this._zoom=this._map._zoom,this._currentShownBounds=this._getExpandedVisibleBounds())},_moveEnd:function(){if(!this._inZoomAnimation){var t=this._getExpandedVisibleBounds();this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,t),this._topClusterLevel._recursivelyAddChildrenToMap(null,this._map._zoom,t),this._currentShownBounds=t}},_generateInitialClusters:function(){var t=this._map.getMaxZoom(),e=this.options.maxClusterRadius,i=e;"function"!=typeof e&&(i=function(){return e}),this.options.disableClusteringAtZoom&&(t=this.options.disableClusteringAtZoom-1),this._maxZoom=t,this._gridClusters={},this._gridUnclustered={};for(var n=t;n>=0;n--)this._gridClusters[n]=new L.DistanceGrid(i(n)),this._gridUnclustered[n]=new L.DistanceGrid(i(n));this._topClusterLevel=new this._markerCluster(this,-1)},_addLayer:function(t,e){var i,n,o=this._gridClusters,r=this._gridUnclustered;for(this.options.singleMarkerMode&&this._overrideMarkerIcon(t);e>=0;e--){i=this._map.project(t.getLatLng(),e);var s=o[e].getNearObject(i);if(s)return s._addChild(t),t.__parent=s,void 0;if(s=r[e].getNearObject(i)){var a=s.__parent;a&&this._removeLayer(s,!1);var l=new this._markerCluster(this,e,s,t);o[e].addObject(l,this._map.project(l._cLatLng,e)),s.__parent=l,t.__parent=l;var h=l;for(n=e-1;n>a._zoom;n--)h=new this._markerCluster(this,n,h),o[n].addObject(h,this._map.project(s.getLatLng(),n));return a._addChild(h),this._removeFromGridUnclustered(s,e),void 0}r[e].addObject(t,i)}this._topClusterLevel._addChild(t),t.__parent=this._topClusterLevel},_enqueue:function(t){this._queue.push(t),this._queueTimeout||(this._queueTimeout=setTimeout(L.bind(this._processQueue,this),300))},_processQueue:function(){for(var t=0;t<this._queue.length;t++)this._queue[t].call(this);this._queue.length=0,clearTimeout(this._queueTimeout),this._queueTimeout=null},_mergeSplitClusters:function(){this._processQueue(),this._zoom<this._map._zoom&&this._currentShownBounds.intersects(this._getExpandedVisibleBounds())?(this._animationStart(),this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,this._zoom,this._getExpandedVisibleBounds()),this._animationZoomIn(this._zoom,this._map._zoom)):this._zoom>this._map._zoom?(this._animationStart(),this._animationZoomOut(this._zoom,this._map._zoom)):this._moveEnd()},_getExpandedVisibleBounds:function(){return this.options.removeOutsideVisibleBounds?L.Browser.mobile?this._checkBoundsMaxLat(this._map.getBounds()):this._checkBoundsMaxLat(this._map.getBounds().pad(1)):this._mapBoundsInfinite},_checkBoundsMaxLat:function(t){var e=this._maxLat;return e!==i&&(t.getNorth()>=e&&(t._northEast.lat=1/0),t.getSouth()<=-e&&(t._southWest.lat=-1/0)),t},_animationAddLayerNonAnimated:function(t,e){if(e===t)this._featureGroup.addLayer(t);else if(2===e._childCount){e._addToMap();var i=e.getAllChildMarkers();this._featureGroup.removeLayer(i[0]),this._featureGroup.removeLayer(i[1])}else e._updateIcon()},_overrideMarkerIcon:function(t){var e=t.options.icon=this.options.iconCreateFunction({getChildCount:function(){return 1},getAllChildMarkers:function(){return[t]}});return e}}),L.MarkerClusterGroup.include({_mapBoundsInfinite:new L.LatLngBounds(new L.LatLng(-1/0,-1/0),new L.LatLng(1/0,1/0))}),L.MarkerClusterGroup.include({_noAnimation:{_animationStart:function(){},_animationZoomIn:function(t,e){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,t),this._topClusterLevel._recursivelyAddChildrenToMap(null,e,this._getExpandedVisibleBounds()),this.fire("animationend")},_animationZoomOut:function(t,e){this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,t),this._topClusterLevel._recursivelyAddChildrenToMap(null,e,this._getExpandedVisibleBounds()),this.fire("animationend")
},_animationAddLayer:function(t,e){this._animationAddLayerNonAnimated(t,e)}},_withAnimation:{_animationStart:function(){this._map._mapPane.className+=" leaflet-cluster-anim",this._inZoomAnimation++},_animationZoomIn:function(t,e){var i,n=this._getExpandedVisibleBounds(),o=this._featureGroup;this._topClusterLevel._recursively(n,t,0,function(r){var s,a=r._latlng,l=r._markers;for(n.contains(a)||(a=null),r._isSingleParent()&&t+1===e?(o.removeLayer(r),r._recursivelyAddChildrenToMap(null,e,n)):(r.clusterHide(),r._recursivelyAddChildrenToMap(a,e,n)),i=l.length-1;i>=0;i--)s=l[i],n.contains(s._latlng)||o.removeLayer(s)}),this._forceLayout(),this._topClusterLevel._recursivelyBecomeVisible(n,e),o.eachLayer(function(t){t instanceof L.MarkerCluster||!t._icon||t.clusterShow()}),this._topClusterLevel._recursively(n,t,e,function(t){t._recursivelyRestoreChildPositions(e)}),this._enqueue(function(){this._topClusterLevel._recursively(n,t,0,function(t){o.removeLayer(t),t.clusterShow()}),this._animationEnd()})},_animationZoomOut:function(t,e){this._animationZoomOutSingle(this._topClusterLevel,t-1,e),this._topClusterLevel._recursivelyAddChildrenToMap(null,e,this._getExpandedVisibleBounds()),this._topClusterLevel._recursivelyRemoveChildrenFromMap(this._currentShownBounds,t,this._getExpandedVisibleBounds())},_animationAddLayer:function(t,e){var i=this,n=this._featureGroup;n.addLayer(t),e!==t&&(e._childCount>2?(e._updateIcon(),this._forceLayout(),this._animationStart(),t._setPos(this._map.latLngToLayerPoint(e.getLatLng())),t.clusterHide(),this._enqueue(function(){n.removeLayer(t),t.clusterShow(),i._animationEnd()})):(this._forceLayout(),i._animationStart(),i._animationZoomOutSingle(e,this._map.getMaxZoom(),this._map.getZoom())))}},_animationZoomOutSingle:function(t,e,i){var n=this._getExpandedVisibleBounds();t._recursivelyAnimateChildrenInAndAddSelfToMap(n,e+1,i);var o=this;this._forceLayout(),t._recursivelyBecomeVisible(n,i),this._enqueue(function(){if(1===t._childCount){var r=t._markers[0];r.setLatLng(r.getLatLng()),r.clusterShow&&r.clusterShow()}else t._recursively(n,i,0,function(t){t._recursivelyRemoveChildrenFromMap(n,e+1)});o._animationEnd()})},_animationEnd:function(){this._map&&(this._map._mapPane.className=this._map._mapPane.className.replace(" leaflet-cluster-anim","")),this._inZoomAnimation--,this.fire("animationend")},_forceLayout:function(){L.Util.falseFn(e.body.offsetWidth)}}),L.markerClusterGroup=function(t){return new L.MarkerClusterGroup(t)},L.MarkerCluster=L.Marker.extend({initialize:function(t,e,i,n){L.Marker.prototype.initialize.call(this,i?i._cLatLng||i.getLatLng():new L.LatLng(0,0),{icon:this}),this._group=t,this._zoom=e,this._markers=[],this._childClusters=[],this._childCount=0,this._iconNeedsUpdate=!0,this._boundsNeedUpdate=!0,this._bounds=new L.LatLngBounds,i&&this._addChild(i),n&&this._addChild(n)},getAllChildMarkers:function(t){t=t||[];for(var e=this._childClusters.length-1;e>=0;e--)this._childClusters[e].getAllChildMarkers(t);for(var i=this._markers.length-1;i>=0;i--)t.push(this._markers[i]);return t},getChildCount:function(){return this._childCount},zoomToBounds:function(){for(var t,e=this._childClusters.slice(),i=this._group._map,n=i.getBoundsZoom(this._bounds),o=this._zoom+1,r=i.getZoom();e.length>0&&n>o;){o++;var s=[];for(t=0;t<e.length;t++)s=s.concat(e[t]._childClusters);e=s}n>o?this._group._map.setView(this._latlng,o):r>=n?this._group._map.setView(this._latlng,r+1):this._group._map.fitBounds(this._bounds)},getBounds:function(){var t=new L.LatLngBounds;return t.extend(this._bounds),t},_updateIcon:function(){this._iconNeedsUpdate=!0,this._icon&&this.setIcon(this)},createIcon:function(){return this._iconNeedsUpdate&&(this._iconObj=this._group.options.iconCreateFunction(this),this._iconNeedsUpdate=!1),this._iconObj.createIcon()},createShadow:function(){return this._iconObj.createShadow()},_addChild:function(t,e){this._iconNeedsUpdate=!0,this._boundsNeedUpdate=!0,this._setClusterCenter(t),t instanceof L.MarkerCluster?(e||(this._childClusters.push(t),t.__parent=this),this._childCount+=t._childCount):(e||this._markers.push(t),this._childCount++),this.__parent&&this.__parent._addChild(t,!0)},_setClusterCenter:function(t){this._cLatLng||(this._cLatLng=t._cLatLng||t._latlng)},_resetBounds:function(){var t=this._bounds;t._southWest&&(t._southWest.lat=1/0,t._southWest.lng=1/0),t._northEast&&(t._northEast.lat=-1/0,t._northEast.lng=-1/0)},_recalculateBounds:function(){var t,e,i,n,o=this._markers,r=this._childClusters,s=0,a=0,l=this._childCount;if(0!==l){for(this._resetBounds(),t=0;t<o.length;t++)i=o[t]._latlng,this._bounds.extend(i),s+=i.lat,a+=i.lng;for(t=0;t<r.length;t++)e=r[t],e._boundsNeedUpdate&&e._recalculateBounds(),this._bounds.extend(e._bounds),i=e._wLatLng,n=e._childCount,s+=i.lat*n,a+=i.lng*n;this._latlng=this._wLatLng=new L.LatLng(s/l,a/l),this._boundsNeedUpdate=!1}},_addToMap:function(t){t&&(this._backupLatlng=this._latlng,this.setLatLng(t)),this._group._featureGroup.addLayer(this)},_recursivelyAnimateChildrenIn:function(t,e,i){this._recursively(t,0,i-1,function(t){var i,n,o=t._markers;for(i=o.length-1;i>=0;i--)n=o[i],n._icon&&(n._setPos(e),n.clusterHide())},function(t){var i,n,o=t._childClusters;for(i=o.length-1;i>=0;i--)n=o[i],n._icon&&(n._setPos(e),n.clusterHide())})},_recursivelyAnimateChildrenInAndAddSelfToMap:function(t,e,i){this._recursively(t,i,0,function(n){n._recursivelyAnimateChildrenIn(t,n._group._map.latLngToLayerPoint(n.getLatLng()).round(),e),n._isSingleParent()&&e-1===i?(n.clusterShow(),n._recursivelyRemoveChildrenFromMap(t,e)):n.clusterHide(),n._addToMap()})},_recursivelyBecomeVisible:function(t,e){this._recursively(t,0,e,null,function(t){t.clusterShow()})},_recursivelyAddChildrenToMap:function(t,e,i){this._recursively(i,-1,e,function(n){if(e!==n._zoom)for(var o=n._markers.length-1;o>=0;o--){var r=n._markers[o];i.contains(r._latlng)&&(t&&(r._backupLatlng=r.getLatLng(),r.setLatLng(t),r.clusterHide&&r.clusterHide()),n._group._featureGroup.addLayer(r))}},function(e){e._addToMap(t)})},_recursivelyRestoreChildPositions:function(t){for(var e=this._markers.length-1;e>=0;e--){var i=this._markers[e];i._backupLatlng&&(i.setLatLng(i._backupLatlng),delete i._backupLatlng)}if(t-1===this._zoom)for(var n=this._childClusters.length-1;n>=0;n--)this._childClusters[n]._restorePosition();else for(var o=this._childClusters.length-1;o>=0;o--)this._childClusters[o]._recursivelyRestoreChildPositions(t)},_restorePosition:function(){this._backupLatlng&&(this.setLatLng(this._backupLatlng),delete this._backupLatlng)},_recursivelyRemoveChildrenFromMap:function(t,e,i){var n,o;this._recursively(t,-1,e-1,function(t){for(o=t._markers.length-1;o>=0;o--)n=t._markers[o],i&&i.contains(n._latlng)||(t._group._featureGroup.removeLayer(n),n.clusterShow&&n.clusterShow())},function(t){for(o=t._childClusters.length-1;o>=0;o--)n=t._childClusters[o],i&&i.contains(n._latlng)||(t._group._featureGroup.removeLayer(n),n.clusterShow&&n.clusterShow())})},_recursively:function(t,e,i,n,o){var r,s,a=this._childClusters,l=this._zoom;if(e>l)for(r=a.length-1;r>=0;r--)s=a[r],t.intersects(s._bounds)&&s._recursively(t,e,i,n,o);else if(n&&n(this),o&&this._zoom===i&&o(this),i>l)for(r=a.length-1;r>=0;r--)s=a[r],t.intersects(s._bounds)&&s._recursively(t,e,i,n,o)},_isSingleParent:function(){return this._childClusters.length>0&&this._childClusters[0]._childCount===this._childCount}}),L.Marker.include({clusterHide:function(){return this.options.opacityWhenUnclustered=this.options.opacity||1,this.setOpacity(0)},clusterShow:function(){var t=this.setOpacity(this.options.opacity||this.options.opacityWhenUnclustered);return delete this.options.opacityWhenUnclustered,t}}),L.DistanceGrid=function(t){this._cellSize=t,this._sqCellSize=t*t,this._grid={},this._objectPoint={}},L.DistanceGrid.prototype={addObject:function(t,e){var i=this._getCoord(e.x),n=this._getCoord(e.y),o=this._grid,r=o[n]=o[n]||{},s=r[i]=r[i]||[],a=L.Util.stamp(t);this._objectPoint[a]=e,s.push(t)},updateObject:function(t,e){this.removeObject(t),this.addObject(t,e)},removeObject:function(t,e){var i,n,o=this._getCoord(e.x),r=this._getCoord(e.y),s=this._grid,a=s[r]=s[r]||{},l=a[o]=a[o]||[];for(delete this._objectPoint[L.Util.stamp(t)],i=0,n=l.length;n>i;i++)if(l[i]===t)return l.splice(i,1),1===n&&delete a[o],!0},eachObject:function(t,e){var i,n,o,r,s,a,l,h=this._grid;for(i in h){s=h[i];for(n in s)for(a=s[n],o=0,r=a.length;r>o;o++)l=t.call(e,a[o]),l&&(o--,r--)}},getNearObject:function(t){var e,i,n,o,r,s,a,l,h=this._getCoord(t.x),u=this._getCoord(t.y),c=this._objectPoint,d=this._sqCellSize,p=null;for(e=u-1;u+1>=e;e++)if(o=this._grid[e])for(i=h-1;h+1>=i;i++)if(r=o[i])for(n=0,s=r.length;s>n;n++)a=r[n],l=this._sqDist(c[L.Util.stamp(a)],t),d>l&&(d=l,p=a);return p},_getCoord:function(t){return Math.floor(t/this._cellSize)},_sqDist:function(t,e){var i=e.x-t.x,n=e.y-t.y;return i*i+n*n}},function(){L.QuickHull={getDistant:function(t,e){var i=e[1].lat-e[0].lat,n=e[0].lng-e[1].lng;return n*(t.lat-e[0].lat)+i*(t.lng-e[0].lng)},findMostDistantPointFromBaseLine:function(t,e){var i,n,o,r=0,s=null,a=[];for(i=e.length-1;i>=0;i--)n=e[i],o=this.getDistant(n,t),o>0&&(a.push(n),o>r&&(r=o,s=n));return{maxPoint:s,newPoints:a}},buildConvexHull:function(t,e){var i=[],n=this.findMostDistantPointFromBaseLine(t,e);return n.maxPoint?(i=i.concat(this.buildConvexHull([t[0],n.maxPoint],n.newPoints)),i=i.concat(this.buildConvexHull([n.maxPoint,t[1]],n.newPoints))):[t[0]]},getConvexHull:function(t){var e,i=!1,n=!1,o=!1,r=!1,s=null,a=null,l=null,h=null,u=null,c=null;for(e=t.length-1;e>=0;e--){var d=t[e];(i===!1||d.lat>i)&&(s=d,i=d.lat),(n===!1||d.lat<n)&&(a=d,n=d.lat),(o===!1||d.lng>o)&&(l=d,o=d.lng),(r===!1||d.lng<r)&&(h=d,r=d.lng)}n!==i?(c=a,u=s):(c=h,u=l);var p=[].concat(this.buildConvexHull([c,u],t),this.buildConvexHull([u,c],t));return p}}}(),L.MarkerCluster.include({getConvexHull:function(){var t,e,i=this.getAllChildMarkers(),n=[];for(e=i.length-1;e>=0;e--)t=i[e].getLatLng(),n.push(t);return L.QuickHull.getConvexHull(n)}}),L.MarkerCluster.include({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_circleSpiralSwitchover:9,spiderfy:function(){if(this._group._spiderfied!==this&&!this._group._inZoomAnimation){var t,e=this.getAllChildMarkers(),i=this._group,n=i._map,o=n.latLngToLayerPoint(this._latlng);this._group._unspiderfy(),this._group._spiderfied=this,e.length>=this._circleSpiralSwitchover?t=this._generatePointsSpiral(e.length,o):(o.y+=10,t=this._generatePointsCircle(e.length,o)),this._animationSpiderfy(e,t)}},unspiderfy:function(t){this._group._inZoomAnimation||(this._animationUnspiderfy(t),this._group._spiderfied=null)},_generatePointsCircle:function(t,e){var i,n,o=this._group.options.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+t),r=o/this._2PI,s=this._2PI/t,a=[];for(a.length=t,i=t-1;i>=0;i--)n=this._circleStartAngle+i*s,a[i]=new L.Point(e.x+r*Math.cos(n),e.y+r*Math.sin(n))._round();return a},_generatePointsSpiral:function(t,e){var i,n=this._group.options.spiderfyDistanceMultiplier,o=n*this._spiralLengthStart,r=n*this._spiralFootSeparation,s=n*this._spiralLengthFactor*this._2PI,a=0,l=[];for(l.length=t,i=t-1;i>=0;i--)a+=r/o+5e-4*i,l[i]=new L.Point(e.x+o*Math.cos(a),e.y+o*Math.sin(a))._round(),o+=s/a;return l},_noanimationUnspiderfy:function(){var t,e,i=this._group,n=i._map,o=i._featureGroup,r=this.getAllChildMarkers();for(this.setOpacity(1),e=r.length-1;e>=0;e--)t=r[e],o.removeLayer(t),t._preSpiderfyLatlng&&(t.setLatLng(t._preSpiderfyLatlng),delete t._preSpiderfyLatlng),t.setZIndexOffset&&t.setZIndexOffset(0),t._spiderLeg&&(n.removeLayer(t._spiderLeg),delete t._spiderLeg);i.fire("unspiderfied",{cluster:this,markers:r}),i._spiderfied=null}}),L.MarkerClusterNonAnimated=L.MarkerCluster.extend({_animationSpiderfy:function(t,e){var i,n,o,r,s=this._group,a=s._map,l=s._featureGroup,h=this._group.options.spiderLegPolylineOptions;for(i=0;i<t.length;i++)r=a.layerPointToLatLng(e[i]),n=t[i],o=new L.Polyline([this._latlng,r],h),a.addLayer(o),n._spiderLeg=o,n._preSpiderfyLatlng=n._latlng,n.setLatLng(r),n.setZIndexOffset&&n.setZIndexOffset(1e6),l.addLayer(n);this.setOpacity(.3),s.fire("spiderfied",{cluster:this,markers:t})},_animationUnspiderfy:function(){this._noanimationUnspiderfy()}}),L.MarkerCluster.include({_animationSpiderfy:function(t,e){var n,o,r,s,a,l,h=this,u=this._group,c=u._map,d=u._featureGroup,p=this._latlng,m=c.latLngToLayerPoint(p),f=L.Path.SVG,g=L.extend({},this._group.options.spiderLegPolylineOptions),_=g.opacity;for(_===i&&(_=L.MarkerClusterGroup.prototype.options.spiderLegPolylineOptions.opacity),f?(g.opacity=0,g.className=(g.className||"")+" leaflet-cluster-spider-leg"):g.opacity=_,n=0;n<t.length;n++)o=t[n],l=c.layerPointToLatLng(e[n]),r=new L.Polyline([p,l],g),c.addLayer(r),o._spiderLeg=r,f&&(s=r._path,a=s.getTotalLength()+.1,s.style.strokeDasharray=a,s.style.strokeDashoffset=a),o.setZIndexOffset&&o.setZIndexOffset(1e6),o.clusterHide&&o.clusterHide(),d.addLayer(o),o._setPos&&o._setPos(m);for(u._forceLayout(),u._animationStart(),n=t.length-1;n>=0;n--)l=c.layerPointToLatLng(e[n]),o=t[n],o._preSpiderfyLatlng=o._latlng,o.setLatLng(l),o.clusterShow&&o.clusterShow(),f&&(r=o._spiderLeg,s=r._path,s.style.strokeDashoffset=0,r.setStyle({opacity:_}));this.setOpacity(.3),setTimeout(function(){u._animationEnd(),u.fire("spiderfied",{cluster:h,markers:t})},200)},_animationUnspiderfy:function(t){var e,i,n,o,r,s,a=this,l=this._group,h=l._map,u=l._featureGroup,c=t?h._latLngToNewLayerPoint(this._latlng,t.zoom,t.center):h.latLngToLayerPoint(this._latlng),d=this.getAllChildMarkers(),p=L.Path.SVG;for(l._animationStart(),this.setOpacity(1),i=d.length-1;i>=0;i--)e=d[i],e._preSpiderfyLatlng&&(e.setLatLng(e._preSpiderfyLatlng),delete e._preSpiderfyLatlng,s=!0,e._setPos&&(e._setPos(c),s=!1),e.clusterHide&&(e.clusterHide(),s=!1),s&&u.removeLayer(e),p&&(n=e._spiderLeg,o=n._path,r=o.getTotalLength()+.1,o.style.strokeDashoffset=r,n.setStyle({opacity:0})));setTimeout(function(){var t=0;for(i=d.length-1;i>=0;i--)e=d[i],e._spiderLeg&&t++;for(i=d.length-1;i>=0;i--)e=d[i],e._spiderLeg&&(e.clusterShow&&e.clusterShow(),e.setZIndexOffset&&e.setZIndexOffset(0),t>1&&u.removeLayer(e),h.removeLayer(e._spiderLeg),delete e._spiderLeg);l._animationEnd(),l.fire("unspiderfied",{cluster:a,markers:d})},200)}}),L.MarkerClusterGroup.include({_spiderfied:null,_spiderfierOnAdd:function(){this._map.on("click",this._unspiderfyWrapper,this),this._map.options.zoomAnimation&&this._map.on("zoomstart",this._unspiderfyZoomStart,this),this._map.on("zoomend",this._noanimationUnspiderfy,this)},_spiderfierOnRemove:function(){this._map.off("click",this._unspiderfyWrapper,this),this._map.off("zoomstart",this._unspiderfyZoomStart,this),this._map.off("zoomanim",this._unspiderfyZoomAnim,this),this._map.off("zoomend",this._noanimationUnspiderfy,this),this._noanimationUnspiderfy()},_unspiderfyZoomStart:function(){this._map&&this._map.on("zoomanim",this._unspiderfyZoomAnim,this)},_unspiderfyZoomAnim:function(t){L.DomUtil.hasClass(this._map._mapPane,"leaflet-touching")||(this._map.off("zoomanim",this._unspiderfyZoomAnim,this),this._unspiderfy(t))},_unspiderfyWrapper:function(){this._unspiderfy()},_unspiderfy:function(t){this._spiderfied&&this._spiderfied.unspiderfy(t)},_noanimationUnspiderfy:function(){this._spiderfied&&this._spiderfied._noanimationUnspiderfy()},_unspiderfyLayer:function(t){t._spiderLeg&&(this._featureGroup.removeLayer(t),t.clusterShow&&t.clusterShow(),t.setZIndexOffset&&t.setZIndexOffset(0),this._map.removeLayer(t._spiderLeg),delete t._spiderLeg)}}),L.MarkerClusterGroup.include({refreshClusters:function(t){return t?t instanceof L.MarkerClusterGroup?t=t._topClusterLevel.getAllChildMarkers():t instanceof L.LayerGroup?t=t._layers:t instanceof L.MarkerCluster?t=t.getAllChildMarkers():t instanceof L.Marker&&(t=[t]):t=this._topClusterLevel.getAllChildMarkers(),this._flagParentsIconsNeedUpdate(t),this._refreshClustersIcons(),this.options.singleMarkerMode&&this._refreshSingleMarkerModeMarkers(t),this},_flagParentsIconsNeedUpdate:function(t){var e,i;for(e in t)for(i=t[e].__parent;i;)i._iconNeedsUpdate=!0,i=i.__parent},_refreshClustersIcons:function(){this._featureGroup.eachLayer(function(t){t instanceof L.MarkerCluster&&t._iconNeedsUpdate&&t._updateIcon()})},_refreshSingleMarkerModeMarkers:function(t){var e,i;for(e in t)i=t[e],this.hasLayer(i)&&i.setIcon(this._overrideMarkerIcon(i))}}),L.Marker.include({refreshIconOptions:function(t,e){var i=this.options.icon;return L.setOptions(i,t),this.setIcon(i),e&&this.__parent&&this.__parent._group.refreshClusters(this),this}})}(window,document),function(){"use strict";var t=function(t,e){return t.replace(/\{ *([\w_]+) *\}/g,function(t,i){var n=e[i];return void 0===n?n="":"function"==typeof n&&(n=n(e)),n})},e=function(){};e.prototype.initFromDescription=function(t){var e=t.properties,i=e.MetaProperties,n=i["url-template"]&&i["url-template"].Value,o=!!i["merc-projection"],r={};if(!n)return new L.gmx.DummyLayer(e);e.Copyright&&(r.attribution=e.Copyright),i.minZoom&&(r.minZoom=i.minZoom.Value),i.maxZoom&&(r.maxZoom=i.maxZoom.Value);var s=(o?L.tileLayer.Mercator:L.tileLayer)(n,r);return s.getGmxProperties=function(){return e},s},L.gmx.addLayerClass("TMS",e),L.gmx.addLayerClass("TiledRaster",e);var i=function(){};i.prototype.initFromDescription=function(e){var i=["layers","styles","format","transparent","version","minZoom","maxZoom","tileSize","f","bboxSR","imageSR","size"],n={tileSize:parseInt},o=e.properties,r=o.MetaProperties,s=r["base-url"]&&r["base-url"].Value,a={};if(!s)return new L.gmx.DummyLayer(o);o.Copyright&&(a.attribution=o.Copyright);for(var l in r)-1!==i.indexOf(l)&&(a[l]=n[l]?n[l](r[l].Value):r[l].Value);var h=L.tileLayer.wms(s,a);h.getGmxProperties=function(){return o};var u=r.balloonTemplate&&r.balloonTemplate.Value;if(r.clickable&&u){h.options.clickable=!0,h.onRemove=function(t){c&&t.removeLayer(c),L.TileLayer.WMS.prototype.onRemove.apply(this,arguments)};var c;h.gmxEventCheck=function(e){if("click"===e.type){var i=this._map.project(e.latlng),n=h.options.tileSize,o=i.x%n,r=i.y%n,s=i.divideBy(n).floor(),l=this.getTileUrl(s);l=l.replace("=GetMap","=GetFeatureInfo"),l+="&X="+o+"&Y="+r+"&INFO_FORMAT=application/geojson&QUERY_LAYERS="+a.layers,$.getJSON(l).then(function(i){if(i.features[0]){var n=t(u,i.features[0].properties);c=L.popup().setLatLng(e.latlng).setContent(n).openOn(this._map)}}.bind(this))}return 1}}return h},L.gmx.addLayerClass("WMS",i)}();L.Map.addInitHook(function() {
	this.gmxControlsManager.setSvgSprites('http://www.kosmosnimki.ru/lib/geomixer/img/svg-symbols.svg');
});
}());
